<!-- matricula/templates/matricula.html -->
{% extends 'layouts/plantilla2.html'%}
{% load static %}

{% block head %}
<title>Gestion Matriculas</title>
<link rel="stylesheet" href="{% static 'matricula/css/matricula_nuevo.css' %}" />
{% endblock %}

{% block content %}
<div class="grid-main">
        <section class="portada-container">
            <div class="titulo">
                <h2>Gesti√≥n de Matriculas y Postulantes</h2>
            </div>

            <div class="menu">
                <ui>
                    <li data-target="#matriculas">Matricula</li>
                    <li data-target="#postulantes">Postulantes</li>
                </ui>
            </div>
        </section>
        <section class="paginas-container">
            <div class="row mb-4">
            
                    <div class="col-12">
                        <div class="d-flex justify-content-between justify-content-center mb-3">
                            <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Resumen de Categor√≠as</h5>
                            <button type="button" class="btn btn-sm btn-outline-info" id="btnActualizarResumen">
                                <i class="fas fa-sync-alt"></i> Actualizar
                            </button>
                        </div>
                        <div id="resumen-categorias" class="resumen-categorias">
                            <!-- Se cargar√° din√°micamente con JavaScript -->
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary"></div>
                                <p class="text-muted mt-2">Cargando resumen...</p>
                            </div>
                        </div>
                    </div>
                </div>

            <div data-content id="matriculas" class="active">
                <section class="matriculas-container" id="matriculas-row">
                    <h4>Alumnos Matriculados üë¶üñãÔ∏è</h4>

                    {% if info_u.tipo_personal == 'Administrador' or categorias_usuario %}
                    <div class="mb-3">
                        <!-- Bot√≥n para ver renovaciones -->
                        <button type="button" class="btn mb-5 p-2" data-bs-toggle="modal" style="background: linear-gradient(110deg,#1976d2 0%, #1565c0 100%);; color: #fff;"
                            data-bs-target="#modalRenovaciones">
                            <i class="fas fa-sync-alt"></i> Ver Renovaciones {{ anio_siguiente }}
                        </button>

                        <!-- Bot√≥n para buscar alumnos terminados -->
                        <button type="button" class="btn mb-5 p-2" data-bs-toggle="modal" style="background: linear-gradient(110deg,#1976d2 0%, #1565c0 100%);; color: #fff;"
                            data-bs-target="#modalBuscarTerminados">
                            <i class="fas fa-search"></i> Buscar Alumnos Terminados
                        </button>

                        <!-- Bot√≥n para terminar per√≠odo -->
                        <button type="button" class="btn mb-5 p-2" data-bs-toggle="modal" style="background: linear-gradient(110deg,#1976d2 0%, #1565c0 100%);; color: #fff;"
                            data-bs-target="#terminarPeriodoModal">
                            <i class="fas fa-graduation-cap"></i> Terminar Per√≠odo Acad√©mico
                        </button>
                    </div>
                    {% endif %}

                    <section class="filtros-matriculas-container mb-4">
                    <div class="row" style="display: flex; justify-content: center;">
                        <!-- B√∫squeda en tiempo real -->
                        <div class="col-md-3 m-2">
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                <input type="text" id="buscarMatriculados" class="form-control"
                                    placeholder="Buscar por nombre, apellido...">
                            </div>
                        </div>

                        <!-- Filtro por categor√≠a -->
                        <div class="col-md-2 m-2">
                            <select id="filtroCategoriaMatriculados" class="form-select">
                                <option value="">Todas las categor√≠as</option>
                                {% for c in categorias_usuario %}
                                <option value="{{ c.idcategoria }}">{{ c.nom_categoria }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- FILTRO NUEVO: Por rendimiento -->
                        <div class="col-md-2 m-2">
                            <select id="filtroRendimiento" class="form-select">
                                <option value="todos">Todos los rendimientos</option>
                                <option value="Excelente">Excelente (‚â•80%)</option>
                                <option value="Regular">Regular (60-79%)</option>
                                <option value="Bajo">Bajo (<60%)< /option>
                                <option value="Sin datos">Sin datos</option>
                            </select>
                        </div>

                        <!-- Botones de acci√≥n -->
                        <div class="col-md-3 m-2">
                            <div class="d-flex gap-2">
                                <button type="button" id="btnLimpiarFiltrosMatriculados"
                                    class="btn btn-outline-secondary btn-sm">
                                    <i class="fas fa-times"></i> Limpiar
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Contador de resultados -->
                    <div class="row mt-2 ">
                        <div class="col-12">
                            <small class="text-muted" id="contadorMatriculados"></small>
                        </div>
                    </div>
                </section>

                    <div class="contenedor-scroll-vertical" id="scrollVerticalMatriculados">
                        <div class="encabezado-scroll">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="fas fa-users me-2"></i>Matriculas
                                    <span class="badge bg-primary ms-2" id="contadorScrollMatriculados">0</span>
                                </h5>
                            </div>
                        </div>

                        <div class="row g-3">
                            {% for m in allMatriculas %}
                            {% if not m.codigo_fin_periodo %}
                            {% with per=m.fk_alumno.fk_persona_alumno %}
                            <div class="col-md-4">
                                <div class="card" id="alumno-card"
                                    data-nombre="{{ per.nom1_persona }} {{ per.ape1_persona }}"
                                    data-categoria="{{ m.fk_categoria.idcategoria }}"
                                    data-rendimiento="{{ m.estadisticas.rendimiento }}"
                                    data-porcentaje-asistencia="{{ m.estadisticas.porcentaje_asistencia }}"
                                    data-porcentaje-objetivos="{{ m.estadisticas.porcentaje_objetivos }}"
                                    data-calificacion-general="{{ m.estadisticas.calificacion_general }}"
                                    data-codigo-fin-periodo="{{ m.codigo_fin_periodo|default:'' }}">

                                    {% if m.fk_alumno.foto and m.fk_alumno.foto.url %}
                                    <img src="{{ m.fk_alumno.foto.url }}" alt="foto {{ per.nom1_persona }}" style="width: 100%; height: 250px; object-fit: cover; border-radius: 15px;">
                                    {% else %}
                                    <div class="card-placeholder"> <i class="fas fa-user"></i> </div>
                                    {% endif %}

                                    {% if m.estado_matricula %}
                                    <div class="estado-badge estado-activo">Activo</div>
                                    {% else %}
                                    <div class="estado-badge estado-inactivo">Suspendido</div>
                                    {% endif %}

                                    <div class="card-body">
                                        <h5 class="card-title">{{ per.nom1_persona }} {{ per.ape1_persona }}</h5>

                                        <div class="alumno-info">
                                            <div><strong>ID:</strong> {{ per.id_persona }}</div>
                                            <div><strong>Categor√≠a:</strong> {{ m.fk_categoria.nom_categoria | default:"-" }}
                                            </div>
                                            <div><strong>Posici√≥n:</strong> {{ m.fk_alumno.fk_posicion.nom_posicion | default:"-" }}</div>
                                        </div>

                                        <div class="menu-action mt-3">
                                            <button type="button" class="btn btn-primary btn-sm editAlumnoBtn"
                                                data-id="{{ per.id_persona }}" data-nom1="{{ per.nom1_persona }}"
                                                data-nom2="{{ per.nom2_persona|default:'' }}" data-ape1="{{ per.ape1_persona }}"
                                                data-ape2="{{ per.ape2_persona|default:'' }}"
                                                data-fecha="{{ per.fecha_nacimiento|date:'Y-m-d' }}"
                                                data-direc="{{ per.direc_persona|default:'' }}"
                                                data-tel="{{ per.tel_persona|default:'' }}"
                                                data-email="{{ per.email_persona|default:'' }}"
                                                data-genero="{{ per.genero|default:'' }}" data-eps="{{ per.eps|default:'' }}"
                                                data-rh="{{ per.rh|default:'' }}"
                                                data-tipoidentidad="{{ per.tipo_identidad|default:'' }}"
                                                data-numidentidad="{{ per.id_persona }}"
                                                data-altura="{{ m.fk_alumno.altura_metros|default:'' }}"
                                                data-peso="{{ m.fk_alumno.peso_medidas|default:'' }}"
                                                data-imc="{{ m.fk_alumno.imc_medidas|default:'' }}"
                                                data-talla="{{ m.fk_alumno.talla|default:'' }}"
                                                data-calzado="{{ m.fk_alumno.calzado|default:'' }}"
                                                data-pie="{{ m.fk_alumno.pie_dominante|default:'' }}"
                                                data-nom1acudiente="{{ m.fk_alumno.fk_acudiente.nom1_acudiente|default:'' }}"
                                                data-nom2acudiente="{{ m.fk_alumno.fk_acudiente.nom2_acudiente|default:'' }}"
                                                data-ape1acudiente="{{ m.fk_alumno.fk_acudiente.ape1_acudiente|default:'' }}"
                                                data-ape2acudiente="{{ m.fk_alumno.fk_acudiente.ape2_acudiente|default:'' }}"
                                                data-telacudiente="{{ m.fk_alumno.fk_acudiente.tel_acudiente|default:'' }}"
                                                data-emailacudiente="{{ m.fk_alumno.fk_acudiente.email_acudiente|default:'' }}"
                                                data-parentesco="{{ m.fk_alumno.fk_acudiente.parentesco|default:'' }}"
                                                data-idacudiente="{{ m.fk_alumno.fk_acudiente.idacudiente }}"
                                                data-categoria="{{ m.fk_categoria.idcategoria }}"
                                                data-posicion="{{ m.fk_alumno.fk_posicion.idposicion|default:'' }}"
                                                data-matricula="{{ m.idmatricula }}"
                                                data-tradatos="{% if m.fk_alumno.tradatos %}{{ m.fk_alumno.tradatos.url }}{% endif %}"
                                                data-foto="{% if m.fk_alumno.foto %}{{ m.fk_alumno.foto.url }}{% endif %}"
                                                data-automedica="{% if m.fk_alumno.automedica %}{{ m.fk_alumno.automedica.url}}{% endif %}"
                                                data-certeps="{% if m.fk_alumno.certeps %}{{ m.fk_alumno.certeps.url }}{% endif %}"
                                                data-otraescuela="{% if m.fk_alumno.otraescuela %}{{ m.fk_alumno.otraescuela.url}}{% endif %}"
                                                data-documento_identidad="{% if m.fk_alumno.documento_identidad %}{{ m.fk_alumno.documento_identidad.url}}{% endif %}">
                                                <i class="fas fa-edit"></i> Editar
                                            </button>

                                            <!-- Cambiar estado: form que hace POST con nuevo valor -->
                                            <form method="post" style="display:inline-block;">
                                                {% csrf_token %}
                                                <input type="hidden" name="action" value="change_state">
                                                <input type="hidden" name="id_matricula" value="{{ m.idmatricula }}">
                                                <input type="hidden" name="nuevo_estado"
                                                    value="{% if m.estado_matricula %}false{% else %}true{% endif %}">
                                                <button type="submit" class="btn btn-secondary btn-soft">
                                                    {% if m.estado_matricula %}Suspender{% else %}Activar{% endif %}
                                                </button>
                                            </form>

                                            <!-- Bot√≥n de vista previa del carnet -->
                                            <button type="button" class="btn btn-info btn-sm btn-preview-carnet" 
                                                    data-id="{{ per.id_persona }}" 
                                                    data-nombre="{{ per.nom1_persona }} {{ per.ape1_persona }}">
                                                <i class="fas fa-eye"></i> Vista Previa Carnet
                                            </button>

                                            <!-- Bot√≥n para enviar carnet por email (mant√©n el existente) -->
                                            <form method="post" style="display:inline-block;">
                                                {% csrf_token %}
                                                <input type="hidden" name="action" value="generate_carnet">
                                                <input type="hidden" name="persona_id" value="{{ per.id_persona }}">
                                                <button type="submit" class="btn btn-warning btn-sm">
                                                    <i class="fas fa-id-card"></i> Generar y Enviar Carnet
                                                </button>
                                            </form>
                                        </div>

                                        <div class="estadisticas-container mt-3 p-2 border-top">
                                            <!-- Barra de asistencia -->
                                            <div class="mb-2">
                                                <small class="d-flex justify-content-between">
                                                    <span>Asistencia:</span>
                                                    <strong>{{ m.estadisticas.porcentaje_asistencia }}%</strong>
                                                </small>
                                                <div class="progress" style="height: 6px;">
                                                    <div class="progress-bar bg-success" role="progressbar"></div>
                                                </div>
                                                <small class="text-muted">
                                                    {{ m.estadisticas.total_asistencias }}/{{ m.estadisticas.total_entrenamientos }} sesiones
                                                </small>
                                            </div>

                                            <!-- Barra de objetivos -->
                                            <div class="mb-2">
                                                <small class="d-flex justify-content-between">
                                                    <span>Objetivos:</span>
                                                    <strong>{{ m.estadisticas.porcentaje_objetivos }}%</strong>
                                                </small>
                                                <div class="progress" style="height: 6px;">
                                                    <div class="progress-bar bg-info" role="progressbar"></div>
                                                </div>
                                                <small class="text-muted">
                                                    {{ m.estadisticas.total_objetivos_cumplidos }}/{{ m.estadisticas.total_objetivos_evaluados }} cumplidos
                                                </small>
                                            </div>

                                            <!-- Calificaci√≥n general -->
                                            <div class="mt-2 text-center">
                                                <span class="badge {% if m.estadisticas.rendimiento == 'Excelente' %}bg-success
                                                {% elif m.estadisticas.rendimiento == 'Regular' %}bg-warning
                                                {% else %}bg-danger{% endif %} p-2">
                                                    {{ m.estadisticas.rendimiento }}: {{ m.estadisticas.calificacion_general }}%
                                                </span>
                                            </div>
                                        </div>

                                    </div>
                                </div>
                            </div>
                            {% endwith %}
                            {% endif %}
                            {% empty %}
                            <div class="col-12 text-center text-muted py-5">
                                <i class="fas fa-users-slash fa-3x mb-3"></i>
                                <h5>No hay alumnos matriculados</h5>
                                <p class="mb-3">No se encontraron alumnos sin per√≠odo terminado.</p>
                                <div class="d-flex justify-content-center gap-2">
                                    <a href="#" class="btn btn-info" data-bs-toggle="modal"
                                        data-bs-target="#modalBuscarTerminados">
                                        <i class="fas fa-search"></i> Ver alumnos terminados
                                    </a>
                                    <a href="#" class="btn btn-success" data-bs-toggle="modal"
                                        data-bs-target="#modalRenovaciones">
                                        <i class="fas fa-sync-alt"></i> Ver renovaciones
                                    </a>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </section>
            </div>

            <div data-content id="postulantes">
                <h4>Postulantes registrados üì©</h4>

                <!-- ================= NUEVO: BOT√ìN PARA CAMBIAR A VISTA KANBAN ================= -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="btn-group" role="group">
                        <button type="button" id="btnVistaLista" class="btn btn-outline-primary active">
                            <i class="fas fa-list"></i> Lista
                        </button>
                        <button type="button" id="btnVistaKanban" class="btn btn-outline-primary">
                            <i class="fas fa-columns"></i> Columnas
                        </button>

                    </div>

                    <!-- Bot√≥n para gestionar l√≠mites de categor√≠as -->
                    <button type="button" class="btn btn-info" data-bs-toggle="modal"
                        data-bs-target="#modalLimitesCategoria">
                        <i class="fas fa-sliders-h"></i> Gestionar l√≠mites de categor√≠as
                    </button>
                </div>

                <section class="filtros-container mb-4">
                    <div class="row" style="display: flex; justify-content: center;">
                        <!-- B√∫squeda en tiempo real -->
                        <div class="col-md-3">
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                <input type="text" id="buscarPostulantes" class="form-control"
                                    placeholder="Buscar por nombre, apellido, email...">
                            </div>
                        </div>

                        <!-- Filtro por categor√≠a sugerida -->
                        <div class="col-md-3">
                            <select name="fk_categoria" id="filtroCategoria" class="form-select">
                                <option value="">Todas las categor√≠as</option>
                                {% for c in categorias_usuario %}
                                <option value="{{ c.idcategoria }}">{{ c.nom_categoria }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Ordenamiento -->
                        <div class="col-md-3">
                            <select id="ordenarPostulantes" class="form-select">
                                <option value="recientes">M√°s recientes primero</option>
                                <option value="antiguos">M√°s antiguos primero</option>
                                <option value="nombre_asc">Nombre A-Z</option>
                                <option value="nombre_desc">Nombre Z-A</option>
                            </select>
                        </div>
                    </div>

                    <!-- Contador de resultados -->
                    <div class="row mt-2">
                        <div class="col-12">
                            <small class="text-muted" id="contadorResultados"></small>
                        </div>
                    </div>
                </section>

                <!-- ================= NUEVO: SECCI√ìN KANBAN (OCULTA INICIALMENTE) ================= -->
                <div id="seccion-kanban" style="display: none;">
                    <div class="kanban-board">
                        <div class="row">
                            <!-- COLUMNA 1: POSTULANTES -->
                            <div class="col-md-4">
                                <div class="kanban-column" data-column="postulantes">
                                    <div class="kanban-column-header bg-primary text-white">
                                        <h5 class="mb-0">
                                            <i class="fas fa-user-clock me-2"></i>Postulantes
                                            <span class="badge bg-light text-dark ms-2"
                                                id="contador-kanban-postulantes">0</span>
                                        </h5>
                                        <small>Personas que se han registrado</small>
                                    </div>
                                    <div class="kanban-column-body" id="columna-kanban-postulantes">
                                        <!-- Se llenar√° con JavaScript -->
                                    </div>
                                </div>
                            </div>

                            <!-- COLUMNA 2: EN PROCESO -->
                            <div class="col-md-4">
                                <div class="kanban-column" data-column="en-proceso">
                                    <div class="kanban-column-header bg-warning text-dark">
                                        <h5 class="mb-0">
                                            <i class="fas fa-user-check me-2"></i>En Proceso
                                            <span class="badge bg-light text-dark ms-2"
                                                id="contador-kanban-en-proceso">0</span>
                                        </h5>
                                        <small>En evaluaci√≥n por el administrador</small>
                                    </div>
                                    <div class="kanban-column-body" id="columna-kanban-en-proceso">
                                        <div class="text-center text-muted py-3">
                                            <i class="fas fa-hourglass-half fa-2x mb-2"></i><br>
                                            Arrastra postulantes aqu√≠
                                        </div>
                                    </div>
                                    <div class="kanban-column-footer">
                                        <button class="btn btn-success w-100 btn-kanban-aceptar-todos"
                                            data-columna="en-proceso">
                                            <i class="fas fa-check-circle me-1"></i> Aceptar Todos
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- COLUMNA 3: DECISI√ìN -->
                            <div class="col-md-4">
                                <div class="kanban-column" data-column="decision">
                                    <div class="kanban-column-header bg-secondary text-white">
                                        <h5 class="mb-0">
                                            <i class="fas fa-clipboard-check me-2"></i>Decisi√≥n Final
                                            <span class="badge bg-light text-dark ms-2"
                                                id="contador-kanban-decision">0</span>
                                        </h5>
                                        <small>Listos para decisi√≥n final</small>
                                    </div>
                                    <div class="kanban-column-body" id="columna-kanban-decision">
                                        <div class="text-center text-muted py-3">
                                            <i class="fas fa-balance-scale fa-2x mb-2"></i><br>
                                            Arrastra aqu√≠ para decidir
                                        </div>
                                    </div>
                                    <div class="kanban-column-footer d-grid gap-2">
                                        <button class="btn btn-success btn-kanban-aceptar-todos" data-columna="decision">
                                            <i class="fas fa-thumbs-up me-1"></i> Aceptar Todos
                                        </button>
                                        <button class="btn btn-danger btn-kanban-rechazar-todos" data-columna="decision">
                                            <i class="fas fa-thumbs-down me-1"></i> Rechazar Todos
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <section class="postulantes-container">
                    <div class="contenedor-scroll-vertical" id="scrollVerticalPostulantes">
                        <div class="encabezado-scroll">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="fas fa-user-clock me-2"></i>Postulantes Registrados
                                    <span class="badge bg-primary ms-2" id="contadorScrollPostulantes">0</span>
                                </h5>
                                <button class="btn btn-sm btn-outline-primary btn-expandir-scroll" 
                                        data-target="scrollVerticalPostulantes">
                                    <i class="fas fa-expand-alt"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="row g-3" id="postulantes-row">
                            {% for p in allPostulantes %}
                            {% with per=p.fk_persona_alumno %}
                            <div class="col-md-4">
                                <div class="position-relative" id="postulante-card">
                                    {% if p.foto and p.foto.url %}
                                    <img src="{{ p.foto.url }}" alt="foto {{ per.nom1_persona }}"
                                        style="width: 100%; height: 250px; object-fit: cover; border-radius: 15px;">
                                    {% else %}
                                    <div class="card-placeholder"> <i class="fas fa-user"></i> </div>
                                    {% endif %}
                                    <div class="card-body">
                                        <h5 class="card-title">{{ per.nom1_persona }} {{ per.ape1_persona }}</h5>
                                        <div class="alumno-info">
                                            <div><strong>Tel:</strong> {{ per.tel_persona|default:"-" }}</div>
                                            <div><strong>Email:</strong> {{ per.email_persona|default:"-" }}</div>
                                            <div><strong>Posici√≥n:</strong> {{ p.fk_posicion.nom_posicion | default:"-"}}</div>
                                            <div>
                                                <strong>Categor√≠a sugerida:</strong>
                                                <span class="categoria-sugerida"
                                                    data-edad="{{ p.fk_persona_alumno.fecha_nacimiento|date:'Y-m-d' }}">Calculando...</span>
                                            </div>

                                            <div class="fecha-postulacion" data-fecha="{{ per.fecha_registro|date:'Y-m-d' }}">
                                                <strong>Fecha de postulacion:</strong> {{ per.fecha_registro|date:"d/m/Y"|default:"Fecha no disponible" }}
                                            </div>
                                        </div>

                                        <div class="menu-action mt-3">
                                            <!-- Bot√≥n ver (data-*) - ACTUALIZADO CON TODOS LOS CAMPOS -->
                                            <button type="button" class="btn btn-info btn-soft btn-ver-info"
                                                data-nom="{{ per.nom1_persona }}" data-nom2="{{ per.nom2_persona|default:'' }}"
                                                data-ape="{{ per.ape1_persona }}" data-ape2="{{ per.ape2_persona|default:'' }}"
                                                data-id="{{ per.id }}" data-id-persona="{{ per.id_persona }}"
                                                data-fecha="{{ per.fecha_nacimiento|date:'Y-m-d' }}"
                                                data-direc="{{ per.direc_persona|default:'' }}"
                                                data-tel="{{ per.tel_persona|default:'' }}"
                                                data-email="{{ per.email_persona|default:'' }}"
                                                data-genero="{{ per.genero|default:'' }}" data-eps="{{ per.eps|default:'' }}"
                                                data-rh="{{ per.rh|default:'' }}"
                                                data-tipo-identidad="{{ per.tipo_identidad|default:'' }}"
                                                data-altura="{{ p.altura_metros|default:'' }}"
                                                data-peso="{{ p.peso_medidas|default:'' }}"
                                                data-imc="{{ p.imc_medidas|default:'' }}" data-talla="{{ p.talla|default:'' }}"
                                                data-calzado="{{ p.calzado|default:'' }}"
                                                data-pie-dominante="{{ p.pie_dominante|default:'' }}"
                                                data-posicion="{{ p.fk_posicion.nom_posicion|default:'' }}"
                                                data-nom1-acudiente="{{ p.fk_acudiente.nom1_acudiente|default:'' }}"
                                                data-nom2-acudiente="{{ p.fk_acudiente.nom2_acudiente|default:'' }}"
                                                data-ape1-acudiente="{{ p.fk_acudiente.ape1_acudiente|default:'' }}"
                                                data-ape2-acudiente="{{ p.fk_acudiente.ape2_acudiente|default:'' }}"
                                                data-tel-acudiente="{{ p.fk_acudiente.tel_acudiente|default:'' }}"
                                                data-email-acudiente="{{ p.fk_acudiente.email_acudiente|default:'' }}"
                                                data-parentesco="{{ p.fk_acudiente.parentesco|default:'' }}"
                                                data-id-acudiente="{{ p.fk_acudiente.idacudiente|default:'' }}"
                                                data-tradatos="{% if p.tradatos %}{{ p.tradatos.url }}{% endif %}"
                                                data-foto="{% if p.foto %}{{ p.foto.url }}{% endif %}"
                                                data-automedica="{% if p.automedica %}{{ p.automedica.url }}{% endif %}"
                                                data-certeps="{% if p.certeps %}{{ p.certeps.url }}{% endif %}"
                                                data-otraescuela="{% if p.otraescuela %}{{ p.otraescuela.url }}{% endif %}"
                                                data-documento_identidad="{% if p.documento_identidad %}{{ p.documento_identidad.url}}{% endif %}">

                                                <i class="fas fa-eye"></i> Info Completa
                                            </button>

                                            <!-- Bot√≥n aceptar -->
                                            <form method="post" style="display:inline-block;">
                                                {% csrf_token %}
                                                <input type="hidden" name="action" value="accept">
                                                <input type="hidden" name="id_persona" value="{{ per.id }}">
                                                <input type="hidden" name="fk_categoria" value="">
                                                <button type="submit" class="btn btn-success btn-soft">
                                                    <i class="fas fa-thumbs-up"></i> Aceptar
                                                </button>
                                            </form>

                                            <!-- Bot√≥n rechazar -->
                                            <button type="button" class="btn btn-danger btn-soft btn-open-rechazar"
                                                data-id="{{ per.id }}" data-nom="{{ per.nom1_persona|escapejs }}">
                                                <i class="fas fa-thumbs-down"></i> Rechazar
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endwith %}
                            {% endfor %}
                        </div>
                    </div>
                </section>
            </div>
        </section>
</div>

<!-- ================= MODAL: VER INFO POSTULANTE COMPLETO ================= -->
<div class="modal fade" id="modalInfo" tabindex="-1" aria-labelledby="infoPostulanteLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Informaci√≥n Completa del Postulante</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modalInfoBody">
                <!-- Se llena din√°micamente por JavaScript -->
            </div>
        </div>
    </div>
</div>

<!-- ================= MODAL: RECHAZAR CON MENSAJE PERSONALIZADO ================= -->
<div class="modal fade modal-lg" id="modalRechazar" tabindex="-1" aria-labelledby="rechazarLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h4 class="modal-title" id="rechazarLabel">
                    <i class="fas fa-times-circle me-2"></i>Rechazar Postulante
                </h4>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <form method="post" id="form-rechazar">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="reject">
                    <input type="hidden" id="rechazar_id_persona" name="id_persona">

                    <div class="mb-3">
                        <p id="texto-rechazar" class="fw-bold fs-5"></p>
                    </div>

                    <div class="mb-3">
                        <label for="mensajeRechazo" class="form-label">
                            <i class="fas fa-comment me-1"></i>Mensaje de rechazo (opcional)
                        </label>
                        <textarea class="form-control" id="mensajeRechazo" name="mensaje_rechazo" rows="4" placeholder="Ej: No cumple con los requisitos de edad para ninguna categor√≠a disponible...
O: Documentaci√≥n incompleta...
O: Capacidad m√°xima alcanzada en la categor√≠a correspondiente..." maxlength="500"></textarea>
                        <div class="form-text">
                            Este mensaje se incluir√° en el correo de notificaci√≥n. M√°ximo 500 caracteres.
                            <span id="contadorCaracteres" class="badge bg-secondary">0/500</span>
                        </div>
                    </div>

                    <div class="d-flex gap-2 justify-content-end">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i>Cancelar
                        </button>
                        <button type="submit" class="btn btn-danger">
                            <i class="fas fa-thumbs-down me-1"></i>Confirmar Rechazo
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- ================= MODAL: EDITAR ================= -->
<div class="modal fade" id="editAlumnoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="POST" enctype="multipart/form-data" id="editAlumnoForm">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title">Editar Alumno Matriculado</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="action" value="edit">
                    <input type="hidden" name="persona_id" id="edit_persona_id">
                    <input type="hidden" name="idmatricula" id="edit_matricula_id">
                    <input type="hidden" name="idacudiente_actual" id="edit_idacudiente_actual">

                    <!-- Informaci√≥n de Identificaci√≥n (NO EDITABLE) -->
                    <div class="card mb-3">
                        <div class="card-header bg-secondary text-white">
                            <h6 class="mb-0">üìÑ Documentos de Identificaci√≥n (No editable)</h6>
                        </div>
                        <div class="card-body">
                            <div class="row mb-2">
                                <div class="col-md-4">
                                    <label>Tipo de Identificaci√≥n</label>
                                    <input type="text" id="edit_tipo_identidad_display" class="form-control" readonly
                                        style="background-color: #e9ecef;">
                                    <input type="hidden" name="tipo_identidad" id="edit_tipo_identidad">
                                </div>
                                <div class="col-md-4">
                                    <label>N√∫mero de Identificaci√≥n</label>
                                    <input type="text" id="edit_num_identidad_display" class="form-control" readonly
                                        style="background-color: #e9ecef;">
                                    <input type="hidden" name="num_identidad" id="edit_num_identidad">
                                </div>
                                <div class="col-md-4">
                                    <label>Fecha de Nacimiento</label>
                                    <input type="text" id="edit_fecha_display" class="form-control" readonly
                                        style="background-color: #e9ecef;">
                                    <input type="hidden" name="fecha_nacimiento" id="edit_fecha">
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-md-6">
                                    <label>Tipo de Sangre (RH)</label>
                                    <input type="text" id="edit_rh_display" class="form-control" readonly
                                        style="background-color: #e9ecef;">
                                    <input type="hidden" name="rh" id="edit_rh">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Informaci√≥n Personal (EDITABLE) -->
                    <div class="card mb-3">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0">üë§ Informaci√≥n Personal (Editable)</h6>
                        </div>
                        <div class="card-body">
                            <div class="row mb-2">
                                <div class="col">
                                    <label>Primer Nombre</label>
                                    <input type="text" name="nom1_persona" id="edit_nom1" class="form-control"
                                        placeholder="Ingresa el primer nombre" readonly
                                        style="background-color: #e9ecef;">
                                    <input type="hidden" name="nom1_persona_hidden" id="edit_nom1_hidden">
                                    <div class="invalid-feedback">Solo letras, m√°ximo 20 caracteres</div>
                                </div>
                                <div class="col">
                                    <label>Segundo Nombre</label>
                                    <input type="text" name="nom2_persona" id="edit_nom2" class="form-control"
                                        placeholder="Ingresa el segundo nombre" readonly
                                        style="background-color: #e9ecef;">
                                    <input type="hidden" name="nom2_persona_hidden" id="edit_nom2_hidden">
                                    <div class="invalid-feedback">Solo letras, m√°ximo 20 caracteres</div>
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col">
                                    <label>Primer Apellido</label>
                                    <input type="text" name="ape1_persona" id="edit_ape1" class="form-control"
                                        placeholder="Ingresa el primer apellido" readonly
                                        style="background-color: #e9ecef;">
                                    <input type="hidden" name="ape1_persona_hidden" id="edit_ape1_hidden">
                                    <div class="invalid-feedback">Solo letras, m√°ximo 20 caracteres</div>
                                </div>
                                <div class="col">
                                    <label>Segundo Apellido</label>
                                    <input type="text" name="ape2_persona" id="edit_ape2" class="form-control"
                                        placeholder="Ingresa el segundo apellido" readonly
                                        style="background-color: #e9ecef;">
                                    <input type="hidden" name="ape2_persona_hidden" id="edit_ape2_hidden">
                                    <div class="invalid-feedback">Solo letras, m√°ximo 20 caracteres</div>
                                </div>
                            </div>

                            <div class="row mb-2">
                                <div class="col">
                                    <label>Direcci√≥n</label>
                                    <input type="text" name="direc_persona" id="edit_direc" class="form-control"
                                        placeholder="Ingresa la direcci√≥n">
                                    <div class="invalid-feedback">M√°ximo 40 caracteres permitidos</div>
                                </div>
                                <div class="col">
                                    <label>Tel√©fono</label>
                                    <input type="tel" name="tel_persona" id="edit_tel" class="form-control"
                                        placeholder="Ingresa 10 d√≠gitos">
                                    <div class="invalid-feedback">Debe tener exactamente 10 d√≠gitos</div>
                                </div>
                            </div>

                            <div class="row mb-2">
                                <div class="col">
                                    <label>Email</label>
                                    <input type="email" name="email_persona" id="edit_email" class="form-control"
                                        placeholder="ejemplo@correo.com">
                                    <div class="invalid-feedback">Formato de email inv√°lido o m√°ximo 40 caracteres</div>
                                </div>
                                <div class="col">
                                    <label>G√©nero</label>
                                    <input type="text" name="genero_display" id="edit_genero_display"
                                        class="form-control" readonly style="background-color: #e9ecef;">
                                    <input type="hidden" name="genero" id="edit_genero">
                                    <div class="invalid-feedback">Selecciona un g√©nero</div>
                                </div>
                            </div>

                            <div class="row mb-2">
                                <div class="col">
                                    <label>EPS</label>
                                    <select name="eps" id="edit_eps" class="form-select">
                                        <option value="">Seleccionar</option>
                                        {% for ep in eps %}
                                        <option value="{{ ep.0 }}">{{ ep.1 }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Medidas F√≠sicas (EDITABLE) -->
                    <div class="card mb-3">
                        <div class="card-header bg-warning text-dark">
                            <h6 class="mb-0">üìè Medidas F√≠sicas (Editable)</h6>
                        </div>
                        <div class="card-body">
                            <div class="row mb-2">
                                <div class="col">
                                    <label>Altura (metros)</label>
                                    <input type="number" step="0.01" name="altura_metros" id="edit_altura"
                                        class="form-control" min="0.5" max="2.5" placeholder="Ej: 1.65">
                                    <div class="invalid-feedback">La altura debe estar entre 0.5 y 2.5 metros</div>
                                </div>
                                <div class="col">
                                    <label>Peso (kg)</label>
                                    <input type="number" step="0.1" name="peso_medidas" id="edit_peso"
                                        class="form-control" min="10" max="150" placeholder="Ej: 55.5">
                                    <div class="invalid-feedback">El peso debe estar entre 10 y 150 kg</div>
                                </div>
                                <div class="col">
                                    <label>IMC (autom√°tico)</label>
                                    <input type="number" step="0.01" name="imc_medidas" id="edit_imc"
                                        class="form-control" readonly style="background-color: #f8f9fa;">
                                </div>
                            </div>

                            <div class="row mb-2">
                                <div class="col">
                                    <label>Talla de ropa</label>
                                    <select name="talla" id="edit_talla" class="form-select">
                                        <option value="">Seleccionar</option>
                                        {% for talla in talla_ropa %}
                                        <option value="{{ talla.0 }}">{{ talla.1 }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col">
                                    <label>Talla de calzado</label>
                                    <input type="number" name="calzado" id="edit_calzado" class="form-control" min="15"
                                        max="50" placeholder="Ej: 38">
                                    <div class="invalid-feedback">La talla debe estar entre 15 y 50</div>
                                </div>
                                <div class="col">
                                    <label>Pie Dominante</label>
                                    <select name="pie_dominante" id="edit_pie" class="form-select">
                                        <option value="">Seleccionar</option>
                                        {% for pie in pie_dom %}
                                        <option value="{{ pie.0 }}">{{ pie.1 }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Informaci√≥n Acad√©mica/Deportiva (EDITABLE) -->
                    <div class="card mb-3">
                        <div class="card-header bg-success text-white">
                            <h6 class="mb-0">‚öΩ Informaci√≥n Deportiva (Editable)</h6>
                        </div>
                        <div class="card-body">
                            <div class="row mb-2">
                                <div class="col">
                                    <label>Categor√≠a</label>
                                    <select name="fk_categoria" id="edit_categoria" class="form-select"
                                        onchange="validarCategoriaEdicion(this)">
                                        <option value="">Seleccionar</option>
                                        {% for cat in categorias_usuario %}
                                        <option value="{{ cat.idcategoria }}" data-nombre="{{ cat.nom_categoria }}">
                                            {{ cat.nom_categoria }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col">
                                    <label>Posici√≥n</label>
                                    <select name="fk_posicion" id="edit_posicion" class="form-select">
                                        <option value="">Seleccionar</option>
                                        {% for pos in posiciones %}
                                        <option value="{{ pos.idposicion }}">{{ pos.nom_posicion }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Informaci√≥n del Acudiente (EDITABLE) -->
                    <div class="card mb-3">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Informaci√≥n del Acudiente (Editable)</h6>
                        </div>
                        <div class="card-body">
                            <div class="row mb-2">
                                <div class="col">
                                    <label>ID del Acudiente *</label>
                                    <input type="text" name="idacudiente" id="edit_idacudiente" class="form-control"
                                        placeholder="Ingresa el ID del acudiente" required>
                                    <div class="invalid-feedback">El ID del acudiente es requerido</div>
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col">
                                    <label>Primer Nombre Acudiente</label>
                                    <input type="text" name="nom1_acudiente" id="edit_nom1_acudiente"
                                        class="form-control" placeholder="Ingresa el primer nombre">
                                    <div class="invalid-feedback">Solo letras, m√°ximo 20 caracteres</div>
                                </div>
                                <div class="col">
                                    <label>Segundo Nombre Acudiente</label>
                                    <input type="text" name="nom2_acudiente" id="edit_nom2_acudiente"
                                        class="form-control" placeholder="Ingresa el segundo nombre">
                                    <div class="invalid-feedback">Solo letras, m√°ximo 20 caracteres</div>
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col">
                                    <label>Primer Apellido Acudiente</label>
                                    <input type="text" name="ape1_acudiente" id="edit_ape1_acudiente"
                                        class="form-control" placeholder="Ingresa el primer apellido">
                                    <div class="invalid-feedback">Solo letras, m√°ximo 20 caracteres</div>
                                </div>
                                <div class="col">
                                    <label>Segundo Apellido Acudiente</label>
                                    <input type="text" name="ape2_acudiente" id="edit_ape2_acudiente"
                                        class="form-control" placeholder="Ingresa el segundo apellido">
                                    <div class="invalid-feedback">Solo letras, m√°ximo 20 caracteres</div>
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col">
                                    <label>Tel√©fono Acudiente</label>
                                    <input type="tel" name="tel_acudiente" id="edit_telacud" class="form-control"
                                        placeholder="Ingresa 10 d√≠gitos">
                                    <div class="invalid-feedback">Debe tener exactamente 10 d√≠gitos</div>
                                </div>
                                <div class="col">
                                    <label>Email Acudiente</label>
                                    <input type="email" name="email_acudiente" id="edit_emailacud" class="form-control"
                                        placeholder="ejemplo@correo.com">
                                    <div class="invalid-feedback">Formato de email inv√°lido</div>
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col">
                                    <label>Parentesco</label>
                                    <select name="parentesco" id="edit_parentesco" class="form-select">
                                        <option value="">Seleccionar</option>
                                        {% for parent in parentescos %}
                                        <option value="{{ parent.0 }}">{{ parent.1 }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Archivos (SOLO AUTORIZACI√ìN M√âDICA Y EPS EDITABLES) -->
                    <div class="card mb-3">
                        <div class="card-header bg-dark text-white">
                            <h6 class="mb-0">üìÅ Documentos</h6>
                        </div>
                        <div class="card-body">
                            <!-- Archivos EXISTENTES (solo visualizaci√≥n) -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label>Tratamiento de Datos (No editable)</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="edit_tradatos_display" readonly
                                            style="background-color: #e9ecef;" placeholder="Documento cargado">
                                        <button type="button" class="btn btn-outline-primary btn-sm"
                                            onclick="verDocumento('tradatos')" id="btn_ver_tradatos">
                                            üëÅÔ∏è Ver
                                        </button>
                                    </div>
                                    <input type="hidden" name="tradatos_existente" id="edit_tradatos_existente">
                                </div>
                                <div class="col-md-6">
                                    <label>Foto (No editable)</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="edit_foto_display" readonly
                                            style="background-color: #e9ecef;" placeholder="Foto cargada">
                                        <button type="button" class="btn btn-outline-primary btn-sm"
                                            onclick="verDocumento('foto')" id="btn_ver_foto">
                                            üëÅÔ∏è Ver
                                        </button>
                                    </div>
                                    <input type="hidden" name="foto_existente" id="edit_foto_existente">
                                </div>
                                <div class="col-md-6">
                                    <label>Documento de Identidad (No editable)</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="edit_documento_identidad_display"
                                            readonly style="background-color: #e9ecef;" placeholder="Documento cargado">
                                        <button type="button" class="btn btn-outline-primary btn-sm"
                                            onclick="verDocumento('documento_identidad')"
                                            id="btn_ver_documento_identidad">
                                            üëÅÔ∏è Ver
                                        </button>
                                    </div>
                                    <input type="hidden" name="documento_identidad_existente"
                                        id="edit_documento_identidad_existente">
                                </div>
                            </div>

                            <!-- Archivos EDITABLES -->
                            <div class="row">
                                <div class="col-md-6">
                                    <label>Autorizaci√≥n M√©dica</label>
                                    <div class="mb-2">
                                        <div class="input-group mb-2">
                                            <input type="text" class="form-control" id="edit_automedica_display"
                                                readonly style="background-color: #e9ecef;"
                                                placeholder="Documento cargado">
                                            <button type="button" class="btn btn-outline-primary btn-sm"
                                                onclick="verDocumento('automedica')" id="btn_ver_automedica">
                                                üëÅÔ∏è Ver
                                            </button>
                                        </div>
                                        <input type="hidden" name="automedica_existente" id="edit_automedica_existente">
                                    </div>
                                    <input type="file" name="automedica" id="edit_automedica" class="form-control"
                                        accept=".pdf,.doc,.docx">
                                    <div class="invalid-feedback">Formato permitido: PDF, DOC, DOCX (m√°x. 5MB)</div>
                                    <small class="text-muted">Puedes subir un nuevo documento si es necesario</small>
                                </div>
                                <div class="col-md-6">
                                    <label>Comprobante EPS</label>
                                    <div class="mb-2">
                                        <div class="input-group mb-2">
                                            <input type="text" class="form-control" id="edit_certeps_display" readonly
                                                style="background-color: #e9ecef;" placeholder="Documento cargado">
                                            <button type="button" class="btn btn-outline-primary btn-sm"
                                                onclick="verDocumento('certeps')" id="btn_ver_certeps">
                                                üëÅÔ∏è Ver
                                            </button>
                                        </div>
                                        <input type="hidden" name="certeps_existente" id="edit_certeps_existente">
                                    </div>
                                    <input type="file" name="certeps" id="edit_certeps" class="form-control"
                                        accept=".pdf,.doc,.docx">
                                    <div class="invalid-feedback">Formato permitido: PDF, DOC, DOCX (m√°x. 5MB)</div>
                                    <small class="text-muted">Puedes subir un nuevo documento si es necesario</small>
                                </div>
                            </div>

                            <!-- Otros documentos (solo visualizaci√≥n) -->
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <label>Certificado Otra Escuela (No editable)</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="edit_otraescuela_display" readonly
                                            style="background-color: #e9ecef;" placeholder="Documento cargado">
                                        <button type="button" class="btn btn-outline-primary btn-sm"
                                            onclick="verDocumento('otraescuela')" id="btn_ver_otraescuela">
                                            üëÅÔ∏è Ver
                                        </button>
                                    </div>
                                    <input type="hidden" name="otraescuela_existente" id="edit_otraescuela_existente">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-success">üíæ Guardar Cambios</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‚ùå Cancelar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Terminar Per√≠odo -->
<div class="modal fade" id="terminarPeriodoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Terminar Per√≠odo Acad√©mico</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <label for="categoriaSelect">Selecciona una categor√≠a:</label>
                <select id="categoriaSelect" class="form-select mb-3">
                    <option value="">-- Selecciona --</option>
                    {% for cat in categorias_usuario %} <!-- ‚úÖ Aseg√∫rate que dice categorias_usuario -->
                    <option value="{{ cat.idcategoria }}">{{ cat.nom_categoria }}</option>
                    {% endfor %}
                </select>

                <div>
                    <input type="checkbox" id="checkAll"> <label for="checkAll"><strong>Seleccionar
                            Todos</strong></label>
                </div>

                <ul id="listaMatriculas" class="list-group mt-2" style="max-height:300px; overflow-y:auto;">
                    <!-- Aqu√≠ se cargan los alumnos din√°micamente -->
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" id="btnTerminarPeriodo" class="btn btn-success">Terminar Per√≠odo</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- ================= MODAL: CONFIRMAR TERMINAR PERIODO ================= -->
<div class="modal fade" id="confirmarTerminarModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar Terminar Per√≠odo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="confirmarTexto">¬øEst√°s seguro de terminar el per√≠odo para <span id="cantidadAlumnos">0</span>
                    alumno(s)?</p>
                <small>
                    <strong>üìù Qu√© pasar√°:</strong><br>
                    ‚Ä¢ Se generar√°n c√≥digos de renovaci√≥n<br>
                    ‚Ä¢ Se enviar√°n emails a los alumnos
                </small>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="btnConfirmarTerminar">Terminar Per√≠odo</button>
            </div>
        </div>
    </div>
</div>

<!-- ================= NUEVO: MODAL ACEPTAR TODOS ================= -->
<div class="modal fade" id="modalAceptarTodosKanban" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-check-circle me-2"></i>Aceptar Todos (Kanban)</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="texto-aceptar-todos-kanban">¬øEst√°s seguro de aceptar a todos los postulantes en esta columna?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" id="btn-confirmar-aceptar-todos-kanban">Aceptar
                    Todos</button>
            </div>
        </div>
    </div>
</div>

<!-- ================= NUEVO: MODAL RECHAZAR TODOS ================= -->
<div class="modal fade" id="modalRechazarTodosKanban" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h4 class="modal-title" id="rechazarLabel">
                    <i class="fas fa-times-circle me-2"></i>Rechazar Postulante
                </h4>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            
            <div class="modal-body">
                <p id="texto-rechazar-todos-kanban" class="fw-bold fs-5">¬øEst√°s seguro de rechazar a todos los postulantes en esta columna?</p>
                
                <div class="mb-3">
                    <label for="motivo-rechazo-todos-kanban" class="form-label">
                        <i class="fas fa-comment-dots me-1"></i>Mensaje de rechazo (opcional)
                    </label>
                    <textarea class="form-control" id="motivo-rechazo-todos-kanban" rows="4" 
                              placeholder="Ej: No cumple con los requisitos de edad para ninguna categor√≠a disponible...
O: Documentaci√≥n incompleta...
O: Capacidad m√°xima alcanzada en la categor√≠a correspondiente..." maxlength="500"></textarea>
                    <div class="form-text">
                        Este mensaje se incluir√° en el correo de notificaci√≥n. M√°ximo 500 caracteres.
                        <span id="contador-caracteres-rechazo" class="badge bg-secondary">0/500</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancelar
                </button>
                <button type="button" class="btn btn-danger" id="btn-confirmar-rechazar-todos-kanban">
                    <i class="fas fa-thumbs-down me-1"></i>Rechazar y Notificar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ================= MODAL: RECHAZAR CON MENSAJE PERSONALIZADO ================= -->
<div class="modal fade modal-lg" id="modalRechazar" tabindex="-1" aria-labelledby="rechazarLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h4 class="modal-title" id="rechazarLabel">
                    <i class="fas fa-times-circle me-2"></i>Rechazar Postulante
                </h4>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <form method="post" id="form-rechazar">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="reject">
                    <input type="hidden" id="rechazar_id_persona" name="id_persona">

                    <div class="mb-3">
                        <p id="texto-rechazar" class="fw-bold fs-5"></p>
                    </div>

                    <div class="mb-3">
                        <label for="mensajeRechazo" class="form-label">
                            <i class="fas fa-comment me-1"></i>Mensaje de rechazo (opcional)
                        </label>
                        <textarea class="form-control" id="mensajeRechazo" name="mensaje_rechazo" rows="4" placeholder="Ej: No cumple con los requisitos de edad para ninguna categor√≠a disponible...
O: Documentaci√≥n incompleta...
O: Capacidad m√°xima alcanzada en la categor√≠a correspondiente..." maxlength="500"></textarea>
                        <div class="form-text">
                            Este mensaje se incluir√° en el correo de notificaci√≥n. M√°ximo 500 caracteres.
                            <span id="contadorCaracteres" class="badge bg-secondary">0/500</span>
                        </div>
                    </div>

                    <div class="d-flex gap-2 justify-content-end">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i>Cancelar
                        </button>
                        <button type="submit" class="btn btn-danger">
                            <i class="fas fa-thumbs-down me-1"></i>Confirmar Rechazo
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- ================= NUEVO: MODAL GESTIONAR L√çMITES DE CATEGOR√çA ================= -->
<div class="modal fade" id="modalLimitesCategoria" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-sliders-h me-2"></i>Gestionar L√≠mites por Categor√≠a</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Categor√≠a</th>
                                <th>Alumnos Actuales</th>
                                <th>L√≠mite Actual</th>
                                <th>Cupos Disponibles</th>
                                <th>Nuevo L√≠mite</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-limites-categorias">
                            <!-- Se llenar√° con JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-success" id="btn-guardar-limites-todos">Guardar Todos</button>
            </div>
        </div>
    </div>
</div>

<!-- ================= MODAL: BUSCAR ALUMNOS TERMINADOS ================= -->
<div class="modal fade" id="modalBuscarTerminados" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-search me-2"></i>Alumnos con Per√≠odo Terminado
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Tabla de resultados -->
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Alumno</th>
                                <th>Categor√≠a</th>
                                <th>C√≥digo</th>
                                <th>Fecha T√©rmino</th>
                                <th>Estado C√≥digo</th>
                            </tr>
                        </thead>
                        <tbody id="tbodyTerminados">
                            {% for alumno in alumnos_terminados %}
                            <tr class="fila-terminado"
                                data-nombre="{{ alumno.alumno.fk_persona_alumno.nom1_persona|lower }} {{ alumno.alumno.fk_persona_alumno.ape1_persona|lower }}"
                                data-categoria="{{ alumno.categoria|lower }}" data-codigo="{{ alumno.codigo|lower }}">
                                <td>
                                    <strong>{{ alumno.alumno.fk_persona_alumno.nom1_persona }} {{ alumno.alumno.fk_persona_alumno.ape1_persona }}</strong><br>
                                    <small class="text-muted">ID: {{ alumno.alumno.fk_persona_alumno.id_persona }}</small>
                                </td>
                                <td>
                                    <span class="badge bg-secondary">{{ alumno.categoria }}</span>
                                </td>
                                <td>
                                    {% if alumno.estado_codigo == 'VENCIDO' %}
                                    <code class="text-danger">{{ alumno.codigo }}</code>
                                    {% else %}
                                    <code class="text-primary">{{ alumno.codigo }}</code>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if alumno.fecha_terminacion %}
                                    {{ alumno.fecha_terminacion|date:"d/m/Y" }}
                                    {% else %}
                                    <span class="text-muted">Sin fecha</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if alumno.estado_codigo == 'VENCIDO' %}
                                    <span class="badge bg-danger">Vencido</span>
                                    {% else %}
                                    <span class="badge bg-success">Vigente</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center text-muted py-4">
                                    <i class="fas fa-user-graduate fa-2x mb-2"></i>
                                    <p>No hay alumnos con per√≠odo terminado</p>
                                    <small>Todos los alumnos est√°n activos o ya renovaron</small>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Contador -->
                <div class="alert alert-info mt-3">
                    <i class="fas fa-info-circle me-2"></i>
                    Mostrando <strong id="contadorVisiblesTerminados">{{ alumnos_terminados|length }}</strong> de
                    <strong id="contadorTotalTerminados">{{ alumnos_terminados|length }}</strong> alumnos con per√≠odo
                    terminado
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- ================= MODAL: RENOVACIONES ================= -->
<div class="modal fade" id="modalRenovaciones" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-sync-alt me-2"></i>Renovaciones para {{ anio_siguiente }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Tabla con renovaciones -->
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-success">
                            <tr>
                                <th>Alumno</th>
                                <th>Categor√≠a {{ anio_actual }}</th>
                                <th>Categor√≠a {{ anio_siguiente }}</th>
                                <th>Fecha Renovaci√≥n</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody id="tablaRenovaciones">
                            {% for renovacion in renovaciones %}
                            <tr>
                                <td>
                                    <strong>{{ renovacion.alumno.fk_persona_alumno.nom1_persona }} {{ renovacion.alumno.fk_persona_alumno.ape1_persona }}</strong><br>
                                    <small class="text-muted">ID: {{ renovacion.alumno.fk_persona_alumno.id_persona }}</small>
                                </td>
                                <td>
                                    <span class="badge bg-secondary">{{ renovacion.categoria_anterior }}</span>
                                </td>
                                <td>
                                    <span class="badge bg-success">{{ renovacion.categoria_actual }}</span>
                                </td>
                                <td>
                                    {{ renovacion.fecha_renovacion|date:"d/m/Y" }}
                                </td>
                                <td>
                                    <span class="badge bg-success">Renovado</span>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center text-muted py-4">
                                    <i class="fas fa-users fa-2x mb-2"></i>
                                    <p>No hay renovaciones registradas para {{ anio_siguiente }}</p>
                                    <small>Los alumnos aparecer√°n aqu√≠ despu√©s de renovar su matr√≠cula</small>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Resumen estad√≠stico -->
                <div class="row mt-3">
                    <div class="col-md-3">
                        <div class="card bg-success text-white">
                            <div class="card-body text-center">
                                <h4>{{ contador_renovados }}</h4>
                                <small>Renovados {{ anio_siguiente }}</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-primary text-white">
                            <div class="card-body text-center">
                                <h4>{{ contador_activos }}</h4>
                                <small>Activos {{ anio_actual }}</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-warning text-dark">
                            <div class="card-body text-center">
                                <h4>{{ contador_inactivos }}</h4>
                                <small>Inactivos</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-info text-white">
                            <div class="card-body text-center">
                                <h4>{{ contador_terminados }}</h4>
                                <small>Por Renovar</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="{% static 'partida/scripts/paginas.js' %}"></script>
<script>
    // Vista previa del carnet
    // Modifica la funci√≥n que abre la vista previa
document.addEventListener('click', function(e) {
    if (e.target.closest('.btn-preview-carnet')) {
        const btn = e.target.closest('.btn-preview-carnet');
        const alumnoId = btn.getAttribute('data-id');
        const alumnoNombre = btn.getAttribute('data-nombre');
        
        // Mostrar mensaje de carga
        mostrarToast('Generando vista previa del carnet...', 'info');
        
        // Abrir ventana de vista previa con la URL corregida
        const url = `/matricula/preview-carnet/?alumno_id=${alumnoId}&nombre=${encodeURIComponent(alumnoNombre)}`;
        
        // Abrir en nueva ventana con tama√±o adecuado
        const ventana = window.open(
            url, 
            'previewCarnet', 
            'width=900,height=700,scrollbars=yes,resizable=yes,toolbar=no,location=no,status=no'
        );
        
        if (ventana) {
            ventana.focus();
        } else {
            mostrarToast('Por favor permita ventanas emergentes para ver la vista previa', 'warning');
        }
    }
});
    // Funci√≥n principal que se ejecuta cuando todo est√° listo
    function inicializarMatriculas() {
        console.log('Cargando matr√≠culas via AJAX...');

        // 1. INICIALIZAR FILTROS INMEDIATAMENTE (no esperar a AJAX)
        inicializarFiltrosPostulantes();

        // Hacer petici√≥n al servidor para obtener las matr√≠culas
        fetch("{% url 'get_matriculas_json' %}")
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error en la respuesta: ' + response.status);
                }
                return response.json();
            })
            .then(matriculasData => {
                console.log('Matr√≠culas cargadas via AJAX:', matriculasData);

                // Inicializar los event listeners con los datos cargados
                inicializarEventListeners(matriculasData);
            })
            .catch(error => {
                console.error('Error cargando matr√≠culas:', error);
                alert('Error cargando los datos de matr√≠culas');
                // Inicializar con array vac√≠o si hay error
                inicializarEventListeners([]);
            });
    }

    // ================= FILTROS PARA MATRICULADOS (Versi√≥n simplificada y funcional) =================
    function inicializarFiltrosMatriculados() {
        const buscarInput = document.getElementById('buscarMatriculados');
        const filtroCategoria = document.getElementById('filtroCategoriaMatriculados');
        const filtroRendimiento = document.getElementById('filtroRendimiento');
        const ordenarSelect = document.getElementById('ordenarMatriculados');
        const btnLimpiar = document.getElementById('btnLimpiarFiltrosMatriculados');

        // Event listeners simples
        if (buscarInput) {
            buscarInput.addEventListener('input', function () {
                aplicarFiltrosMatriculados();
            });
        }

        if (filtroCategoria) {
            filtroCategoria.addEventListener('change', function () {
                aplicarFiltrosMatriculados();
            });
        }

        if (filtroRendimiento) {
            filtroRendimiento.addEventListener('change', function () {
                aplicarFiltrosMatriculados();
            });
        }

        if (ordenarSelect) {
            ordenarSelect.addEventListener('change', function () {
                aplicarFiltrosMatriculados();
            });
        }

        if (btnLimpiar) {
            btnLimpiar.addEventListener('click', function () {
                limpiarFiltrosMatriculados();
            });
        }
        aplicarFiltrosMatriculados(); // Aplicar filtros iniciales
    }

    function aplicarFiltrosMatriculados() {
        // Obtener valores de filtros
        const buscarTexto = document.getElementById('buscarMatriculados')?.value.toLowerCase() || '';
        const filtroCategoria = document.getElementById('filtroCategoriaMatriculados')?.value || '';
        const filtroRendimiento = document.getElementById('filtroRendimiento')?.value || 'todos';
        const orden = document.getElementById('ordenarMatriculados')?.value || 'nombre_asc';


        // Obtener todas las tarjetas - BUSCAR EL CARD DENTRO DEL COL-MD-4
        const tarjetas = document.querySelectorAll('#matriculas-row .col-md-4');

        let tarjetasVisibles = 0;
        const tarjetasArray = Array.from(tarjetas);

        // Aplicar filtros a cada tarjeta
        tarjetasArray.forEach((colElement, index) => {
            // Obtener el elemento .card que tiene los data-attributes
            const cardElement = colElement.querySelector('.card');

            if (!cardElement) {
                return;
            }

            // Obtener datos de la tarjeta desde el .card
            const nombre = cardElement.getAttribute('data-nombre')?.toLowerCase() || '';
            const categoria = cardElement.getAttribute('data-categoria') || '';
            const rendimiento = cardElement.getAttribute('data-rendimiento') || '';

            // Obtener valores num√©ricos para ordenamiento
            const asistencia = parseFloat(cardElement.getAttribute('data-porcentaje-asistencia')) || 0;
            const objetivos = parseFloat(cardElement.getAttribute('data-porcentaje-objetivos')) || 0;
            const calificacion = parseFloat(cardElement.getAttribute('data-calificacion-general')) || 0;


            // Aplicar filtros
            const coincideBusqueda = !buscarTexto || nombre.includes(buscarTexto);
            const coincideCategoria = !filtroCategoria || categoria === filtroCategoria;

            // Filtrar por rendimiento
            let coincideRendimiento = true;
            if (filtroRendimiento !== 'todos') {
                if (filtroRendimiento === 'Sin datos') {
                    coincideRendimiento = !rendimiento || rendimiento === 'Sin datos';
                } else {
                    coincideRendimiento = rendimiento === filtroRendimiento;
                }
            }

            // Mostrar/ocultar seg√∫n filtros
            if (coincideBusqueda && coincideCategoria && coincideRendimiento) {
                colElement.style.display = 'block';
                tarjetasVisibles++;
            } else {
                colElement.style.display = 'none';
            }
        });

        // Ordenar las tarjetas visibles
        ordenarTarjetasMatriculados(orden, tarjetasArray);

        // Actualizar contador
        actualizarContadorMatriculados(tarjetasVisibles, tarjetas.length);

        // Mostrar mensaje si no hay resultados
        mostrarMensajeSinResultadosMatriculados(tarjetasVisibles);
    }

    function ordenarTarjetasMatriculados(orden, tarjetasArray) {
        // Filtrar solo las tarjetas visibles
        const tarjetasVisibles = tarjetasArray.filter(t => t.style.display !== 'none');

        if (tarjetasVisibles.length === 0) {
            return;
        }

        // Ordenar las tarjetas visibles
        tarjetasVisibles.sort((a, b) => {
            const cardA = a.querySelector('.card');
            const cardB = b.querySelector('.card');

            if (!cardA || !cardB) return 0;

            const nombreA = cardA.getAttribute('data-nombre')?.toLowerCase() || '';
            const nombreB = cardB.getAttribute('data-nombre')?.toLowerCase() || '';
            const calificacionA = parseFloat(cardA.getAttribute('data-calificacion-general')) || 0;
            const calificacionB = parseFloat(cardB.getAttribute('data-calificacion-general')) || 0;
            const asistenciaA = parseFloat(cardA.getAttribute('data-porcentaje-asistencia')) || 0;
            const asistenciaB = parseFloat(cardB.getAttribute('data-porcentaje-asistencia')) || 0;
            const objetivosA = parseFloat(cardA.getAttribute('data-porcentaje-objetivos')) || 0;
            const objetivosB = parseFloat(cardB.getAttribute('data-porcentaje-objetivos')) || 0;

            let resultado = 0;

            switch (orden) {
                case 'nombre_asc':
                    resultado = nombreA.localeCompare(nombreB);
                    break;
                case 'nombre_desc':
                    resultado = nombreB.localeCompare(nombreA);
                    break;
                case 'rendimiento_desc':
                    resultado = calificacionB - calificacionA;
                    break;
                case 'rendimiento_asc':
                    resultado = calificacionA - calificacionB;
                    break;
                case 'asistencia_desc':
                    resultado = asistenciaB - asistenciaA;
                    break;
                case 'objetivos_desc':
                    resultado = objetivosB - objetivosA;
                    break;
            }

            return resultado;
        });

        // Reordenar en el DOM
        const contenedor = document.querySelector('#matriculas-row .row.g-3');
        if (contenedor) {
            // Vaciar contenedor
            tarjetasArray.forEach(colElement => {
                contenedor.removeChild(colElement);
            });

            // Agregar tarjetas ordenadas
            tarjetasArray.forEach(colElement => {
                contenedor.appendChild(colElement);
            });
        }
    }

    function actualizarContadorMatriculados(visibles, total) {
        const contador = document.getElementById('contadorMatriculados');
        if (contador) {
            if (visibles === total) {
                contador.textContent = `Mostrando todos los ${total} alumnos matriculados`;
            } else {
                contador.textContent = `Mostrando ${visibles} de ${total} alumnos matriculados`;
            }
        }
    }

    function mostrarMensajeSinResultadosMatriculados(visibles) {
        let mensajeExistente = document.getElementById('mensajeSinResultadosMatriculados');

        if (visibles === 0) {
            if (!mensajeExistente) {
                mensajeExistente = document.createElement('div');
                mensajeExistente.id = 'mensajeSinResultadosMatriculados';
                mensajeExistente.className = 'col-12 text-center text-muted py-4';
                mensajeExistente.innerHTML = `
                <i class="fas fa-search fa-2x mb-2"></i><br>
                No se encontraron alumnos con los filtros aplicados
            `;

                const contenedor = document.querySelector('#matriculas-row .row.g-3');
                if (contenedor) {
                    contenedor.appendChild(mensajeExistente);
                }
            }
        } else if (mensajeExistente) {
            mensajeExistente.remove();
        }
    }

    function limpiarFiltrosMatriculados() {
        document.getElementById('buscarMatriculados').value = '';
        document.getElementById('filtroCategoriaMatriculados').value = '';
        document.getElementById('filtroRendimiento').value = 'todos';
        // Si tienes ordenamiento:
        if (document.getElementById('ordenarMatriculados')) {
            document.getElementById('ordenarMatriculados').value = 'nombre_asc';
        }

        aplicarFiltrosMatriculados();

        // Mostrar mensaje temporal
        const alerta = document.createElement('div');
        alerta.className = 'alert alert-success alert-dismissible fade show position-fixed';
        alerta.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 250px;';
        alerta.innerHTML = `
        Filtros limpiados correctamente
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

        document.body.appendChild(alerta);

        setTimeout(() => {
            if (alerta.parentNode) {
                alerta.remove();
            }
        }, 3000);
    }

    // Inicializar cuando el DOM est√© listo
    document.addEventListener('DOMContentLoaded', function () {
        inicializarFiltrosMatriculados();
    });

    // ================= FILTROS Y B√öSQUEDA EN TIEMPO REAL =================
    function inicializarFiltrosPostulantes() {
        const buscarInput = document.getElementById('buscarPostulantes');
        const filtroCategoria = document.getElementById('filtroCategoria');
        const ordenarSelect = document.getElementById('ordenarPostulantes');

        // Calcular categor√≠as sugeridas para todos los postulantes
        calcularCategoriasSugeridas();

        // Inicializar botones de limpieza
        inicializarBotonesFiltros();

        // Aplicar filtros iniciales para mostrar contador
        aplicarFiltros();

    }

    // Funci√≥n para calcular la categor√≠a sugerida basada en la edad
    function calcularCategoriaSugerida(fechaNacimiento) {
        const hoy = new Date();
        const nacimiento = new Date(fechaNacimiento);
        let edad = hoy.getFullYear() - nacimiento.getFullYear();

        // Ajustar edad si a√∫n no ha pasado el cumplea√±os este a√±o
        const mes = hoy.getMonth();
        const dia = hoy.getDate();
        if (mes < nacimiento.getMonth() || (mes === nacimiento.getMonth() && dia < nacimiento.getDate())) {
            edad--;
        }

        // Determinar categor√≠a seg√∫n edad (usa las mismas reglas que tu view)
        if (edad >= 4 && edad <= 7) return '4 a 7 a√±os';
        if (edad >= 8 && edad <= 11) return '8 a 11 a√±os';
        if (edad >= 12 && edad <= 15) return '12 a 15 a√±os';
        if (edad >= 16 && edad <= 17) return '16 a 17 a√±os';
        if (edad >= 18 && edad <= 25) return '18 a√±os';

        return 'No aplica';
    }

    // Calcular categor√≠as para todos los postulantes
    function calcularCategoriasSugeridas() {
        document.querySelectorAll('.categoria-sugerida').forEach(element => {
            const fechaNacimiento = element.getAttribute('data-edad');
            if (fechaNacimiento) {
                const categoria = calcularCategoriaSugerida(fechaNacimiento);
                element.textContent = categoria;
                element.setAttribute('data-categoria', categoria);

                // Agregar clase seg√∫n la categor√≠a para estilos
                element.classList.add('badge');
                if (categoria === 'No aplica') {
                    element.classList.add('bg-secondary');
                } else {
                    element.classList.add('bg-primary');
                }
            }
        });
    }

    // Funci√≥n principal para aplicar todos los filtros - CON DIAGN√ìSTICO
    function aplicarFiltros() {
        console.log('üîç Aplicando filtros...');

        const buscarTexto = document.getElementById('buscarPostulantes').value.toLowerCase();
        const filtroCategoria = document.getElementById('filtroCategoria').value;
        const orden = document.getElementById('ordenarPostulantes').value;

        const tarjetas = document.querySelectorAll('#postulantes-row > .col-md-4');
        const totalTarjetas = tarjetas.length;
        let tarjetasVisibles = 0;

        tarjetas.forEach((tarjeta, index) => {
            const nombre = tarjeta.querySelector('.card-title')?.textContent.toLowerCase() || '';
            const infoDivs = tarjeta.querySelectorAll('.alumno-info div');
            const telefono = infoDivs[0]?.textContent.toLowerCase() || '';
            const email = infoDivs[1]?.textContent.toLowerCase() || '';
            const categoriaElement = tarjeta.querySelector('.categoria-sugerida');
            const categoria = categoriaElement ? categoriaElement.getAttribute('data-categoria') : '';

            // Verificar elementos de fecha
            const fechaElement = tarjeta.querySelector('.fecha-postulacion');
            const fechaData = fechaElement ? fechaElement.getAttribute('data-fecha') : 'No fecha';

            // Aplicar filtro de b√∫squeda
            const coincideBusqueda = !buscarTexto ||
                nombre.includes(buscarTexto) ||
                telefono.includes(buscarTexto) ||
                email.includes(buscarTexto);

            // Aplicar filtro de categor√≠a
            const coincideCategoria = !filtroCategoria || categoria === obtenerNombreCategoriaPorId(filtroCategoria);

            // Mostrar/ocultar seg√∫n filtros
            if (coincideBusqueda && coincideCategoria) {
                tarjeta.style.display = 'block';
                tarjetasVisibles++;
            } else {
                tarjeta.style.display = 'none';
            }
        });

        // Ordenar las tarjetas visibles
        ordenarTarjetas(orden);

        // Actualizar contador
        actualizarContadorResultados(tarjetasVisibles, totalTarjetas);

        // Mostrar mensaje si no hay resultados
        mostrarMensajeSinResultados(tarjetasVisibles);
    }

    // Funci√≥n auxiliar para obtener nombre de categor√≠a por ID
    function obtenerNombreCategoriaPorId(idCategoria) {
        const select = document.getElementById('filtroCategoria');
        const option = select.querySelector(`option[value="${idCategoria}"]`);
        return option ? option.textContent : '';
    }

    // Funci√≥n para ordenar tarjetas
    // Funci√≥n para ordenar tarjetas - VERSI√ìN FUNCIONAL
    function ordenarTarjetas(orden) {
        const contenedor = document.getElementById('postulantes-row');
        if (!contenedor) {
            console.log('‚ùå Contenedor postulantes-row no encontrado');
            return;
        }

        // OBTENER TODAS LAS TARJETAS VISIBLES CORRECTAMENTE
        const todasLasTarjetas = Array.from(contenedor.querySelectorAll('.col-md-4'));
        const tarjetasVisibles = todasLasTarjetas.filter(tarjeta => {
            return tarjeta.style.display !== 'none';
        });

        console.log(`üîÑ Ordenando ${tarjetasVisibles.length} tarjetas visibles por: ${orden}`);

        if (tarjetasVisibles.length === 0) {
            console.log('‚ö†Ô∏è No hay tarjetas visibles para ordenar');
            return;
        }

        tarjetasVisibles.sort((a, b) => {
            const nombreA = a.querySelector('.card-title')?.textContent.trim().toLowerCase() || '';
            const nombreB = b.querySelector('.card-title')?.textContent.trim().toLowerCase() || '';

            // Obtener fechas desde el atributo data-fecha
            const fechaElementA = a.querySelector('.fecha-postulacion');
            const fechaElementB = b.querySelector('.fecha-postulacion');

            let fechaA = new Date('2000-01-01');
            let fechaB = new Date('2000-01-01');

            if (fechaElementA) {
                const fechaData = fechaElementA.getAttribute('data-fecha');
                if (fechaData && fechaData !== '' && fechaData !== 'None') {
                    fechaA = new Date(fechaData);
                    console.log(`üìÖ Fecha A: ${fechaData} -> ${fechaA.toISOString()}`);
                }
            }

            if (fechaElementB) {
                const fechaData = fechaElementB.getAttribute('data-fecha');
                if (fechaData && fechaData !== '' && fechaData !== 'None') {
                    fechaB = new Date(fechaData);
                    console.log(`üìÖ Fecha B: ${fechaData} -> ${fechaB.toISOString()}`);
                }
            }

            let resultado = 0;

            switch (orden) {
                case 'recientes':
                    resultado = fechaB - fechaA; // M√°s recientes primero
                    console.log(`‚û°Ô∏è Orden recientes: ${fechaB} - ${fechaA} = ${resultado}`);
                    break;
                case 'antiguos':
                    resultado = fechaA - fechaB; // M√°s antiguos primero
                    console.log(`‚¨ÖÔ∏è Orden antiguos: ${fechaA} - ${fechaB} = ${resultado}`);
                    break;
                case 'nombre_asc':
                    resultado = nombreA.localeCompare(nombreB);
                    console.log(`üî§ Orden nombre A-Z: "${nombreA}" vs "${nombreB}" = ${resultado}`);
                    break;
                case 'nombre_desc':
                    resultado = nombreB.localeCompare(nombreA);
                    console.log(`üî§ Orden nombre Z-A: "${nombreB}" vs "${nombreA}" = ${resultado}`);
                    break;
                default:
                    resultado = 0;
            }

            return resultado;
        });

        // LIMPIAR el contenedor y REINSERTAR las tarjetas ordenadas
        contenedor.innerHTML = '';
        tarjetasVisibles.forEach(tarjeta => {
            contenedor.appendChild(tarjeta);
        });

        console.log('‚úÖ Ordenamiento completado correctamente');
        console.log('üìã Orden final:', tarjetasVisibles.map(t => t.querySelector('.card-title')?.textContent.trim()));
    }

    // Mostrar mensaje cuando no hay resultados
    function mostrarMensajeSinResultados(visibles) {
        let mensajeExistente = document.getElementById('mensajeSinResultados');

        if (visibles === 0) {
            if (!mensajeExistente) {
                mensajeExistente = document.createElement('div');
                mensajeExistente.id = 'mensajeSinResultados';
                mensajeExistente.className = 'col-12 text-center text-muted py-4';
                mensajeExistente.innerHTML = '<i class="fas fa-search fa-2x mb-2"></i><br>No se encontraron postulantes con los filtros aplicados';
                document.getElementById('postulantes-row').appendChild(mensajeExistente);
            }
        } else if (mensajeExistente) {
            mensajeExistente.remove();
        }
    }

    function inicializarBotonesFiltros() {
        console.log('üîß Inicializando botones de filtros...');

        const btnLimpiar = document.getElementById('btnLimpiarFiltros');
        const btnResetear = document.getElementById('btnResetearOrden');

        if (btnLimpiar) {
            btnLimpiar.addEventListener('click', limpiarFiltros);
            console.log('‚úÖ Bot√≥n limpiar inicializado');
        } else {
            console.log('‚ùå Bot√≥n btnLimpiarFiltros no encontrado');
        }

        if (btnResetear) {
            btnResetear.addEventListener('click', resetearOrden);
            console.log('‚úÖ Bot√≥n resetear orden inicializado');
        } else {
            console.log('‚ùå Bot√≥n btnResetearOrden no encontrado');
        }
    }

    // Limpiar todos los filtros
    function limpiarFiltros() {
        document.getElementById('buscarPostulantes').value = '';
        document.getElementById('filtroCategoria').value = '';
        document.getElementById('ordenarPostulantes').value = 'recientes';

        // Aplicar filtros (que mostrar√° todo)
        aplicarFiltros();

        // Mostrar mensaje de √©xito
        mostrarMensajeTemporal('Filtros limpiados', 'success');
    }

    // Resetear al orden original (m√°s recientes primero)
    function resetearOrden() {
        document.getElementById('ordenarPostulantes').value = 'recientes';
        aplicarFiltros();
        mostrarMensajeTemporal('Orden restablecido', 'info');
    }

    // Mostrar contador de resultados
    function actualizarContadorResultados(visibles, total) {
        const contador = document.getElementById('contadorResultados');
        if (contador) {
            if (visibles === total) {
                contador.textContent = `Mostrando todos los ${total} postulantes`;
            } else {
                contador.textContent = `Mostrando ${visibles} de ${total} postulantes`;
            }
        }
    }

    // Mostrar mensaje temporal
    function mostrarMensajeTemporal(mensaje, tipo = 'info') {
        // Crear elemento de mensaje
        const alerta = document.createElement('div');
        alerta.className = `alert alert-${tipo} alert-dismissible fade show position-fixed`;
        alerta.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 250px;';
        alerta.innerHTML = `
        ${mensaje}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

        document.body.appendChild(alerta);

        // Auto-eliminar despu√©s de 3 segundos
        setTimeout(() => {
            if (alerta.parentNode) {
                alerta.remove();
            }
        }, 3000);
    }

    // TERMINAR PER√çODO ACAD√âMICO - JavaScript mejorado
    function inicializarTerminarPeriodo(matriculasData) {
        const categoriaSelect = document.getElementById('categoriaSelect');
        const listaMatriculas = document.getElementById('listaMatriculas');
        const checkAll = document.getElementById('checkAll');
        const btnTerminarPeriodo = document.getElementById('btnTerminarPeriodo');

        if (!categoriaSelect || !listaMatriculas) {
            console.log('‚ùå Elementos del modal de terminar per√≠odo no encontrados');
            return;
        }

        // Cuando cambie la categor√≠a
        categoriaSelect.addEventListener('change', function () {
            const categoriaId = parseInt(this.value);
            console.log('Categor√≠a seleccionada:', categoriaId);

            listaMatriculas.innerHTML = '';

            if (!categoriaId) {
                console.log('No se seleccion√≥ categor√≠a');
                return;
            }

            console.log('Total matr√≠culas disponibles:', matriculasData.length);

            // Filtrar por categor√≠a y estado activo
            const filtradas = matriculasData.filter(function (m) {
                const idCategoriaMatricula = parseInt(m.fk_categoria.idcategoria);
                const coincideCategoria = idCategoriaMatricula === categoriaId;
                const estaActiva = m.estado_matricula === true || m.estado_matricula === 1;

                console.log(`Filtro: Matr√≠cula ${m.idmatricula} - Categor√≠a: ${idCategoriaMatricula}, Coincide: ${coincideCategoria}, Activa: ${estaActiva}`);

                return coincideCategoria && estaActiva;
            });
            console.log('Matr√≠culas filtradas:', filtradas);

            if (filtradas.length === 0) {
                listaMatriculas.innerHTML = '<li class="list-group-item text-muted">No hay alumnos activos para esta categor√≠a.</li>';
                return;
            }

            // Crear checkboxes
            filtradas.forEach(function (m) {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex align-items-center';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'chkAlumno me-2';
                checkbox.value = m.idmatricula;
                checkbox.id = 'mat' + m.idmatricula;

                const label = document.createElement('label');
                label.htmlFor = 'mat' + m.idmatricula;
                label.textContent = m.fk_alumno.fk_persona_alumno.nom1_persona + ' ' + m.fk_alumno.fk_persona_alumno.ape1_persona;
                label.className = 'mb-0';

                li.appendChild(checkbox);
                li.appendChild(label);
                listaMatriculas.appendChild(li);
            });

            console.log('Se agregaron', filtradas.length, 'alumnos a la lista');
        });

        // Seleccionar/Deseleccionar todos
        if (checkAll) {
            checkAll.addEventListener('change', function () {
                const checked = this.checked;
                document.querySelectorAll('.chkAlumno').forEach(function (c) {
                    c.checked = checked;
                });
            });
        }

        // Enviar los seleccionados al servidor - CON MODAL DE CONFIRMACI√ìN
        if (btnTerminarPeriodo) {
            btnTerminarPeriodo.addEventListener('click', function () {
                console.log('üî¥ BOT√ìN TERMINAR PERIODO CLICKEADO');

                const seleccionados = Array.from(document.querySelectorAll('.chkAlumno:checked'))
                    .map(function (c) {
                        return c.value;
                    });

                console.log('Alumnos seleccionados:', seleccionados);

                if (seleccionados.length === 0) {
                    alert('‚ùå No has seleccionado ning√∫n alumno.');
                    return;
                }

                // Mostrar modal de confirmaci√≥n en lugar del confirm() nativo
                const confirmarModal = new bootstrap.Modal(document.getElementById('confirmarTerminarModal'));
                const cantidadAlumnos = document.getElementById('cantidadAlumnos');
                const btnConfirmarTerminar = document.getElementById('btnConfirmarTerminar');

                // Actualizar el texto con la cantidad de alumnos
                cantidadAlumnos.textContent = seleccionados.length;

                // Configurar el evento de confirmaci√≥n
                btnConfirmarTerminar.onclick = function () {
                    console.log('üü° CONFIRMADO - Enviando datos al servidor...');

                    // Cerrar el modal de confirmaci√≥n
                    confirmarModal.hide();

                    // Proceder con el env√≠o de datos
                    procesarTerminarPeriodo(seleccionados);
                };

                // Mostrar el modal de confirmaci√≥n
                confirmarModal.show();
            });
        }
    }

    // Funci√≥n para procesar el t√©rmino del per√≠odo
    function procesarTerminarPeriodo(seleccionados) {
        console.log('üü° Enviando datos al servidor...');

        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const formData = new FormData();
        const btnTerminarPeriodo = document.getElementById('btnTerminarPeriodo');

        seleccionados.forEach(function (id) {
            formData.append('matriculas[]', id);
        });
        formData.append('csrfmiddlewaretoken', csrfToken);

        // Mostrar loading en el bot√≥n principal
        btnTerminarPeriodo.disabled = true;
        btnTerminarPeriodo.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Procesando...';

        fetch("{% url 'terminar_periodo' %}", {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(function (response) {
                console.log('Respuesta del servidor - Status:', response.status);
                if (!response.ok) {
                    throw new Error('Error del servidor: ' + response.status);
                }
                return response.json();
            })
            .then(function (data) {
                console.log('Datos recibidos:', data);

                if (data.error) {
                    throw new Error(data.error);
                }

                // ‚úÖ SIMPLEMENTE RECARGAR LA P√ÅGINA para mostrar los mensajes de Django
                let exitosos = data.resultados.filter(r => r.status === '√©xito').length;

                if (exitosos > 0) {
                    // Recargar la p√°gina para mostrar los mensajes de Django
                    location.reload();
                } else {
                    // Si no hubo √©xitos, mostrar alerta y recargar
                    alert('‚ùå No se pudo procesar ninguna matr√≠cula. Revise los errores.');
                    location.reload();
                }
            })
            .catch(function (error) {
                console.error('Error completo:', error);
                alert('‚ùå Ocurri√≥ un error al terminar el per√≠odo: ' + error.message);

                // Restaurar bot√≥n
                btnTerminarPeriodo.disabled = false;
                btnTerminarPeriodo.innerHTML = 'Terminar Per√≠odo';
            });
    }

    // ================= FUNCIONES AUXILIARES PARA MODAL DE INFORMACI√ìN =================

    // Funci√≥n para formatear valores vac√≠os
    function formatearValor(valor) {
        return valor && valor !== 'undefined' && valor !== 'None' && valor !== '' ? valor : '<span class="text-muted"></span>';
    }

    // Funci√≥n para formatear documentos - MEJORADA PARA ABRIR ARCHIVOS
    function formatearDocumento(url, texto, tipo = 'documento') {
        if (url && url !== 'undefined' && url !== 'None' && url !== '') {
            return `
                <div class="d-flex align-items-center gap-2">
                    <a href="${url}" target="_blank" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-eye me-1"></i>Ver ${texto}
                    </a>
                    <span class="badge bg-success">‚úì Cargado</span>
                </div>`;
        }
        return '<span class="text-muted">No cargado</span>';
    }

    // Funci√≥n para obtener el texto del g√©nero
    function obtenerTextoGenero(codigo) {
        const generos = {
            'M': 'Masculino',
            'F': 'Femenino'
        };
        return generos[codigo] || codigo;
    }

    // Funci√≥n para obtener el texto del tipo de identificaci√≥n
    function obtenerTextoTipoIdentidad(codigo) {
        const tipos = {
            'CC': 'C√©dula de Ciudadan√≠a',
            'TI': 'Tarjeta de Identidad',
            'RC': 'Registro Civil',
            'PAS': 'Pasaporte'
        };
        return tipos[codigo] || codigo;
    }

    // Funci√≥n para obtener el texto del parentesco
    function obtenerTextoParentesco(codigo) {
        const parentescos = {
            'Padre': 'Padre',
            'Madre': 'Madre',
            'Madrastra': 'Madrastra',
            'Padrastro': 'Padrastro',
            'Tio': 'T√≠o',
            'Primo': 'Primo',
            'Hermano': 'Hermano',
            'Abuelo': 'Abuelo',
            'Cuidador': 'Cuidador'
        };
        return parentescos[codigo] || codigo;
    }

    // ================= MODAL DE INFORMACI√ìN COMPLETA DE POSTULANTES =================

    function inicializarModalInfoPostulantes() {
        // Event listeners para postulantes - MODAL COMPLETO
        document.querySelectorAll('.btn-ver-info').forEach(btn => {
            btn.addEventListener('click', function () {
                const data = this.dataset;
                console.log('üîç Datos del postulante:', data);

                const html = `
                <div class="row">
                    <!-- Informaci√≥n Personal -->
                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0">Informaci√≥n Personal</h6>
                            </div>
                            <div class="card-body">
                                <div class="row mb-2">
                                    <div class="col-12">
                                        <strong>Nombre Completo:</strong><br>
                                        ${formatearValor(data.nom)} ${formatearValor(data.nom2)} ${formatearValor(data.ape)} ${formatearValor(data.ape2)}
                                    </div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-md-6">
                                        <strong>Tipo Identificaci√≥n:</strong><br>
                                        ${obtenerTextoTipoIdentidad(formatearValor(data.tipoIdentidad))}
                                    </div>
                                    <div class="col-md-6">
                                        <strong>N√∫mero Identificaci√≥n:</strong><br>
                                        ${formatearValor(data.idPersona)}
                                    </div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-md-6">
                                        <strong>Fecha Nacimiento:</strong><br>
                                        ${formatearValor(data.fecha)}
                                    </div>
                                    <div class="col-md-6">
                                        <strong>G√©nero:</strong><br>
                                        ${obtenerTextoGenero(formatearValor(data.genero))}
                                    </div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-md-6">
                                        <strong>EPS:</strong><br>
                                        ${formatearValor(data.eps)}
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Tipo de Sangre:</strong><br>
                                        ${formatearValor(data.rh)}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Informaci√≥n de Contacto -->
                        <div class="card mb-3">
                            <div class="card-header bg-warning text-dark">
                                <h6 class="mb-0">Informaci√≥n de Contacto</h6>
                            </div>
                            <div class="card-body">
                                <div class="row mb-2">
                                    <div class="col-12">
                                        <strong>Direcci√≥n:</strong><br>
                                        ${formatearValor(data.direc)}
                                    </div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-md-6">
                                        <strong>Tel√©fono:</strong><br>
                                        ${formatearValor(data.tel)}
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Email:</strong><br>
                                        ${formatearValor(data.email)}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Informaci√≥n Deportiva y Acudiente -->
                    <div class="col-md-6">
                        <!-- Informaci√≥n Deportiva -->
                        <div class="card mb-3">
                            <div class="card-header bg-warning text-dark">
                                <h6 class="mb-0">Informaci√≥n Deportiva</h6>
                            </div>
                            <div class="card-body">
                                <div class="row mb-2">
                                    <div class="col-12">
                                        <strong>Posici√≥n:</strong><br>
                                        ${formatearValor(data.posicion)}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Medidas F√≠sicas -->
                        <div class="card mb-3">
                            <div class="card-header bg-warning text-dark">
                                <h6 class="mb-0">Medidas F√≠sicas</h6>
                            </div>
                            <div class="card-body">
                                <div class="row mb-2">
                                    <div class="col-md-4">
                                        <strong>Altura:</strong><br>
                                        ${formatearValor(data.altura)} m
                                    </div>
                                    <div class="col-md-4">
                                        <strong>Peso:</strong><br>
                                        ${formatearValor(data.peso)} kg
                                    </div>
                                    <div class="col-md-4">
                                        <strong>IMC:</strong><br>
                                        ${formatearValor(data.imc)}
                                    </div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-md-4">
                                        <strong>Talla Ropa:</strong><br>
                                        ${formatearValor(data.talla)}
                                    </div>
                                    <div class="col-md-4">
                                        <strong>Calzado:</strong><br>
                                        ${formatearValor(data.calzado)}
                                    </div>
                                    <div class="col-md-4">
                                        <strong>Pie Dominante:</strong><br>
                                        ${formatearValor(data.pieDominante)}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Informaci√≥n del Acudiente -->
                        <div class="card mb-3">
                            <div class="card-header bg-warning text-dark">
                                <h6 class="mb-0"><i class="fas fa-users me-2"></i>Informaci√≥n del Acudiente</h6>
                            </div>
                            <div class="card-body">
                                <div class="row mb-2">
                                    <div class="col-12">
                                        <strong>Nombre Completo:</strong><br>
                                        ${formatearValor(data.nom1Acudiente)} ${formatearValor(data.nom2Acudiente)} ${formatearValor(data.ape1Acudiente)} ${formatearValor(data.ape2Acudiente)}
                                    </div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-md-6">
                                        <strong>ID Acudiente:</strong><br>
                                        ${formatearValor(data.idAcudiente)}
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Parentesco:</strong><br>
                                        ${obtenerTextoParentesco(formatearValor(data.parentesco))}
                                    </div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-md-6">
                                        <strong>Tel√©fono:</strong><br>
                                        ${formatearValor(data.telAcudiente)}
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Email:</strong><br>
                                        ${formatearValor(data.emailAcudiente)}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Documentos -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-warning text-dark">
                                <h6 class="mb-0"><i class="fas fa-file me-2"></i>Documentos</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4 mb-2">
                                        <strong>Tratamiento de Datos:</strong><br>
                                        ${formatearDocumento(data.tradatos, 'Tratamiento')}
                                    </div>
                                    <div class="col-md-4 mb-2">
                                        <strong>Foto:</strong><br>
                                        ${formatearDocumento(data.foto, 'Foto', 'imagen')}
                                    </div>
                                    <div class="col-md-4 mb-2">
                                        <strong>Autorizaci√≥n M√©dica:</strong><br>
                                        ${formatearDocumento(data.automedica, 'Autorizaci√≥n')}
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-4 mb-2">
                                        <strong>Comprobante EPS:</strong><br>
                                        ${formatearDocumento(data.certeps, 'Comprobante EPS')}
                                    </div>
                                    <div class="col-md-4 mb-2">
                                        <strong>Certificado Otra Escuela:</strong><br>
                                        ${formatearDocumento(data.otraescuela, 'otra Escuela')}
                                    </div>
                                    <div class="col-md-4 mb-2">
                                        <strong>Documento identidad:</strong><br>
                                        ${formatearDocumento(data.documento_identidad, 'Documento Identidad')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                `;

                document.getElementById('modalInfoBody').innerHTML = html;
                const modal = new bootstrap.Modal(document.getElementById('modalInfo'));
                modal.show();
                console.log('‚úÖ Modal de informaci√≥n abierto');
            });
        });
    }

    // ================= MODALES DE POSTULANTES (ACEPTAR/RECHAZAR) =================
    function inicializarModalesPostulantes() {
        // Modal Rechazar Postulante con mensaje
        inicializarModalRechazo();

        // Ya no necesitamos el modal de aceptar porque ahora es autom√°tico
        console.log('‚úÖ Modal de rechazo con mensaje inicializado');
    }

    // ================= MODAL RECHAZO CON MENSAJE =================
    function inicializarModalRechazo() {
        const modalRechazarEl = document.getElementById('modalRechazar');
        if (!modalRechazarEl) {
            console.log('‚ùå Modal de rechazo no encontrado');
            return;
        }

        const modalRechazar = new bootstrap.Modal(modalRechazarEl);
        const textoRechazar = document.getElementById('texto-rechazar');
        const rechazarId = document.getElementById('rechazar_id_persona');
        const mensajeTextarea = document.getElementById('mensajeRechazo');
        const contadorCaracteres = document.getElementById('contadorCaracteres');

        // Contador de caracteres para el mensaje
        if (mensajeTextarea && contadorCaracteres) {
            mensajeTextarea.addEventListener('input', function () {
                const longitud = this.value.length;
                contadorCaracteres.textContent = `${longitud}/500`;

                if (longitud > 450) {
                    contadorCaracteres.className = 'badge bg-warning';
                } else if (longitud > 490) {
                    contadorCaracteres.className = 'badge bg-danger';
                } else {
                    contadorCaracteres.className = 'badge bg-secondary';
                }
            });
        }

        // Event listeners para botones de rechazar
        document.querySelectorAll('.btn-open-rechazar').forEach(btn => {
            btn.addEventListener('click', function () {
                const nombre = this.dataset.nom;
                const id = this.dataset.id;

                textoRechazar.textContent = `¬øEst√°s seguro de rechazar a ${nombre}?`;
                rechazarId.value = id;

                // Limpiar mensaje anterior
                if (mensajeTextarea) {
                    mensajeTextarea.value = '';
                    contadorCaracteres.textContent = '0/500';
                    contadorCaracteres.className = 'badge bg-secondary';
                }

                modalRechazar.show();
            });
        });

        // Prevenir env√≠o si el mensaje es muy largo
        document.getElementById('form-rechazar')?.addEventListener('submit', function (e) {
            const mensaje = mensajeTextarea?.value || '';
            if (mensaje.length > 500) {
                e.preventDefault();
                alert('El mensaje de rechazo no puede tener m√°s de 500 caracteres.');
                mensajeTextarea.focus();
            }
        });
    }

    // ================= FUNCI√ìN PARA VER DOCUMENTOS =================
    // Funci√≥n para ver documentos (compatible con el modal de edici√≥n)
    // Funci√≥n para ver documentos (compatible con el modal de edici√≥n)
    function verDocumento(tipo) {
        let ruta = '';
        let nombreDocumento = '';

        // Obtener la ruta del documento seg√∫n el tipo
        switch (tipo) {
            case 'tradatos':
                ruta = document.getElementById('edit_tradatos_existente')?.value || '';
                nombreDocumento = 'Tratamiento de Datos';
                break;
            case 'foto':
                ruta = document.getElementById('edit_foto_existente')?.value || '';
                nombreDocumento = 'Foto';
                break;
            case 'documento_identidad':
                ruta = document.getElementById('edit_documento_identidad_existente')?.value || '';
                nombreDocumento = 'Documento de Identidad';
                break;
            case 'automedica':
                ruta = document.getElementById('edit_automedica_existente')?.value || '';
                nombreDocumento = 'Autorizaci√≥n M√©dica';
                break;
            case 'certeps':
                ruta = document.getElementById('edit_certeps_existente')?.value || '';
                nombreDocumento = 'Comprobante EPS';
                break;
            case 'otraescuela':
                ruta = document.getElementById('edit_otraescuela_existente')?.value || '';
                nombreDocumento = 'Certificado Otra Escuela';
                break;
        }

        console.log(`üîç Intentando abrir ${nombreDocumento}:`, ruta); // Para debugging

        if (ruta && ruta !== 'undefined' && ruta !== 'None' && ruta !== '' && ruta !== 'undefined url') {
            // Verificar si la ruta ya es una URL completa
            if (ruta.startsWith('http') || ruta.startsWith('//')) {
                window.open(ruta, '_blank');
                console.log(`‚úÖ Abriendo ${nombreDocumento} desde URL completa: ${ruta}`);
            } else if (ruta.startsWith('/')) {
                // Es una ruta absoluta del servidor
                window.open(ruta, '_blank');
                console.log(`‚úÖ Abriendo ${nombreDocumento} desde ruta absoluta: ${ruta}`);
            } else {
                // Es una ruta relativa, construir la URL completa
                const urlCompleta = `/media/${ruta}`;
                window.open(urlCompleta, '_blank');
                console.log(`‚úÖ Abriendo ${nombreDocumento} desde ruta relativa: ${urlCompleta}`);
            }
        } else {
            console.log(`‚ùå No hay ${nombreDocumento} disponible:`, ruta);
            alert(`No hay ${nombreDocumento} disponible para visualizar`);
        }
    }

    // ================= FUNCI√ìN PARA INICIALIZAR EVENT LISTENERS =================
    // Funci√≥n para inicializar los event listeners con los datos
    function inicializarEventListeners(matriculasData) {
        console.log('üéØ Inicializando event listeners con', matriculasData.length, 'matr√≠culas');

        // Inicializar funcionalidad de terminar per√≠odo
        inicializarTerminarPeriodo(matriculasData);

        // Inicializar modales de postulantes
        inicializarModalInfoPostulantes();
        inicializarModalesPostulantes();

        // Inicializar otras funcionalidades
        inicializarOtrasFuncionalidades();
    }

    // ================= OTRAS FUNCIONALIDADES =================
    function inicializarOtrasFuncionalidades() {
        console.log('üîß Inicializando otras funcionalidades...');

        // C√°lculo autom√°tico de IMC para el modal de edici√≥n
        const editAltura = document.getElementById('edit_altura');
        const editPeso = document.getElementById('edit_peso');

        if (editAltura && editPeso) {
            editAltura.addEventListener('input', calcularIMCEdicion);
            editPeso.addEventListener('input', calcularIMCEdicion);
        }

        // Abrir modal EDITAR y poblar inputs
        const modalEdit = document.getElementById('editAlumnoModal');
        if (modalEdit) {
            const modal = new bootstrap.Modal(modalEdit);

            // Configurar validaciones cuando se abra el modal
            modalEdit.addEventListener('shown.bs.modal', function () {
                console.log('üîß Modal de edici√≥n abierto, configurando validaciones...');
                configurarValidacionesEdicion();
            });

            // En la funci√≥n que se ejecuta al hacer clic en el bot√≥n "Editar":
            document.querySelectorAll('.editAlumnoBtn').forEach(btn => {
                btn.addEventListener('click', function () {
                    console.log('üî¥ BOT√ìN EDITAR CLICKEADO - Datos disponibles:');

                    // Funci√≥n segura para obtener datos
                    function getData(key) {
                        const value = this.dataset[key];
                        return (value && value !== 'undefined' && value !== 'None' && value !== '') ? value : '';
                    }

                    // ========== DATOS B√ÅSICOS DE PERSONA ==========
                    const personaId = getData.call(this, 'id');
                    document.getElementById('edit_persona_id').value = personaId;

                    // Campos NO EDITABLES (solo visualizaci√≥n)
                    const nom1 = getData.call(this, 'nom1');
                    const nom2 = getData.call(this, 'nom2');
                    const ape1 = getData.call(this, 'ape1');
                    const ape2 = getData.call(this, 'ape2');
                    const genero = getData.call(this, 'genero');

                    // Mostrar en campos de solo lectura
                    document.getElementById('edit_nom1').value = nom1 || '';
                    document.getElementById('edit_nom2').value = nom2 || '';
                    document.getElementById('edit_ape1').value = ape1 || '';
                    document.getElementById('edit_ape2').value = ape2 || '';

                    // Convertir c√≥digo de g√©nero a texto
                    let generoTexto = '';
                    switch (genero) {
                        case 'M': generoTexto = 'Masculino'; break;
                        case 'F': generoTexto = 'Femenino'; break;
                        default: generoTexto = genero || '';
                    }
                    document.getElementById('edit_genero_display').value = generoTexto;
                    document.getElementById('edit_genero').value = genero || '';

                    // Guardar en hidden fields para enviar al servidor
                    document.getElementById('edit_nom1_hidden').value = nom1;
                    document.getElementById('edit_nom2_hidden').value = nom2;
                    document.getElementById('edit_ape1_hidden').value = ape1;
                    document.getElementById('edit_ape2_hidden').value = ape2;

                    // Campos EDITABLES
                    document.getElementById('edit_direc').value = getData.call(this, 'direc');
                    document.getElementById('edit_tel').value = getData.call(this, 'tel');
                    document.getElementById('edit_email').value = getData.call(this, 'email');
                    document.getElementById('edit_eps').value = getData.call(this, 'eps');

                    // ========== CAMPOS NO EDITABLES (solo visualizaci√≥n) ==========
                    const tipoIdentidad = getData.call(this, 'tipoidentidad');
                    const numIdentidad = getData.call(this, 'numidentidad');
                    const fechaNacimiento = getData.call(this, 'fecha');
                    const rh = getData.call(this, 'rh');

                    // Mostrar en campos de solo lectura
                    document.getElementById('edit_tipo_identidad_display').value = tipoIdentidad || '';
                    document.getElementById('edit_num_identidad_display').value = numIdentidad || '';
                    document.getElementById('edit_fecha_display').value = fechaNacimiento || '';
                    document.getElementById('edit_rh_display').value = rh || '';

                    // Guardar en hidden fields
                    document.getElementById('edit_tipo_identidad').value = tipoIdentidad;
                    document.getElementById('edit_num_identidad').value = numIdentidad;
                    document.getElementById('edit_fecha').value = fechaNacimiento;
                    document.getElementById('edit_rh').value = rh;

                    // ========== MEDIDAS F√çSICAS ==========
                    // Convertir valores num√©ricos reemplazando comas por puntos
                    const altura = getData.call(this, 'altura');
                    const peso = getData.call(this, 'peso');
                    const imc = getData.call(this, 'imc');
                    const calzado = getData.call(this, 'calzado');

                    document.getElementById('edit_altura').value = altura ? altura.replace(',', '.') : '';
                    document.getElementById('edit_peso').value = peso ? peso.replace(',', '.') : '';
                    document.getElementById('edit_imc').value = imc ? imc.replace(',', '.') : '';
                    document.getElementById('edit_calzado').value = calzado || '';
                    document.getElementById('edit_talla').value = getData.call(this, 'talla');
                    document.getElementById('edit_pie').value = getData.call(this, 'pie');

                    // ========== ACUDIENTE ==========
                    const idAcudiente = getData.call(this, 'idacudiente');
                    document.getElementById('edit_idacudiente').value = idAcudiente;
                    document.getElementById('edit_idacudiente_actual').value = idAcudiente;

                    document.getElementById('edit_nom1_acudiente').value = getData.call(this, 'nom1acudiente');
                    document.getElementById('edit_nom2_acudiente').value = getData.call(this, 'nom2acudiente');
                    document.getElementById('edit_ape1_acudiente').value = getData.call(this, 'ape1acudiente');
                    document.getElementById('edit_ape2_acudiente').value = getData.call(this, 'ape2acudiente');
                    document.getElementById('edit_telacud').value = getData.call(this, 'telacudiente');
                    document.getElementById('edit_emailacud').value = getData.call(this, 'emailacudiente');
                    document.getElementById('edit_parentesco').value = getData.call(this, 'parentesco');

                    // ========== INFORMACI√ìN DEPORTIVA ==========
                    document.getElementById('edit_categoria').value = getData.call(this, 'categoria');
                    document.getElementById('edit_posicion').value = getData.call(this, 'posicion');
                    document.getElementById('edit_matricula_id').value = getData.call(this, 'matricula');

                    // ========== DOCUMENTOS EXISTENTES ==========
                    const tradatosRuta = getData.call(this, 'tradatos');
                    const fotoRuta = getData.call(this, 'foto');
                    const automedicaRuta = getData.call(this, 'automedica');
                    const certepsRuta = getData.call(this, 'certeps');
                    const otraEscuelaRuta = getData.call(this, 'otraescuela');
                    const documentoIdentidadRuta = getData.call(this, 'documento_identidad');

                    // Mostrar estado de documentos existentes
                    document.getElementById('edit_tradatos_display').value = tradatosRuta ? 'Documento cargado' : 'No cargado';
                    document.getElementById('edit_foto_display').value = fotoRuta ? 'Foto cargada' : 'No cargada';
                    document.getElementById('edit_automedica_display').value = automedicaRuta ? 'Documento cargado' : 'No cargado';
                    document.getElementById('edit_certeps_display').value = certepsRuta ? 'Documento cargado' : 'No cargado';
                    document.getElementById('edit_otraescuela_display').value = otraEscuelaRuta ? 'Documento cargado' : 'No aplica';
                    document.getElementById('edit_documento_identidad_display').value = documentoIdentidadRuta ? 'Documento cargado' : 'No cargado';

                    // Guardar rutas existentes en hidden fields
                    document.getElementById('edit_tradatos_existente').value = tradatosRuta || '';
                    document.getElementById('edit_foto_existente').value = fotoRuta || '';
                    document.getElementById('edit_automedica_existente').value = automedicaRuta || '';
                    document.getElementById('edit_certeps_existente').value = certepsRuta || '';
                    document.getElementById('edit_otraescuela_existente').value = otraEscuelaRuta || '';
                    document.getElementById('edit_documento_identidad_existente').value = documentoIdentidadRuta || '';

                    // Habilitar/deshabilitar botones de ver seg√∫n si hay documento
                    document.getElementById('btn_ver_tradatos').disabled = !tradatosRuta;
                    document.getElementById('btn_ver_foto').disabled = !fotoRuta;
                    document.getElementById('btn_ver_automedica').disabled = !automedicaRuta;
                    document.getElementById('btn_ver_certeps').disabled = !certepsRuta;
                    document.getElementById('btn_ver_otraescuela').disabled = !otraEscuelaRuta;
                    document.getElementById('btn_ver_documento_identidad').disabled = !documentoIdentidadRuta;

                    // Calcular IMC inicial si hay datos
                    calcularIMCEdicion();

                    console.log('‚úÖ Datos cargados en modal de edici√≥n para persona ID:', personaId);
                    modal.show();
                });
            });

        }

        // Prevenir env√≠o del formulario de edici√≥n si hay errores
        document.getElementById('editAlumnoForm')?.addEventListener('submit', function (e) {
            const errores = this.querySelectorAll('.is-invalid');
            if (errores.length > 0) {
                e.preventDefault();
                alert('Por favor corrige los errores antes de guardar los cambios.');

                // Desplazarse al primer error
                const primerError = this.querySelector('.is-invalid');
                if (primerError) {
                    primerError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    primerError.focus();
                }
            }
        });
    }

    // ================= VALIDACIONES PARA MODAL DE EDICI√ìN =================
    function configurarValidacionesEdicion() {
        console.log('üîß Configurando validaciones para modal de edici√≥n...');

        // Excluir campos de solo lectura de la validaci√≥n
        const campos = {
            'edit_tel': validarTelefono,
            'edit_telacud': validarTelefono,
            'edit_email': validarEmail,
            'edit_emailacud': validarEmailOpcional,
            'edit_direc': validarDireccion,
            'edit_nom1_acudiente': validarNombre,
            'edit_nom2_acudiente': validarNombreOpcional,
            'edit_ape1_acudiente': validarApellido,
            'edit_ape2_acudiente': validarApellidoOpcional,
            'edit_altura': validarAltura,
            'edit_peso': validarPeso,
            'edit_calzado': validarCalzado,
            'edit_idacudiente': validarIdentificacion
        };

        // Aplicar validaciones espec√≠ficas solo a campos editables
        Object.keys(campos).forEach(campoId => {
            const campo = document.getElementById(campoId);
            if (campo && !campo.readOnly) { // Solo validar si no es de solo lectura
                campo.addEventListener('blur', function () {
                    validarCampoEdicion(this, campos[campoId]);
                });
                campo.addEventListener('input', function () {
                    limpiarValidacionEdicion(this);
                    // Validar longitud en tiempo real mientras escribe
                    if (this.value.trim()) {
                        validarLongitudEdicion(this);
                    }
                });
            }
        });

        // Validaci√≥n para campos requeridos simples (excluir campos de solo lectura)
        const camposRequeridos = document.querySelectorAll('#editAlumnoForm input[required]:not([readonly]), #editAlumnoForm select[required]');
        camposRequeridos.forEach(campo => {
            if (!Object.keys(campos).includes(campo.id) && !campo.readOnly) {
                campo.addEventListener('blur', function () {
                    validarCampoRequeridoEdicion(this);
                });
                campo.addEventListener('input', function () {
                    limpiarValidacionEdicion(this);
                });
            }
        });

        // Validar archivos
        const archivos = ['edit_automedica', 'edit_certeps'];
        archivos.forEach(archivoId => {
            const archivo = document.getElementById(archivoId);
            if (archivo) {
                archivo.addEventListener('change', function () {
                    validarArchivoEdicion(this);
                });
            }
        });

        // Configurar campos num√©ricos para reemplazar comas por puntos
        const camposNumericos = ['edit_altura', 'edit_peso'];
        camposNumericos.forEach(campoId => {
            const campo = document.getElementById(campoId);
            if (campo) {
                campo.addEventListener('input', function () {
                    // Reemplazar comas por puntos
                    this.value = this.value.replace(',', '.');
                });
            }
        });

        // Configurar c√°lculo autom√°tico de IMC
        const editAltura = document.getElementById('edit_altura');
        const editPeso = document.getElementById('edit_peso');
        if (editAltura && editPeso) {
            editAltura.addEventListener('input', calcularIMCEdicion);
            editPeso.addEventListener('input', calcularIMCEdicion);
        }
    }

    // Funciones de validaci√≥n espec√≠ficas para edici√≥n
    function validarCampoEdicion(campo, funcionValidacion) {
        const valor = campo.value.trim();
        limpiarValidacionEdicion(campo);

        if (valor && !funcionValidacion(valor, campo)) {
            mostrarErrorEdicion(campo, obtenerMensajeErrorEdicion(campo.id));
        } else if (campo.checkValidity() && valor) {
            mostrarExitoEdicion(campo);
        }
    }

    function validarCampoRequeridoEdicion(campo) {
        const valor = campo.value.trim();
        limpiarValidacionEdicion(campo);

        if (!valor) {
            mostrarErrorEdicion(campo, 'Este campo es requerido');
        } else {
            mostrarExitoEdicion(campo);
        }
    }

    function validarLongitudEdicion(campo) {
        // No validar campos de solo lectura
        if (campo.readOnly) return true;

        const valor = campo.value.trim();
        const limites = {
            'edit_direc': 40,
            'edit_email': 40,
            'edit_emailacud': 40,
            'edit_nom1_acudiente': 20,
            'edit_nom2_acudiente': 20,
            'edit_ape1_acudiente': 20,
            'edit_ape2_acudiente': 20
        };

        if (limites[campo.id] && valor.length > limites[campo.id]) {
            mostrarErrorEdicion(campo, `M√°ximo ${limites[campo.id]} caracteres`);
            return false;
        }
        return true;
    }

    // VALIDACIONES ESPEC√çFICAS
    function validarTelefono(valor) {
        return /^\d{10}$/.test(valor); // Exactamente 10 d√≠gitos
    }

    function validarEmail(valor, campo) {
        if (valor.length > 40) {
            mostrarErrorEdicion(campo, 'M√°ximo 40 caracteres');
            return false;
        }
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(valor);
    }

    function validarEmailOpcional(valor, campo) {
        if (!valor) return true;
        if (valor.length > 40) {
            mostrarErrorEdicion(campo, 'M√°ximo 40 caracteres');
            return false;
        }
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(valor);
    }

    function validarNombre(valor, campo) {
        if (valor.length > 20) {
            mostrarErrorEdicion(campo, 'M√°ximo 20 caracteres');
            return false;
        }
        return /^[A-Za-z√Å√â√ç√ì√ö√°√©√≠√≥√∫√ë√±\s]+$/.test(valor);
    }

    function validarNombreOpcional(valor, campo) {
        if (valor && valor.length > 20) {
            mostrarErrorEdicion(campo, 'M√°ximo 20 caracteres');
            return false;
        }
        return !valor || /^[A-Za-z√Å√â√ç√ì√ö√°√©√≠√≥√∫√ë√±\s]+$/.test(valor);
    }

    function validarApellido(valor, campo) {
        if (valor.length > 20) {
            mostrarErrorEdicion(campo, 'M√°ximo 20 caracteres');
            return false;
        }
        return /^[A-Za-z√Å√â√ç√ì√ö√°√©√≠√≥√∫√ë√±\s]+$/.test(valor);
    }

    function validarApellidoOpcional(valor, campo) {
        if (valor && valor.length > 20) {
            mostrarErrorEdicion(campo, 'M√°ximo 20 caracteres');
            return false;
        }
        return !valor || /^[A-Za-z√Å√â√ç√ì√ö√°√©√≠√≥√∫√ë√±\s]+$/.test(valor);
    }

    function validarDireccion(valor, campo) {
        if (valor.length > 40) {
            mostrarErrorEdicion(campo, 'M√°ximo 40 caracteres');
            return false;
        }
        return true;
    }

    function validarAltura(valor, campo) {
        const valorNormalizado = valor.replace(',', '.');
        const altura = parseFloat(valorNormalizado);
        return !isNaN(altura) && altura >= 0.5 && altura <= 2.5;
    }

    function validarPeso(valor, campo) {
        const valorNormalizado = valor.replace(',', '.');
        const peso = parseFloat(valorNormalizado);
        return !isNaN(peso) && peso >= 10 && peso <= 150;
    }

    function validarCalzado(valor, campo) {
        const calzado = parseInt(valor);
        return !isNaN(calzado) && calzado >= 15 && calzado <= 50;
    }

    function validarIdentificacion(valor) {
        return /^\d+$/.test(valor) && valor.length >= 6 && valor.length <= 10;
    }

    function validarArchivoEdicion(archivo) {
        const nombreArchivo = archivo.value;
        const extensionesPermitidas = {
            'edit_automedica': ['.pdf', '.doc', '.docx'],
            'edit_certeps': ['.pdf', '.doc', '.docx']
        };

        if (nombreArchivo) {
            const extension = nombreArchivo.toLowerCase().substring(nombreArchivo.lastIndexOf('.'));
            const extensiones = extensionesPermitidas[archivo.id];

            if (extensiones && !extensiones.includes(extension)) {
                mostrarErrorEdicion(archivo, `Formatos permitidos: ${extensiones.join(', ')}`);
                return false;
            } else {
                mostrarExitoEdicion(archivo);
                return true;
            }
        }

        // En edici√≥n, los archivos no son obligatorios
        return true;
    }

    function obtenerMensajeErrorEdicion(campoId) {
        const mensajes = {
            'edit_tel': 'Exactamente 10 d√≠gitos',
            'edit_telacud': 'Exactamente 10 d√≠gitos',
            'edit_email': 'Email inv√°lido o m√°ximo 40 caracteres',
            'edit_emailacud': 'Email inv√°lido o m√°ximo 40 caracteres',
            'edit_nom1': 'Solo letras, m√°ximo 20 caracteres',
            'edit_nom2': 'Solo letras, m√°ximo 20 caracteres',
            'edit_ape1': 'Solo letras, m√°ximo 20 caracteres',
            'edit_ape2': 'Solo letras, m√°ximo 20 caracteres',
            'edit_nom1_acudiente': 'Solo letras, m√°ximo 20 caracteres',
            'edit_nom2_acudiente': 'Solo letras, m√°ximo 20 caracteres',
            'edit_ape1_acudiente': 'Solo letras, m√°ximo 20 caracteres',
            'edit_ape2_acudiente': 'Solo letras, m√°ximo 20 caracteres',
            'edit_direc': 'M√°ximo 40 caracteres',
            'edit_altura': 'La altura debe estar entre 0.5 y 2.5 metros',
            'edit_peso': 'El peso debe estar entre 10 y 150 kg',
            'edit_calzado': 'La talla de calzado debe estar entre 15 y 50',
            'edit_idacudiente': 'Solo n√∫meros, entre 6 y 10 d√≠gitos'
        };
        return mensajes[campoId] || 'Valor inv√°lido';
    }

    function mostrarErrorEdicion(campo, mensaje) {
        campo.classList.add('is-invalid');
        campo.classList.remove('is-valid');

        // Buscar mensaje de error existente
        let feedback = campo.nextElementSibling;
        while (feedback && !feedback.classList.contains('invalid-feedback')) {
            feedback = feedback.nextElementSibling;
        }

        if (!feedback || !feedback.classList.contains('invalid-feedback')) {
            feedback = document.createElement('div');
            feedback.className = 'invalid-feedback';
            campo.parentNode.appendChild(feedback);
        }
        feedback.textContent = mensaje;
        feedback.style.display = 'block';
    }

    function mostrarExitoEdicion(campo) {
        campo.classList.add('is-valid');
        campo.classList.remove('is-invalid');

        // Ocultar mensaje de error si existe
        let feedback = campo.nextElementSibling;
        while (feedback && !feedback.classList.contains('invalid-feedback')) {
            feedback = feedback.nextElementSibling;
        }

        if (feedback && feedback.classList.contains('invalid-feedback')) {
            feedback.style.display = 'none';
        }
    }

    function limpiarValidacionEdicion(campo) {
        campo.classList.remove('is-invalid', 'is-valid');
    }

    function calcularIMCEdicion() {
        let altura = document.getElementById('edit_altura').value;
        let peso = document.getElementById('edit_peso').value;
        const imcInput = document.getElementById('edit_imc');

        // Normalizar valores
        altura = altura.replace(',', '.');
        peso = peso.replace(',', '.');

        const alturaNum = parseFloat(altura) || 0;
        const pesoNum = parseFloat(peso) || 0;

        if (alturaNum > 0 && pesoNum > 0) {
            const imc = pesoNum / (alturaNum * alturaNum);
            imcInput.value = imc.toFixed(2);

            // Validar visualmente el IMC con colores
            if (imc < 18.5) {
                imcInput.style.borderColor = '#ffc107';
                imcInput.style.backgroundColor = '#fffbf0';
            } else if (imc >= 18.5 && imc <= 24.9) {
                imcInput.style.borderColor = '#28a745';
                imcInput.style.backgroundColor = '#f8fff9';
            } else if (imc >= 25 && imc <= 29.9) {
                imcInput.style.borderColor = '#fd7e14';
                imcInput.style.backgroundColor = '#fff4e6';
            } else {
                imcInput.style.borderColor = '#dc3545';
                imcInput.style.backgroundColor = '#fff5f5';
            }
        } else {
            imcInput.value = '';
            imcInput.style.borderColor = '';
            imcInput.style.backgroundColor = '#f8f9fa';
        }
    }

    // DEBUG TEMPORAL - Verificar que las URLs sean correctas
    document.addEventListener('DOMContentLoaded', function () {
        console.log('üîó URL terminar_periodo:', "{% url 'terminar_periodo' %}");
        console.log('üîó URL get_matriculas_json:', "{% url 'get_matriculas_json' %}");

        // Inicializar matr√≠culas cuando el DOM est√© listo
        console.log('DOM cargado, inicializando matr√≠culas...');
        inicializarMatriculas();
    });

    document.addEventListener('DOMContentLoaded', function () {
        console.log('üîç DIAGN√ìSTICO DE ELEMENTOS:');
        console.log('buscarPostulantes:', document.getElementById('buscarPostulantes'));
        console.log('filtroCategoria:', document.getElementById('filtroCategoria'));
        console.log('ordenarPostulantes:', document.getElementById('ordenarPostulantes'));
        console.log('btnLimpiarFiltros:', document.getElementById('btnLimpiarFiltros'));
        console.log('btnResetearOrden:', document.getElementById('btnResetearOrden'));
        console.log('postulantes-row:', document.getElementById('postulantes-row'));
    });

    setTimeout(() => {
        console.log('üîç VERIFICANDO FECHAS EN TARJETAS:');
        document.querySelectorAll('.fecha-postulacion').forEach((element, index) => {
            const fechaData = element.getAttribute('data-fecha');
            const textoFecha = element.textContent;
            console.log(`Tarjeta ${index}: data-fecha="${fechaData}", texto="${textoFecha}"`);
        });
    }, 1000);


    function diagnosticarProblemas() {
        console.log('üîç DIAGN√ìSTICO COMPLETO DE FILTROS:');

        // 1. Verificar data attributes
        const primeraTarjeta = document.querySelector('#matriculas-row .col-md-4');
        if (primeraTarjeta) {
            console.log('üìä DATA ATTRIBUTES DE PRIMERA TARJETA:');
            console.log('- data-nombre:', primeraTarjeta.getAttribute('data-nombre'));
            console.log('- data-categoria:', primeraTarjeta.getAttribute('data-categoria'));
            console.log('- data-rendimiento:', primeraTarjeta.getAttribute('data-rendimiento'));
            console.log('- data-porcentaje-asistencia:', primeraTarjeta.getAttribute('data-porcentaje-asistencia'));
            console.log('- data-porcentaje-objetivos:', primeraTarjeta.getAttribute('data-porcentaje-objetivos'));
            console.log('- data-calificacion-general:', primeraTarjeta.getAttribute('data-calificacion-general'));
        } else {
            console.log('‚ùå No se encontraron tarjetas en #matriculas-row');
        }


        // 3. Verificar elementos de filtro
        console.log('üéØ ELEMENTOS DE FILTRO:');
        console.log('- buscarMatriculados:', document.getElementById('buscarMatriculados'));
        console.log('- filtroCategoriaMatriculados:', document.getElementById('filtroCategoriaMatriculados'));
        console.log('- filtroRendimiento:', document.getElementById('filtroRendimiento'));
        console.log('- ordenarMatriculados:', document.getElementById('ordenarMatriculados'));
        console.log('- contadorMatriculados:', document.getElementById('contadorMatriculados'));

        // 4. Verificar si las funciones se est√°n llamando
        console.log('üîß FUNCIONES INICIALIZADAS:');
        console.log('- inicializarFiltrosMatriculados se ejecut√≥?', typeof inicializarFiltrosMatriculados === 'function');
        console.log('- aplicarFiltrosMatriculados se ejecut√≥?', typeof aplicarFiltrosMatriculados === 'function');
    }

    // Ejecutar diagn√≥stico cuando cargue la p√°gina
    document.addEventListener('DOMContentLoaded', function () {
        console.log('üöÄ P√°gina cargada, ejecutando diagn√≥stico...');
        diagnosticarProblemas();

        // Probar los filtros manualmente
        setTimeout(() => {
            console.log('üß™ Probando filtros manualmente...');
            aplicarFiltrosMatriculados();
        }, 1000);
    });

    // Tambi√©n probar cuando se escriba en el buscador
    document.getElementById('buscarMatriculados')?.addEventListener('input', function () {
        console.log('‚å®Ô∏è Teclado presionado en buscarMatriculados:', this.value);
    });

    // ================= NUEVO: SISTEMA KANBAN MEJORADO =================

    // Funci√≥n para inicializar el sistema Kanban
    function inicializarSistemaKanban() {
        console.log('üéØ Inicializando sistema Kanban mejorado...');

        // 1. Cargar resumen de categor√≠as
        cargarResumenCategorias();

        // 2. Configurar botones de cambio de vista
        const btnVistaLista = document.getElementById('btnVistaLista');
        const btnVistaKanban = document.getElementById('btnVistaKanban');
        const seccionLista = document.querySelector('.postulantes-container');
        const seccionKanban = document.getElementById('seccion-kanban');

        if (btnVistaLista && btnVistaKanban && seccionLista && seccionKanban) {
            // Vista Lista (default)
            btnVistaLista.addEventListener('click', function () {
                btnVistaLista.classList.add('active');
                btnVistaKanban.classList.remove('active');
                seccionLista.style.display = 'block';
                seccionKanban.style.display = 'none';
                console.log('üìã Cambiando a Vista Lista');
            });

            // Vista Kanban
            btnVistaKanban.addEventListener('click', function () {
                btnVistaKanban.classList.add('active');
                btnVistaLista.classList.remove('active');
                seccionLista.style.display = 'none';
                seccionKanban.style.display = 'block';
                console.log('üìä Cambiando a Vista Kanban');

                // Inicializar Kanban si no se ha hecho
                if (!window.kanbanInicializado) {
                    inicializarKanban();
                    window.kanbanInicializado = true;
                }
            });
        }

        // 3. Bot√≥n para actualizar resumen
        document.getElementById('btnActualizarResumen')?.addEventListener('click', cargarResumenCategorias);

        // 4. Inicializar gesti√≥n de l√≠mites
        inicializarGestionLimites();
    }

    // Funci√≥n para cargar resumen de categor√≠as
    function cargarResumenCategorias() {
        const contenedor = document.getElementById('resumen-categorias');
        if (!contenedor) return;

        contenedor.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary"></div><p class="text-muted mt-2">Cargando resumen...</p></div>';

        fetch("{% url 'obtener_resumen_categorias' %}")
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    mostrarResumenCategorias(data.resumen);
                } else {
                    contenedor.innerHTML = `<div class="alert alert-danger">Error cargando resumen: ${data.error}</div>`;
                }
            })
            .catch(error => {
                console.error('Error cargando resumen:', error);
                contenedor.innerHTML = '<div class="alert alert-danger">Error cargando resumen</div>';
            });
    }

    // Mostrar resumen de categor√≠as
    function mostrarResumenCategorias(resumen) {
        const contenedor = document.getElementById('resumen-categorias');
        if (!contenedor) return;

        if (resumen.length === 0) {
            contenedor.innerHTML = '<div class="alert alert-info">No hay categor√≠as configuradas</div>';
            return;
        }

        let html = '';
        resumen.forEach(cat => {
            html += `
        <div class="tarjeta-categoria ${cat.clase_color}">
            <h5 class="mb-1">${cat.nombre}</h5>
            <div class="contador">${cat.texto}</div>
            <div class="cupos">
                <i class="fas fa-users me-1"></i> ${cat.cupos} cupos disponibles
            </div>
            <div class="d-flex justify-content-between align-items-center mt-2">
                <small>${cat.porcentaje}% ocupado</small>
            </div>
        </div>
        `;
        });

        contenedor.innerHTML = html;
    }

    // Funci√≥n para inicializar el Kanban
    function inicializarKanban() {
        console.log('üîÑ Configurando Kanban mejorado...');

        // 1. Cargar las tarjetas desde la vista lista al Kanban
        cargarTarjetasAKanban();

        // 2. Configurar drag & drop
        configurarDragAndDrop();

        // 3. Configurar botones de acci√≥n masiva CON VERIFICACI√ìN DE L√çMITES
        configurarBotonesKanban();

        // 4. Configurar filtros para Kanban
        configurarFiltrosKanban();

        // 5. Actualizar contadores
        actualizarContadoresKanban();
    }

    // Cargar tarjetas desde la vista lista al Kanban
    function cargarTarjetasAKanban() {
        const contenedorLista = document.querySelector('#postulantes-row');
        const contenedorKanban = document.getElementById('columna-kanban-postulantes');

        if (!contenedorLista || !contenedorKanban) {
            console.log('‚ùå No se encontraron contenedores para Kanban');
            return;
        }

        // Limpiar contenedor Kanban
        contenedorKanban.innerHTML = '';

        // Obtener todas las tarjetas de la vista lista
        const tarjetasLista = contenedorLista.querySelectorAll('.col-md-4');

        tarjetasLista.forEach((tarjetaCol, index) => {
            // Clonar la estructura b√°sica de la tarjeta
            const tarjetaOriginal = tarjetaCol.querySelector('.position-relative');
            if (!tarjetaOriginal) return;

            // Extraer datos de la tarjeta original
            const nombre = tarjetaOriginal.querySelector('.card-title')?.textContent || `Postulante ${index + 1}`;
            const infoDivs = tarjetaOriginal.querySelectorAll('.alumno-info div');
            const telefono = infoDivs[0]?.textContent.replace('Tel:', '').trim() || '';
            const email = infoDivs[1]?.textContent.replace('Email:', '').trim() || '';
            const posicion = infoDivs[2]?.textContent.replace('Posici√≥n:', '').trim() || '';

            // Obtener fecha de registro
            const fechaElement = tarjetaOriginal.querySelector('.fecha-postulacion');
            const fechaData = fechaElement ? fechaElement.getAttribute('data-fecha') : '';
            const fechaTexto = fechaElement ? fechaElement.textContent.replace('Fecha de postulacion:', '').trim() : 'Sin fecha';

            // Obtener ID del postulante
            const btnVerInfo = tarjetaOriginal.querySelector('.btn-ver-info');
            const idPostulante = btnVerInfo ? btnVerInfo.getAttribute('data-id') : `post-${index}`;

            // Obtener datos de nacimiento para calcular categor√≠a
            const fechaNacimiento = btnVerInfo ? btnVerInfo.getAttribute('data-fecha') : '';

            // Crear tarjeta Kanban
            const tarjetaKanban = document.createElement('div');
            tarjetaKanban.className = 'kanban-card';
            tarjetaKanban.setAttribute('data-id', idPostulante);
            tarjetaKanban.setAttribute('data-columna', 'postulantes');
            tarjetaKanban.setAttribute('draggable', 'true');
            tarjetaKanban.setAttribute('data-nombre', nombre.toLowerCase());
            tarjetaKanban.setAttribute('data-email', email.toLowerCase());
            tarjetaKanban.setAttribute('data-telefono', telefono.toLowerCase());
            tarjetaKanban.setAttribute('data-fecha-registro', fechaData);

            // Estructura de la tarjeta Kanban CON FECHA
            tarjetaKanban.innerHTML = `
        <div class="kanban-card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0">${nombre}</h6>
                <div class="kanban-actions">
                    <button class="btn btn-sm btn-outline-info btn-kanban-ver-info"
                            data-id="${idPostulante}">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
            </div>
        </div>
        <div class="kanban-card-body">
            <div class="small">
                ${telefono ? `<div><strong>Tel:</strong> ${telefono}</div>` : ''}
                ${email ? `<div><strong>Email:</strong> ${email}</div>` : ''}
                ${posicion ? `<div><strong>Posici√≥n:</strong> ${posicion}</div>` : ''}
                <div class="fecha-kanban">
                    <i class="far fa-calendar-alt me-1"></i> ${fechaTexto}
                </div>
                <div>
                    <strong>Categor√≠a sugerida:</strong>
                    <span class="categoria-sugerida-kanban badge bg-primary" 
                          data-id="${idPostulante}"
                          data-fecha="${fechaNacimiento}">
                        Calculando...
                    </span>
                </div>
            </div>
        </div>
    `;

            contenedorKanban.appendChild(tarjetaKanban);
        });

        // Calcular categor√≠as sugeridas para Kanban
        calcularCategoriasSugeridasKanban();

        console.log(`‚úÖ Cargadas ${tarjetasLista.length} tarjetas al Kanban`);
    }

    // Configurar drag & drop para Kanban
    function configurarDragAndDrop() {
        const columns = document.querySelectorAll('.kanban-column-body');

        columns.forEach(column => {
            // Permitir que la columna reciba elementos
            column.addEventListener('dragover', function (e) {
                e.preventDefault();
                this.classList.add('drop-over');
            });

            column.addEventListener('dragleave', function () {
                this.classList.remove('drop-over');
            });

            column.addEventListener('drop', function (e) {
                e.preventDefault();
                this.classList.remove('drop-over');

                const cardId = e.dataTransfer.getData('text/plain');
                const card = document.querySelector(`.kanban-card[data-id="${cardId}"]`);

                if (card && card !== this) {
                    // Obtener la columna destino
                    const columnType = this.closest('.kanban-column').getAttribute('data-column');

                    // Actualizar columna de la tarjeta
                    card.setAttribute('data-columna', columnType);

                    // Cambiar color del borde seg√∫n columna
                    if (columnType === 'en-proceso') {
                        card.style.borderLeft = '4px solid #ffc107';
                    } else if (columnType === 'decision') {
                        card.style.borderLeft = '4px solid #6c757d';
                    } else {
                        card.style.borderLeft = '4px solid #0d6efd';
                    }

                    // Mover la tarjeta a esta columna
                    this.appendChild(card);

                    // Actualizar contadores
                    actualizarContadoresKanban();

                    // Mostrar notificaci√≥n con toast
                    mostrarToast(`Postulante movido a ${getNombreColumnaKanban(columnType)}`, 'warning');
                }
            });
        });

        // Hacer las tarjetas arrastrables
        document.addEventListener('dragstart', function (e) {
            if (e.target.classList.contains('kanban-card')) {
                e.target.classList.add('dragging');
                e.dataTransfer.setData('text/plain', e.target.getAttribute('data-id'));
            }
        });

        document.addEventListener('dragend', function (e) {
            if (e.target.classList.contains('kanban-card')) {
                e.target.classList.remove('dragging');
            }
        });
    }

    // Configurar botones del Kanban CON VERIFICACI√ìN DE L√çMITES
    function configurarBotonesKanban() {
        // Bot√≥n "Aceptar Todos" para columnas
        document.querySelectorAll('.btn-kanban-aceptar-todos').forEach(btn => {
            btn.addEventListener('click', function () {
                const columna = this.getAttribute('data-columna');
                const columnId = `columna-kanban-${columna}`;
                const cards = document.querySelectorAll(`#${columnId} .kanban-card`);

                if (cards.length === 0) {
                    mostrarToast('No hay postulantes en esta columna', 'warning');
                    return;
                }

                // Primero verificar l√≠mites antes de mostrar modal
                verificarLimitesAntesDeAceptar(cards, function (puedeContinuar, mensaje) {
                    if (!puedeContinuar) {
                        mostrarToast(mensaje, 'danger');
                        return;
                    }

                    // Mostrar modal de confirmaci√≥n
                    const modal = new bootstrap.Modal(document.getElementById('modalAceptarTodosKanban'));
                    const textoModal = document.getElementById('texto-aceptar-todos-kanban');
                    const btnConfirmar = document.getElementById('btn-confirmar-aceptar-todos-kanban');

                    textoModal.textContent = `¬øEst√°s seguro de aceptar a ${cards.length} postulantes de esta columna?`;

                    btnConfirmar.onclick = function () {
                        procesarAceptacionMasivaKanban(cards, columnId);
                        modal.hide();
                    };

                    modal.show();
                });
            });
        });

        // Bot√≥n "Rechazar Todos" para columna "Decisi√≥n"
        document.querySelectorAll('.btn-kanban-rechazar-todos').forEach(btn => {
            btn.addEventListener('click', function () {
                const columna = this.getAttribute('data-columna');
                const cards = document.querySelectorAll(`#columna-kanban-${columna} .kanban-card`);

                if (cards.length === 0) {
                    mostrarToast('No hay postulantes en esta columna', 'warning');
                    return;
                }

                // Mostrar modal de rechazo masivo
                const modalRechazo = new bootstrap.Modal(document.getElementById('modalRechazarTodosKanban'));
                const textoRechazo = document.getElementById('texto-rechazar-todos-kanban');
                const btnRechazar = document.getElementById('btn-confirmar-rechazar-todos-kanban');

                textoRechazo.textContent = `¬øEst√°s seguro de rechazar a ${cards.length} postulantes de esta columna?`;

                btnRechazar.onclick = function () {
                    procesarRechazoMasivoKanban(cards);
                    modalRechazo.hide();
                };

                modalRechazo.show();
            });
        });

        // Botones "Ver info" en tarjetas Kanban
        document.addEventListener('click', function (e) {
            if (e.target.closest('.btn-kanban-ver-info')) {
                const btn = e.target.closest('.btn-kanban-ver-info');
                const idPostulante = btn.getAttribute('data-id');

                // Buscar el bot√≥n correspondiente en la vista lista
                const btnLista = document.querySelector(`.btn-ver-info[data-id="${idPostulante}"]`);
                if (btnLista) {
                    // Simular clic en el bot√≥n de la vista lista
                    btnLista.click();
                } else {
                    mostrarToast('Informaci√≥n no disponible en este momento', 'warning');
                }
            }
        });
    }

    // Verificar l√≠mites antes de aceptar
    function verificarLimitesAntesDeAceptar(cards, callback) {
        // Primero, obtener datos de categor√≠as
        fetch("{% url 'obtener_resumen_categorias' %}")
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    callback(false, 'Error obteniendo datos de categor√≠as');
                    return;
                }

                let problemas = [];
                let puedeContinuar = true;

                // Por cada tarjeta, verificar la categor√≠a sugerida
                cards.forEach(card => {
                    const categoriaElement = card.querySelector('.categoria-sugerida-kanban');
                    if (categoriaElement) {
                        const categoriaNombre = categoriaElement.textContent.trim();

                        // Buscar esta categor√≠a en los datos del resumen
                        const categoriaInfo = data.resumen.find(cat => cat.nombre === categoriaNombre);

                        if (categoriaInfo) {
                            if (categoriaInfo.cupos <= 0) {
                                const nombre = card.querySelector('h6').textContent;
                                problemas.push(`${nombre}: Sin cupos en ${categoriaNombre}`);
                                puedeContinuar = false;
                            }
                        }
                    }
                });

                if (!puedeContinuar) {
                    let mensaje = 'No se puede aceptar por falta de cupos:<br>';
                    problemas.forEach((p, i) => {
                        mensaje += `${i + 1}. ${p}<br>`;
                    });
                    callback(false, mensaje);
                } else {
                    callback(true, '');
                }
            })
            .catch(error => {
                console.error('Error verificando l√≠mites:', error);
                callback(false, 'Error verificando disponibilidad de cupos');
            });
    }

    // Procesar aceptaci√≥n masiva en Kanban
    // Reemplaza la funci√≥n procesarAceptacionMasivaKanban con esta versi√≥n mejorada:
function procesarAceptacionMasivaKanban(cards, columnId) {
    const ids = Array.from(cards).map(card => card.getAttribute('data-id'));
    const nombres = Array.from(cards).map(card => card.querySelector('h6').textContent);

    console.log(`Aceptando masivamente ${ids.length} postulantes del Kanban:`, ids);

    // Crear un formulario virtual para enviar la solicitud
    const formData = new FormData();
    ids.forEach(id => {
        formData.append('ids[]', id);
    });
    formData.append('action', 'accept_multiple');
    formData.append('enviar_carnet_auto', 'true'); // A√±adir flag para carnets
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

    // Mostrar loading
    const btnOriginal = document.querySelector(`#${columnId}`).closest('.kanban-column').querySelector('.btn-kanban-aceptar-todos');
    const originalText = btnOriginal.innerHTML;
    btnOriginal.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Procesando...';
    btnOriginal.disabled = true;

    // Enviar solicitud al servidor
    fetch(window.location.href, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (response.redirected) {
            // Si hay redirecci√≥n, mostrar mensaje detallado y recargar
            mostrarToast(`Los postulantes han sido aceptados correctamente. Recargando`, 'success');
            setTimeout(() => {
                window.location.reload();
            }, 3000);
            return null;
        }
        return response.text();
    })
    .then(data => {
        if (data) {
            try {
                const jsonData = JSON.parse(data);
                if (jsonData.success) {
                    mostrarToast(jsonData.message, 'success');
                } else {
                    mostrarToast(jsonData.error || 'Error en el proceso', 'danger');
                }
            } catch (e) {
                // Si no es JSON, probablemente es HTML de redirecci√≥n
                mostrarToast('Proceso completado, recargando...', 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        mostrarToast('Error procesando la solicitud: ' + error.message, 'danger');
    })
    .finally(() => {
        btnOriginal.innerHTML = originalText;
        btnOriginal.disabled = false;
    });
}

// Reemplaza la funci√≥n procesarRechazoMasivoKanban con esta versi√≥n mejorada:
function procesarRechazoMasivoKanban(cards) {
    const ids = Array.from(cards).map(card => card.getAttribute('data-id'));
    const nombres = Array.from(cards).map(card => card.querySelector('h6').textContent);
    const motivoElement = document.getElementById('motivo-rechazo-todos-kanban');
    const motivo = motivoElement ? motivoElement.value || '' : '';

    console.log(`Rechazando masivamente ${ids.length} postulantes del Kanban:`, ids);

    // Crear un formulario virtual
    const formData = new FormData();
    ids.forEach(id => {
        formData.append('ids[]', id);
    });
    formData.append('mensaje_rechazo', motivo);
    formData.append('action', 'reject_multiple');
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

    // Mostrar loading
    const btnOriginal = document.querySelector('#columna-kanban-decision').closest('.kanban-column').querySelector('.btn-kanban-rechazar-todos');
    const originalText = btnOriginal ? btnOriginal.innerHTML : '';
    if (btnOriginal) {
        btnOriginal.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Procesando...';
        btnOriginal.disabled = true;
    }

    // Cerrar el modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('modalRechazarTodosKanban'));
    if (modal) {
        modal.hide();
    }

    // Enviar solicitud
    fetch(window.location.href, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (response.redirected) {
            mostrarToast(`Proceso completado. Recargando p√°gina...`, 'danger');
            setTimeout(() => {
                window.location.reload();
            }, 3000);
            return null;
        }
        return response.text();
    })
    .then(data => {
        if (data) {
            try {
                const jsonData = JSON.parse(data);
                if (jsonData.success) {
                    mostrarToast(jsonData.message, 'info');
                } else {
                    mostrarToast(jsonData.error || 'Error en el proceso', 'danger');
                }
            } catch (e) {
                mostrarToast('Proceso completado, recargando...', 'info');
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        mostrarToast('Error procesando el rechazo: ' + error.message, 'danger');
    })
    .finally(() => {
        if (btnOriginal) {
            btnOriginal.innerHTML = originalText;
            btnOriginal.disabled = false;
        }
    });
}

// Mejora la funci√≥n mostrarToast para mejor visualizaci√≥n:
function mostrarToast(mensaje, tipo = 'info') {
    // Eliminar toasts antiguos si hay muchos
    const container = document.getElementById('toast-container-kanban') || 
                     document.getElementById('toast-container') || 
                     document.createElement('div');
    
    if (!container.id) {
        container.id = 'toast-container';
        container.className = 'toast-container position-fixed top-0 end-0 p-3';
        container.style.zIndex = '99999';
        document.body.appendChild(container);
    }
    
    // Limitar a 3 toasts m√°ximo
    const toasts = container.querySelectorAll('.toast');
    if (toasts.length >= 3) {
        toasts[0].remove();
    }
    
    const toastId = 'toast-' + Date.now();
    const iconos = {
        'success': '',
        'danger': '',
        'warning': '',
        'info': ''
    };
    
    const icono = iconos[tipo] || '';
    
    const toastHTML = `
    <div id="${toastId}" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="5000" style="padding: 30px;">
        <div class="toast-header bg-${tipo} text-white">
            <strong class="me-auto">${icono} Sistema de Matr√≠culas</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body">
            ${mensaje}
        </div>
    </div>
    `;
    
    container.insertAdjacentHTML('beforeend', toastHTML);
    
    // Mostrar el toast
    const toastEl = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastEl);
    toast.show();
    
    // Remover despu√©s de ocultar
    toastEl.addEventListener('hidden.bs.toast', function () {
        this.remove();
    });
}

    // Configurar filtros para Kanban
    function configurarFiltrosKanban() {
        const buscarInput = document.getElementById('buscarPostulantes');
        const filtroCategoria = document.getElementById('filtroCategoria');

        if (buscarInput) {
            buscarInput.addEventListener('input', function () {
                aplicarFiltrosKanban();
            });
        }

        if (filtroCategoria) {
            filtroCategoria.addEventListener('change', function () {
                aplicarFiltrosKanban();
            });
        }
    }

    // Aplicar filtros al Kanban
    function aplicarFiltrosKanban() {
        const buscarTexto = document.getElementById('buscarPostulantes').value.toLowerCase();
        const filtroCategoria = document.getElementById('filtroCategoria').value;

        // Obtener todas las tarjetas Kanban en todas las columnas
        const tarjetas = document.querySelectorAll('.kanban-card');

        let tarjetasVisibles = 0;

        tarjetas.forEach(tarjeta => {
            const nombre = tarjeta.getAttribute('data-nombre') || '';
            const email = tarjeta.getAttribute('data-email') || '';
            const telefono = tarjeta.getAttribute('data-telefono') || '';

            // Obtener texto de fecha desde el contenido HTML
            const fechaElement = tarjeta.querySelector('.fecha-kanban');
            const fechaTexto = fechaElement ? fechaElement.textContent.toLowerCase() : '';

            const categoriaElement = tarjeta.querySelector('.categoria-sugerida-kanban');
            const categoria = categoriaElement ? categoriaElement.textContent.toLowerCase() : '';

            // Aplicar filtro de b√∫squeda
            const coincideBusqueda = !buscarTexto ||
                nombre.includes(buscarTexto) ||
                email.includes(buscarTexto) ||
                telefono.includes(buscarTexto) ||
                fechaTexto.includes(buscarTexto);

            // Aplicar filtro de categor√≠a
            let coincideCategoria = true;
            if (filtroCategoria) {
                const nombreCategoria = obtenerNombreCategoriaPorId(filtroCategoria);
                coincideCategoria = categoria.includes(nombreCategoria.toLowerCase());
            }

            // Mostrar/ocultar seg√∫n filtros
            if (coincideBusqueda && coincideCategoria) {
                tarjeta.style.display = 'block';
                tarjetasVisibles++;
            } else {
                tarjeta.style.display = 'none';
            }
        });

        // Actualizar contadores despu√©s de filtrar
        actualizarContadoresKanban();

        // Mostrar mensaje si no hay resultados
        mostrarMensajeSinResultadosKanban(tarjetasVisibles);
    }

    // Funci√≥n para mostrar mensaje cuando no hay resultados en Kanban
    function mostrarMensajeSinResultadosKanban(visibles) {
        const columnas = ['postulantes', 'en-proceso', 'decision'];

        columnas.forEach(columna => {
            const contenedor = document.getElementById(`columna-kanban-${columna}`);
            let mensajeExistente = contenedor.querySelector('.mensaje-sin-resultados');

            // Contar tarjetas visibles en esta columna
            const cards = contenedor.querySelectorAll('.kanban-card');
            const cardsVisibles = Array.from(cards).filter(card => card.style.display !== 'none').length;

            if (cardsVisibles === 0 && cards.length > 0) {
                if (!mensajeExistente) {
                    mensajeExistente = document.createElement('div');
                    mensajeExistente.className = 'mensaje-sin-resultados text-center text-muted py-3';
                    mensajeExistente.innerHTML = `
                    <i class="fas fa-search fa-2x mb-2"></i><br>
                    No hay postulantes que coincidan con los filtros
                `;
                    contenedor.appendChild(mensajeExistente);
                }
            } else if (mensajeExistente) {
                mensajeExistente.remove();
            }
        });
    }

    // Actualizar contadores del Kanban
    function actualizarContadoresKanban() {
        const contadores = {
            'postulantes': document.getElementById('contador-kanban-postulantes'),
            'en-proceso': document.getElementById('contador-kanban-en-proceso'),
            'decision': document.getElementById('contador-kanban-decision')
        };

        for (const [columna, contador] of Object.entries(contadores)) {
            if (contador) {
                const cards = document.querySelectorAll(`#columna-kanban-${columna} .kanban-card`);
                const cardsVisibles = Array.from(cards).filter(card => card.style.display !== 'none').length;
                contador.textContent = cardsVisibles;
            }
        }
    }

    // Calcular categor√≠as sugeridas para Kanban
    function calcularCategoriasSugeridasKanban() {
        document.querySelectorAll('.categoria-sugerida-kanban').forEach(element => {
            const fechaNacimiento = element.getAttribute('data-fecha');

            if (fechaNacimiento && fechaNacimiento !== 'undefined' && fechaNacimiento !== 'None') {
                const categoria = calcularCategoriaSugerida(fechaNacimiento);
                element.textContent = categoria;
            } else {
                element.textContent = 'No disponible';
            }
        });
    }

    // Funci√≥n auxiliar para obtener nombre de categor√≠a por ID
    function obtenerNombreCategoriaPorId(idCategoria) {
        const select = document.getElementById('filtroCategoria');
        const option = select.querySelector(`option[value="${idCategoria}"]`);
        return option ? option.textContent : '';
    }

    // Inicializar gesti√≥n de l√≠mites de categor√≠as
    function inicializarGestionLimites() {
        const modal = document.getElementById('modalLimitesCategoria');
        if (modal) {
            modal.addEventListener('shown.bs.modal', function () {
                cargarDatosLimitesCategorias();
            });
        }

        // Bot√≥n para guardar todos los l√≠mites
        const btnGuardarTodos = document.getElementById('btn-guardar-limites-todos');
        if (btnGuardarTodos) {
            btnGuardarTodos.addEventListener('click', function () {
                guardarTodosLimitesCategorias();
            });
        }
    }

    // Cargar datos de l√≠mites de categor√≠as
    function cargarDatosLimitesCategorias() {
        const tbody = document.getElementById('tabla-limites-categorias');
        if (!tbody) return;

        tbody.innerHTML = '<tr><td colspan="6" class="text-center"><div class="spinner-border"></div> Cargando...</td></tr>';

        // Hacer una petici√≥n AJAX para obtener los datos de categor√≠as
        fetch("{% url 'obtener_datos_categorias' %}")
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    mostrarDatosLimitesCategorias(data.categorias);
                } else {
                    tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">${data.error}</td></tr>`;
                }
            })
            .catch(error => {
                console.error('Error cargando datos de categor√≠as:', error);
                tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">Error cargando datos</td></tr>`;
            });
    }

    // Mostrar datos en la tabla
    function mostrarDatosLimitesCategorias(categorias) {
        const tbody = document.getElementById('tabla-limites-categorias');
        if (!tbody) return;

        tbody.innerHTML = '';

        categorias.forEach(cat => {
            const porcentaje = cat.alumnos_actuales / cat.limite_alumnos * 100;
            let claseEstado = 'bg-success';
            if (porcentaje >= 80) claseEstado = 'bg-warning';
            if (porcentaje >= 95) claseEstado = 'bg-danger';

            const row = document.createElement('tr');
            row.innerHTML = `
        <td>${cat.nom_categoria}</td>
        <td>${cat.alumnos_actuales}</td>
        <td>${cat.limite_alumnos}</td>
        <td>
            <span class="badge ${claseEstado} limite-categoria-badge">
                ${cat.cupos_disponibles}
            </span>
        </td>
        <td>
            <input type="number" class="form-control form-control-sm nuevo-limite" 
                   value="${cat.limite_alumnos}" min="${cat.alumnos_actuales}" 
                   data-id="${cat.idcategoria}" style="width: 100px;">
        </td>
        <td>
            <button class="btn btn-sm btn-success btn-guardar-limite" 
                    data-id="${cat.idcategoria}">
                <i class="fas fa-save"></i>
            </button>
        </td>
    `;
            tbody.appendChild(row);
        });

        // Configurar botones de guardar individuales
        document.querySelectorAll('.btn-guardar-limite').forEach(btn => {
            btn.addEventListener('click', function () {
                const idCategoria = this.getAttribute('data-id');
                guardarLimiteCategoria(idCategoria);
            });
        });
    }

    // Guardar un l√≠mite individual
    function guardarLimiteCategoria(idCategoria) {
        const input = document.querySelector(`.nuevo-limite[data-id="${idCategoria}"]`);
        if (!input) return;

        const nuevoLimite = parseInt(input.value);
        const min = parseInt(input.min);

        if (nuevoLimite < min) {
            mostrarToast(`El l√≠mite no puede ser menor a ${min} (alumnos actuales)`, 'danger');
            input.value = min;
            return;
        }

        // Enviar al servidor
        const formData = new FormData();
        formData.append('categoria_id', idCategoria);
        formData.append('nuevo_limite', nuevoLimite);
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

        fetch("{% url 'actualizar_limite_categoria' %}", {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    mostrarToast(data.message, 'success');
                    cargarDatosLimitesCategorias(); // Recargar datos
                    cargarResumenCategorias(); // Actualizar resumen
                } else {
                    mostrarToast(data.error, 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarToast('Error actualizando l√≠mite', 'danger');
            });
    }

    // Guardar todos los l√≠mites
    function guardarTodosLimitesCategorias() {
        const inputs = document.querySelectorAll('.nuevo-limite');
        const cambios = [];

        inputs.forEach(input => {
            const idCategoria = input.getAttribute('data-id');
            const nuevoLimite = parseInt(input.value);
            const min = parseInt(input.min);

            if (nuevoLimite < min) {
                mostrarToast(`El l√≠mite para la categor√≠a ${idCategoria} no puede ser menor a ${min}`, 'danger');
                return;
            }

            cambios.push({ id: idCategoria, limite: nuevoLimite });
        });

        if (cambios.length === 0) return;

        // Enviar todos los cambios al servidor
        const formData = new FormData();
        formData.append('cambios', JSON.stringify(cambios));
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

        fetch("{% url 'actualizar_limites_masivo' %}", {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    mostrarToast(data.message, 'success');
                    cargarDatosLimitesCategorias(); // Recargar datos
                    cargarResumenCategorias(); // Actualizar resumen
                } else {
                    mostrarToast(data.error, 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarToast('Error actualizando l√≠mites', 'danger');
            });
    }

    // Funciones auxiliares para Kanban
    function getNombreColumnaKanban(tipo) {
        const nombres = {
            'postulantes': 'Postulantes',
            'en-proceso': 'En Proceso',
            'decision': 'Decisi√≥n Final'
        };
        return nombres[tipo] || tipo;
    }

    // Funci√≥n para mostrar toast (reemplaza mostrarNotificacionKanban)
    function mostrarToast(mensaje, tipo = 'info') {
        // Crear elemento toast
        const toastId = 'toast-' + Date.now();
        const toastHTML = `
    <div id="${toastId}" class="toast align-items-center text-bg-${tipo} border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                ${mensaje}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
    `;

        // Agregar al contenedor de toasts (crear si no existe)
        let toastContainer = document.getElementById('toast-container-kanban');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.id = 'toast-container-kanban';
            toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
            toastContainer.style.zIndex = '99999';
            document.body.appendChild(toastContainer);
        }

        toastContainer.insertAdjacentHTML('beforeend', toastHTML);

        // Mostrar el toast
        const toastEl = document.getElementById(toastId);
        const toast = new bootstrap.Toast(toastEl, {
            autohide: true,
            delay: 3000
        });
        toast.show();

        // Remover despu√©s de ocultar
        toastEl.addEventListener('hidden.bs.toast', function () {
            this.remove();
        });
    }

    // ================= INICIALIZAR TODO AL CARGAR LA P√ÅGINA =================
    document.addEventListener('DOMContentLoaded', function () {
        // Tu c√≥digo existente se mantiene intacto...

        // Solo agregamos esta l√≠nea al final para inicializar el sistema Kanban
        setTimeout(() => {
            inicializarSistemaKanban();
        }, 1000);
    });

    // ================= FUNCIONES PARA ALUMNOS TERMINADOS =================
    // ================= FUNCIONES PARA ALUMNOS TERMINADOS (SIMPLIFICADAS) =================

    function filtrarAlumnosTerminados() {
        const filtro = document.getElementById('buscarTerminadosInput')?.value.toLowerCase() || '';
        const filas = document.querySelectorAll('#tbodyTerminados .fila-terminado');

        let visibles = 0;

        filas.forEach(fila => {
            const nombre = fila.getAttribute('data-nombre') || '';
            const categoria = fila.getAttribute('data-categoria') || '';
            const codigo = fila.getAttribute('data-codigo') || '';

            const coincide = nombre.includes(filtro) || categoria.includes(filtro) || codigo.includes(filtro);

            if (coincide || !filtro) {
                fila.style.display = '';
                visibles++;
            } else {
                fila.style.display = 'none';
            }
        });

        // Actualizar contador
        const contadorVisibles = document.getElementById('contadorVisiblesTerminados');
        const contadorTotal = document.getElementById('contadorTotalTerminados');

        if (contadorVisibles) {
            contadorVisibles.textContent = visibles;
        }
    }

    function limpiarBusquedaTerminados() {
        const input = document.getElementById('buscarTerminadosInput');
        if (input) {
            input.value = '';
            filtrarAlumnosTerminados();
        }
    }

    // ================= FUNCI√ìN AUXILIAR =================

    function mostrarMensajeTemporal(mensaje, tipo = 'info') {
        const alerta = document.createElement('div');
        alerta.className = `alert alert-${tipo} alert-dismissible fade show position-fixed`;
        alerta.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        alerta.innerHTML = `
        ${mensaje}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

        document.body.appendChild(alerta);

        setTimeout(() => {
            if (alerta.parentNode) {
                alerta.remove();
            }
        }, 3000);
    }

    // ================= INICIALIZACI√ìN =================

    document.addEventListener('DOMContentLoaded', function () {
        console.log('üîß Inicializando modales...');

        // Configurar b√∫squeda en tiempo real para alumnos terminados
        const inputBuscarTerminados = document.getElementById('buscarTerminadosInput');
        if (inputBuscarTerminados) {
            inputBuscarTerminados.addEventListener('input', filtrarAlumnosTerminados);
            console.log('‚úÖ B√∫squeda de terminados configurada');
        }

        // Configurar eventos del modal de alumnos terminados
        const modalTerminados = document.getElementById('modalBuscarTerminados');
        if (modalTerminados) {
            modalTerminados.addEventListener('shown.bs.modal', function () {
                console.log('üìã Modal de alumnos terminados abierto');
                // Resetear b√∫squeda al abrir
                if (inputBuscarTerminados) {
                    inputBuscarTerminados.value = '';
                }
                // Aplicar filtro inicial
                filtrarAlumnosTerminados();
            });
        }

        // Configurar eventos del modal de renovaciones
        const modalRenovaciones = document.getElementById('modalRenovaciones');
        if (modalRenovaciones) {
            modalRenovaciones.addEventListener('shown.bs.modal', function () {
                console.log('üîÑ Modal de renovaciones abierto');
            });
        }

        console.log('‚úÖ Inicializaci√≥n completada');
    });

    // ================= FUNCIONES AUXILIARES =================
    function mostrarNotificacion(mensaje, tipo = 'info') {
        // Crear notificaci√≥n
        const notificacion = document.createElement('div');
        notificacion.className = `alert alert-${tipo} alert-dismissible fade show position-fixed`;
        notificacion.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        notificacion.innerHTML = `
        ${mensaje}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

        document.body.appendChild(notificacion);

        // Auto-eliminar despu√©s de 5 segundos
        setTimeout(() => {
            if (notificacion.parentNode) {
                notificacion.remove();
            }
        }, 5000);
    }
    // Agrega este c√≥digo al final de tu script
document.addEventListener('DOMContentLoaded', function() {
    console.log('üîß Configurando modal de rechazo masivo kanban...');
    
    // Configurar contador de caracteres para rechazo masivo
    const textareaRechazo = document.getElementById('motivo-rechazo-todos-kanban');
    const contador = document.getElementById('contador-caracteres-rechazo');
    const infoMensaje = document.getElementById('info-mensaje-personalizado');
    
    if (textareaRechazo && contador) {
        textareaRechazo.addEventListener('input', function() {
            const longitud = this.value.length;
            contador.textContent = `${longitud}/500`;
            
            if (longitud > 450) {
                contador.className = 'badge bg-warning';
            } else if (longitud > 490) {
                contador.className = 'badge bg-danger';
            } else {
                contador.className = 'badge bg-secondary';
            }
            
            // Mostrar/ocultar info de mensaje personalizado
            if (longitud > 0 && infoMensaje) {
                infoMensaje.style.display = 'inline';
            } else if (infoMensaje) {
                infoMensaje.style.display = 'none';
            }
        });
    }
    
    // Actualizar cantidad al abrir modal de rechazo
    const modalRechazo = document.getElementById('modalRechazarTodosKanban');
    if (modalRechazo) {
        modalRechazo.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            const columna = button.getAttribute('data-columna');
            const cards = document.querySelectorAll(`#columna-kanban-${columna} .kanban-card`);
            
            // Actualizar texto - CORREGIDO: usar ID correcto
            const textoElement = document.getElementById('texto-rechazar-todos-kanban');
            if (textoElement) {
                textoElement.textContent = `¬øEst√°s seguro de rechazar a ${cantidad} postulantes?`;
            }
            
            console.log(`Modal de rechazo abierto: ${cantidad} postulantes en columna ${columna}`);
        });
    }
    
    // Configurar bot√≥n de confirmar rechazo
    const btnConfirmarRechazo = document.getElementById('btn-confirmar-rechazar-todos-kanban');
    if (btnConfirmarRechazo) {
        btnConfirmarRechazo.addEventListener('click', function() {
            const columna = 'decision'; // Siempre ser√° la columna de decisi√≥n
            const cards = document.querySelectorAll(`#columna-kanban-${columna} .kanban-card`);
            procesarRechazoMasivoKanban(cards);
        });
    }
});

// ================= SCROLL VERTICAL - FUNCIONALIDADES =================
function inicializarScrollVertical() {
    console.log('üîß Inicializando scroll vertical...');
    
    // 1. Actualizar contadores iniciales
    actualizarContadoresScroll();
    
    // 2. Configurar botones de expandir/contraer
    document.querySelectorAll('.btn-expandir-scroll').forEach(btn => {
        btn.addEventListener('click', function() {
            const targetId = this.getAttribute('data-target');
            alternarTama√±oScroll(targetId);
        });
    });
    
    // 3. Configurar eventos de scroll para actualizar contadores
    const scrollMatriculados = document.getElementById('scrollVerticalMatriculados');
    const scrollPostulantes = document.getElementById('scrollVerticalPostulantes');
    
    if (scrollMatriculados) {
        scrollMatriculados.addEventListener('scroll', function() {
            actualizarContadorVisible('scrollVerticalMatriculados', 'contadorActualMatriculados');
        });
    }
    
    if (scrollPostulantes) {
        scrollPostulantes.addEventListener('scroll', function() {
            actualizarContadorVisible('scrollVerticalPostulantes', 'contadorActualPostulantes');
        });
    }
    
    // 4. Actualizar cuando cambien filtros
    document.getElementById('buscarMatriculados')?.addEventListener('input', function() {
        setTimeout(() => {
            actualizarContadoresScroll();
        }, 300);
    });
    
    document.getElementById('buscarPostulantes')?.addEventListener('input', function() {
        setTimeout(() => {
            actualizarContadoresScroll();
        }, 300);
    });
    
    console.log('‚úÖ Scroll vertical inicializado');
}

// Actualizar todos los contadores
function actualizarContadoresScroll() {
    // Para matriculados
    const contenedorMat = document.getElementById('scrollVerticalMatriculados');
    if (contenedorMat) {
        const tarjetasTotal = contenedorMat.querySelectorAll('.col-md-4');
        const tarjetasVisibles = Array.from(tarjetasTotal).filter(t => 
            t.style.display !== 'none' && window.getComputedStyle(t).display !== 'none'
        ).length;
        
        document.getElementById('contadorScrollMatriculados').textContent = tarjetasVisibles;
        document.getElementById('contadorTotalMatriculados').textContent = tarjetasVisibles;
        document.getElementById('contadorActualMatriculados').textContent = tarjetasVisibles;
    }
    
    // Para postulantes
    const contenedorPost = document.getElementById('scrollVerticalPostulantes');
    if (contenedorPost) {
        const tarjetasTotal = contenedorPost.querySelectorAll('.col-md-4');
        const tarjetasVisibles = Array.from(tarjetasTotal).filter(t => 
            t.style.display !== 'none' && window.getComputedStyle(t).display !== 'none'
        ).length;
        
        document.getElementById('contadorScrollPostulantes').textContent = tarjetasVisibles;
        document.getElementById('contadorTotalPostulantes').textContent = tarjetasVisibles;
        document.getElementById('contadorActualPostulantes').textContent = tarjetasVisibles;
    }
}


// Actualizar contador de elementos visibles en scroll
function actualizarContadorVisible(contenedorId, elementoContadorId) {
    const contenedor = document.getElementById(contenedorId);
    const elementoContador = document.getElementById(elementoContadorId);
    
    if (!contenedor || !elementoContador) return;
    
    // Calcular cu√°ntas tarjetas son visibles en el viewport
    const tarjetas = contenedor.querySelectorAll('.col-md-4');
    const alturaContenedor = contenedor.clientHeight;
    const scrollTop = contenedor.scrollTop;
    
    let tarjetasVisibles = 0;
    
    tarjetas.forEach(tarjeta => {
        if (tarjeta.style.display !== 'none' && window.getComputedStyle(tarjeta).display !== 'none') {
            const posicion = tarjeta.offsetTop - contenedor.offsetTop;
            const alturaTarjeta = tarjeta.clientHeight;
            
            // Verificar si la tarjeta est√° dentro del viewport del scroll
            const estaVisible = (
                posicion + alturaTarjeta >= scrollTop &&
                posicion <= scrollTop + alturaContenedor
            );
            
            if (estaVisible) {
                tarjetasVisibles++;
            }
        }
    });
    
    elementoContador.textContent = tarjetasVisibles;
}


// Llamar a la inicializaci√≥n cuando cargue la p√°gina
document.addEventListener('DOMContentLoaded', function() {
    // Esperar un poco para que se carguen los filtros
    setTimeout(() => {
        inicializarScrollVertical();
    }, 1000);
});


// Tambi√©n actualizar despu√©s de aplicar filtros
function aplicarFiltrosConScroll() {
    setTimeout(() => {
        actualizarContadoresScroll();
    }, 100);
}

// Sobreescribir tu funci√≥n aplicarFiltros para incluir esto
const aplicarFiltrosOriginal = aplicarFiltros;
aplicarFiltros = function() {
    aplicarFiltrosOriginal();
    aplicarFiltrosConScroll();
};

// Lo mismo para matriculados
if (typeof aplicarFiltrosMatriculados === 'function') {
    const aplicarFiltrosMatriculadosOriginal = aplicarFiltrosMatriculados;
    aplicarFiltrosMatriculados = function() {
        aplicarFiltrosMatriculadosOriginal();
        aplicarFiltrosConScroll();
    };
}
</script>
{% endblock %}