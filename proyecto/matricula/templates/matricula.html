{% extends 'layouts/plantilla2.html'%}
{% load static %}

{% block head %}
<title>Gestion Matriculas</title>
<link rel="stylesheet" href="{% static 'matricula/css/matricula_nuevo.css' %}" />
<style>
    :root {
        --portada-bg: url('{% static "partida/img/5.png" %}');
    }
</style>
{% endblock %}

{% block content %}
<div class="grid-main">
    <section class="portada-container">
        <div class="titulo">
            <h2>Gesti√≥n de Matriculas y Postulantes</h2>
        </div>
        <div class="menu">
            <ui>
                <li data-target="#matriculas">Matricula</li>
                <li data-target="#postulantes">Postulantes</li>
            </ui>
        </div>
    </section>
    <section class="paginas-container">
        <div data-content id="matriculas" class="active">
            <section class="titulo-seccion">
                <h3>‚öΩ Alumnos Matriculados üë¶üñãÔ∏è</h3>
                <div class="line"></div>
            </section>

            <section class="filtros-matriculas-container mb-4">
                <div class="row">
                    <!-- B√∫squeda en tiempo real -->
                    <div class="col-md-3">
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input type="text" id="buscarMatriculados" class="form-control"
                                placeholder="Buscar por nombre, apellido...">
                        </div>
                    </div>

                    <!-- Filtro por categor√≠a -->
                    <div class="col-md-2">
                        <select id="filtroCategoriaMatriculados" class="form-select">
                            <option value="">Todas las categor√≠as</option>
                            {% for c in categorias_usuario %}
                            <option value="{{ c.idcategoria }}">{{ c.nom_categoria }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- FILTRO NUEVO: Por rendimiento -->
                    <div class="col-md-2">
                        <select id="filtroRendimiento" class="form-select">
                            <option value="todos">Todos los rendimientos</option>
                            <option value="Excelente">Excelente (‚â•80%)</option>
                            <option value="Regular">Regular (60-79%)</option>
                            <option value="Bajo">Bajo (<60%)< /option>
                            <option value="Sin datos">Sin datos</option>
                        </select>
                    </div>

                    <!-- Ordenamiento 
                    <div class="col-md-2">
                        <select id="ordenarMatriculados" class="form-select">
                            <option value="nombre_asc">Nombre A-Z</option>
                            <option value="nombre_desc">Nombre Z-A</option>
                            <option value="rendimiento_desc">Mejor rendimiento</option>
                            <option value="rendimiento_asc">Peor rendimiento</option>
                            <option value="asistencia_desc">Mayor asistencia</option>
                            <option value="objetivos_desc">Mayor objetivos</option>
                        </select>
                    </div>
                    -->

                    <!-- Botones de acci√≥n -->
                    <div class="col-md-3">
                        <div class="d-flex gap-2">
                            <button type="button" id="btnLimpiarFiltrosMatriculados"
                                class="btn btn-outline-secondary btn-sm">
                                <i class="fas fa-times"></i> Limpiar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Contador de resultados -->
                <div class="row mt-2">
                    <div class="col-12">
                        <small class="text-muted" id="contadorMatriculados"></small>
                    </div>
                </div>
            </section>

            <section class="matriculas-container" id="matriculas-row">
                <h4>Alumnos Matriculados</h4>
                <div class="row g-3">
                    {% for m in allMatriculas %}
                    {% with per=m.fk_alumno.fk_persona_alumno %}
                    <div class="col-md-4">
                        <div class="card card-dark position-relative" id="alumno-card"
                            data-nombre="{{ per.nom1_persona }} {{ per.ape1_persona }}"
                            data-categoria="{{ m.fk_categoria.idcategoria }}"
                            data-rendimiento="{{ m.estadisticas.rendimiento }}"
                            data-porcentaje-asistencia="{{ m.estadisticas.porcentaje_asistencia }}"
                            data-porcentaje-objetivos="{{ m.estadisticas.porcentaje_objetivos }}"
                            data-calificacion-general="{{ m.estadisticas.calificacion_general }}">
                            {% if m.fk_alumno.foto and m.fk_alumno.foto.url %}
                            <img src="{{ m.fk_alumno.foto.url }}" alt="foto {{ per.nom1_persona }}">
                            {% else %}
                            <div class="card-placeholder"> <i class="fas fa-user"></i> </div>
                            {% endif %}

                            {% if m.estado_matricula %}
                            <div class="estado-badge estado-activo">‚úì Activo</div>
                            {% else %}
                            <div class="estado-badge estado-inactivo">‚úó Suspendido</div>
                            {% endif %}

                            <div class="card-body">
                                <h5 class="card-title">{{ per.nom1_persona }} {{ per.ape1_persona }}</h5>

                                <div class="alumno-info">
                                    <div><strong>ID:</strong> {{ per.id_persona }}</div>
                                    <div><strong>Categor√≠a:</strong> {{ m.fk_categoria.nom_categoria | default:"-" }}
                                    </div>
                                    <div><strong>Posici√≥n:</strong> {{ m.fk_alumno.fk_posicion.nom_posicion | default:"-" }}</div>
                                </div>

                                <div class="menu-action mt-3">
                                    <button type="button" class="btn btn-primary btn-sm editAlumnoBtn"
                                        data-id="{{ per.id_persona }}" data-nom1="{{ per.nom1_persona }}"
                                        data-nom2="{{ per.nom2_persona|default:'' }}" data-ape1="{{ per.ape1_persona }}"
                                        data-ape2="{{ per.ape2_persona|default:'' }}"
                                        data-fecha="{{ per.fecha_nacimiento|date:'Y-m-d' }}"
                                        data-direc="{{ per.direc_persona|default:'' }}"
                                        data-tel="{{ per.tel_persona|default:'' }}"
                                        data-email="{{ per.email_persona|default:'' }}"
                                        data-genero="{{ per.genero|default:'' }}" data-eps="{{ per.eps|default:'' }}"
                                        data-rh="{{ per.rh|default:'' }}"
                                        data-tipoidentidad="{{ per.tipo_identidad|default:'' }}"
                                        data-numidentidad="{{ per.id_persona }}"
                                        data-altura="{{ m.fk_alumno.altura_metros|default:'' }}"
                                        data-peso="{{ m.fk_alumno.peso_medidas|default:'' }}"
                                        data-imc="{{ m.fk_alumno.imc_medidas|default:'' }}"
                                        data-talla="{{ m.fk_alumno.talla|default:'' }}"
                                        data-calzado="{{ m.fk_alumno.calzado|default:'' }}"
                                        data-pie="{{ m.fk_alumno.pie_dominante|default:'' }}"
                                        data-nom1acudiente="{{ m.fk_alumno.fk_acudiente.nom1_acudiente|default:'' }}"
                                        data-nom2acudiente="{{ m.fk_alumno.fk_acudiente.nom2_acudiente|default:'' }}"
                                        data-ape1acudiente="{{ m.fk_alumno.fk_acudiente.ape1_acudiente|default:'' }}"
                                        data-ape2acudiente="{{ m.fk_alumno.fk_acudiente.ape2_acudiente|default:'' }}"
                                        data-telacudiente="{{ m.fk_alumno.fk_acudiente.tel_acudiente|default:'' }}"
                                        data-emailacudiente="{{ m.fk_alumno.fk_acudiente.email_acudiente|default:'' }}"
                                        data-parentesco="{{ m.fk_alumno.fk_acudiente.parentesco|default:'' }}"
                                        data-idacudiente="{{ m.fk_alumno.fk_acudiente.idacudiente }}"
                                        data-categoria="{{ m.fk_categoria.idcategoria }}"
                                        data-posicion="{{ m.fk_alumno.fk_posicion.idposicion|default:'' }}"
                                        data-matricula="{{ m.idmatricula }}"
                                        data-tradatos="{% if m.fk_alumno.tradatos %}{{ m.fk_alumno.tradatos.url }}{% endif %}"
                                        data-foto="{% if m.fk_alumno.foto %}{{ m.fk_alumno.foto.url }}{% endif %}"
                                        data-automedica="{% if m.fk_alumno.automedica %}{{ m.fk_alumno.automedica.url}}{% endif %}"
                                        data-certeps="{% if m.fk_alumno.certeps %}{{ m.fk_alumno.certeps.url }}{% endif %}"
                                        data-otraescuela="{% if m.fk_alumno.otraEscuela %}{{ m.fk_alumno.otraEscuela.url}}{% endif %}">
                                        <i class="fas fa-edit"></i> Editar
                                    </button>

                                    <!-- Cambiar estado: form que hace POST con nuevo valor -->
                                    <form method="post" style="display:inline-block;">
                                        {% csrf_token %}
                                        <input type="hidden" name="action" value="change_state">
                                        <input type="hidden" name="id_matricula" value="{{ m.idmatricula }}">
                                        <input type="hidden" name="nuevo_estado"
                                            value="{% if m.estado_matricula %}false{% else %}true{% endif %}">
                                        <button type="submit" class="btn btn-secondary btn-soft">
                                            {% if m.estado_matricula %}Suspender{% else %}Activar{% endif %}
                                        </button>
                                    </form>

                                    <form method="post" style="display:inline-block;">
                                        {% csrf_token %}
                                        <input type="hidden" name="action" value="generate_carnet">
                                        <input type="hidden" name="persona_id" value="{{ per.id_persona }}">
                                        <button type="submit" class="btn btn-warning btn-sm">
                                            <i class="fas fa-id-card"></i> Generar Carnet
                                        </button>
                                    </form>
                                </div>

                                <div class="estadisticas-container mt-3 p-2 border-top">
                                    <!-- Barra de asistencia -->
                                    <div class="mb-2">
                                        <small class="d-flex justify-content-between">
                                            <span>Asistencia:</span>
                                            <strong>{{ m.estadisticas.porcentaje_asistencia }}%</strong>
                                        </small>
                                        <div class="progress" style="height: 6px;">
                                            <div class="progress-bar bg-success" role="progressbar"
                                                style="width: {{ m.estadisticas.porcentaje_asistencia }}%"></div>
                                        </div>
                                        <small class="text-muted">
                                            {{ m.estadisticas.total_asistencias }}/{{ m.estadisticas.total_entrenamientos }} sesiones
                                        </small>
                                    </div>

                                    <!-- Barra de objetivos -->
                                    <div class="mb-2">
                                        <small class="d-flex justify-content-between">
                                            <span>Objetivos:</span>
                                            <strong>{{ m.estadisticas.porcentaje_objetivos }}%</strong>
                                        </small>
                                        <div class="progress" style="height: 6px;">
                                            <div class="progress-bar bg-info" role="progressbar"
                                                style="width: {{ m.estadisticas.porcentaje_objetivos }}%"></div>
                                        </div>
                                        <small class="text-muted">
                                            {{ m.estadisticas.total_objetivos_cumplidos }}/{{ m.estadisticas.total_objetivos_evaluados }} cumplidos
                                        </small>
                                    </div>

                                    <!-- Calificaci√≥n general -->
                                    <div class="mt-2 text-center">
                                        <span class="badge 
                    {% if m.estadisticas.rendimiento == 'Excelente' %}bg-success
                    {% elif m.estadisticas.rendimiento == 'Regular' %}bg-warning
                    {% else %}bg-danger{% endif %} p-2">
                                            {{ m.estadisticas.rendimiento }}: {{ m.estadisticas.calificacion_general }}%
                                        </span>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                    {% endwith %}
                    {% empty %}
                    <div class="col-12 small-muted">No hay matr√≠culas para este a√±o.</div>
                    {% endfor %}
                </div>

                {% if info_u.tipo_personal == 'Administrador' or categorias_usuario %}
                <div class="mb-3">
                    <button type="button" class="btn btn-warning" data-bs-toggle="modal"
                        data-bs-target="#terminarPeriodoModal">
                        Terminar Per√≠odo Acad√©mico
                    </button>
                </div>
                {% endif %}
            </section>
        </div>

        <div data-content id="postulantes">
            <section class="titulo-seccion">
                <h3>üßë‚Äçüßí‚Äçüßí Postulantes registrados üì©üì´</h3>
                <div class="line"></div>
            </section>
            <section class="filtros-container mb-4">
                <div class="row">
                    <!-- B√∫squeda en tiempo real -->
                    <div class="col-md-3">
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input type="text" id="buscarPostulantes" class="form-control"
                                placeholder="Buscar por nombre, apellido, email...">
                        </div>
                    </div>

                    <!-- Filtro por categor√≠a sugerida -->
                    <div class="col-md-3">
                        <select name="fk_categoria" id="filtroCategoria" class="form-select">
                            <option value="">Todas las categor√≠as</option>
                            {% for c in categorias_usuario %}
                            <option value="{{ c.idcategoria }}">{{ c.nom_categoria }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Ordenamiento -->
                    <div class="col-md-3">
                        <select id="ordenarPostulantes" class="form-select">
                            <option value="recientes">M√°s recientes primero</option>
                            <option value="antiguos">M√°s antiguos primero</option>
                            <option value="nombre_asc">Nombre A-Z</option>
                            <option value="nombre_desc">Nombre Z-A</option>
                        </select>
                    </div>

                    <!-- Botones de acci√≥n -->
                    <div class="col-md-3">
                        <div class="d-flex gap-2">
                            <button type="button" id="btnLimpiarFiltros" class="btn btn-outline-secondary btn-sm">
                                <i class="fas fa-times"></i> Limpiar
                            </button>
                            <button type="button" id="btnResetearOrden" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-sort"></i> Orden Original
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Contador de resultados -->
                <div class="row mt-2">
                    <div class="col-12">
                        <small class="text-muted" id="contadorResultados"></small>
                    </div>
                </div>
            </section>
            <section class="postulantes-container">
                <div class="row g-3" id="postulantes-row">
                    {% for p in allPostulantes %}
                    {% with per=p.fk_persona_alumno %}
                    <div class="col-md-4">
                        <div class="position-relative"
                            style="border:1px solid #ddd; border-radius:8px; padding:25px; background:#63a2e0; box-shadow:0 2px 6px rgba(0,0,0,0.1);">
                            {% if p.foto and p.foto.url %}
                            <img src="{{ p.foto.url }}" alt="foto {{ per.nom1_persona }}">
                            {% else %}
                            <div class="card-placeholder"> <i class="fas fa-user"></i> </div>
                            {% endif %}
                            <div class="card-body">
                                <h5 class="card-title">{{ per.nom1_persona }} {{ per.ape1_persona }}</h5>
                                <div class="alumno-info">
                                    <div><strong>Tel:</strong> {{ per.tel_persona|default:"-" }}</div>
                                    <div><strong>Email:</strong> {{ per.email_persona|default:"-" }}</div>
                                    <div><strong>Posici√≥n:</strong> {{ p.fk_posicion.nom_posicion | default:"-"}}</div>
                                    <div>
                                        <strong>Categor√≠a sugerida:</strong>
                                        <span class="categoria-sugerida"
                                            data-edad="{{ p.fk_persona_alumno.fecha_nacimiento|date:'Y-m-d' }}">Calculando...</span>
                                    </div>

                                    <div class="fecha-postulacion" data-fecha="{{ per.fecha_registro|date:'Y-m-d' }}">
                                        <strong>Fecha de postulacion:</strong> {{ per.fecha_registro|date:"d/m/Y"|default:"Fecha no disponible" }}
                                    </div>
                                </div>

                                <div class="menu-action mt-3">
                                    <!-- Bot√≥n ver (data-*) - ACTUALIZADO CON TODOS LOS CAMPOS -->
                                    <button type="button" class="btn btn-info btn-soft btn-ver-info"
                                        data-nom="{{ per.nom1_persona }}" data-nom2="{{ per.nom2_persona|default:'' }}"
                                        data-ape="{{ per.ape1_persona }}" data-ape2="{{ per.ape2_persona|default:'' }}"
                                        data-id="{{ per.id }}" data-id-persona="{{ per.id_persona }}"
                                        data-fecha="{{ per.fecha_nacimiento|date:'Y-m-d' }}"
                                        data-direc="{{ per.direc_persona|default:'' }}"
                                        data-tel="{{ per.tel_persona|default:'' }}"
                                        data-email="{{ per.email_persona|default:'' }}"
                                        data-genero="{{ per.genero|default:'' }}" data-eps="{{ per.eps|default:'' }}"
                                        data-rh="{{ per.rh|default:'' }}"
                                        data-tipo-identidad="{{ per.tipo_identidad|default:'' }}"
                                        data-altura="{{ p.altura_metros|default:'' }}"
                                        data-peso="{{ p.peso_medidas|default:'' }}"
                                        data-imc="{{ p.imc_medidas|default:'' }}" data-talla="{{ p.talla|default:'' }}"
                                        data-calzado="{{ p.calzado|default:'' }}"
                                        data-pie-dominante="{{ p.pie_dominante|default:'' }}"
                                        data-posicion="{{ p.fk_posicion.nom_posicion|default:'' }}"
                                        data-nom1-acudiente="{{ p.fk_acudiente.nom1_acudiente|default:'' }}"
                                        data-nom2-acudiente="{{ p.fk_acudiente.nom2_acudiente|default:'' }}"
                                        data-ape1-acudiente="{{ p.fk_acudiente.ape1_acudiente|default:'' }}"
                                        data-ape2-acudiente="{{ p.fk_acudiente.ape2_acudiente|default:'' }}"
                                        data-tel-acudiente="{{ p.fk_acudiente.tel_acudiente|default:'' }}"
                                        data-email-acudiente="{{ p.fk_acudiente.email_acudiente|default:'' }}"
                                        data-parentesco="{{ p.fk_acudiente.parentesco|default:'' }}"
                                        data-id-acudiente="{{ p.fk_acudiente.idacudiente|default:'' }}"
                                        data-tradatos="{% if p.tradatos %}{{ p.tradatos.url }}{% endif %}"
                                        data-foto="{% if p.foto %}{{ p.foto.url }}{% endif %}"
                                        data-automedica="{% if p.automedica %}{{ p.automedica.url }}{% endif %}"
                                        data-certeps="{% if p.certeps %}{{ p.certeps.url }}{% endif %}"
                                        data-otraescuela="{% if p.otraEscuela %}{{ p.otraEscuela.url }}{% endif %}">
                                        <i class="fas fa-eye"></i> Info Completa
                                    </button>

                                    <!-- Bot√≥n aceptar -->
                                    <form method="post" style="display:inline-block;">
                                        {% csrf_token %}
                                        <input type="hidden" name="action" value="accept">
                                        <input type="hidden" name="id_persona" value="{{ per.id }}">
                                        <input type="hidden" name="fk_categoria" value="">
                                        <button type="submit" class="btn btn-success btn-soft">
                                            <i class="fas fa-thumbs-up"></i> Aceptar
                                        </button>
                                    </form>

                                    <!-- Bot√≥n rechazar -->
                                    <button type="button" class="btn btn-danger btn-soft btn-open-rechazar"
                                        data-id="{{ per.id }}" data-nom="{{ per.nom1_persona|escapejs }}">
                                        <i class="fas fa-thumbs-down"></i> Rechazar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endwith %}
                    {% empty %}
                    <div class="col-12">
                        <div class="small-muted">No hay postulantes.</div>
                    </div>
                    {% endfor %}
                </div>
            </section>
        </div>
    </section>
</div>

<!-- ================= MODAL: VER INFO POSTULANTE COMPLETO ================= -->
<div class="modal fade" id="modalInfo" tabindex="-1" aria-labelledby="infoPostulanteLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Informaci√≥n Completa del Postulante</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modalInfoBody">
                <!-- Se llena din√°micamente por JavaScript -->
            </div>
        </div>
    </div>
</div>

<!-- ================= MODAL: RECHAZAR CON MENSAJE PERSONALIZADO ================= -->
<div class="modal fade modal-lg" id="modalRechazar" tabindex="-1" aria-labelledby="rechazarLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h4 class="modal-title" id="rechazarLabel">
                    <i class="fas fa-times-circle me-2"></i>Rechazar Postulante
                </h4>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <form method="post" id="form-rechazar">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="reject">
                    <input type="hidden" id="rechazar_id_persona" name="id_persona">

                    <div class="mb-3">
                        <p id="texto-rechazar" class="fw-bold fs-5"></p>
                        <p class="text-muted small">Esta acci√≥n no se puede deshacer.</p>
                    </div>

                    <div class="mb-3">
                        <label for="mensajeRechazo" class="form-label">
                            <i class="fas fa-comment me-1"></i>Mensaje de rechazo (opcional)
                        </label>
                        <textarea class="form-control" id="mensajeRechazo" name="mensaje_rechazo" rows="4" placeholder="Ej: No cumple con los requisitos de edad para ninguna categor√≠a disponible...
O: Documentaci√≥n incompleta...
O: Capacidad m√°xima alcanzada en la categor√≠a correspondiente..." maxlength="500"></textarea>
                        <div class="form-text">
                            Este mensaje se incluir√° en el correo de notificaci√≥n. M√°ximo 500 caracteres.
                            <span id="contadorCaracteres" class="badge bg-secondary">0/500</span>
                        </div>
                    </div>

                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Advertencia:</strong> El postulante ser√° eliminado del sistema y se enviar√° una
                        notificaci√≥n por correo.
                    </div>

                    <div class="d-flex gap-2 justify-content-end">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i>Cancelar
                        </button>
                        <button type="submit" class="btn btn-danger">
                            <i class="fas fa-thumbs-down me-1"></i>Confirmar Rechazo
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- ================= MODAL: EDITAR ================= -->
<div class="modal fade" id="editAlumnoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="POST" enctype="multipart/form-data" id="editAlumnoForm">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title">Editar Alumno Matriculado</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="action" value="edit">
                    <input type="hidden" name="persona_id" id="edit_persona_id">
                    <input type="hidden" name="idmatricula" id="edit_matricula_id">
                    <input type="hidden" name="idacudiente_actual" id="edit_idacudiente_actual">

                    <!-- Informaci√≥n de Identificaci√≥n (NO EDITABLE) -->
                    <div class="card mb-3">
                        <div class="card-header bg-secondary text-white">
                            <h6 class="mb-0">üìÑ Documentos de Identificaci√≥n (No editable)</h6>
                        </div>
                        <div class="card-body">
                            <div class="row mb-2">
                                <div class="col-md-4">
                                    <label>Tipo de Identificaci√≥n</label>
                                    <input type="text" id="edit_tipo_identidad_display" class="form-control" readonly
                                        style="background-color: #e9ecef;">
                                    <input type="hidden" name="tipo_identidad" id="edit_tipo_identidad">
                                </div>
                                <div class="col-md-4">
                                    <label>N√∫mero de Identificaci√≥n</label>
                                    <input type="text" id="edit_num_identidad_display" class="form-control" readonly
                                        style="background-color: #e9ecef;">
                                    <input type="hidden" name="num_identidad" id="edit_num_identidad">
                                </div>
                                <div class="col-md-4">
                                    <label>Fecha de Nacimiento</label>
                                    <input type="text" id="edit_fecha_display" class="form-control" readonly
                                        style="background-color: #e9ecef;">
                                    <input type="hidden" name="fecha_nacimiento" id="edit_fecha">
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-md-6">
                                    <label>Tipo de Sangre (RH)</label>
                                    <input type="text" id="edit_rh_display" class="form-control" readonly
                                        style="background-color: #e9ecef;">
                                    <input type="hidden" name="rh" id="edit_rh">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Informaci√≥n Personal (EDITABLE) -->
                    <div class="card mb-3">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0">üë§ Informaci√≥n Personal (Editable)</h6>
                        </div>
                        <div class="card-body">
                            <div class="row mb-2">
                                <div class="col">
                                    <label>Primer Nombre</label>
                                    <input type="text" name="nom1_persona" id="edit_nom1" class="form-control"
                                        placeholder="Ingresa el primer nombre">
                                    <div class="invalid-feedback">Solo letras, m√°ximo 20 caracteres</div>
                                </div>
                                <div class="col">
                                    <label>Segundo Nombre</label>
                                    <input type="text" name="nom2_persona" id="edit_nom2" class="form-control"
                                        placeholder="Ingresa el segundo nombre">
                                    <div class="invalid-feedback">Solo letras, m√°ximo 20 caracteres</div>
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col">
                                    <label>Primer Apellido</label>
                                    <input type="text" name="ape1_persona" id="edit_ape1" class="form-control"
                                        placeholder="Ingresa el primer apellido">
                                    <div class="invalid-feedback">Solo letras, m√°ximo 20 caracteres</div>
                                </div>
                                <div class="col">
                                    <label>Segundo Apellido</label>
                                    <input type="text" name="ape2_persona" id="edit_ape2" class="form-control"
                                        placeholder="Ingresa el segundo apellido">
                                    <div class="invalid-feedback">Solo letras, m√°ximo 20 caracteres</div>
                                </div>
                            </div>

                            <div class="row mb-2">
                                <div class="col">
                                    <label>Direcci√≥n</label>
                                    <input type="text" name="direc_persona" id="edit_direc" class="form-control"
                                        placeholder="Ingresa la direcci√≥n">
                                    <div class="invalid-feedback">M√°ximo 40 caracteres permitidos</div>
                                </div>
                                <div class="col">
                                    <label>Tel√©fono</label>
                                    <input type="tel" name="tel_persona" id="edit_tel" class="form-control"
                                        placeholder="Ingresa 10 d√≠gitos">
                                    <div class="invalid-feedback">Debe tener exactamente 10 d√≠gitos</div>
                                </div>
                            </div>

                            <div class="row mb-2">
                                <div class="col">
                                    <label>Email</label>
                                    <input type="email" name="email_persona" id="edit_email" class="form-control"
                                        placeholder="ejemplo@correo.com">
                                    <div class="invalid-feedback">Formato de email inv√°lido o m√°ximo 40 caracteres</div>
                                </div>
                                <div class="col">
                                    <label>G√©nero</label>
                                    <select name="genero" id="edit_genero" class="form-select">
                                        <option value="">Seleccionar</option>
                                        {% for genero in generos %}
                                        <option value="{{ genero.0 }}">{{ genero.1 }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>

                            <div class="row mb-2">
                                <div class="col">
                                    <label>EPS</label>
                                    <select name="eps" id="edit_eps" class="form-select">
                                        <option value="">Seleccionar</option>
                                        {% for ep in eps %}
                                        <option value="{{ ep.0 }}">{{ ep.1 }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Medidas F√≠sicas (EDITABLE) -->
                    <div class="card mb-3">
                        <div class="card-header bg-warning text-dark">
                            <h6 class="mb-0">üìè Medidas F√≠sicas (Editable)</h6>
                        </div>
                        <div class="card-body">
                            <div class="row mb-2">
                                <div class="col">
                                    <label>Altura (metros)</label>
                                    <input type="number" step="0.01" name="altura_metros" id="edit_altura"
                                        class="form-control" min="0.5" max="2.5" placeholder="Ej: 1.65">
                                    <div class="invalid-feedback">La altura debe estar entre 0.5 y 2.5 metros</div>
                                </div>
                                <div class="col">
                                    <label>Peso (kg)</label>
                                    <input type="number" step="0.1" name="peso_medidas" id="edit_peso"
                                        class="form-control" min="10" max="150" placeholder="Ej: 55.5">
                                    <div class="invalid-feedback">El peso debe estar entre 10 y 150 kg</div>
                                </div>
                                <div class="col">
                                    <label>IMC (autom√°tico)</label>
                                    <input type="number" step="0.01" name="imc_medidas" id="edit_imc"
                                        class="form-control" readonly style="background-color: #f8f9fa;">
                                </div>
                            </div>

                            <div class="row mb-2">
                                <div class="col">
                                    <label>Talla de ropa</label>
                                    <select name="talla" id="edit_talla" class="form-select">
                                        <option value="">Seleccionar</option>
                                        {% for talla in talla_ropa %}
                                        <option value="{{ talla.0 }}">{{ talla.1 }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col">
                                    <label>Talla de calzado</label>
                                    <input type="number" name="calzado" id="edit_calzado" class="form-control" min="15"
                                        max="50" placeholder="Ej: 38">
                                    <div class="invalid-feedback">La talla debe estar entre 15 y 50</div>
                                </div>
                                <div class="col">
                                    <label>Pie Dominante</label>
                                    <select name="pie_dominante" id="edit_pie" class="form-select">
                                        <option value="">Seleccionar</option>
                                        {% for pie in pie_dom %}
                                        <option value="{{ pie.0 }}">{{ pie.1 }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Informaci√≥n Acad√©mica/Deportiva (EDITABLE) -->
                    <div class="card mb-3">
                        <div class="card-header bg-success text-white">
                            <h6 class="mb-0">‚öΩ Informaci√≥n Deportiva (Editable)</h6>
                        </div>
                        <div class="card-body">
                            <div class="row mb-2">
                                <div class="col">
                                    <label>Categor√≠a</label>
                                    <select name="fk_categoria" id="edit_categoria" class="form-select">
                                        {% for cat in categorias_usuario %}
                                        <option value="{{ cat.idcategoria }}">{{ cat.nom_categoria }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col">
                                    <label>Posici√≥n</label>
                                    <select name="fk_posicion" id="edit_posicion" class="form-select">
                                        <option value="">Seleccionar</option>
                                        {% for pos in posiciones %}
                                        <option value="{{ pos.idposicion }}">{{ pos.nom_posicion }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Informaci√≥n del Acudiente (EDITABLE) -->
                    <div class="card mb-3">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Informaci√≥n del Acudiente (Editable)</h6>
                        </div>
                        <div class="card-body">
                            <div class="row mb-2">
                                <div class="col">
                                    <label>ID del Acudiente *</label>
                                    <input type="text" name="idacudiente" id="edit_idacudiente" class="form-control"
                                        placeholder="Ingresa el ID del acudiente" required>
                                    <div class="invalid-feedback">El ID del acudiente es requerido</div>
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col">
                                    <label>Primer Nombre Acudiente</label>
                                    <input type="text" name="nom1_acudiente" id="edit_nom1_acudiente"
                                        class="form-control" placeholder="Ingresa el primer nombre">
                                    <div class="invalid-feedback">Solo letras, m√°ximo 20 caracteres</div>
                                </div>
                                <div class="col">
                                    <label>Segundo Nombre Acudiente</label>
                                    <input type="text" name="nom2_acudiente" id="edit_nom2_acudiente"
                                        class="form-control" placeholder="Ingresa el segundo nombre">
                                    <div class="invalid-feedback">Solo letras, m√°ximo 20 caracteres</div>
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col">
                                    <label>Primer Apellido Acudiente</label>
                                    <input type="text" name="ape1_acudiente" id="edit_ape1_acudiente"
                                        class="form-control" placeholder="Ingresa el primer apellido">
                                    <div class="invalid-feedback">Solo letras, m√°ximo 20 caracteres</div>
                                </div>
                                <div class="col">
                                    <label>Segundo Apellido Acudiente</label>
                                    <input type="text" name="ape2_acudiente" id="edit_ape2_acudiente"
                                        class="form-control" placeholder="Ingresa el segundo apellido">
                                    <div class="invalid-feedback">Solo letras, m√°ximo 20 caracteres</div>
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col">
                                    <label>Tel√©fono Acudiente</label>
                                    <input type="tel" name="tel_acudiente" id="edit_telacud" class="form-control"
                                        placeholder="Ingresa 10 d√≠gitos">
                                    <div class="invalid-feedback">Debe tener exactamente 10 d√≠gitos</div>
                                </div>
                                <div class="col">
                                    <label>Email Acudiente</label>
                                    <input type="email" name="email_acudiente" id="edit_emailacud" class="form-control"
                                        placeholder="ejemplo@correo.com">
                                    <div class="invalid-feedback">Formato de email inv√°lido</div>
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col">
                                    <label>Parentesco</label>
                                    <select name="parentesco" id="edit_parentesco" class="form-select">
                                        <option value="">Seleccionar</option>
                                        {% for parent in parentescos %}
                                        <option value="{{ parent.0 }}">{{ parent.1 }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Archivos (SOLO AUTORIZACI√ìN M√âDICA Y EPS EDITABLES) -->
                    <div class="card mb-3">
                        <div class="card-header bg-dark text-white">
                            <h6 class="mb-0">üìÅ Documentos</h6>
                        </div>
                        <div class="card-body">
                            <!-- Archivos EXISTENTES (solo visualizaci√≥n) -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label>Tratamiento de Datos (No editable)</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="edit_tradatos_display" readonly
                                            style="background-color: #e9ecef;" placeholder="Documento cargado">
                                        <button type="button" class="btn btn-outline-primary btn-sm"
                                            onclick="verDocumento('tradatos')" id="btn_ver_tradatos">
                                            üëÅÔ∏è Ver
                                        </button>
                                    </div>
                                    <input type="hidden" name="tradatos_existente" id="edit_tradatos_existente">
                                </div>
                                <div class="col-md-6">
                                    <label>Foto (No editable)</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="edit_foto_display" readonly
                                            style="background-color: #e9ecef;" placeholder="Foto cargada">
                                        <button type="button" class="btn btn-outline-primary btn-sm"
                                            onclick="verDocumento('foto')" id="btn_ver_foto">
                                            üëÅÔ∏è Ver
                                        </button>
                                    </div>
                                    <input type="hidden" name="foto_existente" id="edit_foto_existente">
                                </div>
                            </div>

                            <!-- Archivos EDITABLES -->
                            <div class="row">
                                <div class="col-md-6">
                                    <label>Autorizaci√≥n M√©dica</label>
                                    <div class="mb-2">
                                        <div class="input-group mb-2">
                                            <input type="text" class="form-control" id="edit_automedica_display"
                                                readonly style="background-color: #e9ecef;"
                                                placeholder="Documento cargado">
                                            <button type="button" class="btn btn-outline-primary btn-sm"
                                                onclick="verDocumento('automedica')" id="btn_ver_automedica">
                                                üëÅÔ∏è Ver
                                            </button>
                                        </div>
                                        <input type="hidden" name="automedica_existente" id="edit_automedica_existente">
                                    </div>
                                    <input type="file" name="automedica" id="edit_automedica" class="form-control"
                                        accept=".pdf,.doc,.docx">
                                    <div class="invalid-feedback">Formato permitido: PDF, DOC, DOCX (m√°x. 5MB)</div>
                                    <small class="text-muted">Puedes subir un nuevo documento si es necesario</small>
                                </div>
                                <div class="col-md-6">
                                    <label>Comprobante EPS</label>
                                    <div class="mb-2">
                                        <div class="input-group mb-2">
                                            <input type="text" class="form-control" id="edit_certeps_display" readonly
                                                style="background-color: #e9ecef;" placeholder="Documento cargado">
                                            <button type="button" class="btn btn-outline-primary btn-sm"
                                                onclick="verDocumento('certeps')" id="btn_ver_certeps">
                                                üëÅÔ∏è Ver
                                            </button>
                                        </div>
                                        <input type="hidden" name="certeps_existente" id="edit_certeps_existente">
                                    </div>
                                    <input type="file" name="certeps" id="edit_certeps" class="form-control"
                                        accept=".pdf,.doc,.docx">
                                    <div class="invalid-feedback">Formato permitido: PDF, DOC, DOCX (m√°x. 5MB)</div>
                                    <small class="text-muted">Puedes subir un nuevo documento si es necesario</small>
                                </div>
                            </div>

                            <!-- Otros documentos (solo visualizaci√≥n) -->
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <label>Certificado Otra Escuela (No editable)</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="edit_otraescuela_display" readonly
                                            style="background-color: #e9ecef;" placeholder="Documento cargado">
                                        <button type="button" class="btn btn-outline-primary btn-sm"
                                            onclick="verDocumento('otraescuela')" id="btn_ver_otraescuela">
                                            üëÅÔ∏è Ver
                                        </button>
                                    </div>
                                    <input type="hidden" name="otraescuela_existente" id="edit_otraescuela_existente">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-success">üíæ Guardar Cambios</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‚ùå Cancelar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Terminar Per√≠odo -->
<div class="modal fade" id="terminarPeriodoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Terminar Per√≠odo Acad√©mico</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <label for="categoriaSelect">Selecciona una categor√≠a:</label>
                <select id="categoriaSelect" class="form-select mb-3">
                    <option value="">-- Selecciona --</option>
                    {% for cat in categorias_usuario %} <!-- ‚úÖ Aseg√∫rate que dice categorias_usuario -->
                    <option value="{{ cat.idcategoria }}">{{ cat.nom_categoria }}</option>
                    {% endfor %}
                </select>

                <div>
                    <input type="checkbox" id="checkAll"> <label for="checkAll"><strong>Seleccionar
                            Todos</strong></label>
                </div>

                <ul id="listaMatriculas" class="list-group mt-2" style="max-height:300px; overflow-y:auto;">
                    <!-- Aqu√≠ se cargan los alumnos din√°micamente -->
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" id="btnTerminarPeriodo" class="btn btn-success">Terminar Per√≠odo</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- ================= MODAL: CONFIRMAR TERMINAR PERIODO ================= -->
<div class="modal fade" id="confirmarTerminarModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">‚ö†Ô∏è Confirmar Terminar Per√≠odo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="confirmarTexto">¬øEst√°s seguro de terminar el per√≠odo para <span id="cantidadAlumnos">0</span>
                    alumno(s)?</p>
                <small>
                    <strong>üìù Qu√© pasar√°:</strong><br>
                    ‚Ä¢ Las matr√≠culas se marcar√°n como inactivas<br>
                    ‚Ä¢ Se generar√°n c√≥digos de renovaci√≥n<br>
                    ‚Ä¢ Se enviar√°n emails a los alumnos
                </small>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="btnConfirmarTerminar">Terminar Per√≠odo</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="{% static 'partida/scripts/paginas.js' %}"></script>
<script src="{% static 'matricula/scripts/matricula.js' %}"></script>

<script>
    // Funci√≥n principal que se ejecuta cuando todo est√° listo
    function inicializarMatriculas() {
        console.log('Cargando matr√≠culas via AJAX...');

        // 1. INICIALIZAR FILTROS INMEDIATAMENTE (no esperar a AJAX)
        inicializarFiltrosPostulantes();

        // Hacer petici√≥n al servidor para obtener las matr√≠culas
        fetch("{% url 'get_matriculas_json' %}")
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error en la respuesta: ' + response.status);
                }
                return response.json();
            })
            .then(matriculasData => {
                console.log('Matr√≠culas cargadas via AJAX:', matriculasData);

                // Inicializar los event listeners con los datos cargados
                inicializarEventListeners(matriculasData);
            })
            .catch(error => {
                console.error('Error cargando matr√≠culas:', error);
                alert('Error cargando los datos de matr√≠culas');
                // Inicializar con array vac√≠o si hay error
                inicializarEventListeners([]);
            });
    }

    // ================= FILTROS PARA MATRICULADOS (Versi√≥n simplificada y funcional) =================
function inicializarFiltrosMatriculados() {
    console.log('üîß Inicializando filtros para matriculados...');
    
    const buscarInput = document.getElementById('buscarMatriculados');
    const filtroCategoria = document.getElementById('filtroCategoriaMatriculados');
    const filtroRendimiento = document.getElementById('filtroRendimiento');
    const ordenarSelect = document.getElementById('ordenarMatriculados');
    const btnLimpiar = document.getElementById('btnLimpiarFiltrosMatriculados');
    
    if (!buscarInput) {
        console.log('‚ùå No se encontr√≥ el campo de b√∫squeda');
        return;
    }
    
    // Event listeners simples
    if (buscarInput) {
        buscarInput.addEventListener('input', function() {
            console.log('üîç B√∫squeda cambiada:', this.value);
            aplicarFiltrosMatriculados();
        });
    }
    
    if (filtroCategoria) {
        filtroCategoria.addEventListener('change', function() {
            console.log('üìä Categor√≠a cambiada:', this.value);
            aplicarFiltrosMatriculados();
        });
    }
    
    if (filtroRendimiento) {
        filtroRendimiento.addEventListener('change', function() {
            console.log('üìà Rendimiento cambiado:', this.value);
            aplicarFiltrosMatriculados();
        });
    }
    
    if (ordenarSelect) {
        ordenarSelect.addEventListener('change', function() {
            console.log('üîÄ Orden cambiado:', this.value);
            aplicarFiltrosMatriculados();
        });
    }
    
    if (btnLimpiar) {
        btnLimpiar.addEventListener('click', function() {
            limpiarFiltrosMatriculados();
        });
    }
    
    console.log('‚úÖ Filtros para matriculados inicializados');
    aplicarFiltrosMatriculados(); // Aplicar filtros iniciales
}

function aplicarFiltrosMatriculados() {
    console.log('üîç Aplicando filtros a matriculados...');
    
    // Obtener valores de filtros
    const buscarTexto = document.getElementById('buscarMatriculados')?.value.toLowerCase() || '';
    const filtroCategoria = document.getElementById('filtroCategoriaMatriculados')?.value || '';
    const filtroRendimiento = document.getElementById('filtroRendimiento')?.value || 'todos';
    const orden = document.getElementById('ordenarMatriculados')?.value || 'nombre_asc';
    
    console.log(`Filtros: B√∫squeda="${buscarTexto}", Categor√≠a="${filtroCategoria}", Rendimiento="${filtroRendimiento}", Orden="${orden}"`);
    
    // Obtener todas las tarjetas - BUSCAR EL CARD DENTRO DEL COL-MD-4
    const tarjetas = document.querySelectorAll('#matriculas-row .col-md-4');
    console.log(`üìä Total tarjetas encontradas: ${tarjetas.length}`);
    
    if (tarjetas.length === 0) {
        console.log('‚ö†Ô∏è No se encontraron tarjetas de matriculados');
        return;
    }
    
    let tarjetasVisibles = 0;
    const tarjetasArray = Array.from(tarjetas);
    
    // Aplicar filtros a cada tarjeta
    tarjetasArray.forEach((colElement, index) => {
        // Obtener el elemento .card que tiene los data-attributes
        const cardElement = colElement.querySelector('.card');
        
        if (!cardElement) {
            console.log(`‚ùå Tarjeta ${index} no tiene elemento .card`);
            return;
        }
        
        // Obtener datos de la tarjeta desde el .card
        const nombre = cardElement.getAttribute('data-nombre')?.toLowerCase() || '';
        const categoria = cardElement.getAttribute('data-categoria') || '';
        const rendimiento = cardElement.getAttribute('data-rendimiento') || '';
        
        // Obtener valores num√©ricos para ordenamiento
        const asistencia = parseFloat(cardElement.getAttribute('data-porcentaje-asistencia')) || 0;
        const objetivos = parseFloat(cardElement.getAttribute('data-porcentaje-objetivos')) || 0;
        const calificacion = parseFloat(cardElement.getAttribute('data-calificacion-general')) || 0;
        
        console.log(`Tarjeta ${index}: "${nombre}", Categor√≠a: ${categoria}, Rendimiento: ${rendimiento}`);
        
        // Aplicar filtros
        const coincideBusqueda = !buscarTexto || nombre.includes(buscarTexto);
        const coincideCategoria = !filtroCategoria || categoria === filtroCategoria;
        
        // Filtrar por rendimiento
        let coincideRendimiento = true;
        if (filtroRendimiento !== 'todos') {
            if (filtroRendimiento === 'Sin datos') {
                coincideRendimiento = !rendimiento || rendimiento === 'Sin datos';
            } else {
                coincideRendimiento = rendimiento === filtroRendimiento;
            }
        }
        
        // Mostrar/ocultar seg√∫n filtros
        if (coincideBusqueda && coincideCategoria && coincideRendimiento) {
            colElement.style.display = 'block';
            tarjetasVisibles++;
        } else {
            colElement.style.display = 'none';
        }
    });
    
    console.log(`‚úÖ Filtros aplicados. Tarjetas visibles: ${tarjetasVisibles}/${tarjetas.length}`);
    
    // Ordenar las tarjetas visibles
    ordenarTarjetasMatriculados(orden, tarjetasArray);
    
    // Actualizar contador
    actualizarContadorMatriculados(tarjetasVisibles, tarjetas.length);
    
    // Mostrar mensaje si no hay resultados
    mostrarMensajeSinResultadosMatriculados(tarjetasVisibles);
}

function ordenarTarjetasMatriculados(orden, tarjetasArray) {
    console.log(`üîÑ Ordenando por: ${orden}`);
    
    // Filtrar solo las tarjetas visibles
    const tarjetasVisibles = tarjetasArray.filter(t => t.style.display !== 'none');
    
    if (tarjetasVisibles.length === 0) {
        console.log('‚ö†Ô∏è No hay tarjetas visibles para ordenar');
        return;
    }
    
    // Ordenar las tarjetas visibles
    tarjetasVisibles.sort((a, b) => {
        const cardA = a.querySelector('.card');
        const cardB = b.querySelector('.card');
        
        if (!cardA || !cardB) return 0;
        
        const nombreA = cardA.getAttribute('data-nombre')?.toLowerCase() || '';
        const nombreB = cardB.getAttribute('data-nombre')?.toLowerCase() || '';
        const calificacionA = parseFloat(cardA.getAttribute('data-calificacion-general')) || 0;
        const calificacionB = parseFloat(cardB.getAttribute('data-calificacion-general')) || 0;
        const asistenciaA = parseFloat(cardA.getAttribute('data-porcentaje-asistencia')) || 0;
        const asistenciaB = parseFloat(cardB.getAttribute('data-porcentaje-asistencia')) || 0;
        const objetivosA = parseFloat(cardA.getAttribute('data-porcentaje-objetivos')) || 0;
        const objetivosB = parseFloat(cardB.getAttribute('data-porcentaje-objetivos')) || 0;
        
        let resultado = 0;
        
        switch (orden) {
            case 'nombre_asc':
                resultado = nombreA.localeCompare(nombreB);
                break;
            case 'nombre_desc':
                resultado = nombreB.localeCompare(nombreA);
                break;
            case 'rendimiento_desc':
                resultado = calificacionB - calificacionA;
                break;
            case 'rendimiento_asc':
                resultado = calificacionA - calificacionB;
                break;
            case 'asistencia_desc':
                resultado = asistenciaB - asistenciaA;
                break;
            case 'objetivos_desc':
                resultado = objetivosB - objetivosA;
                break;
        }
        
        return resultado;
    });
    
    // Reordenar en el DOM
    const contenedor = document.querySelector('#matriculas-row .row.g-3');
    if (contenedor) {
        // Vaciar contenedor
        tarjetasArray.forEach(colElement => {
            contenedor.removeChild(colElement);
        });
        
        // Agregar tarjetas ordenadas
        tarjetasArray.forEach(colElement => {
            contenedor.appendChild(colElement);
        });
        
        console.log(`‚úÖ Ordenamiento completado. ${tarjetasVisibles.length} tarjetas ordenadas`);
    }
}

function actualizarContadorMatriculados(visibles, total) {
    const contador = document.getElementById('contadorMatriculados');
    if (contador) {
        if (visibles === total) {
            contador.textContent = `Mostrando todos los ${total} alumnos matriculados`;
        } else {
            contador.textContent = `Mostrando ${visibles} de ${total} alumnos matriculados`;
        }
    }
}

function mostrarMensajeSinResultadosMatriculados(visibles) {
    let mensajeExistente = document.getElementById('mensajeSinResultadosMatriculados');
    
    if (visibles === 0) {
        if (!mensajeExistente) {
            mensajeExistente = document.createElement('div');
            mensajeExistente.id = 'mensajeSinResultadosMatriculados';
            mensajeExistente.className = 'col-12 text-center text-muted py-4';
            mensajeExistente.innerHTML = `
                <i class="fas fa-search fa-2x mb-2"></i><br>
                No se encontraron alumnos con los filtros aplicados
            `;
            
            const contenedor = document.querySelector('#matriculas-row .row.g-3');
            if (contenedor) {
                contenedor.appendChild(mensajeExistente);
            }
        }
    } else if (mensajeExistente) {
        mensajeExistente.remove();
    }
}

function limpiarFiltrosMatriculados() {
    document.getElementById('buscarMatriculados').value = '';
    document.getElementById('filtroCategoriaMatriculados').value = '';
    document.getElementById('filtroRendimiento').value = 'todos';
    document.getElementById('ordenarMatriculados').value = 'nombre_asc';
    
    aplicarFiltrosMatriculados();
    
    // Mostrar mensaje temporal
    const alerta = document.createElement('div');
    alerta.className = 'alert alert-success alert-dismissible fade show position-fixed';
    alerta.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 250px;';
    alerta.innerHTML = `
        Filtros limpiados
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alerta);
    
    setTimeout(() => {
        if (alerta.parentNode) {
            alerta.remove();
        }
    }, 3000);
}

// Inicializar cuando el DOM est√© listo
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ DOM cargado, inicializando filtros de matriculados...');
    inicializarFiltrosMatriculados();
});

    // ================= FILTROS Y B√öSQUEDA EN TIEMPO REAL =================
    function inicializarFiltrosPostulantes() {
        console.log('üîß Inicializando filtros de postulantes...');

        const buscarInput = document.getElementById('buscarPostulantes');
        const filtroCategoria = document.getElementById('filtroCategoria');
        const ordenarSelect = document.getElementById('ordenarPostulantes');

        // Verificar que los elementos existen antes de agregar event listeners
        if (buscarInput) {
            buscarInput.addEventListener('input', aplicarFiltros);
            console.log('‚úÖ B√∫squeda inicializada');
        } else {
            console.log('‚ùå Elemento buscarPostulantes no encontrado');
        }

        if (filtroCategoria) {
            filtroCategoria.addEventListener('change', aplicarFiltros);
            console.log('‚úÖ Filtro categor√≠a inicializado');
        } else {
            console.log('‚ùå Elemento filtroCategoria no encontrado');
        }

        if (ordenarSelect) {
            ordenarSelect.addEventListener('change', aplicarFiltros);
            console.log('‚úÖ Ordenamiento inicializado');
        } else {
            console.log('‚ùå Elemento ordenarPostulantes no encontrado');
        }

        // Calcular categor√≠as sugeridas para todos los postulantes
        calcularCategoriasSugeridas();

        // Inicializar botones de limpieza
        inicializarBotonesFiltros();

        // Aplicar filtros iniciales para mostrar contador
        aplicarFiltros();

        console.log('‚úÖ Filtros inicializados correctamente');
    }

    // Funci√≥n para calcular la categor√≠a sugerida basada en la edad
    function calcularCategoriaSugerida(fechaNacimiento) {
        const hoy = new Date();
        const nacimiento = new Date(fechaNacimiento);
        let edad = hoy.getFullYear() - nacimiento.getFullYear();

        // Ajustar edad si a√∫n no ha pasado el cumplea√±os este a√±o
        const mes = hoy.getMonth();
        const dia = hoy.getDate();
        if (mes < nacimiento.getMonth() || (mes === nacimiento.getMonth() && dia < nacimiento.getDate())) {
            edad--;
        }

        // Determinar categor√≠a seg√∫n edad (usa las mismas reglas que tu view)
        if (edad >= 4 && edad <= 7) return '4 a 7 a√±os';
        if (edad >= 8 && edad <= 11) return '8 a 11 a√±os';
        if (edad >= 12 && edad <= 15) return '12 a 15 a√±os';
        if (edad >= 16 && edad <= 17) return '16 a 17 a√±os';
        if (edad >= 18 && edad <= 25) return '18 a√±os';

        return 'No aplica';
    }

    // Calcular categor√≠as para todos los postulantes
    function calcularCategoriasSugeridas() {
        document.querySelectorAll('.categoria-sugerida').forEach(element => {
            const fechaNacimiento = element.getAttribute('data-edad');
            if (fechaNacimiento) {
                const categoria = calcularCategoriaSugerida(fechaNacimiento);
                element.textContent = categoria;
                element.setAttribute('data-categoria', categoria);

                // Agregar clase seg√∫n la categor√≠a para estilos
                element.classList.add('badge');
                if (categoria === 'No aplica') {
                    element.classList.add('bg-secondary');
                } else {
                    element.classList.add('bg-primary');
                }
            }
        });
    }

    // Funci√≥n principal para aplicar todos los filtros - CON DIAGN√ìSTICO
    function aplicarFiltros() {
        console.log('üîç Aplicando filtros...');

        const buscarTexto = document.getElementById('buscarPostulantes').value.toLowerCase();
        const filtroCategoria = document.getElementById('filtroCategoria').value;
        const orden = document.getElementById('ordenarPostulantes').value;

        const tarjetas = document.querySelectorAll('#postulantes-row > .col-md-4');
        const totalTarjetas = tarjetas.length;
        let tarjetasVisibles = 0;

        console.log(`üìä Total tarjetas: ${totalTarjetas}`);
        console.log(`üîé B√∫squeda: "${buscarTexto}", Categor√≠a: "${filtroCategoria}", Orden: "${orden}"`);

        tarjetas.forEach((tarjeta, index) => {
            const nombre = tarjeta.querySelector('.card-title')?.textContent.toLowerCase() || '';
            const infoDivs = tarjeta.querySelectorAll('.alumno-info div');
            const telefono = infoDivs[0]?.textContent.toLowerCase() || '';
            const email = infoDivs[1]?.textContent.toLowerCase() || '';
            const categoriaElement = tarjeta.querySelector('.categoria-sugerida');
            const categoria = categoriaElement ? categoriaElement.getAttribute('data-categoria') : '';

            // Verificar elementos de fecha
            const fechaElement = tarjeta.querySelector('.fecha-postulacion');
            const fechaData = fechaElement ? fechaElement.getAttribute('data-fecha') : 'No fecha';
            console.log(`üìÖ Tarjeta ${index}: "${nombre}" - Fecha: ${fechaData}`);

            // Aplicar filtro de b√∫squeda
            const coincideBusqueda = !buscarTexto ||
                nombre.includes(buscarTexto) ||
                telefono.includes(buscarTexto) ||
                email.includes(buscarTexto);

            // Aplicar filtro de categor√≠a
            const coincideCategoria = !filtroCategoria || categoria === obtenerNombreCategoriaPorId(filtroCategoria);

            // Mostrar/ocultar seg√∫n filtros
            if (coincideBusqueda && coincideCategoria) {
                tarjeta.style.display = 'block';
                tarjetasVisibles++;
            } else {
                tarjeta.style.display = 'none';
            }
        });

        console.log(`üëÄ Tarjetas visibles: ${tarjetasVisibles}`);

        // Ordenar las tarjetas visibles
        ordenarTarjetas(orden);

        // Actualizar contador
        actualizarContadorResultados(tarjetasVisibles, totalTarjetas);

        // Mostrar mensaje si no hay resultados
        mostrarMensajeSinResultados(tarjetasVisibles);
    }

    // Funci√≥n auxiliar para obtener nombre de categor√≠a por ID
    function obtenerNombreCategoriaPorId(idCategoria) {
        const select = document.getElementById('filtroCategoria');
        const option = select.querySelector(`option[value="${idCategoria}"]`);
        return option ? option.textContent : '';
    }

    // Funci√≥n para ordenar tarjetas
    // Funci√≥n para ordenar tarjetas - VERSI√ìN FUNCIONAL
    function ordenarTarjetas(orden) {
        const contenedor = document.getElementById('postulantes-row');
        if (!contenedor) {
            console.log('‚ùå Contenedor postulantes-row no encontrado');
            return;
        }

        // OBTENER TODAS LAS TARJETAS VISIBLES CORRECTAMENTE
        const todasLasTarjetas = Array.from(contenedor.querySelectorAll('.col-md-4'));
        const tarjetasVisibles = todasLasTarjetas.filter(tarjeta => {
            return tarjeta.style.display !== 'none';
        });

        console.log(`üîÑ Ordenando ${tarjetasVisibles.length} tarjetas visibles por: ${orden}`);

        if (tarjetasVisibles.length === 0) {
            console.log('‚ö†Ô∏è No hay tarjetas visibles para ordenar');
            return;
        }

        tarjetasVisibles.sort((a, b) => {
            const nombreA = a.querySelector('.card-title')?.textContent.trim().toLowerCase() || '';
            const nombreB = b.querySelector('.card-title')?.textContent.trim().toLowerCase() || '';

            // Obtener fechas desde el atributo data-fecha
            const fechaElementA = a.querySelector('.fecha-postulacion');
            const fechaElementB = b.querySelector('.fecha-postulacion');

            let fechaA = new Date('2000-01-01');
            let fechaB = new Date('2000-01-01');

            if (fechaElementA) {
                const fechaData = fechaElementA.getAttribute('data-fecha');
                if (fechaData && fechaData !== '' && fechaData !== 'None') {
                    fechaA = new Date(fechaData);
                    console.log(`üìÖ Fecha A: ${fechaData} -> ${fechaA.toISOString()}`);
                }
            }

            if (fechaElementB) {
                const fechaData = fechaElementB.getAttribute('data-fecha');
                if (fechaData && fechaData !== '' && fechaData !== 'None') {
                    fechaB = new Date(fechaData);
                    console.log(`üìÖ Fecha B: ${fechaData} -> ${fechaB.toISOString()}`);
                }
            }

            let resultado = 0;

            switch (orden) {
                case 'recientes':
                    resultado = fechaB - fechaA; // M√°s recientes primero
                    console.log(`‚û°Ô∏è Orden recientes: ${fechaB} - ${fechaA} = ${resultado}`);
                    break;
                case 'antiguos':
                    resultado = fechaA - fechaB; // M√°s antiguos primero
                    console.log(`‚¨ÖÔ∏è Orden antiguos: ${fechaA} - ${fechaB} = ${resultado}`);
                    break;
                case 'nombre_asc':
                    resultado = nombreA.localeCompare(nombreB);
                    console.log(`üî§ Orden nombre A-Z: "${nombreA}" vs "${nombreB}" = ${resultado}`);
                    break;
                case 'nombre_desc':
                    resultado = nombreB.localeCompare(nombreA);
                    console.log(`üî§ Orden nombre Z-A: "${nombreB}" vs "${nombreA}" = ${resultado}`);
                    break;
                default:
                    resultado = 0;
            }

            return resultado;
        });

        // LIMPIAR el contenedor y REINSERTAR las tarjetas ordenadas
        contenedor.innerHTML = '';
        tarjetasVisibles.forEach(tarjeta => {
            contenedor.appendChild(tarjeta);
        });

        console.log('‚úÖ Ordenamiento completado correctamente');
        console.log('üìã Orden final:', tarjetasVisibles.map(t => t.querySelector('.card-title')?.textContent.trim()));
    }

    // Mostrar mensaje cuando no hay resultados
    function mostrarMensajeSinResultados(visibles) {
        let mensajeExistente = document.getElementById('mensajeSinResultados');

        if (visibles === 0) {
            if (!mensajeExistente) {
                mensajeExistente = document.createElement('div');
                mensajeExistente.id = 'mensajeSinResultados';
                mensajeExistente.className = 'col-12 text-center text-muted py-4';
                mensajeExistente.innerHTML = '<i class="fas fa-search fa-2x mb-2"></i><br>No se encontraron postulantes con los filtros aplicados';
                document.getElementById('postulantes-row').appendChild(mensajeExistente);
            }
        } else if (mensajeExistente) {
            mensajeExistente.remove();
        }
    }

    function inicializarBotonesFiltros() {
        console.log('üîß Inicializando botones de filtros...');

        const btnLimpiar = document.getElementById('btnLimpiarFiltros');
        const btnResetear = document.getElementById('btnResetearOrden');

        if (btnLimpiar) {
            btnLimpiar.addEventListener('click', limpiarFiltros);
            console.log('‚úÖ Bot√≥n limpiar inicializado');
        } else {
            console.log('‚ùå Bot√≥n btnLimpiarFiltros no encontrado');
        }

        if (btnResetear) {
            btnResetear.addEventListener('click', resetearOrden);
            console.log('‚úÖ Bot√≥n resetear orden inicializado');
        } else {
            console.log('‚ùå Bot√≥n btnResetearOrden no encontrado');
        }
    }

    // Limpiar todos los filtros
    function limpiarFiltros() {
        document.getElementById('buscarPostulantes').value = '';
        document.getElementById('filtroCategoria').value = '';
        document.getElementById('ordenarPostulantes').value = 'recientes';

        // Aplicar filtros (que mostrar√° todo)
        aplicarFiltros();

        // Mostrar mensaje de √©xito
        mostrarMensajeTemporal('Filtros limpiados', 'success');
    }

    // Resetear al orden original (m√°s recientes primero)
    function resetearOrden() {
        document.getElementById('ordenarPostulantes').value = 'recientes';
        aplicarFiltros();
        mostrarMensajeTemporal('Orden restablecido', 'info');
    }

    // Mostrar contador de resultados
    function actualizarContadorResultados(visibles, total) {
        const contador = document.getElementById('contadorResultados');
        if (contador) {
            if (visibles === total) {
                contador.textContent = `Mostrando todos los ${total} postulantes`;
            } else {
                contador.textContent = `Mostrando ${visibles} de ${total} postulantes`;
            }
        }
    }

    // Mostrar mensaje temporal
    function mostrarMensajeTemporal(mensaje, tipo = 'info') {
        // Crear elemento de mensaje
        const alerta = document.createElement('div');
        alerta.className = `alert alert-${tipo} alert-dismissible fade show position-fixed`;
        alerta.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 250px;';
        alerta.innerHTML = `
        ${mensaje}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

        document.body.appendChild(alerta);

        // Auto-eliminar despu√©s de 3 segundos
        setTimeout(() => {
            if (alerta.parentNode) {
                alerta.remove();
            }
        }, 3000);
    }

    // TERMINAR PER√çODO ACAD√âMICO - JavaScript mejorado
    function inicializarTerminarPeriodo(matriculasData) {
        const categoriaSelect = document.getElementById('categoriaSelect');
        const listaMatriculas = document.getElementById('listaMatriculas');
        const checkAll = document.getElementById('checkAll');
        const btnTerminarPeriodo = document.getElementById('btnTerminarPeriodo');

        if (!categoriaSelect || !listaMatriculas) {
            console.log('‚ùå Elementos del modal de terminar per√≠odo no encontrados');
            return;
        }

        // Cuando cambie la categor√≠a
        categoriaSelect.addEventListener('change', function () {
            const categoriaId = parseInt(this.value);
            console.log('Categor√≠a seleccionada:', categoriaId);

            listaMatriculas.innerHTML = '';

            if (!categoriaId) {
                console.log('No se seleccion√≥ categor√≠a');
                return;
            }

            console.log('Total matr√≠culas disponibles:', matriculasData.length);

            // Filtrar por categor√≠a y estado activo
            const filtradas = matriculasData.filter(function (m) {
                const idCategoriaMatricula = parseInt(m.fk_categoria.idcategoria);
                const coincideCategoria = idCategoriaMatricula === categoriaId;
                const estaActiva = m.estado_matricula === true || m.estado_matricula === 1;

                console.log(`Filtro: Matr√≠cula ${m.idmatricula} - Categor√≠a: ${idCategoriaMatricula}, Coincide: ${coincideCategoria}, Activa: ${estaActiva}`);

                return coincideCategoria && estaActiva;
            });
            console.log('Matr√≠culas filtradas:', filtradas);

            if (filtradas.length === 0) {
                listaMatriculas.innerHTML = '<li class="list-group-item text-muted">No hay alumnos activos para esta categor√≠a.</li>';
                return;
            }

            // Crear checkboxes
            filtradas.forEach(function (m) {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex align-items-center';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'chkAlumno me-2';
                checkbox.value = m.idmatricula;
                checkbox.id = 'mat' + m.idmatricula;

                const label = document.createElement('label');
                label.htmlFor = 'mat' + m.idmatricula;
                label.textContent = m.fk_alumno.fk_persona_alumno.nom1_persona + ' ' + m.fk_alumno.fk_persona_alumno.ape1_persona;
                label.className = 'mb-0';

                li.appendChild(checkbox);
                li.appendChild(label);
                listaMatriculas.appendChild(li);
            });

            console.log('Se agregaron', filtradas.length, 'alumnos a la lista');
        });

        // Seleccionar/Deseleccionar todos
        if (checkAll) {
            checkAll.addEventListener('change', function () {
                const checked = this.checked;
                document.querySelectorAll('.chkAlumno').forEach(function (c) {
                    c.checked = checked;
                });
            });
        }

        // Enviar los seleccionados al servidor - CON MODAL DE CONFIRMACI√ìN
        if (btnTerminarPeriodo) {
            btnTerminarPeriodo.addEventListener('click', function () {
                console.log('üî¥ BOT√ìN TERMINAR PERIODO CLICKEADO');

                const seleccionados = Array.from(document.querySelectorAll('.chkAlumno:checked'))
                    .map(function (c) {
                        return c.value;
                    });

                console.log('Alumnos seleccionados:', seleccionados);

                if (seleccionados.length === 0) {
                    alert('‚ùå No has seleccionado ning√∫n alumno.');
                    return;
                }

                // Mostrar modal de confirmaci√≥n en lugar del confirm() nativo
                const confirmarModal = new bootstrap.Modal(document.getElementById('confirmarTerminarModal'));
                const cantidadAlumnos = document.getElementById('cantidadAlumnos');
                const btnConfirmarTerminar = document.getElementById('btnConfirmarTerminar');

                // Actualizar el texto con la cantidad de alumnos
                cantidadAlumnos.textContent = seleccionados.length;

                // Configurar el evento de confirmaci√≥n
                btnConfirmarTerminar.onclick = function () {
                    console.log('üü° CONFIRMADO - Enviando datos al servidor...');

                    // Cerrar el modal de confirmaci√≥n
                    confirmarModal.hide();

                    // Proceder con el env√≠o de datos
                    procesarTerminarPeriodo(seleccionados);
                };

                // Mostrar el modal de confirmaci√≥n
                confirmarModal.show();
            });
        }
    }

    // Funci√≥n para procesar el t√©rmino del per√≠odo
    function procesarTerminarPeriodo(seleccionados) {
        console.log('üü° Enviando datos al servidor...');

        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const formData = new FormData();
        const btnTerminarPeriodo = document.getElementById('btnTerminarPeriodo');

        seleccionados.forEach(function (id) {
            formData.append('matriculas[]', id);
        });
        formData.append('csrfmiddlewaretoken', csrfToken);

        // Mostrar loading en el bot√≥n principal
        btnTerminarPeriodo.disabled = true;
        btnTerminarPeriodo.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Procesando...';

        fetch("{% url 'terminar_periodo' %}", {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(function (response) {
                console.log('Respuesta del servidor - Status:', response.status);
                if (!response.ok) {
                    throw new Error('Error del servidor: ' + response.status);
                }
                return response.json();
            })
            .then(function (data) {
                console.log('Datos recibidos:', data);

                if (data.error) {
                    throw new Error(data.error);
                }

                // ‚úÖ SIMPLEMENTE RECARGAR LA P√ÅGINA para mostrar los mensajes de Django
                let exitosos = data.resultados.filter(r => r.status === '√©xito').length;

                if (exitosos > 0) {
                    // Recargar la p√°gina para mostrar los mensajes de Django
                    location.reload();
                } else {
                    // Si no hubo √©xitos, mostrar alerta y recargar
                    alert('‚ùå No se pudo procesar ninguna matr√≠cula. Revise los errores.');
                    location.reload();
                }
            })
            .catch(function (error) {
                console.error('Error completo:', error);
                alert('‚ùå Ocurri√≥ un error al terminar el per√≠odo: ' + error.message);

                // Restaurar bot√≥n
                btnTerminarPeriodo.disabled = false;
                btnTerminarPeriodo.innerHTML = 'Terminar Per√≠odo';
            });
    }

    // ================= FUNCIONES AUXILIARES PARA MODAL DE INFORMACI√ìN =================

    // Funci√≥n para formatear valores vac√≠os
    function formatearValor(valor) {
        return valor && valor !== 'undefined' && valor !== 'None' && valor !== '' ? valor : '<span class="text-muted"></span>';
    }

    // Funci√≥n para formatear documentos - MEJORADA PARA ABRIR ARCHIVOS
    function formatearDocumento(url, texto, tipo = 'documento') {
        if (url && url !== 'undefined' && url !== 'None' && url !== '') {
            return `
                <div class="d-flex align-items-center gap-2">
                    <a href="${url}" target="_blank" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-eye me-1"></i>Ver ${texto}
                    </a>
                    <span class="badge bg-success">‚úì Cargado</span>
                </div>`;
        }
        return '<span class="text-muted">No cargado</span>';
    }

    // Funci√≥n para obtener el texto del g√©nero
    function obtenerTextoGenero(codigo) {
        const generos = {
            'M': 'Masculino',
            'F': 'Femenino'
        };
        return generos[codigo] || codigo;
    }

    // Funci√≥n para obtener el texto del tipo de identificaci√≥n
    function obtenerTextoTipoIdentidad(codigo) {
        const tipos = {
            'CC': 'C√©dula de Ciudadan√≠a',
            'TI': 'Tarjeta de Identidad',
            'RC': 'Registro Civil',
            'PAS': 'Pasaporte'
        };
        return tipos[codigo] || codigo;
    }

    // Funci√≥n para obtener el texto del parentesco
    function obtenerTextoParentesco(codigo) {
        const parentescos = {
            'Padre': 'Padre',
            'Madre': 'Madre',
            'Madrastra': 'Madrastra',
            'Padrastro': 'Padrastro',
            'Tio': 'T√≠o',
            'Primo': 'Primo',
            'Hermano': 'Hermano',
            'Abuelo': 'Abuelo',
            'Cuidador': 'Cuidador'
        };
        return parentescos[codigo] || codigo;
    }

    // ================= MODAL DE INFORMACI√ìN COMPLETA DE POSTULANTES =================

    function inicializarModalInfoPostulantes() {
        // Event listeners para postulantes - MODAL COMPLETO
        document.querySelectorAll('.btn-ver-info').forEach(btn => {
            btn.addEventListener('click', function () {
                const data = this.dataset;
                console.log('üîç Datos del postulante:', data);

                const html = `
                <div class="row">
                    <!-- Informaci√≥n Personal -->
                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0"><i class="fas fa-user me-2"></i>Informaci√≥n Personal</h6>
                            </div>
                            <div class="card-body">
                                <div class="row mb-2">
                                    <div class="col-12">
                                        <strong>Nombre Completo:</strong><br>
                                        ${formatearValor(data.nom)} ${formatearValor(data.nom2)} ${formatearValor(data.ape)} ${formatearValor(data.ape2)}
                                    </div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-md-6">
                                        <strong>Tipo Identificaci√≥n:</strong><br>
                                        ${obtenerTextoTipoIdentidad(formatearValor(data.tipoIdentidad))}
                                    </div>
                                    <div class="col-md-6">
                                        <strong>N√∫mero Identificaci√≥n:</strong><br>
                                        ${formatearValor(data.idPersona)}
                                    </div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-md-6">
                                        <strong>Fecha Nacimiento:</strong><br>
                                        ${formatearValor(data.fecha)}
                                    </div>
                                    <div class="col-md-6">
                                        <strong>G√©nero:</strong><br>
                                        ${obtenerTextoGenero(formatearValor(data.genero))}
                                    </div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-md-6">
                                        <strong>EPS:</strong><br>
                                        ${formatearValor(data.eps)}
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Tipo de Sangre:</strong><br>
                                        ${formatearValor(data.rh)}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Informaci√≥n de Contacto -->
                        <div class="card mb-3">
                            <div class="card-header bg-warning text-dark">
                                <h6 class="mb-0"><i class="fas fa-address-book me-2"></i>Informaci√≥n de Contacto</h6>
                            </div>
                            <div class="card-body">
                                <div class="row mb-2">
                                    <div class="col-12">
                                        <strong>Direcci√≥n:</strong><br>
                                        ${formatearValor(data.direc)}
                                    </div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-md-6">
                                        <strong>Tel√©fono:</strong><br>
                                        ${formatearValor(data.tel)}
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Email:</strong><br>
                                        ${formatearValor(data.email)}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Informaci√≥n Deportiva y Acudiente -->
                    <div class="col-md-6">
                        <!-- Informaci√≥n Deportiva -->
                        <div class="card mb-3">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0"><i class="fas fa-futbol me-2"></i>Informaci√≥n Deportiva</h6>
                            </div>
                            <div class="card-body">
                                <div class="row mb-2">
                                    <div class="col-12">
                                        <strong>Posici√≥n:</strong><br>
                                        ${formatearValor(data.posicion)}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Medidas F√≠sicas -->
                        <div class="card mb-3">
                            <div class="card-header bg-secondary text-white">
                                <h6 class="mb-0"><i class="fas fa-ruler me-2"></i>Medidas F√≠sicas</h6>
                            </div>
                            <div class="card-body">
                                <div class="row mb-2">
                                    <div class="col-md-4">
                                        <strong>Altura:</strong><br>
                                        ${formatearValor(data.altura)} m
                                    </div>
                                    <div class="col-md-4">
                                        <strong>Peso:</strong><br>
                                        ${formatearValor(data.peso)} kg
                                    </div>
                                    <div class="col-md-4">
                                        <strong>IMC:</strong><br>
                                        ${formatearValor(data.imc)}
                                    </div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-md-4">
                                        <strong>Talla Ropa:</strong><br>
                                        ${formatearValor(data.talla)}
                                    </div>
                                    <div class="col-md-4">
                                        <strong>Calzado:</strong><br>
                                        ${formatearValor(data.calzado)}
                                    </div>
                                    <div class="col-md-4">
                                        <strong>Pie Dominante:</strong><br>
                                        ${formatearValor(data.pieDominante)}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Informaci√≥n del Acudiente -->
                        <div class="card mb-3">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0"><i class="fas fa-users me-2"></i>Informaci√≥n del Acudiente</h6>
                            </div>
                            <div class="card-body">
                                <div class="row mb-2">
                                    <div class="col-12">
                                        <strong>Nombre Completo:</strong><br>
                                        ${formatearValor(data.nom1Acudiente)} ${formatearValor(data.nom2Acudiente)} ${formatearValor(data.ape1Acudiente)} ${formatearValor(data.ape2Acudiente)}
                                    </div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-md-6">
                                        <strong>ID Acudiente:</strong><br>
                                        ${formatearValor(data.idAcudiente)}
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Parentesco:</strong><br>
                                        ${obtenerTextoParentesco(formatearValor(data.parentesco))}
                                    </div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-md-6">
                                        <strong>Tel√©fono:</strong><br>
                                        ${formatearValor(data.telAcudiente)}
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Email:</strong><br>
                                        ${formatearValor(data.emailAcudiente)}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Documentos -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-dark text-white">
                                <h6 class="mb-0"><i class="fas fa-file me-2"></i>Documentos</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4 mb-2">
                                        <strong>Tratamiento de Datos:</strong><br>
                                        ${formatearDocumento(data.tradatos, 'Tratamiento')}
                                    </div>
                                    <div class="col-md-4 mb-2">
                                        <strong>Foto:</strong><br>
                                        ${formatearDocumento(data.foto, 'Foto', 'imagen')}
                                    </div>
                                    <div class="col-md-4 mb-2">
                                        <strong>Autorizaci√≥n M√©dica:</strong><br>
                                        ${formatearDocumento(data.automedica, 'Autorizaci√≥n')}
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-4 mb-2">
                                        <strong>Comprobante EPS:</strong><br>
                                        ${formatearDocumento(data.certeps, 'Comprobante EPS')}
                                    </div>
                                    <div class="col-md-4 mb-2">
                                        <strong>Certificado Otra Escuela:</strong><br>
                                        ${formatearDocumento(data.otraescuela, 'Certificado')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                `;

                document.getElementById('modalInfoBody').innerHTML = html;
                const modal = new bootstrap.Modal(document.getElementById('modalInfo'));
                modal.show();
                console.log('‚úÖ Modal de informaci√≥n abierto');
            });
        });
    }

    // ================= MODALES DE POSTULANTES (ACEPTAR/RECHAZAR) =================

    // ================= MODALES DE POSTULANTES (ACEPTAR/RECHAZAR) =================

    function inicializarModalesPostulantes() {
        // Modal Rechazar Postulante con mensaje
        inicializarModalRechazo();

        // Ya no necesitamos el modal de aceptar porque ahora es autom√°tico
        console.log('‚úÖ Modal de rechazo con mensaje inicializado');
    }

    // ================= MODAL RECHAZO CON MENSAJE =================

    function inicializarModalRechazo() {
        const modalRechazarEl = document.getElementById('modalRechazar');
        if (!modalRechazarEl) {
            console.log('‚ùå Modal de rechazo no encontrado');
            return;
        }

        const modalRechazar = new bootstrap.Modal(modalRechazarEl);
        const textoRechazar = document.getElementById('texto-rechazar');
        const rechazarId = document.getElementById('rechazar_id_persona');
        const mensajeTextarea = document.getElementById('mensajeRechazo');
        const contadorCaracteres = document.getElementById('contadorCaracteres');

        // Contador de caracteres para el mensaje
        if (mensajeTextarea && contadorCaracteres) {
            mensajeTextarea.addEventListener('input', function () {
                const longitud = this.value.length;
                contadorCaracteres.textContent = `${longitud}/500`;

                if (longitud > 450) {
                    contadorCaracteres.className = 'badge bg-warning';
                } else if (longitud > 490) {
                    contadorCaracteres.className = 'badge bg-danger';
                } else {
                    contadorCaracteres.className = 'badge bg-secondary';
                }
            });
        }

        // Event listeners para botones de rechazar
        document.querySelectorAll('.btn-open-rechazar').forEach(btn => {
            btn.addEventListener('click', function () {
                const nombre = this.dataset.nom;
                const id = this.dataset.id;

                textoRechazar.textContent = `¬øEst√°s seguro de rechazar a ${nombre}?`;
                rechazarId.value = id;

                // Limpiar mensaje anterior
                if (mensajeTextarea) {
                    mensajeTextarea.value = '';
                    contadorCaracteres.textContent = '0/500';
                    contadorCaracteres.className = 'badge bg-secondary';
                }

                modalRechazar.show();
            });
        });

        // Prevenir env√≠o si el mensaje es muy largo
        document.getElementById('form-rechazar')?.addEventListener('submit', function (e) {
            const mensaje = mensajeTextarea?.value || '';
            if (mensaje.length > 500) {
                e.preventDefault();
                alert('El mensaje de rechazo no puede tener m√°s de 500 caracteres.');
                mensajeTextarea.focus();
            }
        });
    }

    // ================= FUNCI√ìN PARA VER DOCUMENTOS =================

    // Funci√≥n para ver documentos (compatible con el modal de edici√≥n)
    function verDocumento(tipo) {
        let ruta = '';
        let nombreDocumento = '';

        // Obtener la ruta del documento seg√∫n el tipo
        switch (tipo) {
            case 'tradatos':
                ruta = document.getElementById('edit_tradatos_existente')?.value || '';
                nombreDocumento = 'Tratamiento de Datos';
                break;
            case 'foto':
                ruta = document.getElementById('edit_foto_existente')?.value || '';
                nombreDocumento = 'Foto';
                break;
            case 'automedica':
                ruta = document.getElementById('edit_automedica_existente')?.value || '';
                nombreDocumento = 'Autorizaci√≥n M√©dica';
                break;
            case 'certeps':
                ruta = document.getElementById('edit_certeps_existente')?.value || '';
                nombreDocumento = 'Comprobante EPS';
                break;
            case 'otraescuela':
                ruta = document.getElementById('edit_otraescuela_existente')?.value || '';
                nombreDocumento = 'Certificado Otra Escuela';
                break;
        }

        if (ruta && ruta !== 'undefined' && ruta !== 'None' && ruta !== '') {
            // Si la ruta es una URL completa, abrir directamente
            if (ruta.startsWith('http') || ruta.startsWith('/')) {
                window.open(ruta, '_blank');
            } else {
                // Si es una ruta relativa, construir la URL completa
                const urlCompleta = `/media/${ruta}`;
                window.open(urlCompleta, '_blank');
            }
            console.log(`‚úÖ Abriendo documento: ${nombreDocumento} - ${ruta}`);
        } else {
            alert(`No hay ${nombreDocumento} disponible para visualizar`);
            console.log(`‚ùå No hay documento disponible: ${nombreDocumento}`);
        }
    }

    // ================= FUNCI√ìN PARA INICIALIZAR EVENT LISTENERS =================

    // Funci√≥n para inicializar los event listeners con los datos
    function inicializarEventListeners(matriculasData) {
        console.log('üéØ Inicializando event listeners con', matriculasData.length, 'matr√≠culas');

        // Inicializar funcionalidad de terminar per√≠odo
        inicializarTerminarPeriodo(matriculasData);

        // Inicializar modales de postulantes
        inicializarModalInfoPostulantes();
        inicializarModalesPostulantes();

        // Inicializar otras funcionalidades
        inicializarOtrasFuncionalidades();
    }

    // ================= OTRAS FUNCIONALIDADES =================

    function inicializarOtrasFuncionalidades() {
        console.log('üîß Inicializando otras funcionalidades...');

        // C√°lculo autom√°tico de IMC para el modal de edici√≥n
        const editAltura = document.getElementById('edit_altura');
        const editPeso = document.getElementById('edit_peso');

        if (editAltura && editPeso) {
            editAltura.addEventListener('input', calcularIMCEdicion);
            editPeso.addEventListener('input', calcularIMCEdicion);
        }

        // Abrir modal EDITAR y poblar inputs
        const modalEdit = document.getElementById('editAlumnoModal');
        if (modalEdit) {
            const modal = new bootstrap.Modal(modalEdit);

            // Configurar validaciones cuando se abra el modal
            modalEdit.addEventListener('shown.bs.modal', function () {
                console.log('üîß Modal de edici√≥n abierto, configurando validaciones...');
                configurarValidacionesEdicion();
            });

            document.querySelectorAll('.editAlumnoBtn').forEach(btn => {
                btn.addEventListener('click', function () {
                    console.log('üî¥ BOT√ìN EDITAR CLICKEADO - Datos disponibles:');

                    // Funci√≥n segura para obtener datos
                    function getData(key) {
                        const value = this.dataset[key];
                        return (value && value !== 'undefined' && value !== 'None' && value !== '') ? value : '';
                    }

                    // ========== DATOS B√ÅSICOS DE PERSONA ==========
                    const personaId = getData.call(this, 'id');
                    document.getElementById('edit_persona_id').value = personaId;

                    // Campos EDITABLES
                    document.getElementById('edit_nom1').value = getData.call(this, 'nom1');
                    document.getElementById('edit_nom2').value = getData.call(this, 'nom2');
                    document.getElementById('edit_ape1').value = getData.call(this, 'ape1');
                    document.getElementById('edit_ape2').value = getData.call(this, 'ape2');
                    document.getElementById('edit_direc').value = getData.call(this, 'direc');
                    document.getElementById('edit_tel').value = getData.call(this, 'tel');
                    document.getElementById('edit_email').value = getData.call(this, 'email');
                    document.getElementById('edit_genero').value = getData.call(this, 'genero');
                    document.getElementById('edit_eps').value = getData.call(this, 'eps');

                    // ========== CAMPOS NO EDITABLES (solo visualizaci√≥n) ==========
                    const tipoIdentidad = getData.call(this, 'tipoidentidad');
                    const numIdentidad = getData.call(this, 'numidentidad');
                    const fechaNacimiento = getData.call(this, 'fecha');
                    const rh = getData.call(this, 'rh');

                    // Mostrar en campos de solo lectura
                    document.getElementById('edit_tipo_identidad_display').value = tipoIdentidad || '';
                    document.getElementById('edit_num_identidad_display').value = numIdentidad || '';
                    document.getElementById('edit_fecha_display').value = fechaNacimiento || '';
                    document.getElementById('edit_rh_display').value = rh || '';

                    // Guardar en hidden fields
                    document.getElementById('edit_tipo_identidad').value = tipoIdentidad;
                    document.getElementById('edit_num_identidad').value = numIdentidad;
                    document.getElementById('edit_fecha').value = fechaNacimiento;
                    document.getElementById('edit_rh').value = rh;

                    // ========== MEDIDAS F√çSICAS ==========
                    // Convertir valores num√©ricos reemplazando comas por puntos
                    const altura = getData.call(this, 'altura');
                    const peso = getData.call(this, 'peso');
                    const imc = getData.call(this, 'imc');
                    const calzado = getData.call(this, 'calzado');

                    document.getElementById('edit_altura').value = altura ? altura.replace(',', '.') : '';
                    document.getElementById('edit_peso').value = peso ? peso.replace(',', '.') : '';
                    document.getElementById('edit_imc').value = imc ? imc.replace(',', '.') : '';
                    document.getElementById('edit_calzado').value = calzado || '';
                    document.getElementById('edit_talla').value = getData.call(this, 'talla');
                    document.getElementById('edit_pie').value = getData.call(this, 'pie');

                    // ========== ACUDIENTE ==========
                    const idAcudiente = getData.call(this, 'idacudiente');
                    document.getElementById('edit_idacudiente').value = idAcudiente;
                    document.getElementById('edit_idacudiente_actual').value = idAcudiente;

                    document.getElementById('edit_nom1_acudiente').value = getData.call(this, 'nom1acudiente');
                    document.getElementById('edit_nom2_acudiente').value = getData.call(this, 'nom2acudiente');
                    document.getElementById('edit_ape1_acudiente').value = getData.call(this, 'ape1acudiente');
                    document.getElementById('edit_ape2_acudiente').value = getData.call(this, 'ape2acudiente');
                    document.getElementById('edit_telacud').value = getData.call(this, 'telacudiente');
                    document.getElementById('edit_emailacud').value = getData.call(this, 'emailacudiente');
                    document.getElementById('edit_parentesco').value = getData.call(this, 'parentesco');

                    // ========== INFORMACI√ìN DEPORTIVA ==========
                    document.getElementById('edit_categoria').value = getData.call(this, 'categoria');
                    document.getElementById('edit_posicion').value = getData.call(this, 'posicion');
                    document.getElementById('edit_matricula_id').value = getData.call(this, 'matricula');

                    // ========== DOCUMENTOS EXISTENTES ==========
                    const tradatosRuta = getData.call(this, 'tradatos');
                    const fotoRuta = getData.call(this, 'foto');
                    const automedicaRuta = getData.call(this, 'automedica');
                    const certepsRuta = getData.call(this, 'certeps');
                    const otraEscuelaRuta = getData.call(this, 'otraescuela');

                    // Mostrar estado de documentos existentes
                    document.getElementById('edit_tradatos_display').value = tradatosRuta ? 'Documento cargado ‚úì' : 'No cargado';
                    document.getElementById('edit_foto_display').value = fotoRuta ? 'Foto cargada ‚úì' : 'No cargada';
                    document.getElementById('edit_automedica_display').value = automedicaRuta ? 'Documento cargado ‚úì' : 'No cargado';
                    document.getElementById('edit_certeps_display').value = certepsRuta ? 'Documento cargado ‚úì' : 'No cargado';
                    document.getElementById('edit_otraescuela_display').value = otraEscuelaRuta ? 'Documento cargado ‚úì' : 'No aplica';

                    // Guardar rutas existentes en hidden fields
                    document.getElementById('edit_tradatos_existente').value = tradatosRuta || '';
                    document.getElementById('edit_foto_existente').value = fotoRuta || '';
                    document.getElementById('edit_automedica_existente').value = automedicaRuta || '';
                    document.getElementById('edit_certeps_existente').value = certepsRuta || '';
                    document.getElementById('edit_otraescuela_existente').value = otraEscuelaRuta || '';

                    // Habilitar/deshabilitar botones de ver seg√∫n si hay documento
                    document.getElementById('btn_ver_tradatos').disabled = !tradatosRuta;
                    document.getElementById('btn_ver_foto').disabled = !fotoRuta;
                    document.getElementById('btn_ver_automedica').disabled = !automedicaRuta;
                    document.getElementById('btn_ver_certeps').disabled = !certepsRuta;
                    document.getElementById('btn_ver_otraescuela').disabled = !otraEscuelaRuta;

                    // Calcular IMC inicial si hay datos
                    calcularIMCEdicion();

                    console.log('‚úÖ Datos cargados en modal de edici√≥n para persona ID:', personaId);
                    modal.show();
                });
            });
        }

        // Prevenir env√≠o del formulario de edici√≥n si hay errores
        document.getElementById('editAlumnoForm')?.addEventListener('submit', function (e) {
            const errores = this.querySelectorAll('.is-invalid');
            if (errores.length > 0) {
                e.preventDefault();
                alert('Por favor corrige los errores antes de guardar los cambios.');

                // Desplazarse al primer error
                const primerError = this.querySelector('.is-invalid');
                if (primerError) {
                    primerError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    primerError.focus();
                }
            }
        });
    }

    // ================= VALIDACIONES PARA MODAL DE EDICI√ìN =================
    function configurarValidacionesEdicion() {
        console.log('üîß Configurando validaciones para modal de edici√≥n...');

        const campos = {
            'edit_tel': validarTelefono,
            'edit_telacud': validarTelefono,
            'edit_email': validarEmail,
            'edit_emailacud': validarEmailOpcional,
            'edit_nom1': validarNombre,
            'edit_nom2': validarNombreOpcional,
            'edit_ape1': validarApellido,
            'edit_ape2': validarApellidoOpcional,
            'edit_direc': validarDireccion,
            'edit_nom1_acudiente': validarNombre,
            'edit_nom2_acudiente': validarNombreOpcional,
            'edit_ape1_acudiente': validarApellido,
            'edit_ape2_acudiente': validarApellidoOpcional,
            'edit_altura': validarAltura,
            'edit_peso': validarPeso,
            'edit_calzado': validarCalzado,
            'edit_idacudiente': validarIdentificacion
        };

        // Aplicar validaciones espec√≠ficas
        Object.keys(campos).forEach(campoId => {
            const campo = document.getElementById(campoId);
            if (campo) {
                campo.addEventListener('blur', function () {
                    validarCampoEdicion(this, campos[campoId]);
                });
                campo.addEventListener('input', function () {
                    limpiarValidacionEdicion(this);
                    // Validar longitud en tiempo real mientras escribe
                    if (this.value.trim()) {
                        validarLongitudEdicion(this);
                    }
                });
            }
        });

        // Validaci√≥n para campos requeridos simples
        const camposRequeridos = document.querySelectorAll('#editAlumnoForm input[required], #editAlumnoForm select[required]');
        camposRequeridos.forEach(campo => {
            if (!Object.keys(campos).includes(campo.id)) {
                campo.addEventListener('blur', function () {
                    validarCampoRequeridoEdicion(this);
                });
                campo.addEventListener('input', function () {
                    limpiarValidacionEdicion(this);
                });
            }
        });

        // Validar archivos
        const archivos = ['edit_automedica', 'edit_certeps'];
        archivos.forEach(archivoId => {
            const archivo = document.getElementById(archivoId);
            if (archivo) {
                archivo.addEventListener('change', function () {
                    validarArchivoEdicion(this);
                });
            }
        });

        // Configurar campos num√©ricos para reemplazar comas por puntos
        const camposNumericos = ['edit_altura', 'edit_peso'];
        camposNumericos.forEach(campoId => {
            const campo = document.getElementById(campoId);
            if (campo) {
                campo.addEventListener('input', function () {
                    // Reemplazar comas por puntos
                    this.value = this.value.replace(',', '.');
                });
            }
        });

        // Configurar c√°lculo autom√°tico de IMC
        const editAltura = document.getElementById('edit_altura');
        const editPeso = document.getElementById('edit_peso');
        if (editAltura && editPeso) {
            editAltura.addEventListener('input', calcularIMCEdicion);
            editPeso.addEventListener('input', calcularIMCEdicion);
        }
    }

    // Funciones de validaci√≥n espec√≠ficas para edici√≥n
    function validarCampoEdicion(campo, funcionValidacion) {
        const valor = campo.value.trim();
        limpiarValidacionEdicion(campo);

        if (valor && !funcionValidacion(valor, campo)) {
            mostrarErrorEdicion(campo, obtenerMensajeErrorEdicion(campo.id));
        } else if (campo.checkValidity() && valor) {
            mostrarExitoEdicion(campo);
        }
    }

    function validarCampoRequeridoEdicion(campo) {
        const valor = campo.value.trim();
        limpiarValidacionEdicion(campo);

        if (!valor) {
            mostrarErrorEdicion(campo, 'Este campo es requerido');
        } else {
            mostrarExitoEdicion(campo);
        }
    }

    function validarLongitudEdicion(campo) {
        const valor = campo.value.trim();
        const limites = {
            'edit_nom1': 20, 'edit_nom2': 20, 'edit_ape1': 20, 'edit_ape2': 20,
            'edit_nom1_acudiente': 20, 'edit_nom2_acudiente': 20,
            'edit_ape1_acudiente': 20, 'edit_ape2_acudiente': 20,
            'edit_direc': 40, 'edit_email': 40, 'edit_emailacud': 40
        };

        if (limites[campo.id] && valor.length > limites[campo.id]) {
            mostrarErrorEdicion(campo, `M√°ximo ${limites[campo.id]} caracteres`);
            return false;
        }
        return true;
    }

    // VALIDACIONES ESPEC√çFICAS
    function validarTelefono(valor) {
        return /^\d{10}$/.test(valor); // Exactamente 10 d√≠gitos
    }

    function validarEmail(valor, campo) {
        if (valor.length > 40) {
            mostrarErrorEdicion(campo, 'M√°ximo 40 caracteres');
            return false;
        }
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(valor);
    }

    function validarEmailOpcional(valor, campo) {
        if (!valor) return true;
        if (valor.length > 40) {
            mostrarErrorEdicion(campo, 'M√°ximo 40 caracteres');
            return false;
        }
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(valor);
    }

    function validarNombre(valor, campo) {
        if (valor.length > 20) {
            mostrarErrorEdicion(campo, 'M√°ximo 20 caracteres');
            return false;
        }
        return /^[A-Za-z√Å√â√ç√ì√ö√°√©√≠√≥√∫√ë√±\s]+$/.test(valor);
    }

    function validarNombreOpcional(valor, campo) {
        if (valor && valor.length > 20) {
            mostrarErrorEdicion(campo, 'M√°ximo 20 caracteres');
            return false;
        }
        return !valor || /^[A-Za-z√Å√â√ç√ì√ö√°√©√≠√≥√∫√ë√±\s]+$/.test(valor);
    }

    function validarApellido(valor, campo) {
        if (valor.length > 20) {
            mostrarErrorEdicion(campo, 'M√°ximo 20 caracteres');
            return false;
        }
        return /^[A-Za-z√Å√â√ç√ì√ö√°√©√≠√≥√∫√ë√±\s]+$/.test(valor);
    }

    function validarApellidoOpcional(valor, campo) {
        if (valor && valor.length > 20) {
            mostrarErrorEdicion(campo, 'M√°ximo 20 caracteres');
            return false;
        }
        return !valor || /^[A-Za-z√Å√â√ç√ì√ö√°√©√≠√≥√∫√ë√±\s]+$/.test(valor);
    }

    function validarDireccion(valor, campo) {
        if (valor.length > 40) {
            mostrarErrorEdicion(campo, 'M√°ximo 40 caracteres');
            return false;
        }
        return true;
    }

    function validarAltura(valor, campo) {
        const valorNormalizado = valor.replace(',', '.');
        const altura = parseFloat(valorNormalizado);
        return !isNaN(altura) && altura >= 0.5 && altura <= 2.5;
    }

    function validarPeso(valor, campo) {
        const valorNormalizado = valor.replace(',', '.');
        const peso = parseFloat(valorNormalizado);
        return !isNaN(peso) && peso >= 10 && peso <= 150;
    }

    function validarCalzado(valor, campo) {
        const calzado = parseInt(valor);
        return !isNaN(calzado) && calzado >= 15 && calzado <= 50;
    }

    function validarIdentificacion(valor) {
        return /^\d+$/.test(valor) && valor.length >= 6 && valor.length <= 10;
    }

    function validarArchivoEdicion(archivo) {
        const nombreArchivo = archivo.value;
        const extensionesPermitidas = {
            'edit_automedica': ['.pdf', '.doc', '.docx'],
            'edit_certeps': ['.pdf', '.doc', '.docx']
        };

        if (nombreArchivo) {
            const extension = nombreArchivo.toLowerCase().substring(nombreArchivo.lastIndexOf('.'));
            const extensiones = extensionesPermitidas[archivo.id];

            if (extensiones && !extensiones.includes(extension)) {
                mostrarErrorEdicion(archivo, `Formatos permitidos: ${extensiones.join(', ')}`);
                return false;
            } else {
                mostrarExitoEdicion(archivo);
                return true;
            }
        }

        // En edici√≥n, los archivos no son obligatorios
        return true;
    }

    function obtenerMensajeErrorEdicion(campoId) {
        const mensajes = {
            'edit_tel': 'Exactamente 10 d√≠gitos',
            'edit_telacud': 'Exactamente 10 d√≠gitos',
            'edit_email': 'Email inv√°lido o m√°ximo 40 caracteres',
            'edit_emailacud': 'Email inv√°lido o m√°ximo 40 caracteres',
            'edit_nom1': 'Solo letras, m√°ximo 20 caracteres',
            'edit_nom2': 'Solo letras, m√°ximo 20 caracteres',
            'edit_ape1': 'Solo letras, m√°ximo 20 caracteres',
            'edit_ape2': 'Solo letras, m√°ximo 20 caracteres',
            'edit_nom1_acudiente': 'Solo letras, m√°ximo 20 caracteres',
            'edit_nom2_acudiente': 'Solo letras, m√°ximo 20 caracteres',
            'edit_ape1_acudiente': 'Solo letras, m√°ximo 20 caracteres',
            'edit_ape2_acudiente': 'Solo letras, m√°ximo 20 caracteres',
            'edit_direc': 'M√°ximo 40 caracteres',
            'edit_altura': 'La altura debe estar entre 0.5 y 2.5 metros',
            'edit_peso': 'El peso debe estar entre 10 y 150 kg',
            'edit_calzado': 'La talla de calzado debe estar entre 15 y 50',
            'edit_idacudiente': 'Solo n√∫meros, entre 6 y 10 d√≠gitos'
        };
        return mensajes[campoId] || 'Valor inv√°lido';
    }

    function mostrarErrorEdicion(campo, mensaje) {
        campo.classList.add('is-invalid');
        campo.classList.remove('is-valid');

        // Buscar mensaje de error existente
        let feedback = campo.nextElementSibling;
        while (feedback && !feedback.classList.contains('invalid-feedback')) {
            feedback = feedback.nextElementSibling;
        }

        if (!feedback || !feedback.classList.contains('invalid-feedback')) {
            feedback = document.createElement('div');
            feedback.className = 'invalid-feedback';
            campo.parentNode.appendChild(feedback);
        }
        feedback.textContent = mensaje;
        feedback.style.display = 'block';
    }

    function mostrarExitoEdicion(campo) {
        campo.classList.add('is-valid');
        campo.classList.remove('is-invalid');

        // Ocultar mensaje de error si existe
        let feedback = campo.nextElementSibling;
        while (feedback && !feedback.classList.contains('invalid-feedback')) {
            feedback = feedback.nextElementSibling;
        }

        if (feedback && feedback.classList.contains('invalid-feedback')) {
            feedback.style.display = 'none';
        }
    }

    function limpiarValidacionEdicion(campo) {
        campo.classList.remove('is-invalid', 'is-valid');
    }

    function calcularIMCEdicion() {
        let altura = document.getElementById('edit_altura').value;
        let peso = document.getElementById('edit_peso').value;
        const imcInput = document.getElementById('edit_imc');

        // Normalizar valores
        altura = altura.replace(',', '.');
        peso = peso.replace(',', '.');

        const alturaNum = parseFloat(altura) || 0;
        const pesoNum = parseFloat(peso) || 0;

        if (alturaNum > 0 && pesoNum > 0) {
            const imc = pesoNum / (alturaNum * alturaNum);
            imcInput.value = imc.toFixed(2);

            // Validar visualmente el IMC con colores
            if (imc < 18.5) {
                imcInput.style.borderColor = '#ffc107';
                imcInput.style.backgroundColor = '#fffbf0';
            } else if (imc >= 18.5 && imc <= 24.9) {
                imcInput.style.borderColor = '#28a745';
                imcInput.style.backgroundColor = '#f8fff9';
            } else if (imc >= 25 && imc <= 29.9) {
                imcInput.style.borderColor = '#fd7e14';
                imcInput.style.backgroundColor = '#fff4e6';
            } else {
                imcInput.style.borderColor = '#dc3545';
                imcInput.style.backgroundColor = '#fff5f5';
            }
        } else {
            imcInput.value = '';
            imcInput.style.borderColor = '';
            imcInput.style.backgroundColor = '#f8f9fa';
        }
    }

    // DEBUG TEMPORAL - Verificar que las URLs sean correctas
    document.addEventListener('DOMContentLoaded', function () {
        console.log('üîó URL terminar_periodo:', "{% url 'terminar_periodo' %}");
        console.log('üîó URL get_matriculas_json:', "{% url 'get_matriculas_json' %}");

        // Inicializar matr√≠culas cuando el DOM est√© listo
        console.log('DOM cargado, inicializando matr√≠culas...');
        inicializarMatriculas();
    });

    document.addEventListener('DOMContentLoaded', function () {
        console.log('üîç DIAGN√ìSTICO DE ELEMENTOS:');
        console.log('buscarPostulantes:', document.getElementById('buscarPostulantes'));
        console.log('filtroCategoria:', document.getElementById('filtroCategoria'));
        console.log('ordenarPostulantes:', document.getElementById('ordenarPostulantes'));
        console.log('btnLimpiarFiltros:', document.getElementById('btnLimpiarFiltros'));
        console.log('btnResetearOrden:', document.getElementById('btnResetearOrden'));
        console.log('postulantes-row:', document.getElementById('postulantes-row'));
    });

    setTimeout(() => {
        console.log('üîç VERIFICANDO FECHAS EN TARJETAS:');
        document.querySelectorAll('.fecha-postulacion').forEach((element, index) => {
            const fechaData = element.getAttribute('data-fecha');
            const textoFecha = element.textContent;
            console.log(`Tarjeta ${index}: data-fecha="${fechaData}", texto="${textoFecha}"`);
        });
    }, 1000);


    function diagnosticarProblemas() {
    console.log('üîç DIAGN√ìSTICO COMPLETO DE FILTROS:');
    
    // 1. Verificar data attributes
    const primeraTarjeta = document.querySelector('#matriculas-row .col-md-4');
    if (primeraTarjeta) {
        console.log('üìä DATA ATTRIBUTES DE PRIMERA TARJETA:');
        console.log('- data-nombre:', primeraTarjeta.getAttribute('data-nombre'));
        console.log('- data-categoria:', primeraTarjeta.getAttribute('data-categoria'));
        console.log('- data-rendimiento:', primeraTarjeta.getAttribute('data-rendimiento'));
        console.log('- data-porcentaje-asistencia:', primeraTarjeta.getAttribute('data-porcentaje-asistencia'));
        console.log('- data-porcentaje-objetivos:', primeraTarjeta.getAttribute('data-porcentaje-objetivos'));
        console.log('- data-calificacion-general:', primeraTarjeta.getAttribute('data-calificacion-general'));
    } else {
        console.log('‚ùå No se encontraron tarjetas en #matriculas-row');
    }
    
    // 2. Verificar estad√≠sticas en Django template
    console.log('üìä ESTAD√çSTICAS EN TEMPLATE (primer alumno):');
    {% if allMatriculas %}
    {% with primera=m.allMatriculas.0 %}
    console.log('- Rendimiento:', '{{ primera.estadisticas.rendimiento }}');
    console.log('- Asistencia:', '{{ primera.estadisticas.porcentaje_asistencia }}');
    console.log('- Objetivos:', '{{ primera.estadisticas.porcentaje_objetivos }}');
    console.log('- Calificaci√≥n:', '{{ primera.estadisticas.calificacion_general }}');
    {% endwith %}
    {% endif %}
    
    // 3. Verificar elementos de filtro
    console.log('üéØ ELEMENTOS DE FILTRO:');
    console.log('- buscarMatriculados:', document.getElementById('buscarMatriculados'));
    console.log('- filtroCategoriaMatriculados:', document.getElementById('filtroCategoriaMatriculados'));
    console.log('- filtroRendimiento:', document.getElementById('filtroRendimiento'));
    console.log('- ordenarMatriculados:', document.getElementById('ordenarMatriculados'));
    console.log('- contadorMatriculados:', document.getElementById('contadorMatriculados'));
    
    // 4. Verificar si las funciones se est√°n llamando
    console.log('üîß FUNCIONES INICIALIZADAS:');
    console.log('- inicializarFiltrosMatriculados se ejecut√≥?', typeof inicializarFiltrosMatriculados === 'function');
    console.log('- aplicarFiltrosMatriculados se ejecut√≥?', typeof aplicarFiltrosMatriculados === 'function');
}

// Ejecutar diagn√≥stico cuando cargue la p√°gina
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ P√°gina cargada, ejecutando diagn√≥stico...');
    diagnosticarProblemas();
    
    // Probar los filtros manualmente
    setTimeout(() => {
        console.log('üß™ Probando filtros manualmente...');
        aplicarFiltrosMatriculados();
    }, 1000);
});

// Tambi√©n probar cuando se escriba en el buscador
document.getElementById('buscarMatriculados')?.addEventListener('input', function() {
    console.log('‚å®Ô∏è Teclado presionado en buscarMatriculados:', this.value);
});
</script>
{% endblock %}