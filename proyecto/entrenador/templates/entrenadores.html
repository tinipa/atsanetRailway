{% extends 'layouts/plantilla2.html'%}
{% load static %}
<!-- Template de gesti√≥n de entrenadores -->

{% block head %}
<title>Gestion entrenadores</title>
<link rel="stylesheet" href="{% static 'entrenador/css/entrenador.css' %}">
<link rel="stylesheet" href="{% static 'entrenador/css/postulante.css' %}">
<style>
:root {
  --portada-bg: url('{% static "partida/img/5.png" %}');
}
</style>
{% endblock %}

{% block content %}
<!-- Contenedor de notificaciones modernas -->
<div id="notification-container" style="position: fixed; top: 20px; right: 20px; z-index: 99999; display: flex; flex-direction: column; gap: 10px; max-width: 400px;"></div>

<!-- Modal de confirmaci√≥n moderno -->
<div id="custom-confirm-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100000; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 16px; padding: 0; max-width: 450px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: slideDown 0.3s ease;">
        <div id="confirm-header" style="padding: 24px 24px 16px; border-bottom: 2px solid #e5e7eb;"></div>
        <div id="confirm-body" style="padding: 20px 24px; color: #374151; line-height: 1.6;"></div>
        <div style="padding: 16px 24px; display: flex; gap: 12px; justify-content: flex-end; background: #f9fafb; border-radius: 0 0 16px 16px;">
            <button id="confirm-cancel-btn" style="padding: 10px 24px; border: 2px solid #d1d5db; background: white; color: #374151; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s;">Cancelar</button>
            <button id="confirm-accept-btn" style="padding: 10px 24px; border: none; background: linear-gradient(135deg, #ef4444, #dc2626); color: white; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 12px rgba(239,68,68,0.3);">Aceptar</button>
        </div>
    </div>
</div>

<style>
@keyframes slideDown {
    from { transform: translateY(-20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}
@keyframes slideIn {
    from { transform: translateX(400px); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}
@keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(400px); opacity: 0; }
}
#confirm-accept-btn:hover {
    background: linear-gradient(135deg, #dc2626, #b91c1c) !important;
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(239,68,68,0.4) !important;
}
#confirm-cancel-btn:hover {
    background: #f3f4f6 !important;
    border-color: #9ca3af !important;
}
</style>

<div class="grid-main">
    <section class="portada-container">
        <div class="titulo">
            <h2>Gesti√≥n Entrenadores y Postulantes</h2>
        </div>
        <div class="menu">
            <ui>
                <li data-target="#entrenadores">Entrenadores</li>
                <li data-target="#postulantes">Postulantes</li>
                <li data-target="#jornadas">Jornadas y Categorias</li>
            </ui>
        </div>
    </section>
    <section class="paginas-container">
        <div data-content id="entrenadores" class="active">
            <section class="titulo">
                <h3>Personal T</h3>
                <div class="line"></div>
                </section>
            <!-- Filtros arriba y fuera del contenedor de la tabla -->
            <div class="filtros-bar">
                <form method="get" action="" class="filtros-form">
                    <input type="text" name="q" value="{{ request.GET.q|default:'' }}" placeholder="Buscar por nombre..." class="filtro-buscar" id="buscar-input">
                    <button type="button" id="btn-limpiar" class="filtro-btn-limpiar" style="display:none;">Limpiar</button>
                    <button type="submit" name="rol" value="todos" class="filtro-btn {% if request.GET.rol == 'todos' or not request.GET.rol %}active{% endif %}">Todos</button>
                    
                    <!-- Men√∫ desplegable Entrenadores -->
                    <div class="dropdown-filter">
                        <button type="button" class="filtro-btn dropdown-toggle {% if request.GET.rol == 'Entrenador' %}active{% endif %}">
                            Entrenadores ‚ñº
                        </button>
                        <div class="dropdown-menu">
                            <button type="submit" name="rol" value="Entrenador" class="dropdown-item">Activos</button>
                            <button type="submit" name="rol" value="Entrenador_inactivo" class="dropdown-item">Desactivados</button>
                        </div>
                    </div>
                    
                    <!-- Men√∫ desplegable Administradores -->
                    <div class="dropdown-filter">
                        <button type="button" class="filtro-btn dropdown-toggle {% if request.GET.rol == 'Administrador' %}active{% endif %}">
                            Administradores ‚ñº
                        </button>
                        <div class="dropdown-menu">
                            <button type="submit" name="rol" value="Administrador" class="dropdown-item">Activos</button>
                            <button type="submit" name="rol" value="Administrador_inactivo" class="dropdown-item">Desactivados</button>
                        </div>
                    </div>
                </form>
            </div>
            <section class="entrenadores-container">
                <div class="entrenadores-cards-wrapper" style="width:100%;">
                    <h3 style="margin:0 0 10px 0; color:#0e245c; font-weight:700;">Personal T</h3>
                    <div class="cards-grid">
                        {% for p in personales %}
                        <div class="entrenador-card {% if not p.estado %}inactivo{% endif %}">
                            <div class="card-header">
                                <div class="avatar" aria-hidden="true">
                                    <span class="avatar-initial">{{ p.fk_persona.nom1_persona|slice:":1" }}</span>
                                </div>
                                <div class="info">
                                    <h3 class="nombre">{{ p.fk_persona.nom1_persona }}{% if p.fk_persona.nom2_persona %} {{ p.fk_persona.nom2_persona|slice:":1" }}.{% endif %} {{ p.fk_persona.ape1_persona }}{% if p.fk_persona.ape2_persona %} {{ p.fk_persona.ape2_persona|slice:":1" }}.{% endif %}</h3>
                                    <p class="email">{{ p.fk_persona.email_persona }}</p>
                                </div>
                            </div>
                            <div class="card-actions">
                                <form method="post" action="{% url 'entrenador' %}" class="role-form">
                                    {% csrf_token %}
                                    <input type="hidden" name="id" value="{{ p.fk_persona.id_persona }}">
                                    <select name="tipo_personal" class="role-select" data-current-role="{{ p.tipo_personal }}">
                                        <option value="Entrenador" {% if p.tipo_personal == 'Entrenador' %}selected{% endif %}>Entrenador</option>
                                        <option value="Administrador" {% if p.tipo_personal == 'Administrador' %}selected{% endif %}>Administrador</option>
                                    </select>
                                </form>
                                <form method="post" action="{% url 'entrenador' %}" class="estado-form">
                                    {% csrf_token %}
                                    <input type="hidden" name="id" value="{{ p.fk_persona.id_persona }}">
                                    <input type="hidden" name="estado" value="0">
                                    <label class="switch">
                                        <input type="checkbox" name="estado" value="1" class="estado-checkbox" data-current-state="{% if p.estado %}1{% else %}0{% endif %}" {% if p.estado %}checked{% endif %}>
                                        <span class="slider round"></span>
                                    </label>
                                </form>
                                <button type="button" class="editar edit-btn" title="Editar" data-bs-toggle="modal" data-bs-target="#editar"
                                    data-nom1="{{ p.fk_persona.nom1_persona }}"
                                    data-nom2="{{ p.fk_persona.nom2_persona|default:'' }}"
                                    data-ape1="{{ p.fk_persona.ape1_persona }}"
                                    data-ape2="{{ p.fk_persona.ape2_persona|default:'' }}"
                                    data-email="{{ p.fk_persona.email_persona }}"
                                    data-rol="{{ p.tipo_personal }}"
                                    data-estado="{% if p.estado %}Activo{% else %}Inactivo{% endif %}"
                                    data-tel="{{ p.fk_persona.tel_persona }}"
                                    data-direc="{{ p.fk_persona.direc_persona }}"
                                    data-tipoid="{{ p.fk_persona.tipo_identidad }}"
                                    data-idpersona="{{ p.fk_persona.id_persona }}"
                                    data-fecha_nac="{{ p.fk_persona.fecha_nacimiento|date:'Y-m-d' }}"
                                    data-eps="{{ p.fk_persona.eps }}"
                                    data-rh="{{ p.fk_persona.rh }}"
                                    data-genero="{{ p.fk_persona.genero }}"
                                ><span aria-hidden="true">‚úé</span></button>
                            </div>
                        </div>
                        {% empty %}
                        <p style="grid-column:1/-1; margin:0; padding:12px; background:#fff; border:1px solid #e2e6ee; border-radius:10px; text-align:center;">No hay entrenadores o administradores para mostrar.</p>
                        {% endfor %}
                    </div>
                </div>
            </section>
        </div>

        <div data-content id="postulantes">
            <section class="titulo">
                <h3>Entrenadores Postulados</h3>
                <div class="line"></div>
                <div class="postulantes-tools" style="margin-top:10px; display:flex; gap:12px; flex-wrap:wrap;">
                    <button type="button" id="btn-puntajes" class="filtro-btn postulantes-tool-btn">üìä Mostrar puntaje de postulantes</button>
                    <button type="button" id="btn-mejores" class="filtro-btn postulantes-tool-btn">‚≠ê Traer las mejores opciones</button>
                    <button type="button" id="btn-limpiar-puntajes" class="filtro-btn postulantes-tool-btn">üßπ Limpiar</button>
                    
                    <!-- Desplegable de categor√≠as -->
                    <div class="dropdown-filter">
                        <button class="filtro-btn postulantes-tool-btn dropdown-toggle" type="button" id="dropdownCategorias">
                            üéØ Filtrar por categor√≠a ‚ñº
                        </button>
                        <div class="dropdown-menu">
                            <button type="button" class="dropdown-item filtro-categoria" data-categoria=""></button>
                            {% for categoria in categorias %}
                            <button type="button" class="dropdown-item filtro-categoria" data-categoria="{{ categoria.nom_categoria }}">{{ categoria.nom_categoria }}</button>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <div id="mejoresMensaje" style="margin-top:8px; font-size:0.8rem; color:#0e4da0;"></div>
            
            <section class="postulantes-container">
                <div class="postulante-cards-grid">
                    {% for p in postulantes %}
                    <div class="postulante-card {% if p.estado_proceso == 'en_proceso' %}en-proceso{% endif %}" data-persona-pk="{{ p.fk_persona.id }}">
                        <div class="pc-avatar" aria-hidden="true"><span>{{ p.fk_persona.nom1_persona|slice:":1" }}</span></div>
                        <div class="pc-header">
                            <div class="pc-info">
                                <h4 class="pc-nombre">{{ p.fk_persona.nom1_persona }}{% if p.fk_persona.nom2_persona %} {{ p.fk_persona.nom2_persona }}{% endif %} {{ p.fk_persona.ape1_persona }}{% if p.fk_persona.ape2_persona %} {{ p.fk_persona.ape2_persona }}{% endif %}</h4>
                                <p class="pc-email">{{ p.fk_persona.email_persona }}</p>
                            </div>
                        </div>
                        {% if p.estado_proceso == 'en_proceso' %}
                        <span class="badge-proceso">üìã En Proceso</span>
                        {% endif %}
                        <div class="pc-score" data-score-for="{{ p.fk_persona.id_persona }}">
                            <div class="pc-score-main">Puntaje: <span class="pc-score-value">0</span> pts</div>
                            <div class="pc-score-extra">Exp:<span class="pc-exp">0</span> | Hab:<span class="pc-hab">0</span> | ExpPts:<span class="pc-exp-pts">0</span> HabPts:<span class="pc-hab-pts">0</span></div>
                        </div>
                        <div class="pc-actions-main">
                            {% if p.estado_proceso == 'postulante' %}
                            <!-- Postulante inicial: Pasar a Proceso o Rechazar directo -->
                            <button type="button" class="btn-aceptar btn-pasar-proceso" 
                                data-id="{{ p.fk_persona.id_persona }}"
                                data-nombre="{{ p.fk_persona.nom1_persona }} {{ p.fk_persona.ape1_persona }}"
                                data-email="{{ p.fk_persona.email_persona }}"
                                title="Pasar a proceso de entrevista"><span class="btn-icon">üìã</span> <span class="btn-text">Pasar a Proceso</span></button>
                            <button type="button" class="btn-rechazar btn-rechazar-directo"
                                data-id="{{ p.fk_persona.id_persona }}"
                                data-nombre="{{ p.fk_persona.nom1_persona }} {{ p.fk_persona.ape1_persona }}"
                                title="Rechazar postulante"><span class="btn-icon">‚úñ</span> <span class="btn-text">Rechazar</span></button>
                            {% elif p.estado_proceso == 'en_proceso' %}
                            <!-- En proceso: Aceptar definitivamente o Rechazar con opci√≥n de correo -->
                            <button type="button" class="btn-aceptar btn-aceptar-final"
                                data-id="{{ p.fk_persona.id_persona }}"
                                data-nombre="{{ p.fk_persona.nom1_persona }} {{ p.fk_persona.ape1_persona }}"
                                data-email="{{ p.fk_persona.email_persona }}"
                                title="Aceptar como entrenador"><span class="btn-icon">‚úî</span> <span class="btn-text">Aceptar</span></button>
                            <button type="button" class="btn-rechazar btn-rechazar-proceso"
                                data-id="{{ p.fk_persona.id_persona }}"
                                data-nombre="{{ p.fk_persona.nom1_persona }} {{ p.fk_persona.ape1_persona }}"
                                data-email="{{ p.fk_persona.email_persona }}"
                                title="Rechazar postulante"><span class="btn-icon">‚úñ</span> <span class="btn-text">Rechazar</span></button>
                            {% endif %}
                        </div>
                        <div class="pc-footer">
                            <button type="button" class="btn-verinfo btn-ver" data-bs-toggle="modal" data-bs-target="#verdatos"
                                data-nom1="{{ p.fk_persona.nom1_persona }}"
                                data-nom2="{{ p.fk_persona.nom2_persona|default:'' }}"
                                data-ape1="{{ p.fk_persona.ape1_persona }}"
                                data-ape2="{{ p.fk_persona.ape2_persona|default:'' }}"
                                data-email="{{ p.fk_persona.email_persona }}"
                                data-tel="{{ p.fk_persona.tel_persona }}"
                                data-direc="{{ p.fk_persona.direc_persona }}"
                                data-tipoid="{{ p.fk_persona.tipo_identidad }}"
                                data-idpersona="{{ p.fk_persona.id_persona }}"
                                data-personapk="{{ p.fk_persona.id }}"
                                data-fecha_nac="{{ p.fk_persona.fecha_nacimiento|date:'Y-m-d' }}"
                                data-eps="{{ p.fk_persona.eps }}"
                                data-rh="{{ p.fk_persona.rh }}"
                                data-genero="{{ p.fk_persona.genero }}"
                                data-experiencia="{{ p.experiencia|default:'0' }}"
                                data-especialidad="{{ p.descripcion_especialidad|default:'No especificada' }}"
                                data-categoria-experiencia="{{ p.categoria_experiencia|default:'No especificada' }}"
                                data-hoja-vida="{% if p.hoja_vida %}{{ p.hoja_vida.url }}{% endif %}"
                                data-tarjeta-prof="{% if p.tarjeta_profesional %}{{ p.tarjeta_profesional.url }}{% endif %}"
                                data-antecedentes="{% if p.antecedentes %}{{ p.antecedentes.url }}{% endif %}"
                                data-primeros-auxilios="{% if p.certificado_primeros_auxilios %}{{ p.certificado_primeros_auxilios.url }}{% endif %}"
                                data-experiencias='{{ p.experiencias_relacionadas.all|length }}'
                            >üëÅ Ver Informaci√≥n</button>
                        </div>
                    </div>
                    {% empty %}
                    <p style="grid-column:1/-1; text-align:center; background:#fff; padding:14px; border:1px solid #e2e6ee; border-radius:10px;">No hay postulantes en este momento.</p>
                    {% endfor %}
                </div>
                <!-- Contenedor din√°mico para puntajes -->
                <div id="puntajesPostulantes" style="display:none;"></div>
            </section>
        </div>

        <div data-content id="jornadas">
            <section class="titulo">
                <h3>Asignaci√≥n de Jornadas</h3>
                <div class="line"></div>
            </section>
            <section class="jornadas-container">
                <div class="jornadas-wrapper">
                    <!-- Fila Superior: Crear y Asignaciones lado a lado -->
                    <div class="jornadas-top">
                        <!-- Crear y Asignar Jornada -->
                        <div class="jornada-card jornada-card-compact">
                            <div class="card-header-jornada">
                                <span class="icon-jornada">üìÖ</span>
                                <h4>Creaci√≥n y Asignaci√≥n de Jornada</h4>
                            </div>
                            <p>Selecciona categor√≠a, jornada y entrenador</p>
                            <form id="form-crear-jornada" method="post" action="{% url 'entrenador' %}">
                                {% csrf_token %}
                                <div class="form-group-compact">
                                    <label>Categor√≠a</label>
                                    <div class="checkbox-group-compact">
                                        {% for categoria in categorias %}
                                        <div class="checkbox-item-compact">
                                            <input type="radio" name="categoria" value="{{ categoria.idcategoria }}" id="cat_{{ categoria.idcategoria }}" required>
                                            <label for="cat_{{ categoria.idcategoria }}">{{ categoria.nom_categoria }}</label>
                                        </div>
                                        {% empty %}
                                        <small style="color:#64748b; font-style:italic;">No hay categor√≠as disponibles</small>
                                        {% endfor %}
                                    </div>
                                </div>
                                <div class="form-group-compact">
                                    <label for="jornada_select">Jornada</label>
                                    <select name="jornada" id="jornada_select" class="select-compact" required>
                                        <option value="">-- Selecciona jornada --</option>
                                        {% for jornada in jornadas %}
                                        <option value="{{ jornada.idjornada }}">{{ jornada.dia_jornada }} ({{ jornada.hora_entrada|time:"g:ia" }}-{{ jornada.hora_salida|time:"g:ia" }})</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="form-group-compact">
                                    <label for="entrenador_select">Entrenador</label>
                                    <select name="entrenador" id="entrenador_select" class="select-compact" required>
                                        <option value="">-- Selecciona entrenador --</option>
                                        {% for entrenador in entrenadores %}
                                        <option value="{{ entrenador.fk_persona.id_persona }}">{{ entrenador.fk_persona.nom1_persona }} {{ entrenador.fk_persona.ape1_persona }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <button type="submit" name="accion_jornada" value="crear" class="btn-jornada-submit">‚úì Crear Jornada</button>
                            </form>
                        </div>

                        <!-- Entrenadores con Jornadas -->
                        <div class="jornada-card jornada-card-compact">
                            <div class="card-header-jornada">
                                <span class="icon-jornada">üìã</span>
                                <h4>Entrenadores Asignados</h4>
                            </div>
                            <div class="asignaciones-grid">
                                {% for item in entrenadores_con_jornadas %}
                                <div class="asignacion-item-compact">
                                    <div class="asignacion-details">
                                        <div class="asignacion-entrenador">üë§ {{ item.entrenador.fk_persona.nom1_persona }} {{ item.entrenador.fk_persona.ape1_persona }}</div>
                                        <div class="asignacion-jornada" style="font-size: 0.85rem; color: #64748b;">
                                            {{ item.num_jornadas }} jornada{{ item.num_jornadas|pluralize }}
                                        </div>
                                    </div>
                                    <button class="btn-editar-compact" data-bs-toggle="modal" data-bs-target="#verJornadas"
                                        data-entrenador-id="{{ item.entrenador.fk_persona.id_persona }}"
                                        data-entrenador-nombre="{{ item.entrenador.fk_persona.nom1_persona }} {{ item.entrenador.fk_persona.ape1_persona }}">üëÅ Ver Jornadas</button>
                                </div>
                                {% empty %}
                                <p style="text-align:center; color:#64748b; font-style:italic; padding:20px;">No hay entrenadores con jornadas asignadas</p>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </section>


    <!-- Modal editar entrenador -->
    <div class="modal fade modal-lg" id="editar" tabindex="-1" aria-labelledby="editararia" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="editararia">Editar Entrenador Registrado</h4>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <form id="form-editar-entrenador" method="post" action="{% url 'entrenador' %}">
                        {% csrf_token %}
                        <div class="informacionGeneral" data-aos="zoom-in">
                            <h2>Datos Generales üë§</h2>
                            <div class="input-container">
                                <label for="tipo_identificacion">Tipo de Identificaci√≥n: </label>
                                <input type="text" name="tipo_identificacion" id="tipo_identificacion" required readonly
                                    placeHolder="Ingresa un tipo de id..">
                            </div>

                            <div class="input-container">
                                <label for="id">N√∫mero de Identificaci√≥n: </label>
                                <input type="text" name="id" id="id" required placeHolder="Ingresa un numero..">
                            </div>
                            
                            <div class="input-container">
                                <label for="nom1_persona">Primer Nombre: </label>
                                <input type="text" name="nom1_persona" id="nom1_persona" required
                                    placeHolder="Ingresa un nombre..">
                            </div>

                            <div class="input-container">
                                <label for="nom2_persona">Segundo Nombre : </label>
                                <input type="text" name="nom2_persona" id="nom2_persona"
                                    placeHolder="Ingresa un nombre..">
                            </div>

                            <div class="input-container">
                                <label for="ape1_persona">Primer Apellido: </label>
                                <input type="text" name="ape1_persona" id="ape1_persona" required
                                    placeHolder="Ingresa un nombre..">
                            </div>

                            <div class="input-container">
                                <label for="ape2_persona">Segundo Apellido: </label>
                                <input type="text" name="ape2_persona" id="ape2_persona" required
                                    placeHolder="Ingresa un nombre..">
                            </div>

                            <!-- Rol moved to inline table control; removed from modal to avoid duplicate editing -->

                            <div class="input-container">
                                <label for="genero">Genero: </label>
                                <select name="genero" id="genero" required>
                                    <option value="">--Seleccione--</option>
                                    <option value="M">M</option>
                                    <option value="F">F</option>
                                </select>
                            </div>

                            <div class="input-container">
                                <label for="fecha_nacimiento">Fecha Nacimiento: </label>
                                <!-- Fecha es campo no editable -->
                                <input type="text" name="fecha_nacimiento" id="fecha_nacimiento" required readonly
                                    placeHolder="Ingresa un nombre..">
                            </div>
                        </div>
                        <div class="datosFisicos" data-aos="zoom-in">
                            <h2>Datos Fisicos ‚ù§Ô∏è</h2>
                            <div class="input-container">
                                <label for="rhs">Tipo de Sangre: </label>
                                <!-- Mostrar tipo de sangre como no editable pero enviar su valor mediante input hidden -->
                                <select id="rhs" disabled>
                                    <option value="">--Seleccione--</option>
                                    <option value="A+">A+</option>
                                    <option value="A-">A-</option>
                                    <option value="B+">B+</option>
                                    <option value="B-">B-</option>
                                    <option value="AB+">AB+</option>
                                    <option value="AB-">AB-</option>
                                    <option value="O+">O+</option>
                                    <option value="O-">O-</option>
                                </select>
                                <input type="hidden" name="rhs" id="rhs_hidden">
                            </div>
                            <div class="input-container">
                                <label for="eps">Eps: </label>
                                <select name="eps" id="eps" required>
                                    <option value="">--Seleccione--</option>
                                    <option value="Sanitas">Sanitas</option>
                                    <option value="Sura">Sura</option>
                                    <option value="Compensar">Compensar</option>
                                    <option value="Salud Total">Salud Total</option>
                                    <option value="Famisanar">Famisanar</option>
                                    <option value="Capital Salud">Capital Salud</option>
                                    <option value="Aliansalud">Aliansalud</option>
                                    <option value="Salud Bolivar">Salud Bolivar</option>
                                </select>
                            </div>
                        </div>

                        <div class="datosContactos" data-aos="zoom-in">
                            <h2>Informaci√≥n de Contacto üìû</h2>
                            <div class="input-container">
                                <label for="direc_persona">Direcci√≥n domicilio: </label>
                                <input type="text" name="direc_persona" id="direc_persona" required
                                    placeHolder="Ingresa un nombre..">
                            </div>
                            <div class="input-container">
                                <label for="tel_persona">N√∫mero Celular: </label>
                                <input type="text" name="tel_persona" id="tel_persona" required
                                    placeHolder="Ingresa un nombre..">
                            </div>
                            <div class="input-container">
                                <label for="email_persona">Correo Electr√≥nico: </label>
                                <input type="email" name="email_persona" id="email_persona" required pattern="^[^\s@]+@[^\s@]+\.[^\s@]+$" placeholder="ejemplo@correo.com">
                            </div>
                        </div>

                        <button type="submit" class="btn-enviar">Guardar</button>
                    </form>
                    <button type="button" class="btn-regresar" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal enviar correo personalizado -->
    <div class="modal fade" id="modalCorreo" tabindex="-1" aria-labelledby="modalCorreoLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="modalCorreoLabel">Enviar Correo</h4>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <form id="form-enviar-correo" method="post" action="{% url 'entrenador' %}">
                        {% csrf_token %}
                        <input type="hidden" name="accion_correo" id="accion_correo" value="">
                        <input type="hidden" name="id_postulante" id="id_postulante" value="">
                        <input type="hidden" name="tipo_correo" id="tipo_correo" value="personalizado">
                        
                        <div class="form-group mb-3">
                            <label for="destinatario_correo" class="form-label">Para:</label>
                            <input type="email" class="form-control" id="destinatario_correo" name="destinatario" readonly style="background-color: #f0f0f0;">
                        </div>
                        
                        <!-- Opciones de tipo de correo (solo para aceptar_final y rechazar_proceso) -->
                        <div class="form-group mb-3" id="opciones_tipo_correo" style="display: none;">
                            <label class="form-label">Tipo de correo:</label>
                            <div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="tipo_correo_radio" id="correo_automatico" value="automatico" checked>
                                    <label class="form-check-label" for="correo_automatico">
                                        Autom√°tico 
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="tipo_correo_radio" id="correo_personalizado" value="personalizado">
                                    <label class="form-check-label" for="correo_personalizado">
                                        Personalizado
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Nota para invitaci√≥n (solo cuando es pasar_proceso) -->
                        <div class="form-group mb-3" id="nota_invitacion" style="display: none;">
                            <label class="form-label">Correo personalizado:</label>
                            <p style="margin:0; color:#4b5563; font-size:0.95rem;">Ingresa fecha, hora y lugar de la entrevista.</p>
                        </div>
                        
                        <div id="campos_personalizados">
                            <div class="form-group mb-3">
                                <label for="asunto_correo" class="form-label">Asunto:</label>
                                <input type="text" class="form-control" id="asunto_correo" name="asunto" required>
                            </div>
                            
                            <div class="form-group mb-3">
                                <label for="mensaje_correo" class="form-label">Mensaje:</label>
                                <textarea class="form-control" id="mensaje_correo" name="mensaje" rows="8" required></textarea>
                            </div>
                        </div>
                        
                        <div id="preview_automatico" style="display:none; padding: 15px; background: #f8f9fa; border-radius: 8px; margin-bottom: 15px;">
                            <strong>Vista previa del correo autom√°tico:</strong>
                            <div id="contenido_preview" style="margin-top: 10px; padding: 10px; background: white; border: 1px solid #dee2e6; border-radius: 4px;"></div>
                        </div>
                        
                        <div class="d-flex gap-2 justify-content-end">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-primary">‚úâ Enviar Correo</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal ver jornadas del entrenador -->
    <div class="modal fade" id="verJornadas" tabindex="-1" aria-labelledby="verJornadasLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="verJornadasLabel">Jornadas Asignadas</h4>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <h5 id="ver_entrenador_nombre" style="margin-bottom: 20px; color: #0e245c;"></h5>
                    <div id="jornadas_list" style="display: flex; flex-direction: column; gap: 15px;">
                        <!-- Se llenar√° din√°micamente con JavaScript -->
                    </div>
                    <button type="button" class="btn-regresar" data-bs-dismiss="modal" style="margin-top: 20px;">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal editar jornada individual -->
    <div class="modal fade" id="editarJornada" tabindex="-1" aria-labelledby="editarJornadaLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="editarJornadaLabel">Editar Asignaci√≥n de Jornada</h4>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <form id="form-editar-jornada" method="post" action="{% url 'entrenador' %}">
                        {% csrf_token %}
                        <input type="hidden" name="accion_jornada" value="editar">
                        <input type="hidden" name="asignacion_id" id="edit_asignacion_id">
                        
                        <div class="form-group-compact">
                            <label>Entrenador (No editable)</label>
                            <input type="text" id="edit_entrenador_nombre" class="select-compact" readonly style="background-color: #f0f0f0; cursor: not-allowed;">
                        </div>
                        
                        <div class="form-group-compact">
                            <label>Categor√≠a</label>
                            <div class="checkbox-group-compact">
                                {% for categoria in categorias %}
                                <div class="checkbox-item-compact">
                                    <input type="radio" name="categoria" value="{{ categoria.idcategoria }}" id="edit_cat_{{ categoria.idcategoria }}" required>
                                    <label for="edit_cat_{{ categoria.idcategoria }}">{{ categoria.nom_categoria }}</label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <div class="form-group-compact">
                            <label for="edit_jornada_select">Jornada</label>
                            <select name="jornada" id="edit_jornada_select" class="select-compact" required>
                                <option value="">-- Selecciona jornada --</option>
                                {% for jornada in jornadas %}
                                <option value="{{ jornada.idjornada }}">{{ jornada.dia_jornada }} ({{ jornada.hora_entrada|time:"g:ia" }}-{{ jornada.hora_salida|time:"g:ia" }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <button type="submit" class="btn-jornada-submit">‚úì Guardar Cambios</button>
                    </form>
                    <button type="button" class="btn-regresar" data-bs-dismiss="modal" style="margin-top: 10px;">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal ver informacion -->
    <div class="modal fade modal-lg" id="verdatos" tabindex="-1" aria-labelledby="verdatosaria" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="verdatosaria">Informaci√≥n del Personal</h4>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="informacionGeneral" data-aos="zoom-in">
                            <h2>Datos Generales üë§</h2>
                            <div class="input-container">
                                <label>Tipo de Identificaci√≥n:</label>
                                <div class="readonly-field" id="v_tipoid"></div>
                            </div>
                            <div class="input-container">
                                <label>N√∫mero de Identificaci√≥n:</label>
                                <div class="readonly-field" id="v_idpersona"></div>
                            </div>
                            <div class="input-container">
                                <label>Nombres:</label>
                                <div class="readonly-field" id="v_nombres"></div>
                            </div>
                            <div class="input-container">
                                <label>Apellidos:</label>
                                <div class="readonly-field" id="v_apellidos"></div>
                            </div>
                            <div class="input-container">
                                <label>Genero:</label>
                                <div class="readonly-field" id="v_genero"></div>
                            </div>
                            <div class="input-container">
                                <label>Fecha Nacimiento:</label>
                                <div class="readonly-field" id="v_fecha_nac"></div>
                            </div>
                        </div>
                        <div class="datosFisicos" data-aos="zoom-in">
                            <h2>Datos F√≠sicos ‚ù§Ô∏è</h2>
                            <div class="input-container">
                                <label>Tipo de Sangre:</label>
                                <div class="readonly-field" id="v_rh"></div>
                            </div>
                            <div class="input-container">
                                <label>Eps:</label>
                                <div class="readonly-field" id="v_eps"></div>
                            </div>
                        </div>
                        <div class="datosContactos" data-aos="zoom-in">
                            <h2>Informaci√≥n de Contacto üìû</h2>
                            <div class="input-container">
                                <label>Direcci√≥n domicilio:</label>
                                <div class="readonly-field" id="v_direc"></div>
                            </div>
                            <div class="input-container">
                                <label>N√∫mero Celular:</label>
                                <div class="readonly-field" id="v_tel"></div>
                            </div>
                            <div class="input-container">
                                <label>Correo Electronico:</label>
                                <div class="readonly-field" id="v_email"></div>
                            </div>
                        </div>
                        <div class="experienciaProfesional" data-aos="zoom-in">
                            <h2>Experiencia Profesional üíº</h2>
                            <div class="input-container">
                                <label>Descripci√≥n de Especialidad:</label>
                                <div class="readonly-field" id="v_especialidad" style="white-space: pre-wrap;"></div>
                            </div>
                            <div class="input-container">
                                <label>Categor√≠a de Experiencia:</label>
                                <div class="readonly-field" id="v_categoria_experiencia"></div>
                            </div>
                            <div class="input-container">
                                <label>Hoja de Vida (PDF):</label>
                                <div class="readonly-field" id="v_hoja_vida"></div>
                            </div>
                            <div class="input-container">
                                <label>Tarjeta Profesional:</label>
                                <div class="readonly-field" id="v_tarjeta_prof"></div>
                            </div>
                            <div class="input-container">
                                <label>Antecedentes (PDF):</label>
                                <div class="readonly-field" id="v_antecedentes"></div>
                            </div>
                            <div class="input-container">
                                <label>Certificado Primeros Auxilios:</label>
                                <div class="readonly-field" id="v_primeros_auxilios"></div>
                            </div>
                            <div class="input-container">
                                <label>Experiencias Registradas:</label>
                                <div id="v_experiencias_detalle" style="display: flex; flex-direction: column; gap: 10px;">
                                    <!-- Se llenar√° din√°micamente con las experiencias -->
                                </div>
                            </div>
                            <div class="input-container">
                                <label>Total A√±os de Experiencia:</label>
                                <div class="readonly-field" id="v_experiencia"></div>
                            </div>
                        </div>
                        <div class="habilidades" data-aos="zoom-in">
                            <h2>Habilidades üéØ</h2>
                            <div id="v_habilidades" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 15px; background: #f8fafc; border-radius: 10px;">
                                <!-- Se llenar√° din√°micamente -->
                            </div>
                        </div>
                    </form>
                    <button type="button" class="btn-regresar" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block scripts %}
<script src="{% static 'partida/scripts/paginas.js' %}"></script>
<script>



















































































































































































































































































// Datos de asignaciones para el modal (generados desde el backend)
const asignacionesPorEntrenador = JSON.parse('{{ asignaciones_json|escapejs }}');
console.log('Asignaciones por entrenador:', asignacionesPorEntrenador);

// Verificar si se debe reabrir el modal despu√©s de eliminar una jornada
document.addEventListener('DOMContentLoaded', function(){
    const entrenadorIdReabrir = sessionStorage.getItem('reabrirModalJornadas');
    if(entrenadorIdReabrir) {
        // Limpiar el flag
        sessionStorage.removeItem('reabrirModalJornadas');
        
        // Buscar el bot√≥n de ver jornadas para ese entrenador y hacer click
        setTimeout(function(){
            const btnVerJornadas = document.querySelector(`[data-bs-target="#verJornadas"][data-entrenador-id="${entrenadorIdReabrir}"]`);
            if(btnVerJornadas) {
                btnVerJornadas.click();
            }
        }, 100);
    }
});

// Manejar el evento de ver jornadas
document.addEventListener('DOMContentLoaded', function(){
    document.querySelectorAll('[data-bs-target="#verJornadas"]').forEach(function(btn){
        btn.addEventListener('click', function(e){
            const entrenadorId = e.currentTarget.dataset.entrenadorId;
            const entrenadorNombre = e.currentTarget.dataset.entrenadorNombre;
            
            console.log('Click en Ver Jornadas para entrenador ID:', entrenadorId);
            console.log('Nombre:', entrenadorNombre);
            
            // Actualizar t√≠tulo
            document.getElementById('ver_entrenador_nombre').textContent = 'üë§ ' + entrenadorNombre;
            
            // Limpiar lista de jornadas
            const jornadasList = document.getElementById('jornadas_list');
            jornadasList.innerHTML = '';
            
            // Obtener asignaciones del entrenador
            const asignaciones = asignacionesPorEntrenador[entrenadorId] || [];
            
            console.log('Asignaciones encontradas:', asignaciones);
            
            if(asignaciones.length === 0){
                jornadasList.innerHTML = '<p style="text-align:center; color:#64748b; padding:20px;">No tiene jornadas asignadas</p>';
                return;
            }
            
            // Crear un item por cada asignaci√≥n
            asignaciones.forEach(function(asig){
                const item = document.createElement('div');
                item.style.cssText = 'background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 12px; padding: 15px; display: flex; justify-content: space-between; align-items: center;';
                
                item.innerHTML = `
                    <div>
                        <div style="font-weight: 700; color: #0e245c; margin-bottom: 5px;">üìö ${asig.categoria_nombre}</div>
                        <div style="font-size: 0.9rem; color: #64748b;">üìÖ ${asig.jornada_dia} (${asig.jornada_hora})</div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn-editar-individual" 
                            data-id="${asig.id}"
                            data-categoria="${asig.categoria_id}"
                            data-jornada="${asig.jornada_id}"
                            data-entrenador-nombre="${entrenadorNombre}"
                            style="background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s;">
                            ‚úèÔ∏è Editar
                        </button>
                        <button class="btn-eliminar-jornada" 
                            data-id="${asig.id}"
                            data-categoria-nombre="${asig.categoria_nombre}"
                            data-jornada-info="${asig.jornada_dia} (${asig.jornada_hora})"
                            data-entrenador-nombre="${entrenadorNombre}"
                            style="background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s;">
                            üóëÔ∏è Eliminar
                        </button>
                    </div>
                `;
                
                jornadasList.appendChild(item);
            });
            
            // Agregar event listeners a los botones de editar individual
            document.querySelectorAll('.btn-editar-individual').forEach(function(editBtn){
                editBtn.addEventListener('click', function(){
                    const d = this.dataset;
                    
                    // Cerrar modal de ver jornadas
                    const verJornadasModal = bootstrap.Modal.getInstance(document.getElementById('verJornadas'));
                    if(verJornadasModal) verJornadasModal.hide();
                    
                    // Abrir modal de editar jornada
                    const editarJornadaModal = new bootstrap.Modal(document.getElementById('editarJornada'));
                    editarJornadaModal.show();
                    
                    // Llenar campos del modal de edici√≥n
                    document.getElementById('edit_asignacion_id').value = d.id || '';
                    document.getElementById('edit_entrenador_nombre').value = d.entrenadorNombre || '';
                    
                    // Seleccionar la categor√≠a actual
                    const catRadio = document.getElementById('edit_cat_' + d.categoria);
                    if(catRadio) catRadio.checked = true;
                    
                    // Seleccionar la jornada actual
                    const jornadaSelect = document.getElementById('edit_jornada_select');
                    if(jornadaSelect) jornadaSelect.value = d.jornada || '';
                });
            });
            
            // Agregar event listeners a los botones de eliminar jornada
            document.querySelectorAll('.btn-eliminar-jornada').forEach(function(deleteBtn){
                deleteBtn.addEventListener('click', async function(){
                    const d = this.dataset;
                    const asignacionId = d.id;
                    const categoriaNombre = d.categoriaNombre;
                    const jornadaInfo = d.jornadaInfo;
                    const entrenadorNombre = d.entrenadorNombre;
                    
                    // Mostrar confirmaci√≥n moderna
                    const confirmar = await showConfirm({
                        type: 'danger',
                        title: '¬øEst√° seguro que desea eliminar esta jornada?',
                        message: `
                            <div style="background: #f9fafb; padding: 16px; border-radius: 8px; margin-top: 12px; border-left: 3px solid #ef4444;">
                                <p style="margin: 0 0 8px 0;"><strong>Entrenador:</strong> ${entrenadorNombre}</p>
                                <p style="margin: 0 0 8px 0;"><strong>Categor√≠a:</strong> ${categoriaNombre}</p>
                                <p style="margin: 0;"><strong>Jornada:</strong> ${jornadaInfo}</p>
                            </div>
                            <p style="margin-top: 12px; color: #6b7280;">Esta acci√≥n eliminar√° la asignaci√≥n de la base de datos.</p>
                            <p style="margin-top: 6px; color: #b91c1c; font-weight:600;">Importante: la combinaci√≥n <strong>jornada + categor√≠a</strong> debe quedar asignada al menos a <strong>un entrenador aceptado</strong>. Si es el √∫nico, no se podr√° eliminar.</p>
                        `,
                        acceptText: 'S√≠, Eliminar',
                        cancelText: 'Cancelar'
                    });
                    
                    if(!confirmar) return;
                    
                    // Siempre guardar solo la pesta√±a activa, sin intentar reabrir modal
                    // Esto funciona tanto si es la √∫nica jornada como si hay varias
                    sessionStorage.setItem('pestanaActiva', 'jornadas');
                    sessionStorage.setItem('soloActivarPestana', 'true');
                    
                    // Enviar petici√≥n AJAX para eliminar
                    const formData = new FormData();
                    formData.append('accion_jornada', 'eliminar');
                    formData.append('asignacion_id', asignacionId);
                    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
                    
                    fetch(window.location.href, {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if(data.success){
                            // Recargar la p√°gina
                            window.location.reload();
                        } else {
                            showNotification(data.message || 'No se pudo eliminar la jornada', 'error');
                            sessionStorage.removeItem('reabrirModalJornadas');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showNotification('Error al eliminar la jornada', 'error');
                        sessionStorage.removeItem('reabrirModalJornadas');
                    });
                });
            });
            
            // Agregar manejador AJAX para el formulario de edici√≥n de jornada
            const formEditarJornada = document.getElementById('form-editar-jornada');
            if(formEditarJornada) {
                formEditarJornada.addEventListener('submit', function(e){
                    e.preventDefault(); // Prevenir submit tradicional
                    
                    const formData = new FormData(this);
                    
                    fetch(this.action, {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: formData
                    })
                    .then(response => response.json())
                    .then(async data => {
                        if(data.success){
                            await showConfirm({
                                type: 'success',
                                title: 'Jornada actualizada',
                                message: 'La jornada se actualiz√≥ correctamente',
                                acceptText: 'Entendido',
                                showCancel: false
                            });
                            // Cerrar el modal
                            const editarModal = bootstrap.Modal.getInstance(document.getElementById('editarJornada'));
                            if(editarModal) editarModal.hide();
                            // Recargar la informaci√≥n del modal de ver jornadas si est√° abierto
                            const verJornadasBtn = document.querySelector('.btn-editar-compact');
                            if(verJornadasBtn) {
                                verJornadasBtn.click(); // Re-abrir para actualizar datos
                            }
                        } else {
                            // El error ya se muestra en el showConfirm modal
                            await showConfirm({
                                type: 'danger',
                                title: 'Error al actualizar',
                                message: data.message || 'No se pudo actualizar la jornada',
                                acceptText: 'Entendido',
                                showCancel: false
                            });
                        }
                    })
                    .catch(async error => {
                        console.error('Error:', error);
                        await showConfirm({
                            type: 'danger',
                            title: 'Error',
                            message: 'Error al actualizar la jornada',
                            acceptText: 'Entendido',
                            showCancel: false
                        });
                    });
                });
            }
        });
    });

    // Al cargar la p√°gina, verificar si hay que reabrir el modal de jornadas o activar pesta√±a
    const entrenadorIdReabrir = sessionStorage.getItem('reabrirModalJornadas');
    const pestanaActiva = sessionStorage.getItem('pestanaActiva');
    const soloActivarPestana = sessionStorage.getItem('soloActivarPestana');
    
    if(pestanaActiva === 'jornadas' || soloActivarPestana === 'true') {
        // Limpiar sessionStorage
        sessionStorage.removeItem('reabrirModalJornadas');
        sessionStorage.removeItem('pestanaActiva');
        sessionStorage.removeItem('soloActivarPestana');
        
        // Activar la pesta√±a de jornadas usando el sistema de data-target
        setTimeout(function(){
            const tabJornadas = document.querySelector('[data-target="#jornadas"]');
            if(tabJornadas) {
                tabJornadas.click(); // Hacer clic en la pesta√±a para activarla
            }
        }, 50);
        
        // Solo intentar abrir el modal si hay un entrenadorId y no es solo para activar pesta√±a
        if(entrenadorIdReabrir && soloActivarPestana !== 'true') {
            setTimeout(function(){
                const btnVer = document.querySelector(`.btn-ver[data-entrenador-id="${entrenadorIdReabrir}"]`);
                if(btnVer) {
                    btnVer.click();
                }
            }, 200); // Delay mayor para asegurar que la pesta√±a se active primero
        }
    } else if(pestanaActiva === 'postulantes') {
        // Limpiar sessionStorage
        sessionStorage.removeItem('pestanaActiva');
        
        // Activar la pesta√±a de postulantes
        setTimeout(function(){
            const tabPostulantes = document.querySelector('[data-target="#postulantes"]');
            if(tabPostulantes) {
                tabPostulantes.click();
            }
        }, 50);
    }
});

// Manejo de botones de postulantes con estados
document.addEventListener('DOMContentLoaded', function(){
    const modalCorreo = new bootstrap.Modal(document.getElementById('modalCorreo'));
    const formCorreo = document.getElementById('form-enviar-correo');
    const camposPersonalizados = document.getElementById('campos_personalizados');
    const previewAutomatico = document.getElementById('preview_automatico');
    const opcionesTipoCorreo = document.getElementById('opciones_tipo_correo');
    const notaInvitacion = document.getElementById('nota_invitacion');
    const radioAutomatico = document.getElementById('correo_automatico');
    const radioPersonalizado = document.getElementById('correo_personalizado');
    const tipoCorreoInput = document.getElementById('tipo_correo');
    
    // Manejar cambio de tipo de correo
    if (radioAutomatico && radioPersonalizado) {
        radioAutomatico.addEventListener('change', function() {
            if (this.checked) {
                camposPersonalizados.style.display = 'none';
                previewAutomatico.style.display = 'block';
                tipoCorreoInput.value = 'automatico';
                
                // Quitar required de los campos personalizados
                document.getElementById('asunto_correo').removeAttribute('required');
                document.getElementById('mensaje_correo').removeAttribute('required');
                
                // Mostrar preview seg√∫n la acci√≥n
                const accion = document.getElementById('accion_correo').value;
                let preview = '';
                
                if (accion === 'aceptar_final') {
                    preview = '<strong>Asunto:</strong> ¬°Bienvenido al Equipo! - Club Deportivo Atl√©tico Santander';
                } else if (accion === 'rechazar_proceso') {
                    preview = '<strong>Asunto:</strong> Resultado de tu Postulaci√≥n - Club Deportivo Atl√©tico Santander';
                }
                
                document.getElementById('contenido_preview').innerHTML = preview;
            }
        });
        
        radioPersonalizado.addEventListener('change', function() {
            if (this.checked) {
                camposPersonalizados.style.display = 'block';
                previewAutomatico.style.display = 'none';
                tipoCorreoInput.value = 'personalizado';
                
                // Agregar required de nuevo a los campos personalizados
                document.getElementById('asunto_correo').setAttribute('required', '');
                document.getElementById('mensaje_correo').setAttribute('required', '');
            }
        });
    }
    
    // Bot√≥n "Pasar a Proceso" - SOLO PERSONALIZADO
    document.querySelectorAll('.btn-pasar-proceso').forEach(function(btn){
        btn.addEventListener('click', function(){
            const id = this.dataset.id;
            const nombre = this.dataset.nombre;
            const email = this.dataset.email;
            
            // Configurar modal
            document.getElementById('modalCorreoLabel').textContent = 'Enviar Invitaci√≥n a Entrevista';
            document.getElementById('id_postulante').value = id;
            document.getElementById('accion_correo').value = 'pasar_proceso';
            document.getElementById('destinatario_correo').value = email;
            document.getElementById('asunto_correo').value = 'Invitaci√≥n a Entrevista - Club Deportivo Atl√©tico Santander';
            document.getElementById('mensaje_correo').value = `Hola ${nombre},\n\nNos complace informarte que has pasado a la siguiente etapa del proceso de selecci√≥n.\n\nTe invitamos a entrevista con estos datos:\n- Fecha: [DD/MM/AAAA]\n- Hora: [HH:MM]\n- Lugar: [Direcci√≥n o enlace de videollamada]\n\nPor favor asistir 10 minutos antes para firmar documentos y tomar tu asistencia.\n\nSaludos,\nClub Deportivo Atl√©tico Santander`;
            
            // Ocultar opciones de tipo y mostrar nota
            opcionesTipoCorreo.style.display = 'none';
            notaInvitacion.style.display = 'block';
            camposPersonalizados.style.display = 'block';
            previewAutomatico.style.display = 'none';
            tipoCorreoInput.value = 'personalizado';
            
            modalCorreo.show();
        });
    });
    
    // Bot√≥n "Rechazar" desde postulante (directo, correo autom√°tico)
    document.querySelectorAll('.btn-rechazar-directo').forEach(function(btn){
        btn.addEventListener('click', function(){
            const id = this.dataset.id;
            const nombre = this.dataset.nombre;
            
            if(!confirm(`¬øEst√°s seguro de rechazar a ${nombre}?\n\nSe enviar√° un correo autom√°tico de rechazo.`)) return;
            
            // Enviar formulario directamente
            const formData = new FormData();
            formData.append('accion_postulante', 'rechazar_directo');
            formData.append('id', id);
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
            
            fetch(window.location.href, {
                method: 'POST',
                headers: {'X-Requested-With': 'XMLHttpRequest'},
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if(data.success){
                    alert('‚úì Postulante rechazado correctamente');
                    // Guardar pesta√±a activa antes de recargar
                    sessionStorage.setItem('pestanaActiva', 'postulantes');
                    window.location.reload();
                } else {
                    alert('‚ùå Error: ' + (data.message || 'No se pudo rechazar'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('‚ùå Error al procesar la solicitud');
            });
        });
    });
    
    // Bot√≥n "Aceptar" desde en_proceso - CON OPCIONES
    document.querySelectorAll('.btn-aceptar-final').forEach(function(btn){
        btn.addEventListener('click', function(){
            const id = this.dataset.id;
            const nombre = this.dataset.nombre;
            const email = this.dataset.email;
            
            // Configurar modal
            document.getElementById('modalCorreoLabel').textContent = 'Aceptar como Entrenador';
            document.getElementById('id_postulante').value = id;
            document.getElementById('accion_correo').value = 'aceptar_final';
            document.getElementById('destinatario_correo').value = email;
            document.getElementById('asunto_correo').value = '¬°Bienvenido al Equipo! - Club Deportivo Atl√©tico Santander';
            document.getElementById('mensaje_correo').value = `Hola ${nombre},\n\n¬°Felicidades! Nos complace informarte que has sido aceptado como entrenador en nuestro club.\n\nPronto te contactaremos con m√°s detalles.\n\nSaludos,\nClub Deportivo Atl√©tico Santander`;
            
            // Mostrar opciones de tipo y ocultar nota
            opcionesTipoCorreo.style.display = 'block';
            notaInvitacion.style.display = 'none';
            
            // Por defecto: autom√°tico
            radioAutomatico.checked = true;
            camposPersonalizados.style.display = 'none';
            previewAutomatico.style.display = 'block';
            tipoCorreoInput.value = 'automatico';
            
            // Mostrar preview
            const preview = '<strong>Asunto:</strong> ¬°Bienvenido al Equipo! - Club Deportivo Atl√©tico Santander';
            document.getElementById('contenido_preview').innerHTML = preview;
            
            modalCorreo.show();
        });
    });
    
    // Bot√≥n "Rechazar" desde en_proceso - CON OPCIONES
    document.querySelectorAll('.btn-rechazar-proceso').forEach(function(btn){
        btn.addEventListener('click', function(){
            const id = this.dataset.id;
            const nombre = this.dataset.nombre;
            const email = this.dataset.email;
            
            // Configurar modal
            document.getElementById('modalCorreoLabel').textContent = 'Rechazar Postulante';
            document.getElementById('id_postulante').value = id;
            document.getElementById('accion_correo').value = 'rechazar_proceso';
            document.getElementById('destinatario_correo').value = email;
            document.getElementById('asunto_correo').value = 'Resultado de tu Postulaci√≥n - Club Deportivo Atl√©tico Santander';
            document.getElementById('mensaje_correo').value = `Hola ${nombre},\n\nLamentamos informarte que en esta ocasi√≥n no hemos podido continuar con tu proceso de selecci√≥n.\n\nTe agradecemos tu inter√©s y te deseamos mucho √©xito.\n\nSaludos,\nClub Deportivo Atl√©tico Santander`;
            
            // Mostrar opciones de tipo y ocultar nota
            opcionesTipoCorreo.style.display = 'block';
            notaInvitacion.style.display = 'none';
            
            // Por defecto: autom√°tico
            radioAutomatico.checked = true;
            camposPersonalizados.style.display = 'none';
            previewAutomatico.style.display = 'block';
            tipoCorreoInput.value = 'automatico';
            
            // Mostrar preview
            const preview = '<strong>Asunto:</strong> Resultado de tu Postulaci√≥n - Club Deportivo Atl√©tico Santander';
            document.getElementById('contenido_preview').innerHTML = preview;
            
            modalCorreo.show();
        });
    });
    
    // Env√≠o del formulario de correo
    formCorreo.addEventListener('submit', function(e){
        e.preventDefault();
        
        // Actualizar el valor del campo hidden tipo_correo desde los radio buttons si est√°n visibles
        if (opcionesTipoCorreo.style.display !== 'none') {
            const radioSeleccionado = document.querySelector('input[name="tipo_correo_radio"]:checked');
            if (radioSeleccionado) {
                tipoCorreoInput.value = radioSeleccionado.value;
            }
        }
        
        const formData = new FormData(this);
        
        fetch(window.location.href, {
            method: 'POST',
            headers: {'X-Requested-With': 'XMLHttpRequest'},
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if(data.success){
                alert('‚úì ' + data.message);
                modalCorreo.hide();
                // Guardar pesta√±a activa antes de recargar
                sessionStorage.setItem('pestanaActiva', 'postulantes');
                window.location.reload();
            } else {
                alert('‚ùå Error: ' + (data.message || 'No se pudo completar la acci√≥n'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('‚ùå Error al procesar la solicitud');
        });
    });

    // Funcionalidad para mostrar/ocultar puntajes de postulantes
    // El bot√≥n de puntajes ahora solo muestra los puntajes sin toggle
    // La funcionalidad est√° en entrenadores.js
    
    // Funcionalidad para filtrar postulantes por categor√≠a
    document.querySelectorAll('.filtro-categoria').forEach(function(item) {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const categoria = this.dataset.categoria;
            const categoriaTexto = this.textContent;
            
            // Cerrar el dropdown
            const dropdownMenu = this.closest('.dropdown-menu');
            if (dropdownMenu) {
                dropdownMenu.classList.remove('show');
            }
            
            // Actualizar texto del bot√≥n
            document.getElementById('dropdownCategorias').textContent = 'üéØ ' + categoriaTexto + ' ‚ñº';
            
            // Construir URL correctamente
            const currentUrl = new URL(window.location.href);
            if (categoria) {
                currentUrl.searchParams.set('filtrar_categoria', categoria);
            } else {
                currentUrl.searchParams.delete('filtrar_categoria');
            }
            
            // Hacer petici√≥n AJAX
            fetch(currentUrl.toString(), {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Actualizar mensaje
                    const mensaje = document.getElementById('mejoresMensaje');
                    mensaje.innerHTML = `üìå Mostrando ${data.total} postulante(s) ${categoria ? 'con experiencia en categor√≠a: <strong>' + data.categoria + '</strong>' : 'de <strong>todas las categor√≠as</strong>'}`;
                    mensaje.style.color = '#0e4da0';

                    // Mostrar aviso de restricci√≥n
                    const bodyEl = document.querySelector('#editarJornada .modal-body');
                    if(bodyEl && !bodyEl.querySelector('.edit-warning')){
                        const warn = document.createElement('div');
                        warn.className = 'edit-warning';
                        warn.style.cssText = 'background:#fff7ed; border:1px solid #fdba74; color:#9a3412; padding:8px 12px; border-radius:8px; margin-bottom:12px; font-size:0.9rem;';
                        warn.innerHTML = 'Nota: al editar, la combinaci√≥n <strong>jornada + categor√≠a</strong> anterior debe quedar asignada a <strong>otro entrenador aceptado</strong>. Si esta asignaci√≥n es la √∫nica, no se permitir√° editar.';
                        bodyEl.insertBefore(warn, bodyEl.firstChild);
                    }
                    
                    // Ocultar todas las tarjetas primero
                    document.querySelectorAll('.postulante-card').forEach(card => {
                        card.style.display = 'none';
                    });
                    
                    // Mostrar solo las tarjetas filtradas
                    if (data.postulantes.length > 0) {
                        data.postulantes.forEach(postulante => {
                            const card = document.querySelector(`[data-persona-pk="${postulante.persona_pk}"]`);
                            if (card) {
                                card.style.display = 'block';
                            }
                        });
                    } else {
                        mensaje.innerHTML = `‚ö†Ô∏è No se encontraron postulantes ${categoria ? 'con experiencia en categor√≠a: <strong>' + data.categoria + '</strong>' : ''}`;
                        mensaje.style.color = '#d97706';
                    }
                } else {
                    alert('‚ùå Error al filtrar postulantes');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('‚ùå Error al procesar la solicitud');
            });
        });
    });
});

// Fin de scripts de jornadas y notificaciones
</script>

<script src="{% static 'entrenador/js/entrenadores.js' %}?v=2"></script>
{% endblock %}
