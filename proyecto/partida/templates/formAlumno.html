<!-- partida/templates/formAlumno.html -->
{% extends 'layouts/plantilla1.html' %}
{% load static %}

{% block head %}
<title>Postulacion Alumnos</title>
<link rel="stylesheet" href="{% static 'partida/css/formAlumno.css' %}">
<link rel="stylesheet" href="{% static 'partida/css/validaciones.css' %}">
<style>
    :root {
        --fondo: url('{% static "partida/img/10.jpg" %}');
    }
</style>
{% endblock %}

{% block content %}

<div class="grid-main">
    <section class="informacion-container" data-aos="fade-up">
        <h1>üìã Bienvenido postulante a alumno.üëã‚õπÔ∏è‚Äç‚ôÄÔ∏è‚õπÔ∏è‚Äç‚ôÇÔ∏è</h1>
        <p>
            <em>¬°¬°Te damos la bienvenida a nuestro proceso de inscripci√≥n!!.</em> Si deseas convertirte en un alumno
            matriculado,
            completa este formulario con informaci√≥n precisa.
            <br>
            <br>
            Te confirmamos que la matr√≠cula es completamente gratuita.
            Un administrador revisar√° tus datos para validar tu registro. Mientras tanto, ten la seguridad de que:
            <strong><i>üîí Toda tu informaci√≥n personal est√° protegida y ser√° utilizada √∫nicamente para este proceso.
                    ¬°Gracias
                    por confiar en nosotros! üîí</i></strong>
        </p>
    </section>

    <section class="formulario-container">
        {% if messages %}
        <div class="container mt-3">
            {% for message in messages %}
            <div class="alert 
                {% if message.tags == 'error' %}alert-danger
                {% else %}alert-{{ message.tags }}{% endif %} 
                alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <form method="POST" enctype="multipart/form-data" id="formAlumno">
            {% csrf_token %}

            <!-- DATOS GENERALES -->
            <div class="informacionbasica">
                <h3>Datos generales üë§‚ù§Ô∏è</h3>

                <div class="input-container">
                    <label for="tipo_identidad">Tipo de Identificaci√≥n: </label>
                    <select name="tipo_identidad" id="tipo_identidad" required>
                        <option value="">Seleccione...</option>
                        {% for codigo, nombre in tipos_identidad %}
                        <option value="{{ codigo }}">{{ nombre }}</option>
                        {% endfor %}
                    </select>
                    <div class="invalid-feedback">Selecciona un tipo de identificaci√≥n</div>
                </div>

                <div class="input-container">
                    <label for="id_persona">N√∫mero de Identificaci√≥n: </label>
                    <input type="text" name="id_persona" id="id_persona" required placeholder="Ingresa un numero..">
                    <div class="invalid-feedback">Debe contener solo n√∫meros y m√≠nimo 6 d√≠gitos</div>
                </div>

                <div class="input-container">
                    <label for="nom1_persona">Primer Nombre: </label>
                    <input type="text" name="nom1_persona" id="nom1_persona" required placeholder="Ingresa un nombre..">
                    <div class="invalid-feedback">El primer nombre es requerido</div>
                </div>

                <div class="input-container">
                    <label for="nom2_persona">Segundo Nombre: </label>
                    <input type="text" name="nom2_persona" id="nom2_persona" placeholder="Ingresa un nombre..">
                </div>

                <div class="input-container">
                    <label for="ape1_persona">Primer Apellido: </label>
                    <input type="text" name="ape1_persona" id="ape1_persona" required
                        placeholder="Ingresa un apellido..">
                    <div class="invalid-feedback">El primer apellido es requerido</div>
                </div>

                <div class="input-container">
                    <label for="ape2_persona">Segundo Apellido: </label>
                    <input type="text" name="ape2_persona" id="ape2_persona" placeholder="Ingresa un apellido..">
                </div>

                <div class="input-container">
                    <label for="genero">G√©nero: </label>
                    <select name="genero" id="genero" required>
                        <option value="">Seleccione...</option>
                        {% for codigo, nombre in generos %}
                        <option value="{{ codigo }}">{{ nombre }}</option>
                        {% endfor %}
                    </select>
                    <div class="invalid-feedback">Selecciona un g√©nero</div>
                </div>

                <div class="input-container">
                    <label for="rh">Tipo de Sangre: </label>
                    <select name="rh" id="rh" required>
                        <option value="">Seleccione...</option>
                        {% for codigo, nombre in tipos_sangre %}
                        <option value="{{ codigo }}">{{ nombre }}</option>
                        {% endfor %}
                    </select>
                    <div class="invalid-feedback">Selecciona un tipo de sangre</div>
                </div>
            </div>

            <!-- DATOS DE CONTACTO Y SALUD -->
            <div class="informacionsalud">
                <h3>Datos de contacto y otros üë§‚ù§Ô∏è</h3>

                <div class="input-container">
                    <label for="fecha_nacimiento">Fecha Nacimiento: </label>
                    <input type="date" name="fecha_nacimiento" id="fecha_nacimiento" required
                        min="{{ fecha_minima|date:'Y-m-d' }}" max="{{ fecha_maxima|date:'Y-m-d' }}">
                    <div class="invalid-feedback">Debe tener entre 4 y 20 a√±os de edad</div>
                </div>

                <div class="input-container">
                    <label for="eps">EPS: </label>
                    <select name="eps" id="eps" required>
                        <option value="">Seleccione...</option>
                        {% for codigo, nombre in eps %}
                        <option value="{{ codigo }}">{{ nombre }}</option>
                        {% endfor %}
                    </select>
                    <div class="invalid-feedback">Selecciona una EPS</div>
                </div>

                <div class="input-container">
                    <label for="direc_persona">Direcci√≥n domicilio: </label>
                    <input type="text" name="direc_persona" id="direc_persona" required
                        placeholder="Ingresa una direcci√≥n..">
                    <div class="invalid-feedback">La direcci√≥n es requerida</div>
                </div>

                <div class="input-container">
                    <label for="tel_persona">N√∫mero Celular: </label>
                    <input type="tel" name="tel_persona" id="tel_persona" required placeholder="Ingresa 10 d√≠gitos..">
                    <div class="invalid-feedback">Debe tener exactamente 10 d√≠gitos</div>
                </div>

                <div class="input-container">
                    <label for="email_persona">Correo Electr√≥nico: </label>
                    <input type="email" name="email_persona" id="email_persona" required
                        placeholder="ejemplo@correo.com">
                    <div class="invalid-feedback">Formato de email inv√°lido</div>
                </div>

                <div class="input-container">
                    <label for="fk_posicion">Posicion de cancha: </label>
                    <select name="fk_posicion" id="fk_posicion" required>
                        <option value="">Seleccione...</option>
                        {% for p in posiciones %}
                        <option value="{{ p.idposicion }}">{{ p.nom_posicion }}</option>
                        {% endfor %}
                    </select>
                    <div class="invalid-feedback">Selecciona una posici√≥n</div>
                </div>
            </div>

            <div class="informacionmedidas">
                <h3>Medidas F√≠sicas üìè‚öΩ</h3>
                <div class="input-container">
                    <label for="altura_metros">Altura (metros): </label>
                    <input type="number" name="altura_metros" id="altura_metros" step="0.01" min="0.5" max="2.5"
                        placeholder="Ej: 1.65" required>
                    <div class="invalid-feedback">La altura debe estar entre 0.5 y 2.5 metros</div>
                </div>

                <div class="input-container">
                    <label for="peso_medidas">Peso (kg): </label>
                    <input type="number" name="peso_medidas" id="peso_medidas" step="0.1" min="10" max="150"
                        placeholder="Ej: 55.5" required>
                    <div class="invalid-feedback">El peso debe estar entre 10 y 150 kg</div>
                </div>

                <div class="input-container">
                    <label for="talla">Talla de ropa: </label>
                    <select name="talla" id="talla" required>
                        <option value="">Seleccione...</option>
                        {% for codigo, nombre in talla_ropa %}
                        <option value="{{ codigo }}">{{ nombre }}</option>
                        {% endfor %}
                    </select>
                    <div class="invalid-feedback">Selecciona una talla de ropa</div>
                </div>

                <div class="input-container">
                    <label for="calzado">Talla de calzado: </label>
                    <input type="number" name="calzado" id="calzado" min="15" max="50" placeholder="Ej: 38" required>
                    <div class="invalid-feedback">La talla de calzado debe estar entre 15 y 50</div>
                </div>

                <div class="input-container">
                    <label for="pie_dominante">Pie dominante: </label>
                    <select name="pie_dominante" id="pie_dominante" required>
                        <option value="">Seleccione...</option>
                        {% for codigo, nombre in pie_dom %}
                        <option value="{{ codigo }}">{{ nombre }}</option>
                        {% endfor %}
                    </select>
                    <div class="invalid-feedback">Selecciona el pie dominante</div>
                </div>

                <div class="input-container">
                    <label for="imc_medidas">IMC (se calcula autom√°ticamente): </label>
                    <input type="number" name="imc_medidas" id="imc_medidas" step="0.01" readonly
                        placeholder="Se calcular√° autom√°ticamente" style="background-color: #f8f9fa;">
                    <div class="invalid-feedback">Complete altura y peso para calcular IMC</div>
                </div>
            </div>

            <!-- DATOS ACUDIENTE -->
            <div class="informacionacudiente">
                <h3>Datos Acudiente o de emergencia üßë‚Äçüßí</h3>

                <div class="input-container">
                    <label for="idacudiente">N√∫mero de Identificaci√≥n: </label>
                    <input type="text" name="idacudiente" id="idacudiente" required placeholder="Ingresa un numero..">
                    <div class="invalid-feedback">Debe contener solo n√∫meros y m√≠nimo 6 d√≠gitos</div>
                </div>

                <div class="input-container">
                    <label for="nom1_acudiente">Primer Nombre: </label>
                    <input type="text" name="nom1_acudiente" id="nom1_acudiente" required
                        placeholder="Ingresa un nombre..">
                    <div class="invalid-feedback">El primer nombre es requerido</div>
                </div>

                <div class="input-container">
                    <label for="nom2_acudiente">Segundo Nombre: </label>
                    <input type="text" name="nom2_acudiente" id="nom2_acudiente" placeholder="Ingresa un nombre..">
                </div>

                <div class="input-container">
                    <label for="ape1_acudiente">Primer Apellido: </label>
                    <input type="text" name="ape1_acudiente" id="ape1_acudiente" required
                        placeholder="Ingresa un apellido..">
                    <div class="invalid-feedback">El primer apellido es requerido</div>
                </div>

                <div class="input-container">
                    <label for="ape2_acudiente">Segundo Apellido: </label>
                    <input type="text" name="ape2_acudiente" id="ape2_acudiente" placeholder="Ingresa un apellido..">
                </div>

                <div class="input-container">
                    <label for="tel_acudiente">N√∫mero Celular: </label>
                    <input type="tel" name="tel_acudiente" id="tel_acudiente" required
                        placeholder="Ingresa 10 d√≠gitos..">
                    <div class="invalid-feedback">Debe tener exactamente 10 d√≠gitos</div>
                </div>

                <div class="input-container">
                    <label for="parentesco">Parentesco: </label>
                    <select name="parentesco" id="parentesco" required>
                        <option value="">Seleccione...</option>
                        {% for codigo, nombre in parentescos %}
                        <option value="{{ codigo }}">{{ nombre }}</option>
                        {% endfor %}
                    </select>
                    <div class="invalid-feedback">Selecciona un parentesco</div>
                </div>
            </div>

            <!-- AUTORIZACIONES -->
            <div class="autorizacion">
                <h3>Autorizaciones üìù</h3>

                <div class="input-container">
                    <label for="traDatos">Tratamiento de datos: </label>
                    <input type="file" name="traDatos" id="traDatos" required accept=".pdf,.doc,.docx">
                    <div class="invalid-feedback">El documento de tratamiento de datos es requerido</div>
                    <p style="font-size: 0.85rem; color: #263a5e; margin: 8px 0 0 0; text-align: left;">
                        üìÑ <a
                            href="https://docs.google.com/document/d/1I4L16QBWxFTWgGqzre_TddF0TR9CLVkGlwosukDvKBE/edit?usp=sharing"
                            target="_blank" rel="noopener noreferrer"
                            style="color: #1976d2; text-decoration: underline; font-weight: 500;">
                            Descargar documento de tratamiento de datos
                        </a>
                    </p>
                </div>

                <div class="input-container">
                    <label for="autoMedica">Autorizaci√≥n M√©dica: </label>
                    <input type="file" name="autoMedica" id="autoMedica" required accept=".pdf,.doc,.docx">
                    <div class="invalid-feedback">La autorizaci√≥n m√©dica es requerida</div>
                </div>

                <div class="input-container">
                    <label for="certEps">Comprobante EPS: </label>
                    <input type="file" name="certEps" id="certEps" required accept=".pdf,.doc,.docx">
                    <div class="invalid-feedback">El comprobante EPS es requerido</div>
                </div>

                <div class="input-container">
                    <label for="foto">Foto: </label>
                    <input type="file" name="foto" id="foto" required accept=".jpg,.jpeg,.png">
                    <div class="invalid-feedback">La foto es requerida</div>
                </div>

                <div class="input-container">
                    <label for="otraescuela">Coloca el certificado si estabas matriculado en otra escuela de f√∫tbol:
                    </label>
                    <input type="file" name="otraescuela" id="otraescuela" accept=".pdf,.doc,.docx">
                </div>

                <div class="input-container">
                    <label for="documento_identidad">Documento de identidad del alumno:
                    </label>
                    <input type="file" name="documento_identidad" id="documento_identidad" required
                        accept=".pdf,.doc,.docx">
                </div>
            </div>

            <!-- BOT√ìN CON MODAL -->
            <div class="text-center mt-4">
                <button type="button" class="btn-enviar" id="btnConfirmar">
                    üìù Enviar Postulaci√≥n
                </button>
            </div>
        </form>

        <!-- MODAL DE CONFIRMACI√ìN -->
        <div class="modal fade" id="confirmacionModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">Confirmar Postulaci√≥n</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p class="confirmacion-texto">
                            ¬øEst√°s seguro de enviar tu postulaci√≥n?
                            <br><br>
                            <strong>Revisa que todos los datos sean correctos antes de confirmar.</strong>
                            <br><br>
                            Un administrador revisar√° tu informaci√≥n y te contactar√° pronto.
                        </p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Revisar
                            Datos</button>
                        <button type="submit" form="formAlumno" class="btn btn-success btn-confirmar">
                            S√≠, Enviar Postulaci√≥n
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div>
            <a href="{% url 'index' %}">
                <input class="btn-regresar" type="button" value="üëà Regresar" data-aos="zoom-in">
            </a>
        </div>
    </section>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Validaciones en tiempo real para formularios de alumno - VERSI√ìN CORREGIDA CON L√çMITES EXACTOS
    document.addEventListener('DOMContentLoaded', function () {
        // Configurar validaciones para todos los campos
        configurarValidaciones();
        // Configurar modal de confirmaci√≥n
        configurarModalConfirmacion();
        //Configurar c√°lculo autom√°tico del IMC
        configurarCalculoIMC();

        // Agregar validaci√≥n en tiempo real del documento
        configurarValidacionDocumentoTiempoReal();

        // Validaci√≥n m√°s estricta del formulario antes de enviar
        const form = document.getElementById('formAlumno');
        if (form) {
            form.addEventListener('submit', function (e) {
                // Verificar si el documento es v√°lido
                const documentoInput = document.getElementById('id_persona');
                const feedbackDiv = documentoInput.parentNode.querySelector('.documento-feedback');

                if (documentoInput.classList.contains('is-invalid')) {
                    e.preventDefault();
                    alert('No puedes enviar el formulario. El documento ya est√° matriculado o es inv√°lido.');
                    documentoInput.focus();
                    return false;
                }

                // Verificar transaccionalidad (que todas las tablas se guarden o ninguna)
                const camposRequeridos = form.querySelectorAll('[required]');
                let todosValidos = true;

                camposRequeridos.forEach(campo => {
                    if (!campo.value.trim()) {
                        campo.classList.add('is-invalid');
                        todosValidos = false;
                    }
                });

                if (!todosValidos) {
                    e.preventDefault();
                    alert('Por favor, completa todos los campos requeridos.');
                    return false;
                }

                // Mostrar mensaje de procesamiento
                const btnEnviar = form.querySelector('button[type="submit"]');
                if (btnEnviar) {
                    btnEnviar.disabled = true;
                    btnEnviar.innerHTML = '‚è≥ Procesando...';
                }

                return true;
            });
        }
    });

    function configurarValidaciones() {
        const campos = {
            'id_persona': validarIdentificacion,
            'tel_persona': validarTelefono,
            'tel_acudiente': validarTelefono,
            'email_persona': validarEmail,
            'fecha_nacimiento': validarFechaNacimiento,
            'idacudiente': validarIdentificacion,
            'nom1_persona': validarNombre,
            'nom2_persona': validarNombreOpcional,
            'ape1_persona': validarApellido,
            'ape2_persona': validarApellidoOpcional,
            'direc_persona': validarDireccion,
            'nom1_acudiente': validarNombre,
            'nom2_acudiente': validarNombreOpcional,
            'ape1_acudiente': validarApellido,
            'ape2_acudiente': validarApellidoOpcional,
            'altura_metros': validarAltura,
            'peso_medidas': validarPeso,
            'calzado': validarCalzado
        };

        // Aplicar validaciones espec√≠ficas
        Object.keys(campos).forEach(campoId => {
            const campo = document.getElementById(campoId);
            if (campo) {
                campo.addEventListener('blur', function () {
                    validarCampo(this, campos[campoId]);
                });
                campo.addEventListener('input', function () {
                    limpiarValidacion(this);
                    // Validar longitud en tiempo real mientras escribe
                    if (this.value.trim()) {
                        validarLongitud(this);
                    }
                });
            }
        });

        // Validaci√≥n para campos requeridos simples (solo verificar que no est√©n vac√≠os)
        const camposRequeridos = document.querySelectorAll('input[required], select[required]');
        camposRequeridos.forEach(campo => {
            if (!Object.keys(campos).includes(campo.id)) {
                campo.addEventListener('blur', function () {
                    validarCampoRequerido(this);
                });
                campo.addEventListener('input', function () {
                    limpiarValidacion(this);
                });
            }
        });

        // Validar archivos
        const archivos = document.querySelectorAll('input[type="file"]');
        archivos.forEach(archivo => {
            archivo.addEventListener('change', function () {
                validarArchivo(this);
            });
        });
    }

    function validarCampo(campo, funcionValidacion) {
        const valor = campo.value.trim();
        limpiarValidacion(campo);

        if (valor && !funcionValidacion(valor, campo)) {
            mostrarError(campo, obtenerMensajeError(campo.id));
        } else if (campo.checkValidity() && valor) {
            mostrarExito(campo);
        }
    }

    function validarCampoRequerido(campo) {
        const valor = campo.value.trim();
        limpiarValidacion(campo);

        if (!valor) {
            mostrarError(campo, 'Este campo es requerido');
        } else {
            mostrarExito(campo);
        }
    }

    function validarLongitud(campo) {
        const valor = campo.value.trim();
        const limites = {
            'nom1_persona': 20, 'nom2_persona': 20, 'ape1_persona': 20, 'ape2_persona': 20,
            'nom1_acudiente': 20, 'nom2_acudiente': 20, 'ape1_acudiente': 20, 'ape2_acudiente': 20,
            'direc_persona': 40, 'email_persona': 40
        };

        if (limites[campo.id] && valor.length > limites[campo.id]) {
            mostrarError(campo, `M√°ximo ${limites[campo.id]} caracteres`);
            return false;
        }
        return true;
    }

    // VALIDACIONES ESPEC√çFICAS SEG√öN TUS MODELOS

    function validarIdentificacion(valor) {
        return /^\d+$/.test(valor) && valor.length >= 6 && valor.length <= 10;
    }

    function validarTelefono(valor) {
        return /^\d{10}$/.test(valor); // Exactamente 10 d√≠gitos seg√∫n BigIntegerField
    }

    function validarEmail(valor, campo) {
        if (valor.length > 40) {
            mostrarError(campo, 'M√°ximo 40 caracteres');
            return false;
        }
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(valor);
    }

    function validarFechaNacimiento(valor) {
        const fechaNacimiento = new Date(valor);
        const hoy = new Date();

        let edad = hoy.getFullYear() - fechaNacimiento.getFullYear();
        const mes = hoy.getMonth() - fechaNacimiento.getMonth();

        if (mes < 0 || (mes === 0 && hoy.getDate() < fechaNacimiento.getDate())) {
            edad--;
        }

        return edad >= 4 && edad <= 20;
    }

    function validarNombre(valor, campo) {
        if (valor.length > 20) {
            mostrarError(campo, 'M√°ximo 20 caracteres');
            return false;
        }
        return /^[A-Za-z√Å√â√ç√ì√ö√°√©√≠√≥√∫√ë√±\s]+$/.test(valor);
    }

    function validarNombreOpcional(valor, campo) {
        if (valor && valor.length > 20) {
            mostrarError(campo, 'M√°ximo 20 caracteres');
            return false;
        }
        return !valor || /^[A-Za-z√Å√â√ç√ì√ö√°√©√≠√≥√∫√ë√±\s]+$/.test(valor);
    }

    function validarApellido(valor, campo) {
        if (valor.length > 20) {
            mostrarError(campo, 'M√°ximo 20 caracteres');
            return false;
        }
        return /^[A-Za-z√Å√â√ç√ì√ö√°√©√≠√≥√∫√ë√±\s]+$/.test(valor);
    }

    function validarApellidoOpcional(valor, campo) {
        if (valor && valor.length > 20) {
            mostrarError(campo, 'M√°ximo 20 caracteres');
            return false;
        }
        return !valor || /^[A-Za-z√Å√â√ç√ì√ö√°√©√≠√≥√∫√ë√±\s]+$/.test(valor);
    }

    function validarDireccion(valor, campo) {
        if (valor.length > 40) {
            mostrarError(campo, 'M√°ximo 40 caracteres');
            return false;
        }
        return true;
    }

    function validarAltura(valor, campo) {
        const altura = parseFloat(valor);
        return !isNaN(altura) && altura >= 0.5 && altura <= 2.5;
    }

    function validarPeso(valor, campo) {
        const peso = parseFloat(valor);
        return !isNaN(peso) && peso >= 10 && peso <= 150;
    }

    function validarCalzado(valor, campo) {
        const calzado = parseInt(valor);
        return !isNaN(calzado) && calzado >= 15 && calzado <= 50;
    }

    function validarArchivo(archivo) {
        const nombreArchivo = archivo.value;
        const extensionesPermitidas = {
            'traDatos': ['.pdf', '.doc', '.docx'],
            'autoMedica': ['.pdf', '.doc', '.docx'],
            'certEps': ['.pdf', '.doc', '.docx'],
            'foto': ['.jpg', '.jpeg', '.png'],
            'otraEscuela': ['.pdf', '.doc', '.docx']
        };

        if (nombreArchivo) {
            const extension = nombreArchivo.toLowerCase().substring(nombreArchivo.lastIndexOf('.'));
            const extensiones = extensionesPermitidas[archivo.id];

            if (extensiones && !extensiones.includes(extension)) {
                mostrarError(archivo, `Formatos permitidos: ${extensiones.join(', ')}`);
                return false;
            } else {
                mostrarExito(archivo);
                return true;
            }
        }
        return true;
    }

    function obtenerMensajeError(campoId) {
        const mensajes = {
            'id_persona': 'Solo n√∫meros, entre 6 y 10 d√≠gitos',
            'idacudiente': 'Solo n√∫meros, entre 6 y 10 d√≠gitos',
            'tel_persona': 'Exactamente 10 d√≠gitos',
            'tel_acudiente': 'Exactamente 10 d√≠gitos',
            'email_persona': 'Email inv√°lido o m√°ximo 40 caracteres',
            'fecha_nacimiento': 'Debe tener entre 4 y 20 a√±os de edad',
            'nom1_persona': 'Solo letras, m√°ximo 20 caracteres',
            'nom2_persona': 'Solo letras, m√°ximo 20 caracteres',
            'ape1_persona': 'Solo letras, m√°ximo 20 caracteres',
            'ape2_persona': 'Solo letras, m√°ximo 20 caracteres',
            'nom1_acudiente': 'Solo letras, m√°ximo 20 caracteres',
            'nom2_acudiente': 'Solo letras, m√°ximo 20 caracteres',
            'ape1_acudiente': 'Solo letras, m√°ximo 20 caracteres',
            'ape2_acudiente': 'Solo letras, m√°ximo 20 caracteres',
            'direc_persona': 'M√°ximo 40 caracteres',
            'altura_metros': 'La altura debe estar entre 0.5 y 2.5 metros',
            'peso_medidas': 'El peso debe estar entre 10 y 150 kg',
            'calzado': 'La talla de calzado debe estar entre 15 y 50'
        };
        return mensajes[campoId] || 'Valor inv√°lido';
    }

    function mostrarError(campo, mensaje) {
        campo.classList.add('is-invalid');
        campo.classList.remove('is-valid');

        // Buscar mensaje de error existente
        let feedback = campo.nextElementSibling;
        while (feedback && !feedback.classList.contains('invalid-feedback')) {
            feedback = feedback.nextElementSibling;
        }

        if (!feedback || !feedback.classList.contains('invalid-feedback')) {
            feedback = document.createElement('div');
            feedback.className = 'invalid-feedback';
            campo.parentNode.appendChild(feedback);
        }
        feedback.textContent = mensaje;
        feedback.style.display = 'block';
    }

    function mostrarExito(campo) {
        campo.classList.add('is-valid');
        campo.classList.remove('is-invalid');

        // Ocultar mensaje de error si existe
        let feedback = campo.nextElementSibling;
        while (feedback && !feedback.classList.contains('invalid-feedback')) {
            feedback = feedback.nextElementSibling;
        }

        if (feedback && feedback.classList.contains('invalid-feedback')) {
            feedback.style.display = 'none';
        }
    }

    function limpiarValidacion(campo) {
        campo.classList.remove('is-invalid', 'is-valid');
    }

    function configurarModalConfirmacion() {
    const btnConfirmar = document.getElementById('btnConfirmar');
    const form = document.getElementById('formAlumno');

    if (btnConfirmar && form) {
        btnConfirmar.addEventListener('click', function (e) {
            e.preventDefault();

            // Primero limpiar todas las validaciones previas
            const todosLosCampos = form.querySelectorAll('input, select, textarea');
            todosLosCampos.forEach(campo => {
                limpiarValidacion(campo);
            });

            // Validaci√≥n CR√çTICA del documento primero
            const documentoInput = document.getElementById('id_persona');
            const documentoValue = documentoInput.value.trim();
            
            // Verificar si el documento est√° marcado como inv√°lido por la validaci√≥n en tiempo real
            if (documentoInput.classList.contains('is-invalid')) {
                mostrarError(documentoInput, 'Documento inv√°lido o ya matriculado');
                alert('No puedes continuar. El documento ya est√° matriculado o es inv√°lido.');
                documentoInput.focus();
                return;
            }

            // Validar que el documento tenga al menos 6 d√≠gitos
            if (!documentoValue || documentoValue.length < 6) {
                mostrarError(documentoInput, 'M√≠nimo 6 d√≠gitos');
                documentoInput.focus();
                // NO hacemos return aqu√≠, para que contin√∫e con las dem√°s validaciones
                // pero marcamos que el formulario no es v√°lido
            }

            // Validar todos los campos requeridos
            const camposRequeridos = form.querySelectorAll('[required]');
            let formularioValido = true;
            let primerError = null;

            camposRequeridos.forEach(campo => {
                const valor = campo.value.trim();
                
                // Si ya encontramos un error con el documento, a√∫n as√≠ validamos los dem√°s para mostrarlos
                if (!valor) {
                    mostrarError(campo, 'Este campo es requerido');
                    formularioValido = false;
                    if (!primerError) primerError = campo;
                } else if (campo.type === 'file') {
                    if (!campo.files || campo.files.length === 0) {
                        mostrarError(campo, 'Este archivo es requerido');
                        formularioValido = false;
                        if (!primerError) primerError = campo;
                    }
                }
            });

            // Validar longitudes m√°ximas
            const camposTexto = form.querySelectorAll('input[type="text"], input[type="email"], textarea');
            camposTexto.forEach(campo => {
                if (campo.value.trim() && !validarLongitud(campo)) {
                    formularioValido = false;
                    if (!primerError) primerError = campo;
                }
            });

            // Validar que el documento no tenga errores espec√≠ficos
            if (!documentoValue || documentoValue.length < 6) {
                formularioValido = false;
                if (!primerError) primerError = documentoInput;
            }

            if (formularioValido) {
                // Mostrar modal de confirmaci√≥n
                const modal = new bootstrap.Modal(document.getElementById('confirmacionModal'));
                modal.show();
            } else {
                // Desplazarse al primer error
                if (primerError) {
                    primerError.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'center' 
                    });
                    primerError.focus();
                }
            }
        });
    }
}

    function configurarCalculoIMC() {
        const alturaInput = document.getElementById('altura_metros');
        const pesoInput = document.getElementById('peso_medidas');
        const imcInput = document.getElementById('imc_medidas');

        function calcularIMC() {
            const altura = parseFloat(alturaInput.value);
            const peso = parseFloat(pesoInput.value);

            if (altura && peso && altura > 0) {
                const imc = peso / (altura * altura);
                imcInput.value = imc.toFixed(2);

                // Validar visualmente el IMC con colores
                if (imc < 18.5) {
                    imcInput.style.borderColor = '#ffc107'; // Amarillo - Bajo peso
                    imcInput.style.backgroundColor = '#fffbf0';
                } else if (imc >= 18.5 && imc <= 24.9) {
                    imcInput.style.borderColor = '#28a745'; // Verde - Normal
                    imcInput.style.backgroundColor = '#f8fff9';
                } else if (imc >= 25 && imc <= 29.9) {
                    imcInput.style.borderColor = '#fd7e14'; // Naranja - Sobrepeso
                    imcInput.style.backgroundColor = '#fff4e6';
                } else {
                    imcInput.style.borderColor = '#dc3545'; // Rojo - Obesidad
                    imcInput.style.backgroundColor = '#fff5f5';
                }
            } else {
                imcInput.value = '';
                imcInput.style.borderColor = '';
                imcInput.style.backgroundColor = '#f8f9fa';
            }
        }

        if (alturaInput && pesoInput && imcInput) {
            alturaInput.addEventListener('input', calcularIMC);
            pesoInput.addEventListener('input', calcularIMC);
        }
    }

    // Prevenir env√≠o del formulario si hay errores
    document.getElementById('formAlumno')?.addEventListener('submit', function (e) {
        const errores = this.querySelectorAll('.is-invalid');
        if (errores.length > 0) {
            e.preventDefault();
            alert('Por favor corrige los errores antes de enviar el formulario.');
        }
    });

    function configurarValidacionDocumentoTiempoReal() {
        const documentoInput = document.getElementById('id_persona');
        const feedbackDiv = document.createElement('div');
        feedbackDiv.className = 'documento-feedback';
        feedbackDiv.style.marginTop = '5px';
        feedbackDiv.style.fontSize = '0.9rem';
        feedbackDiv.style.minHeight = '25px';

        // Insertar despu√©s del input
        documentoInput.parentNode.appendChild(feedbackDiv);

        // Variable para controlar el debounce
        let timeoutId = null;

        documentoInput.addEventListener('input', function () {
            const documento = this.value.trim();

            // Limpiar timeout anterior
            if (timeoutId) {
                clearTimeout(timeoutId);
            }

            // Mostrar estado de carga
            if (documento.length >= 6) {
                feedbackDiv.innerHTML = '<span style="color: #666;">‚è≥ Validando documento...</span>';
                feedbackDiv.className = 'documento-feedback loading';

                // Debounce para no hacer muchas solicitudes
                timeoutId = setTimeout(() => {
                    validarDocumento(documento, feedbackDiv, documentoInput);
                }, 500);
            } else if (documento.length > 0) {
                feedbackDiv.innerHTML = '<span style="color: #ff9800;">‚ö†Ô∏è M√≠nimo 6 d√≠gitos para validar</span>';
                feedbackDiv.className = 'documento-feedback warning';
            } else {
                feedbackDiv.innerHTML = '';
                feedbackDiv.className = 'documento-feedback';
                documentoInput.classList.remove('is-invalid', 'is-valid');
            }
        });

        // Tambi√©n validar al perder foco
        documentoInput.addEventListener('blur', function () {
            const documento = this.value.trim();
            if (documento.length >= 6) {
                validarDocumento(documento, feedbackDiv, documentoInput);
            }
        });
    }


    function validarDocumento(documento, feedbackDiv, inputElement) {
        fetch(`/validar-documento/?documento=${encodeURIComponent(documento)}`)
            .then(response => response.json())
            .then(data => {
                if (data.valido) {
                    inputElement.classList.add('is-valid');
                    inputElement.classList.remove('is-invalid');
                    feedbackDiv.innerHTML = `<span style="color: #28a745;">${data.mensaje}</span>`;
                    feedbackDiv.className = 'documento-feedback success';

                    // Si el documento existe, podemos pre-cargar datos
                    if (data.existe) {
                        // Opcional: Aqu√≠ puedes hacer otra llamada para cargar datos existentes
                        console.log('Documento existe, ser√≠a bueno pre-cargar datos');
                    }
                } else {
                    inputElement.classList.add('is-invalid');
                    inputElement.classList.remove('is-valid');
                    feedbackDiv.innerHTML = `<span style="color: #dc3545;">${data.mensaje}</span>`;
                    feedbackDiv.className = 'documento-feedback error';

                    // Deshabilitar el bot√≥n de enviar si el documento no es v√°lido
                    const btnConfirmar = document.getElementById('btnConfirmar');
                    if (btnConfirmar) {
                        btnConfirmar.disabled = true;
                        btnConfirmar.title = 'Corrige el documento para continuar';
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                feedbackDiv.innerHTML = '<span style="color: #dc3545;">Error al validar documento</span>';
                feedbackDiv.className = 'documento-feedback error';
            });
    }
</script>
{% endblock %}