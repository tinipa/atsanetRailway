{% extends 'layouts/plantilla2.html'%}
{% load static %}

{% block head %}
<title>Gestion Matriculas</title>
<link rel="stylesheet" href="{% static 'matricula/css/matricula_nuevo.css' %}" />
<style>
    :root {
        --portada-bg: url('{% static "partida/img/5.png" %}');
    }
</style>
{% endblock %}

{% block content %}
<div class="grid-main">
    <section class="portada-container">
        <div class="titulo">
            <h2>Gesti√≥n de Matriculas y Postulantes</h2>
        </div>
        <div class="menu">
            <ui>
                <li data-target="#matriculas">Matricula</li>
                <li data-target="#postulantes">Postulantes</li>
            </ui>
        </div>
    </section>
    <section class="paginas-container">
        <div data-content id="matriculas" class="active">
            <section class="titulo-seccion">
                <h3>‚öΩ Alumnos Matriculados üë¶üñãÔ∏è</h3>
                <div class="line"></div>
            </section>

            <section class="matriculas-container">
                <h4>Alumnos Matriculados</h4>
                <div class="row g-3">
                    {% for m in allMatriculas %}
                    {% with per=m.fk_alumno.fk_persona_alumno %}
                    <div class="col-md-4">
                        <div class="card card-dark position-relative" id="alumno-card">
                            {% if m.fk_alumno.foto and m.fk_alumno.foto.url %}
                            <img src="{{ m.fk_alumno.foto.url }}" alt="foto {{ per.nom1_persona }}">
                            {% else %}
                            <div class="card-placeholder"> <i class="fas fa-user"></i> </div>
                            {% endif %}

                            {% if m.estado_matricula %}
                            <div class="estado-badge estado-activo">‚úì Activo</div>
                            {% else %}
                            <div class="estado-badge estado-inactivo">‚úó Suspendido</div>
                            {% endif %}

                            <div class="card-body">
                                <h5 class="card-title">{{ per.nom1_persona }} {{ per.ape1_persona }}</h5>

                                <div class="alumno-info">
                                    <div><strong>ID:</strong> {{ per.id_persona }}</div>
                                    <div><strong>Categor√≠a:</strong> {{ m.fk_categoria.nom_categoria | default:"-" }}
                                    </div>
                                    <div><strong>Posici√≥n:</strong> {{ m.fk_alumno.fk_posicion.nom_posicion | default:"-" }}</div>
                                </div>

                                <div class="menu-action mt-3">
                                    <button type="button" class="btn btn-primary btn-sm editAlumnoBtn"
                                        data-id="{{ per.id_persona }}" data-nom1="{{ per.nom1_persona }}"
                                        data-nom2="{{ per.nom2_persona|default:'' }}" data-ape1="{{ per.ape1_persona }}"
                                        data-ape2="{{ per.ape2_persona|default:'' }}"
                                        data-fecha="{{ per.fecha_nacimiento|date:'Y-m-d' }}"
                                        data-direc="{{ per.direc_persona|default:'' }}"
                                        data-tel="{{ per.tel_persona|default:'' }}"
                                        data-email="{{ per.email_persona|default:'' }}"
                                        data-genero="{{ per.genero|default:'' }}" data-eps="{{ per.eps|default:'' }}"
                                        data-rh="{{ per.rh|default:'' }}"
                                        data-tipoidentidad="{{ per.tipo_identidad|default:'' }}"
                                        data-numidentidad="{{ per.id_persona }}"
                                        data-altura="{{ m.fk_alumno.altura_metros|default:'' }}"
                                        data-peso="{{ m.fk_alumno.peso_medidas|default:'' }}"
                                        data-imc="{{ m.fk_alumno.imc_medidas|default:'' }}"
                                        data-talla="{{ m.fk_alumno.talla|default:'' }}"
                                        data-calzado="{{ m.fk_alumno.calzado|default:'' }}"
                                        data-pie="{{ m.fk_alumno.pie_dominante|default:'' }}"
                                        data-nom1acudiente="{{ m.fk_alumno.fk_acudiente.nom1_acudiente|default:'' }}"
                                        data-nom2acudiente="{{ m.fk_alumno.fk_acudiente.nom2_acudiente|default:'' }}"
                                        data-ape1acudiente="{{ m.fk_alumno.fk_acudiente.ape1_acudiente|default:'' }}"
                                        data-ape2acudiente="{{ m.fk_alumno.fk_acudiente.ape2_acudiente|default:'' }}"
                                        data-telacudiente="{{ m.fk_alumno.fk_acudiente.tel_acudiente|default:'' }}"
                                        data-emailacudiente="{{ m.fk_alumno.fk_acudiente.email_acudiente|default:'' }}"
                                        data-parentesco="{{ m.fk_alumno.fk_acudiente.parentesco|default:'' }}"
                                        data-idacudiente="{{ m.fk_alumno.fk_acudiente.idacudiente }}"
                                        data-categoria="{{ m.fk_categoria.idcategoria }}"
                                        data-posicion="{{ m.fk_alumno.fk_posicion.idposicion|default:'' }}"
                                        data-matricula="{{ m.idmatricula }}"
                                        data-tradatos="{% if m.fk_alumno.tradatos %}{{ m.fk_alumno.tradatos.url }}{% endif %}"
                                        data-foto="{% if m.fk_alumno.foto %}{{ m.fk_alumno.foto.url }}{% endif %}"
                                        data-automedica="{% if m.fk_alumno.automedica %}{{ m.fk_alumno.automedica.url}}{% endif %}"
                                        data-certeps="{% if m.fk_alumno.certeps %}{{ m.fk_alumno.certeps.url }}{% endif %}"
                                        data-otraescuela="{% if m.fk_alumno.otraEscuela %}{{ m.fk_alumno.otraEscuela.url}}{% endif %}">
                                        <i class="fas fa-edit"></i> Editar
                                    </button>

                                    <!-- Cambiar estado: form que hace POST con nuevo valor -->
                                    <form method="post" style="display:inline-block;">
                                        {% csrf_token %}
                                        <input type="hidden" name="action" value="change_state">
                                        <input type="hidden" name="id_matricula" value="{{ m.idmatricula }}">
                                        <input type="hidden" name="nuevo_estado"
                                            value="{% if m.estado_matricula %}false{% else %}true{% endif %}">
                                        <button type="submit" class="btn btn-secondary btn-soft">
                                            {% if m.estado_matricula %}Suspender{% else %}Activar{% endif %}
                                        </button>
                                    </form>

                                    <form method="post" style="display:inline-block;">
                                        {% csrf_token %}
                                        <input type="hidden" name="action" value="generate_carnet">
                                        <input type="hidden" name="persona_id" value="{{ per.id_persona }}">
                                        <button type="submit" class="btn btn-warning btn-sm">
                                            <i class="fas fa-id-card"></i> Generar Carnet
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endwith %}
                    {% empty %}
                    <div class="col-12 small-muted">No hay matr√≠culas para este a√±o.</div>
                    {% endfor %}
                </div>

                {% if info_u.tipo_personal == 'Administrador' or categorias_usuario %}
                <div class="mb-3">
                    <button type="button" class="btn btn-warning" data-bs-toggle="modal"
                        data-bs-target="#terminarPeriodoModal">
                        Terminar Per√≠odo Acad√©mico
                    </button>
                </div>
                {% endif %}
            </section>
        </div>

        <div data-content id="postulantes">
            <section class="titulo-seccion">
                <h3>üßë‚Äçüßí‚Äçüßí Postulantes registrados üì©üì´</h3>
                <div class="line"></div>
            </section>
            <section class="postulantes-container">
                <div class="row g-3" id="postulantes-row">
                    {% for p in allPostulantes %}
                    {% with per=p.fk_persona_alumno %}
                    <div class="col-md-4">
                        <div class="position-relative" style="border:1px solid #ddd; border-radius:8px; padding:25px; background:#63a2e0; box-shadow:0 2px 6px rgba(0,0,0,0.1);">
                            {% if p.foto and p.foto.url %}
                            <img src="{{ p.foto.url }}" alt="foto {{ per.nom1_persona }}">
                            {% else %}
                            <div class="card-placeholder"> <i class="fas fa-user"></i> </div>
                            {% endif %}
                            <div class="card-body">
                                <h5 class="card-title">{{ per.nom1_persona }} {{ per.ape1_persona }}</h5>
                                <div class="alumno-info">
                                    <div><strong>Tel:</strong> {{ per.tel_persona|default:"-" }}</div>
                                    <div><strong>Email:</strong> {{ per.email_persona|default:"-" }}</div>
                                    <div><strong>Posici√≥n:</strong> {{ p.fk_posicion.nom_posicion | default:"-"}}</div>
                                </div>

                                <div class="menu-action mt-3">
                                    <!-- Bot√≥n ver (data-*) - ACTUALIZADO CON TODOS LOS CAMPOS -->
                                    <button type="button" class="btn btn-info btn-soft btn-ver-info"
                                        data-nom="{{ per.nom1_persona }}" data-nom2="{{ per.nom2_persona|default:'' }}"
                                        data-ape="{{ per.ape1_persona }}" data-ape2="{{ per.ape2_persona|default:'' }}"
                                        data-id="{{ per.id }}" data-id-persona="{{ per.id_persona }}"
                                        data-fecha="{{ per.fecha_nacimiento|date:'Y-m-d' }}"
                                        data-direc="{{ per.direc_persona|default:'' }}"
                                        data-tel="{{ per.tel_persona|default:'' }}"
                                        data-email="{{ per.email_persona|default:'' }}"
                                        data-genero="{{ per.genero|default:'' }}" data-eps="{{ per.eps|default:'' }}"
                                        data-rh="{{ per.rh|default:'' }}"
                                        data-tipo-identidad="{{ per.tipo_identidad|default:'' }}"
                                        data-altura="{{ p.altura_metros|default:'' }}"
                                        data-peso="{{ p.peso_medidas|default:'' }}"
                                        data-imc="{{ p.imc_medidas|default:'' }}" data-talla="{{ p.talla|default:'' }}"
                                        data-calzado="{{ p.calzado|default:'' }}"
                                        data-pie-dominante="{{ p.pie_dominante|default:'' }}"
                                        data-posicion="{{ p.fk_posicion.nom_posicion|default:'' }}"
                                        data-nom1-acudiente="{{ p.fk_acudiente.nom1_acudiente|default:'' }}"
                                        data-nom2-acudiente="{{ p.fk_acudiente.nom2_acudiente|default:'' }}"
                                        data-ape1-acudiente="{{ p.fk_acudiente.ape1_acudiente|default:'' }}"
                                        data-ape2-acudiente="{{ p.fk_acudiente.ape2_acudiente|default:'' }}"
                                        data-tel-acudiente="{{ p.fk_acudiente.tel_acudiente|default:'' }}"
                                        data-email-acudiente="{{ p.fk_acudiente.email_acudiente|default:'' }}"
                                        data-parentesco="{{ p.fk_acudiente.parentesco|default:'' }}"
                                        data-id-acudiente="{{ p.fk_acudiente.idacudiente|default:'' }}"
                                        data-tradatos="{% if p.tradatos %}{{ p.tradatos.url }}{% endif %}"
                                        data-foto="{% if p.foto %}{{ p.foto.url }}{% endif %}"
                                        data-automedica="{% if p.automedica %}{{ p.automedica.url }}{% endif %}"
                                        data-certeps="{% if p.certeps %}{{ p.certeps.url }}{% endif %}"
                                        data-otraescuela="{% if p.otraEscuela %}{{ p.otraEscuela.url }}{% endif %}">
                                        <i class="fas fa-eye"></i> Info Completa
                                    </button>

                                    <!-- Bot√≥n aceptar (abre modal donde eliges categor√≠a si quieres) -->
                                    <button type="button" class="btn btn-success btn-soft btn-open-aceptar"
                                        data-id="{{ per.id }}" data-nom="{{ per.nom1_persona|escapejs }}">
                                        <i class="fas fa-thumbs-up"></i> Aceptar
                                    </button>

                                    <!-- Bot√≥n rechazar -->
                                    <button type="button" class="btn btn-danger btn-soft btn-open-rechazar"
                                        data-id="{{ per.id }}" data-nom="{{ per.nom1_persona|escapejs }}">
                                        <i class="fas fa-thumbs-down"></i> Rechazar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endwith %}
                    {% empty %}
                    <div class="col-12">
                        <div class="small-muted">No hay postulantes.</div>
                    </div>
                    {% endfor %}
                </div>
            </section>
        </div>
    </section>
</div>

<!-- ================= MODAL: VER INFO POSTULANTE COMPLETO ================= -->
<div class="modal fade" id="modalInfo" tabindex="-1" aria-labelledby="infoPostulanteLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Informaci√≥n Completa del Postulante</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modalInfoBody">
                <!-- Se llena din√°micamente por JavaScript -->
            </div>
        </div>
    </div>
</div>


<!-- ================= MODAL: ACEPTAR (elige categor√≠a si quieres) ================= -->
<div class="modal fade modal-lg" id="modalAceptar" tabindex="-1" aria-labelledby="editararia" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="editararia">Aceptar Postulante</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="accept">
                    <input type="hidden" id="aceptar_id_persona" name="id_persona">

                    <p id="aceptar_text"></p>
                    <p class="small-muted">Si no seleccionas categor√≠a se asignar√° autom√°ticamente por edad.</p>

                    <div class="mb-3">
                        <label class="form-label">Seleccionar categor√≠a (opcional)</label>
                        <select name="fk_categoria" class="form-select">
                            <option value="">-- No cambiar (auto) --</option>
                            {% for c in categorias_usuario %}
                            <option value="{{ c.idcategoria }}">{{ c.nom_categoria }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <button type="submit" class="btn btn-success">Confirmar aceptaci√≥n</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- MODAL RECHAZAR -->
<div class="modal fade modal-lg" id="modalRechazar" tabindex="-1" aria-labelledby="editararia" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="editararia">Rechazar Postulante</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <p id="texto-rechazar">¬øSeguro que deseas rechazar a este postulante?</p>
                <div>
                    <form method="post" id="form-rechazar">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="reject">
                        <input type="hidden" id="rechazar_id_persona" name="id_persona">

                        <button type="submit" class="btn btn-danger">Rechazar</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ================= MODAL: EDITAR ================= -->
<div class="modal fade" id="editAlumnoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="POST" enctype="multipart/form-data" id="editAlumnoForm">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title">Editar Alumno Matriculado</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="action" value="edit">
                    <input type="hidden" name="persona_id" id="edit_persona_id">
                    <input type="hidden" name="idmatricula" id="edit_matricula_id">
                    <input type="hidden" name="idacudiente_actual" id="edit_idacudiente_actual">

                    <!-- Informaci√≥n de Identificaci√≥n (NO EDITABLE) -->
                    <div class="card mb-3">
                        <div class="card-header bg-secondary text-white">
                            <h6 class="mb-0">üìÑ Documentos de Identificaci√≥n (No editable)</h6>
                        </div>
                        <div class="card-body">
                            <div class="row mb-2">
                                <div class="col-md-4">
                                    <label>Tipo de Identificaci√≥n</label>
                                    <input type="text" id="edit_tipo_identidad_display" class="form-control" readonly
                                        style="background-color: #e9ecef;">
                                    <input type="hidden" name="tipo_identidad" id="edit_tipo_identidad">
                                </div>
                                <div class="col-md-4">
                                    <label>N√∫mero de Identificaci√≥n</label>
                                    <input type="text" id="edit_num_identidad_display" class="form-control" readonly
                                        style="background-color: #e9ecef;">
                                    <input type="hidden" name="num_identidad" id="edit_num_identidad">
                                </div>
                                <div class="col-md-4">
                                    <label>Fecha de Nacimiento</label>
                                    <input type="text" id="edit_fecha_display" class="form-control" readonly
                                        style="background-color: #e9ecef;">
                                    <input type="hidden" name="fecha_nacimiento" id="edit_fecha">
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-md-6">
                                    <label>Tipo de Sangre (RH)</label>
                                    <input type="text" id="edit_rh_display" class="form-control" readonly
                                        style="background-color: #e9ecef;">
                                    <input type="hidden" name="rh" id="edit_rh">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Informaci√≥n Personal (EDITABLE) -->
                    <div class="card mb-3">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0">üë§ Informaci√≥n Personal (Editable)</h6>
                        </div>
                        <div class="card-body">
                            <div class="row mb-2">
                                <div class="col">
                                    <label>Primer Nombre</label>
                                    <input type="text" name="nom1_persona" id="edit_nom1" class="form-control"
                                        placeholder="Ingresa el primer nombre">
                                    <div class="invalid-feedback">Solo letras, m√°ximo 20 caracteres</div>
                                </div>
                                <div class="col">
                                    <label>Segundo Nombre</label>
                                    <input type="text" name="nom2_persona" id="edit_nom2" class="form-control"
                                        placeholder="Ingresa el segundo nombre">
                                    <div class="invalid-feedback">Solo letras, m√°ximo 20 caracteres</div>
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col">
                                    <label>Primer Apellido</label>
                                    <input type="text" name="ape1_persona" id="edit_ape1" class="form-control"
                                        placeholder="Ingresa el primer apellido">
                                    <div class="invalid-feedback">Solo letras, m√°ximo 20 caracteres</div>
                                </div>
                                <div class="col">
                                    <label>Segundo Apellido</label>
                                    <input type="text" name="ape2_persona" id="edit_ape2" class="form-control"
                                        placeholder="Ingresa el segundo apellido">
                                    <div class="invalid-feedback">Solo letras, m√°ximo 20 caracteres</div>
                                </div>
                            </div>

                            <div class="row mb-2">
                                <div class="col">
                                    <label>Direcci√≥n</label>
                                    <input type="text" name="direc_persona" id="edit_direc" class="form-control"
                                        placeholder="Ingresa la direcci√≥n">
                                    <div class="invalid-feedback">M√°ximo 40 caracteres permitidos</div>
                                </div>
                                <div class="col">
                                    <label>Tel√©fono</label>
                                    <input type="tel" name="tel_persona" id="edit_tel" class="form-control"
                                        placeholder="Ingresa 10 d√≠gitos">
                                    <div class="invalid-feedback">Debe tener exactamente 10 d√≠gitos</div>
                                </div>
                            </div>

                            <div class="row mb-2">
                                <div class="col">
                                    <label>Email</label>
                                    <input type="email" name="email_persona" id="edit_email" class="form-control"
                                        placeholder="ejemplo@correo.com">
                                    <div class="invalid-feedback">Formato de email inv√°lido o m√°ximo 40 caracteres</div>
                                </div>
                                <div class="col">
                                    <label>G√©nero</label>
                                    <select name="genero" id="edit_genero" class="form-select">
                                        <option value="">Seleccionar</option>
                                        {% for genero in generos %}
                                        <option value="{{ genero.0 }}">{{ genero.1 }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>

                            <div class="row mb-2">
                                <div class="col">
                                    <label>EPS</label>
                                    <select name="eps" id="edit_eps" class="form-select">
                                        <option value="">Seleccionar</option>
                                        {% for ep in eps %}
                                        <option value="{{ ep.0 }}">{{ ep.1 }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Medidas F√≠sicas (EDITABLE) -->
                    <div class="card mb-3">
                        <div class="card-header bg-warning text-dark">
                            <h6 class="mb-0">üìè Medidas F√≠sicas (Editable)</h6>
                        </div>
                        <div class="card-body">
                            <div class="row mb-2">
                                <div class="col">
                                    <label>Altura (metros)</label>
                                    <input type="number" step="0.01" name="altura_metros" id="edit_altura"
                                        class="form-control" min="0.5" max="2.5" placeholder="Ej: 1.65">
                                    <div class="invalid-feedback">La altura debe estar entre 0.5 y 2.5 metros</div>
                                </div>
                                <div class="col">
                                    <label>Peso (kg)</label>
                                    <input type="number" step="0.1" name="peso_medidas" id="edit_peso"
                                        class="form-control" min="10" max="150" placeholder="Ej: 55.5">
                                    <div class="invalid-feedback">El peso debe estar entre 10 y 150 kg</div>
                                </div>
                                <div class="col">
                                    <label>IMC (autom√°tico)</label>
                                    <input type="number" step="0.01" name="imc_medidas" id="edit_imc"
                                        class="form-control" readonly style="background-color: #f8f9fa;">
                                </div>
                            </div>

                            <div class="row mb-2">
                                <div class="col">
                                    <label>Talla de ropa</label>
                                    <select name="talla" id="edit_talla" class="form-select">
                                        <option value="">Seleccionar</option>
                                        {% for talla in talla_ropa %}
                                        <option value="{{ talla.0 }}">{{ talla.1 }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col">
                                    <label>Talla de calzado</label>
                                    <input type="number" name="calzado" id="edit_calzado" class="form-control" min="15"
                                        max="50" placeholder="Ej: 38">
                                    <div class="invalid-feedback">La talla debe estar entre 15 y 50</div>
                                </div>
                                <div class="col">
                                    <label>Pie Dominante</label>
                                    <select name="pie_dominante" id="edit_pie" class="form-select">
                                        <option value="">Seleccionar</option>
                                        {% for pie in pie_dom %}
                                        <option value="{{ pie.0 }}">{{ pie.1 }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Informaci√≥n Acad√©mica/Deportiva (EDITABLE) -->
                    <div class="card mb-3">
                        <div class="card-header bg-success text-white">
                            <h6 class="mb-0">‚öΩ Informaci√≥n Deportiva (Editable)</h6>
                        </div>
                        <div class="card-body">
                            <div class="row mb-2">
                                <div class="col">
                                    <label>Categor√≠a</label>
                                    <select name="fk_categoria" id="edit_categoria" class="form-select">
                                        {% for cat in categorias_usuario %}
                                        <option value="{{ cat.idcategoria }}">{{ cat.nom_categoria }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col">
                                    <label>Posici√≥n</label>
                                    <select name="fk_posicion" id="edit_posicion" class="form-select">
                                        <option value="">Seleccionar</option>
                                        {% for pos in posiciones %}
                                        <option value="{{ pos.idposicion }}">{{ pos.nom_posicion }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Informaci√≥n del Acudiente (EDITABLE) -->
                    <div class="card mb-3">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Informaci√≥n del Acudiente (Editable)</h6>
                        </div>
                        <div class="card-body">
                            <div class="row mb-2">
                                <div class="col">
                                    <label>ID del Acudiente *</label>
                                    <input type="text" name="idacudiente" id="edit_idacudiente" class="form-control"
                                        placeholder="Ingresa el ID del acudiente" required>
                                    <div class="invalid-feedback">El ID del acudiente es requerido</div>
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col">
                                    <label>Primer Nombre Acudiente</label>
                                    <input type="text" name="nom1_acudiente" id="edit_nom1_acudiente"
                                        class="form-control" placeholder="Ingresa el primer nombre">
                                    <div class="invalid-feedback">Solo letras, m√°ximo 20 caracteres</div>
                                </div>
                                <div class="col">
                                    <label>Segundo Nombre Acudiente</label>
                                    <input type="text" name="nom2_acudiente" id="edit_nom2_acudiente"
                                        class="form-control" placeholder="Ingresa el segundo nombre">
                                    <div class="invalid-feedback">Solo letras, m√°ximo 20 caracteres</div>
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col">
                                    <label>Primer Apellido Acudiente</label>
                                    <input type="text" name="ape1_acudiente" id="edit_ape1_acudiente"
                                        class="form-control" placeholder="Ingresa el primer apellido">
                                    <div class="invalid-feedback">Solo letras, m√°ximo 20 caracteres</div>
                                </div>
                                <div class="col">
                                    <label>Segundo Apellido Acudiente</label>
                                    <input type="text" name="ape2_acudiente" id="edit_ape2_acudiente"
                                        class="form-control" placeholder="Ingresa el segundo apellido">
                                    <div class="invalid-feedback">Solo letras, m√°ximo 20 caracteres</div>
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col">
                                    <label>Tel√©fono Acudiente</label>
                                    <input type="tel" name="tel_acudiente" id="edit_telacud" class="form-control"
                                        placeholder="Ingresa 10 d√≠gitos">
                                    <div class="invalid-feedback">Debe tener exactamente 10 d√≠gitos</div>
                                </div>
                                <div class="col">
                                    <label>Email Acudiente</label>
                                    <input type="email" name="email_acudiente" id="edit_emailacud" class="form-control"
                                        placeholder="ejemplo@correo.com">
                                    <div class="invalid-feedback">Formato de email inv√°lido</div>
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col">
                                    <label>Parentesco</label>
                                    <select name="parentesco" id="edit_parentesco" class="form-select">
                                        <option value="">Seleccionar</option>
                                        {% for parent in parentescos %}
                                        <option value="{{ parent.0 }}">{{ parent.1 }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Archivos (SOLO AUTORIZACI√ìN M√âDICA Y EPS EDITABLES) -->
                    <div class="card mb-3">
                        <div class="card-header bg-dark text-white">
                            <h6 class="mb-0">üìÅ Documentos</h6>
                        </div>
                        <div class="card-body">
                            <!-- Archivos EXISTENTES (solo visualizaci√≥n) -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label>Tratamiento de Datos (No editable)</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="edit_tradatos_display" readonly
                                            style="background-color: #e9ecef;" placeholder="Documento cargado">
                                        <button type="button" class="btn btn-outline-primary btn-sm"
                                            onclick="verDocumento('tradatos')" id="btn_ver_tradatos">
                                            üëÅÔ∏è Ver
                                        </button>
                                    </div>
                                    <input type="hidden" name="tradatos_existente" id="edit_tradatos_existente">
                                </div>
                                <div class="col-md-6">
                                    <label>Foto (No editable)</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="edit_foto_display" readonly
                                            style="background-color: #e9ecef;" placeholder="Foto cargada">
                                        <button type="button" class="btn btn-outline-primary btn-sm"
                                            onclick="verDocumento('foto')" id="btn_ver_foto">
                                            üëÅÔ∏è Ver
                                        </button>
                                    </div>
                                    <input type="hidden" name="foto_existente" id="edit_foto_existente">
                                </div>
                            </div>

                            <!-- Archivos EDITABLES -->
                            <div class="row">
                                <div class="col-md-6">
                                    <label>Autorizaci√≥n M√©dica</label>
                                    <div class="mb-2">
                                        <div class="input-group mb-2">
                                            <input type="text" class="form-control" id="edit_automedica_display"
                                                readonly style="background-color: #e9ecef;"
                                                placeholder="Documento cargado">
                                            <button type="button" class="btn btn-outline-primary btn-sm"
                                                onclick="verDocumento('automedica')" id="btn_ver_automedica">
                                                üëÅÔ∏è Ver
                                            </button>
                                        </div>
                                        <input type="hidden" name="automedica_existente" id="edit_automedica_existente">
                                    </div>
                                    <input type="file" name="automedica" id="edit_automedica" class="form-control"
                                        accept=".pdf,.doc,.docx">
                                    <div class="invalid-feedback">Formato permitido: PDF, DOC, DOCX (m√°x. 5MB)</div>
                                    <small class="text-muted">Puedes subir un nuevo documento si es necesario</small>
                                </div>
                                <div class="col-md-6">
                                    <label>Comprobante EPS</label>
                                    <div class="mb-2">
                                        <div class="input-group mb-2">
                                            <input type="text" class="form-control" id="edit_certeps_display" readonly
                                                style="background-color: #e9ecef;" placeholder="Documento cargado">
                                            <button type="button" class="btn btn-outline-primary btn-sm"
                                                onclick="verDocumento('certeps')" id="btn_ver_certeps">
                                                üëÅÔ∏è Ver
                                            </button>
                                        </div>
                                        <input type="hidden" name="certeps_existente" id="edit_certeps_existente">
                                    </div>
                                    <input type="file" name="certeps" id="edit_certeps" class="form-control"
                                        accept=".pdf,.doc,.docx">
                                    <div class="invalid-feedback">Formato permitido: PDF, DOC, DOCX (m√°x. 5MB)</div>
                                    <small class="text-muted">Puedes subir un nuevo documento si es necesario</small>
                                </div>
                            </div>

                            <!-- Otros documentos (solo visualizaci√≥n) -->
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <label>Certificado Otra Escuela (No editable)</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="edit_otraescuela_display" readonly
                                            style="background-color: #e9ecef;" placeholder="Documento cargado">
                                        <button type="button" class="btn btn-outline-primary btn-sm"
                                            onclick="verDocumento('otraescuela')" id="btn_ver_otraescuela">
                                            üëÅÔ∏è Ver
                                        </button>
                                    </div>
                                    <input type="hidden" name="otraescuela_existente" id="edit_otraescuela_existente">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-success">üíæ Guardar Cambios</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‚ùå Cancelar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Terminar Per√≠odo -->
<div class="modal fade" id="terminarPeriodoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Terminar Per√≠odo Acad√©mico</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <label for="categoriaSelect">Selecciona una categor√≠a:</label>
                <select id="categoriaSelect" class="form-select mb-3">
                    <option value="">-- Selecciona --</option>
                    {% for cat in categorias_usuario %} <!-- ‚úÖ Aseg√∫rate que dice categorias_usuario -->
                    <option value="{{ cat.idcategoria }}">{{ cat.nom_categoria }}</option>
                    {% endfor %}
                </select>

                <div>
                    <input type="checkbox" id="checkAll"> <label for="checkAll"><strong>Seleccionar
                            Todos</strong></label>
                </div>

                <ul id="listaMatriculas" class="list-group mt-2" style="max-height:300px; overflow-y:auto;">
                    <!-- Aqu√≠ se cargan los alumnos din√°micamente -->
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" id="btnTerminarPeriodo" class="btn btn-success">Terminar Per√≠odo</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- ================= MODAL: CONFIRMAR TERMINAR PERIODO ================= -->
<div class="modal fade" id="confirmarTerminarModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">‚ö†Ô∏è Confirmar Terminar Per√≠odo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="confirmarTexto">¬øEst√°s seguro de terminar el per√≠odo para <span id="cantidadAlumnos">0</span>
                    alumno(s)?</p>
                <small>
                    <strong>üìù Qu√© pasar√°:</strong><br>
                    ‚Ä¢ Las matr√≠culas se marcar√°n como inactivas<br>
                    ‚Ä¢ Se generar√°n c√≥digos de renovaci√≥n<br>
                    ‚Ä¢ Se enviar√°n emails a los alumnos
                </small>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="btnConfirmarTerminar">Terminar Per√≠odo</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="{% static 'partida/scripts/paginas.js' %}"></script>
<script src="{% static 'matricula/scripts/matricula.js' %}"></script>

<script>
    // Funci√≥n principal que se ejecuta cuando todo est√° listo
    function inicializarMatriculas() {
        console.log('Cargando matr√≠culas via AJAX...');

        // Hacer petici√≥n al servidor para obtener las matr√≠culas
        fetch("{% url 'get_matriculas_json' %}")
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error en la respuesta: ' + response.status);
                }
                return response.json();
            })
            .then(matriculasData => {
                console.log('Matr√≠culas cargadas via AJAX:', matriculasData);
                console.log('Es array?', Array.isArray(matriculasData));
                console.log('Cantidad:', matriculasData.length);

                // Inicializar los event listeners con los datos cargados
                inicializarEventListeners(matriculasData);
            })
            .catch(error => {
                console.error('Error cargando matr√≠culas:', error);
                alert('Error cargando los datos de matr√≠culas');
                // Inicializar con array vac√≠o si hay error
                inicializarEventListeners([]);
            });
    }

    // TERMINAR PER√çODO ACAD√âMICO - JavaScript mejorado
    function inicializarTerminarPeriodo(matriculasData) {
        const categoriaSelect = document.getElementById('categoriaSelect');
        const listaMatriculas = document.getElementById('listaMatriculas');
        const checkAll = document.getElementById('checkAll');
        const btnTerminarPeriodo = document.getElementById('btnTerminarPeriodo');

        if (!categoriaSelect || !listaMatriculas) {
            console.log('‚ùå Elementos del modal de terminar per√≠odo no encontrados');
            return;
        }

        // Cuando cambie la categor√≠a
        categoriaSelect.addEventListener('change', function () {
            const categoriaId = parseInt(this.value);
            console.log('Categor√≠a seleccionada:', categoriaId);

            listaMatriculas.innerHTML = '';

            if (!categoriaId) {
                console.log('No se seleccion√≥ categor√≠a');
                return;
            }

            console.log('Total matr√≠culas disponibles:', matriculasData.length);

            // Filtrar por categor√≠a y estado activo
            const filtradas = matriculasData.filter(function (m) {
                const idCategoriaMatricula = parseInt(m.fk_categoria.idcategoria);
                const coincideCategoria = idCategoriaMatricula === categoriaId;
                const estaActiva = m.estado_matricula === true || m.estado_matricula === 1;

                console.log(`Filtro: Matr√≠cula ${m.idmatricula} - Categor√≠a: ${idCategoriaMatricula}, Coincide: ${coincideCategoria}, Activa: ${estaActiva}`);

                return coincideCategoria && estaActiva;
            });
            console.log('Matr√≠culas filtradas:', filtradas);

            if (filtradas.length === 0) {
                listaMatriculas.innerHTML = '<li class="list-group-item text-muted">No hay alumnos activos para esta categor√≠a.</li>';
                return;
            }

            // Crear checkboxes
            filtradas.forEach(function (m) {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex align-items-center';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'chkAlumno me-2';
                checkbox.value = m.idmatricula;
                checkbox.id = 'mat' + m.idmatricula;

                const label = document.createElement('label');
                label.htmlFor = 'mat' + m.idmatricula;
                label.textContent = m.fk_alumno.fk_persona_alumno.nom1_persona + ' ' + m.fk_alumno.fk_persona_alumno.ape1_persona;
                label.className = 'mb-0';

                li.appendChild(checkbox);
                li.appendChild(label);
                listaMatriculas.appendChild(li);
            });

            console.log('Se agregaron', filtradas.length, 'alumnos a la lista');
        });

        // Seleccionar/Deseleccionar todos
        if (checkAll) {
            checkAll.addEventListener('change', function () {
                const checked = this.checked;
                document.querySelectorAll('.chkAlumno').forEach(function (c) {
                    c.checked = checked;
                });
            });
        }

        // Enviar los seleccionados al servidor - CON MODAL DE CONFIRMACI√ìN
        if (btnTerminarPeriodo) {
            btnTerminarPeriodo.addEventListener('click', function () {
                console.log('üî¥ BOT√ìN TERMINAR PERIODO CLICKEADO');

                const seleccionados = Array.from(document.querySelectorAll('.chkAlumno:checked'))
                    .map(function (c) {
                        return c.value;
                    });

                console.log('Alumnos seleccionados:', seleccionados);

                if (seleccionados.length === 0) {
                    alert('‚ùå No has seleccionado ning√∫n alumno.');
                    return;
                }

                // Mostrar modal de confirmaci√≥n en lugar del confirm() nativo
                const confirmarModal = new bootstrap.Modal(document.getElementById('confirmarTerminarModal'));
                const cantidadAlumnos = document.getElementById('cantidadAlumnos');
                const btnConfirmarTerminar = document.getElementById('btnConfirmarTerminar');

                // Actualizar el texto con la cantidad de alumnos
                cantidadAlumnos.textContent = seleccionados.length;

                // Configurar el evento de confirmaci√≥n
                btnConfirmarTerminar.onclick = function () {
                    console.log('üü° CONFIRMADO - Enviando datos al servidor...');

                    // Cerrar el modal de confirmaci√≥n
                    confirmarModal.hide();

                    // Proceder con el env√≠o de datos
                    procesarTerminarPeriodo(seleccionados);
                };

                // Mostrar el modal de confirmaci√≥n
                confirmarModal.show();
            });
        }
    }

    // Funci√≥n para procesar el t√©rmino del per√≠odo
    function procesarTerminarPeriodo(seleccionados) {
        console.log('üü° Enviando datos al servidor...');

        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const formData = new FormData();
        const btnTerminarPeriodo = document.getElementById('btnTerminarPeriodo');

        seleccionados.forEach(function (id) {
            formData.append('matriculas[]', id);
        });
        formData.append('csrfmiddlewaretoken', csrfToken);

        // Mostrar loading en el bot√≥n principal
        btnTerminarPeriodo.disabled = true;
        btnTerminarPeriodo.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Procesando...';

        fetch("{% url 'terminar_periodo' %}", {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(function (response) {
                console.log('Respuesta del servidor - Status:', response.status);
                if (!response.ok) {
                    throw new Error('Error del servidor: ' + response.status);
                }
                return response.json();
            })
            .then(function (data) {
                console.log('Datos recibidos:', data);

                if (data.error) {
                    throw new Error(data.error);
                }

                // ‚úÖ SIMPLEMENTE RECARGAR LA P√ÅGINA para mostrar los mensajes de Django
                let exitosos = data.resultados.filter(r => r.status === '√©xito').length;

                if (exitosos > 0) {
                    // Recargar la p√°gina para mostrar los mensajes de Django
                    location.reload();
                } else {
                    // Si no hubo √©xitos, mostrar alerta y recargar
                    alert('‚ùå No se pudo procesar ninguna matr√≠cula. Revise los errores.');
                    location.reload();
                }
            })
            .catch(function (error) {
                console.error('Error completo:', error);
                alert('‚ùå Ocurri√≥ un error al terminar el per√≠odo: ' + error.message);

                // Restaurar bot√≥n
                btnTerminarPeriodo.disabled = false;
                btnTerminarPeriodo.innerHTML = 'Terminar Per√≠odo';
            });
    }

    // ================= FUNCIONES AUXILIARES PARA MODAL DE INFORMACI√ìN =================

    // Funci√≥n para formatear valores vac√≠os
    function formatearValor(valor) {
        return valor && valor !== 'undefined' && valor !== 'None' && valor !== '' ? valor : '<span class="text-muted">No especificado</span>';
    }

    // Funci√≥n para formatear documentos - MEJORADA PARA ABRIR ARCHIVOS
    function formatearDocumento(url, texto, tipo = 'documento') {
        if (url && url !== 'undefined' && url !== 'None' && url !== '') {
            return `
                <div class="d-flex align-items-center gap-2">
                    <a href="${url}" target="_blank" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-eye me-1"></i>Ver ${texto}
                    </a>
                    <span class="badge bg-success">‚úì Cargado</span>
                </div>`;
        }
        return '<span class="text-muted">No cargado</span>';
    }

    // Funci√≥n para obtener el texto del g√©nero
    function obtenerTextoGenero(codigo) {
        const generos = {
            'M': 'Masculino',
            'F': 'Femenino'
        };
        return generos[codigo] || codigo;
    }

    // Funci√≥n para obtener el texto del tipo de identificaci√≥n
    function obtenerTextoTipoIdentidad(codigo) {
        const tipos = {
            'CC': 'C√©dula de Ciudadan√≠a',
            'TI': 'Tarjeta de Identidad',
            'RC': 'Registro Civil',
            'PAS': 'Pasaporte'
        };
        return tipos[codigo] || codigo;
    }

    // Funci√≥n para obtener el texto del parentesco
    function obtenerTextoParentesco(codigo) {
        const parentescos = {
            'Padre': 'Padre',
            'Madre': 'Madre',
            'Madrastra': 'Madrastra',
            'Padrastro': 'Padrastro',
            'Tio': 'T√≠o',
            'Primo': 'Primo',
            'Hermano': 'Hermano',
            'Abuelo': 'Abuelo',
            'Cuidador': 'Cuidador'
        };
        return parentescos[codigo] || codigo;
    }

    // ================= MODAL DE INFORMACI√ìN COMPLETA DE POSTULANTES =================

    function inicializarModalInfoPostulantes() {
        // Event listeners para postulantes - MODAL COMPLETO
        document.querySelectorAll('.btn-ver-info').forEach(btn => {
            btn.addEventListener('click', function () {
                const data = this.dataset;
                console.log('üîç Datos del postulante:', data);

                const html = `
                <div class="row">
                    <!-- Informaci√≥n Personal -->
                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0"><i class="fas fa-user me-2"></i>Informaci√≥n Personal</h6>
                            </div>
                            <div class="card-body">
                                <div class="row mb-2">
                                    <div class="col-12">
                                        <strong>Nombre Completo:</strong><br>
                                        ${formatearValor(data.nom)} ${formatearValor(data.nom2)} ${formatearValor(data.ape)} ${formatearValor(data.ape2)}
                                    </div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-md-6">
                                        <strong>Tipo Identificaci√≥n:</strong><br>
                                        ${obtenerTextoTipoIdentidad(formatearValor(data.tipoIdentidad))}
                                    </div>
                                    <div class="col-md-6">
                                        <strong>N√∫mero Identificaci√≥n:</strong><br>
                                        ${formatearValor(data.idPersona)}
                                    </div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-md-6">
                                        <strong>Fecha Nacimiento:</strong><br>
                                        ${formatearValor(data.fecha)}
                                    </div>
                                    <div class="col-md-6">
                                        <strong>G√©nero:</strong><br>
                                        ${obtenerTextoGenero(formatearValor(data.genero))}
                                    </div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-md-6">
                                        <strong>EPS:</strong><br>
                                        ${formatearValor(data.eps)}
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Tipo de Sangre:</strong><br>
                                        ${formatearValor(data.rh)}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Informaci√≥n de Contacto -->
                        <div class="card mb-3">
                            <div class="card-header bg-warning text-dark">
                                <h6 class="mb-0"><i class="fas fa-address-book me-2"></i>Informaci√≥n de Contacto</h6>
                            </div>
                            <div class="card-body">
                                <div class="row mb-2">
                                    <div class="col-12">
                                        <strong>Direcci√≥n:</strong><br>
                                        ${formatearValor(data.direc)}
                                    </div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-md-6">
                                        <strong>Tel√©fono:</strong><br>
                                        ${formatearValor(data.tel)}
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Email:</strong><br>
                                        ${formatearValor(data.email)}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Informaci√≥n Deportiva y Acudiente -->
                    <div class="col-md-6">
                        <!-- Informaci√≥n Deportiva -->
                        <div class="card mb-3">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0"><i class="fas fa-futbol me-2"></i>Informaci√≥n Deportiva</h6>
                            </div>
                            <div class="card-body">
                                <div class="row mb-2">
                                    <div class="col-12">
                                        <strong>Posici√≥n:</strong><br>
                                        ${formatearValor(data.posicion)}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Medidas F√≠sicas -->
                        <div class="card mb-3">
                            <div class="card-header bg-secondary text-white">
                                <h6 class="mb-0"><i class="fas fa-ruler me-2"></i>Medidas F√≠sicas</h6>
                            </div>
                            <div class="card-body">
                                <div class="row mb-2">
                                    <div class="col-md-4">
                                        <strong>Altura:</strong><br>
                                        ${formatearValor(data.altura)} m
                                    </div>
                                    <div class="col-md-4">
                                        <strong>Peso:</strong><br>
                                        ${formatearValor(data.peso)} kg
                                    </div>
                                    <div class="col-md-4">
                                        <strong>IMC:</strong><br>
                                        ${formatearValor(data.imc)}
                                    </div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-md-4">
                                        <strong>Talla Ropa:</strong><br>
                                        ${formatearValor(data.talla)}
                                    </div>
                                    <div class="col-md-4">
                                        <strong>Calzado:</strong><br>
                                        ${formatearValor(data.calzado)}
                                    </div>
                                    <div class="col-md-4">
                                        <strong>Pie Dominante:</strong><br>
                                        ${formatearValor(data.pieDominante)}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Informaci√≥n del Acudiente -->
                        <div class="card mb-3">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0"><i class="fas fa-users me-2"></i>Informaci√≥n del Acudiente</h6>
                            </div>
                            <div class="card-body">
                                <div class="row mb-2">
                                    <div class="col-12">
                                        <strong>Nombre Completo:</strong><br>
                                        ${formatearValor(data.nom1Acudiente)} ${formatearValor(data.nom2Acudiente)} ${formatearValor(data.ape1Acudiente)} ${formatearValor(data.ape2Acudiente)}
                                    </div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-md-6">
                                        <strong>ID Acudiente:</strong><br>
                                        ${formatearValor(data.idAcudiente)}
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Parentesco:</strong><br>
                                        ${obtenerTextoParentesco(formatearValor(data.parentesco))}
                                    </div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-md-6">
                                        <strong>Tel√©fono:</strong><br>
                                        ${formatearValor(data.telAcudiente)}
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Email:</strong><br>
                                        ${formatearValor(data.emailAcudiente)}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Documentos -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-dark text-white">
                                <h6 class="mb-0"><i class="fas fa-file me-2"></i>Documentos</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4 mb-2">
                                        <strong>Tratamiento de Datos:</strong><br>
                                        ${formatearDocumento(data.tradatos, 'Tratamiento')}
                                    </div>
                                    <div class="col-md-4 mb-2">
                                        <strong>Foto:</strong><br>
                                        ${formatearDocumento(data.foto, 'Foto', 'imagen')}
                                    </div>
                                    <div class="col-md-4 mb-2">
                                        <strong>Autorizaci√≥n M√©dica:</strong><br>
                                        ${formatearDocumento(data.automedica, 'Autorizaci√≥n')}
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-4 mb-2">
                                        <strong>Comprobante EPS:</strong><br>
                                        ${formatearDocumento(data.certeps, 'Comprobante EPS')}
                                    </div>
                                    <div class="col-md-4 mb-2">
                                        <strong>Certificado Otra Escuela:</strong><br>
                                        ${formatearDocumento(data.otraescuela, 'Certificado')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                `;

                document.getElementById('modalInfoBody').innerHTML = html;
                const modal = new bootstrap.Modal(document.getElementById('modalInfo'));
                modal.show();
                console.log('‚úÖ Modal de informaci√≥n abierto');
            });
        });
    }

    // ================= MODALES DE POSTULANTES (ACEPTAR/RECHAZAR) =================

    function inicializarModalesPostulantes() {
        // Modal Aceptar Postulante
        document.querySelectorAll('.btn-open-aceptar').forEach(btn => {
            btn.addEventListener('click', function () {
                const id = this.dataset.id;
                const nom = this.dataset.nom;
                document.getElementById('aceptar_id_persona').value = id;
                document.getElementById('aceptar_text').textContent = `Vas a aceptar a ${nom}. Confirma la categor√≠a o deja en blanco para asignar por edad.`;
                new bootstrap.Modal(document.getElementById('modalAceptar')).show();
            });
        });

        // Modal Rechazar Postulante
        const modalRechazarEl = document.getElementById('modalRechazar');
        if (modalRechazarEl) {
            const modalRechazar = new bootstrap.Modal(modalRechazarEl);
            const textoRechazar = document.getElementById('texto-rechazar');
            const rechazarId = document.getElementById('rechazar_id_persona');

            document.querySelectorAll('.btn-open-rechazar').forEach(btn => {
                btn.addEventListener('click', function () {
                    textoRechazar.textContent = `¬øSeguro que deseas rechazar a ${this.dataset.nom}?`;
                    rechazarId.value = this.dataset.id;
                    modalRechazar.show();
                });
            });
        }
    }

    // ================= FUNCI√ìN PARA VER DOCUMENTOS =================

    // Funci√≥n para ver documentos (compatible con el modal de edici√≥n)
    function verDocumento(tipo) {
        let ruta = '';
        let nombreDocumento = '';

        // Obtener la ruta del documento seg√∫n el tipo
        switch (tipo) {
            case 'tradatos':
                ruta = document.getElementById('edit_tradatos_existente')?.value || '';
                nombreDocumento = 'Tratamiento de Datos';
                break;
            case 'foto':
                ruta = document.getElementById('edit_foto_existente')?.value || '';
                nombreDocumento = 'Foto';
                break;
            case 'automedica':
                ruta = document.getElementById('edit_automedica_existente')?.value || '';
                nombreDocumento = 'Autorizaci√≥n M√©dica';
                break;
            case 'certeps':
                ruta = document.getElementById('edit_certeps_existente')?.value || '';
                nombreDocumento = 'Comprobante EPS';
                break;
            case 'otraescuela':
                ruta = document.getElementById('edit_otraescuela_existente')?.value || '';
                nombreDocumento = 'Certificado Otra Escuela';
                break;
        }

        if (ruta && ruta !== 'undefined' && ruta !== 'None' && ruta !== '') {
            // Si la ruta es una URL completa, abrir directamente
            if (ruta.startsWith('http') || ruta.startsWith('/')) {
                window.open(ruta, '_blank');
            } else {
                // Si es una ruta relativa, construir la URL completa
                const urlCompleta = `/media/${ruta}`;
                window.open(urlCompleta, '_blank');
            }
            console.log(`‚úÖ Abriendo documento: ${nombreDocumento} - ${ruta}`);
        } else {
            alert(`No hay ${nombreDocumento} disponible para visualizar`);
            console.log(`‚ùå No hay documento disponible: ${nombreDocumento}`);
        }
    }

    // ================= FUNCI√ìN PARA INICIALIZAR EVENT LISTENERS =================

    // Funci√≥n para inicializar los event listeners con los datos
    function inicializarEventListeners(matriculasData) {
        console.log('üéØ Inicializando event listeners con', matriculasData.length, 'matr√≠culas');

        // Inicializar funcionalidad de terminar per√≠odo
        inicializarTerminarPeriodo(matriculasData);

        // Inicializar modales de postulantes
        inicializarModalInfoPostulantes();
        inicializarModalesPostulantes();

        // Inicializar otras funcionalidades
        inicializarOtrasFuncionalidades();
    }

    // ================= OTRAS FUNCIONALIDADES =================

    function inicializarOtrasFuncionalidades() {
        console.log('üîß Inicializando otras funcionalidades...');

        // C√°lculo autom√°tico de IMC para el modal de edici√≥n
        const editAltura = document.getElementById('edit_altura');
        const editPeso = document.getElementById('edit_peso');

        if (editAltura && editPeso) {
            editAltura.addEventListener('input', calcularIMCEdicion);
            editPeso.addEventListener('input', calcularIMCEdicion);
        }

        // Abrir modal EDITAR y poblar inputs
        const modalEdit = document.getElementById('editAlumnoModal');
        if (modalEdit) {
            const modal = new bootstrap.Modal(modalEdit);

            // Configurar validaciones cuando se abra el modal
            modalEdit.addEventListener('shown.bs.modal', function () {
                console.log('üîß Modal de edici√≥n abierto, configurando validaciones...');
                configurarValidacionesEdicion();
            });

            document.querySelectorAll('.editAlumnoBtn').forEach(btn => {
                btn.addEventListener('click', function () {
                    console.log('üî¥ BOT√ìN EDITAR CLICKEADO - Datos disponibles:');

                    // Funci√≥n segura para obtener datos
                    function getData(key) {
                        const value = this.dataset[key];
                        return (value && value !== 'undefined' && value !== 'None' && value !== '') ? value : '';
                    }

                    // ========== DATOS B√ÅSICOS DE PERSONA ==========
                    const personaId = getData.call(this, 'id');
                    document.getElementById('edit_persona_id').value = personaId;

                    // Campos EDITABLES
                    document.getElementById('edit_nom1').value = getData.call(this, 'nom1');
                    document.getElementById('edit_nom2').value = getData.call(this, 'nom2');
                    document.getElementById('edit_ape1').value = getData.call(this, 'ape1');
                    document.getElementById('edit_ape2').value = getData.call(this, 'ape2');
                    document.getElementById('edit_direc').value = getData.call(this, 'direc');
                    document.getElementById('edit_tel').value = getData.call(this, 'tel');
                    document.getElementById('edit_email').value = getData.call(this, 'email');
                    document.getElementById('edit_genero').value = getData.call(this, 'genero');
                    document.getElementById('edit_eps').value = getData.call(this, 'eps');

                    // ========== CAMPOS NO EDITABLES (solo visualizaci√≥n) ==========
                    const tipoIdentidad = getData.call(this, 'tipoidentidad');
                    const numIdentidad = getData.call(this, 'numidentidad');
                    const fechaNacimiento = getData.call(this, 'fecha');
                    const rh = getData.call(this, 'rh');

                    // Mostrar en campos de solo lectura
                    document.getElementById('edit_tipo_identidad_display').value = tipoIdentidad || '';
                    document.getElementById('edit_num_identidad_display').value = numIdentidad || '';
                    document.getElementById('edit_fecha_display').value = fechaNacimiento || '';
                    document.getElementById('edit_rh_display').value = rh || '';

                    // Guardar en hidden fields
                    document.getElementById('edit_tipo_identidad').value = tipoIdentidad;
                    document.getElementById('edit_num_identidad').value = numIdentidad;
                    document.getElementById('edit_fecha').value = fechaNacimiento;
                    document.getElementById('edit_rh').value = rh;

                    // ========== MEDIDAS F√çSICAS ==========
                    // Convertir valores num√©ricos reemplazando comas por puntos
                    const altura = getData.call(this, 'altura');
                    const peso = getData.call(this, 'peso');
                    const imc = getData.call(this, 'imc');
                    const calzado = getData.call(this, 'calzado');

                    document.getElementById('edit_altura').value = altura ? altura.replace(',', '.') : '';
                    document.getElementById('edit_peso').value = peso ? peso.replace(',', '.') : '';
                    document.getElementById('edit_imc').value = imc ? imc.replace(',', '.') : '';
                    document.getElementById('edit_calzado').value = calzado || '';
                    document.getElementById('edit_talla').value = getData.call(this, 'talla');
                    document.getElementById('edit_pie').value = getData.call(this, 'pie');

                    // ========== ACUDIENTE ==========
                    const idAcudiente = getData.call(this, 'idacudiente');
                    document.getElementById('edit_idacudiente').value = idAcudiente;
                    document.getElementById('edit_idacudiente_actual').value = idAcudiente;

                    document.getElementById('edit_nom1_acudiente').value = getData.call(this, 'nom1acudiente');
                    document.getElementById('edit_nom2_acudiente').value = getData.call(this, 'nom2acudiente');
                    document.getElementById('edit_ape1_acudiente').value = getData.call(this, 'ape1acudiente');
                    document.getElementById('edit_ape2_acudiente').value = getData.call(this, 'ape2acudiente');
                    document.getElementById('edit_telacud').value = getData.call(this, 'telacudiente');
                    document.getElementById('edit_emailacud').value = getData.call(this, 'emailacudiente');
                    document.getElementById('edit_parentesco').value = getData.call(this, 'parentesco');

                    // ========== INFORMACI√ìN DEPORTIVA ==========
                    document.getElementById('edit_categoria').value = getData.call(this, 'categoria');
                    document.getElementById('edit_posicion').value = getData.call(this, 'posicion');
                    document.getElementById('edit_matricula_id').value = getData.call(this, 'matricula');

                    // ========== DOCUMENTOS EXISTENTES ==========
                    const tradatosRuta = getData.call(this, 'tradatos');
                    const fotoRuta = getData.call(this, 'foto');
                    const automedicaRuta = getData.call(this, 'automedica');
                    const certepsRuta = getData.call(this, 'certeps');
                    const otraEscuelaRuta = getData.call(this, 'otraescuela');

                    // Mostrar estado de documentos existentes
                    document.getElementById('edit_tradatos_display').value = tradatosRuta ? 'Documento cargado ‚úì' : 'No cargado';
                    document.getElementById('edit_foto_display').value = fotoRuta ? 'Foto cargada ‚úì' : 'No cargada';
                    document.getElementById('edit_automedica_display').value = automedicaRuta ? 'Documento cargado ‚úì' : 'No cargado';
                    document.getElementById('edit_certeps_display').value = certepsRuta ? 'Documento cargado ‚úì' : 'No cargado';
                    document.getElementById('edit_otraescuela_display').value = otraEscuelaRuta ? 'Documento cargado ‚úì' : 'No aplica';

                    // Guardar rutas existentes en hidden fields
                    document.getElementById('edit_tradatos_existente').value = tradatosRuta || '';
                    document.getElementById('edit_foto_existente').value = fotoRuta || '';
                    document.getElementById('edit_automedica_existente').value = automedicaRuta || '';
                    document.getElementById('edit_certeps_existente').value = certepsRuta || '';
                    document.getElementById('edit_otraescuela_existente').value = otraEscuelaRuta || '';

                    // Habilitar/deshabilitar botones de ver seg√∫n si hay documento
                    document.getElementById('btn_ver_tradatos').disabled = !tradatosRuta;
                    document.getElementById('btn_ver_foto').disabled = !fotoRuta;
                    document.getElementById('btn_ver_automedica').disabled = !automedicaRuta;
                    document.getElementById('btn_ver_certeps').disabled = !certepsRuta;
                    document.getElementById('btn_ver_otraescuela').disabled = !otraEscuelaRuta;

                    // Calcular IMC inicial si hay datos
                    calcularIMCEdicion();

                    console.log('‚úÖ Datos cargados en modal de edici√≥n para persona ID:', personaId);
                    modal.show();
                });
            });
        }

        // Prevenir env√≠o del formulario de edici√≥n si hay errores
        document.getElementById('editAlumnoForm')?.addEventListener('submit', function (e) {
            const errores = this.querySelectorAll('.is-invalid');
            if (errores.length > 0) {
                e.preventDefault();
                alert('Por favor corrige los errores antes de guardar los cambios.');

                // Desplazarse al primer error
                const primerError = this.querySelector('.is-invalid');
                if (primerError) {
                    primerError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    primerError.focus();
                }
            }
        });
    }

    // ================= VALIDACIONES PARA MODAL DE EDICI√ìN =================
    function configurarValidacionesEdicion() {
        console.log('üîß Configurando validaciones para modal de edici√≥n...');

        const campos = {
            'edit_tel': validarTelefono,
            'edit_telacud': validarTelefono,
            'edit_email': validarEmail,
            'edit_emailacud': validarEmailOpcional,
            'edit_nom1': validarNombre,
            'edit_nom2': validarNombreOpcional,
            'edit_ape1': validarApellido,
            'edit_ape2': validarApellidoOpcional,
            'edit_direc': validarDireccion,
            'edit_nom1_acudiente': validarNombre,
            'edit_nom2_acudiente': validarNombreOpcional,
            'edit_ape1_acudiente': validarApellido,
            'edit_ape2_acudiente': validarApellidoOpcional,
            'edit_altura': validarAltura,
            'edit_peso': validarPeso,
            'edit_calzado': validarCalzado,
            'edit_idacudiente': validarIdentificacion
        };

        // Aplicar validaciones espec√≠ficas
        Object.keys(campos).forEach(campoId => {
            const campo = document.getElementById(campoId);
            if (campo) {
                campo.addEventListener('blur', function () {
                    validarCampoEdicion(this, campos[campoId]);
                });
                campo.addEventListener('input', function () {
                    limpiarValidacionEdicion(this);
                    // Validar longitud en tiempo real mientras escribe
                    if (this.value.trim()) {
                        validarLongitudEdicion(this);
                    }
                });
            }
        });

        // Validaci√≥n para campos requeridos simples
        const camposRequeridos = document.querySelectorAll('#editAlumnoForm input[required], #editAlumnoForm select[required]');
        camposRequeridos.forEach(campo => {
            if (!Object.keys(campos).includes(campo.id)) {
                campo.addEventListener('blur', function () {
                    validarCampoRequeridoEdicion(this);
                });
                campo.addEventListener('input', function () {
                    limpiarValidacionEdicion(this);
                });
            }
        });

        // Validar archivos
        const archivos = ['edit_automedica', 'edit_certeps'];
        archivos.forEach(archivoId => {
            const archivo = document.getElementById(archivoId);
            if (archivo) {
                archivo.addEventListener('change', function () {
                    validarArchivoEdicion(this);
                });
            }
        });

        // Configurar campos num√©ricos para reemplazar comas por puntos
        const camposNumericos = ['edit_altura', 'edit_peso'];
        camposNumericos.forEach(campoId => {
            const campo = document.getElementById(campoId);
            if (campo) {
                campo.addEventListener('input', function () {
                    // Reemplazar comas por puntos
                    this.value = this.value.replace(',', '.');
                });
            }
        });

        // Configurar c√°lculo autom√°tico de IMC
        const editAltura = document.getElementById('edit_altura');
        const editPeso = document.getElementById('edit_peso');
        if (editAltura && editPeso) {
            editAltura.addEventListener('input', calcularIMCEdicion);
            editPeso.addEventListener('input', calcularIMCEdicion);
        }
    }

    // Funciones de validaci√≥n espec√≠ficas para edici√≥n
    function validarCampoEdicion(campo, funcionValidacion) {
        const valor = campo.value.trim();
        limpiarValidacionEdicion(campo);

        if (valor && !funcionValidacion(valor, campo)) {
            mostrarErrorEdicion(campo, obtenerMensajeErrorEdicion(campo.id));
        } else if (campo.checkValidity() && valor) {
            mostrarExitoEdicion(campo);
        }
    }

    function validarCampoRequeridoEdicion(campo) {
        const valor = campo.value.trim();
        limpiarValidacionEdicion(campo);

        if (!valor) {
            mostrarErrorEdicion(campo, 'Este campo es requerido');
        } else {
            mostrarExitoEdicion(campo);
        }
    }

    function validarLongitudEdicion(campo) {
        const valor = campo.value.trim();
        const limites = {
            'edit_nom1': 20, 'edit_nom2': 20, 'edit_ape1': 20, 'edit_ape2': 20,
            'edit_nom1_acudiente': 20, 'edit_nom2_acudiente': 20,
            'edit_ape1_acudiente': 20, 'edit_ape2_acudiente': 20,
            'edit_direc': 40, 'edit_email': 40, 'edit_emailacud': 40
        };

        if (limites[campo.id] && valor.length > limites[campo.id]) {
            mostrarErrorEdicion(campo, `M√°ximo ${limites[campo.id]} caracteres`);
            return false;
        }
        return true;
    }

    // VALIDACIONES ESPEC√çFICAS
    function validarTelefono(valor) {
        return /^\d{10}$/.test(valor); // Exactamente 10 d√≠gitos
    }

    function validarEmail(valor, campo) {
        if (valor.length > 40) {
            mostrarErrorEdicion(campo, 'M√°ximo 40 caracteres');
            return false;
        }
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(valor);
    }

    function validarEmailOpcional(valor, campo) {
        if (!valor) return true;
        if (valor.length > 40) {
            mostrarErrorEdicion(campo, 'M√°ximo 40 caracteres');
            return false;
        }
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(valor);
    }

    function validarNombre(valor, campo) {
        if (valor.length > 20) {
            mostrarErrorEdicion(campo, 'M√°ximo 20 caracteres');
            return false;
        }
        return /^[A-Za-z√Å√â√ç√ì√ö√°√©√≠√≥√∫√ë√±\s]+$/.test(valor);
    }

    function validarNombreOpcional(valor, campo) {
        if (valor && valor.length > 20) {
            mostrarErrorEdicion(campo, 'M√°ximo 20 caracteres');
            return false;
        }
        return !valor || /^[A-Za-z√Å√â√ç√ì√ö√°√©√≠√≥√∫√ë√±\s]+$/.test(valor);
    }

    function validarApellido(valor, campo) {
        if (valor.length > 20) {
            mostrarErrorEdicion(campo, 'M√°ximo 20 caracteres');
            return false;
        }
        return /^[A-Za-z√Å√â√ç√ì√ö√°√©√≠√≥√∫√ë√±\s]+$/.test(valor);
    }

    function validarApellidoOpcional(valor, campo) {
        if (valor && valor.length > 20) {
            mostrarErrorEdicion(campo, 'M√°ximo 20 caracteres');
            return false;
        }
        return !valor || /^[A-Za-z√Å√â√ç√ì√ö√°√©√≠√≥√∫√ë√±\s]+$/.test(valor);
    }

    function validarDireccion(valor, campo) {
        if (valor.length > 40) {
            mostrarErrorEdicion(campo, 'M√°ximo 40 caracteres');
            return false;
        }
        return true;
    }

    function validarAltura(valor, campo) {
        const valorNormalizado = valor.replace(',', '.');
        const altura = parseFloat(valorNormalizado);
        return !isNaN(altura) && altura >= 0.5 && altura <= 2.5;
    }

    function validarPeso(valor, campo) {
        const valorNormalizado = valor.replace(',', '.');
        const peso = parseFloat(valorNormalizado);
        return !isNaN(peso) && peso >= 10 && peso <= 150;
    }

    function validarCalzado(valor, campo) {
        const calzado = parseInt(valor);
        return !isNaN(calzado) && calzado >= 15 && calzado <= 50;
    }

    function validarIdentificacion(valor) {
        return /^\d+$/.test(valor) && valor.length >= 6 && valor.length <= 10;
    }

    function validarArchivoEdicion(archivo) {
        const nombreArchivo = archivo.value;
        const extensionesPermitidas = {
            'edit_automedica': ['.pdf', '.doc', '.docx'],
            'edit_certeps': ['.pdf', '.doc', '.docx']
        };

        if (nombreArchivo) {
            const extension = nombreArchivo.toLowerCase().substring(nombreArchivo.lastIndexOf('.'));
            const extensiones = extensionesPermitidas[archivo.id];

            if (extensiones && !extensiones.includes(extension)) {
                mostrarErrorEdicion(archivo, `Formatos permitidos: ${extensiones.join(', ')}`);
                return false;
            } else {
                mostrarExitoEdicion(archivo);
                return true;
            }
        }

        // En edici√≥n, los archivos no son obligatorios
        return true;
    }

    function obtenerMensajeErrorEdicion(campoId) {
        const mensajes = {
            'edit_tel': 'Exactamente 10 d√≠gitos',
            'edit_telacud': 'Exactamente 10 d√≠gitos',
            'edit_email': 'Email inv√°lido o m√°ximo 40 caracteres',
            'edit_emailacud': 'Email inv√°lido o m√°ximo 40 caracteres',
            'edit_nom1': 'Solo letras, m√°ximo 20 caracteres',
            'edit_nom2': 'Solo letras, m√°ximo 20 caracteres',
            'edit_ape1': 'Solo letras, m√°ximo 20 caracteres',
            'edit_ape2': 'Solo letras, m√°ximo 20 caracteres',
            'edit_nom1_acudiente': 'Solo letras, m√°ximo 20 caracteres',
            'edit_nom2_acudiente': 'Solo letras, m√°ximo 20 caracteres',
            'edit_ape1_acudiente': 'Solo letras, m√°ximo 20 caracteres',
            'edit_ape2_acudiente': 'Solo letras, m√°ximo 20 caracteres',
            'edit_direc': 'M√°ximo 40 caracteres',
            'edit_altura': 'La altura debe estar entre 0.5 y 2.5 metros',
            'edit_peso': 'El peso debe estar entre 10 y 150 kg',
            'edit_calzado': 'La talla de calzado debe estar entre 15 y 50',
            'edit_idacudiente': 'Solo n√∫meros, entre 6 y 10 d√≠gitos'
        };
        return mensajes[campoId] || 'Valor inv√°lido';
    }

    function mostrarErrorEdicion(campo, mensaje) {
        campo.classList.add('is-invalid');
        campo.classList.remove('is-valid');

        // Buscar mensaje de error existente
        let feedback = campo.nextElementSibling;
        while (feedback && !feedback.classList.contains('invalid-feedback')) {
            feedback = feedback.nextElementSibling;
        }

        if (!feedback || !feedback.classList.contains('invalid-feedback')) {
            feedback = document.createElement('div');
            feedback.className = 'invalid-feedback';
            campo.parentNode.appendChild(feedback);
        }
        feedback.textContent = mensaje;
        feedback.style.display = 'block';
    }

    function mostrarExitoEdicion(campo) {
        campo.classList.add('is-valid');
        campo.classList.remove('is-invalid');

        // Ocultar mensaje de error si existe
        let feedback = campo.nextElementSibling;
        while (feedback && !feedback.classList.contains('invalid-feedback')) {
            feedback = feedback.nextElementSibling;
        }

        if (feedback && feedback.classList.contains('invalid-feedback')) {
            feedback.style.display = 'none';
        }
    }

    function limpiarValidacionEdicion(campo) {
        campo.classList.remove('is-invalid', 'is-valid');
    }

    function calcularIMCEdicion() {
        let altura = document.getElementById('edit_altura').value;
        let peso = document.getElementById('edit_peso').value;
        const imcInput = document.getElementById('edit_imc');

        // Normalizar valores
        altura = altura.replace(',', '.');
        peso = peso.replace(',', '.');

        const alturaNum = parseFloat(altura) || 0;
        const pesoNum = parseFloat(peso) || 0;

        if (alturaNum > 0 && pesoNum > 0) {
            const imc = pesoNum / (alturaNum * alturaNum);
            imcInput.value = imc.toFixed(2);

            // Validar visualmente el IMC con colores
            if (imc < 18.5) {
                imcInput.style.borderColor = '#ffc107';
                imcInput.style.backgroundColor = '#fffbf0';
            } else if (imc >= 18.5 && imc <= 24.9) {
                imcInput.style.borderColor = '#28a745';
                imcInput.style.backgroundColor = '#f8fff9';
            } else if (imc >= 25 && imc <= 29.9) {
                imcInput.style.borderColor = '#fd7e14';
                imcInput.style.backgroundColor = '#fff4e6';
            } else {
                imcInput.style.borderColor = '#dc3545';
                imcInput.style.backgroundColor = '#fff5f5';
            }
        } else {
            imcInput.value = '';
            imcInput.style.borderColor = '';
            imcInput.style.backgroundColor = '#f8f9fa';
        }
    }

    // DEBUG TEMPORAL - Verificar que las URLs sean correctas
    document.addEventListener('DOMContentLoaded', function () {
        console.log('üîó URL terminar_periodo:', "{% url 'terminar_periodo' %}");
        console.log('üîó URL get_matriculas_json:', "{% url 'get_matriculas_json' %}");

        // Inicializar matr√≠culas cuando el DOM est√© listo
        console.log('DOM cargado, inicializando matr√≠culas...');
        inicializarMatriculas();
    });
</script>
{% endblock %}